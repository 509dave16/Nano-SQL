!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.e?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=4)}([function(e,t,n){var r=n(1),o=n(3);t.t=function(e){return JSON.parse(JSON.stringify(e))};var i=function(){function e(){var e=this;e.r={},e.a={},e.u={},e._=[],e.f=[],e.h=["change","delete","upsert","drop","select","error"],e.y={},e.b={},e.y["*"]={};for(var t=e.h.length;t--;)e.y["*"][e.h[t]]=[];e.g={},e.v={}}return e.prototype.table=function(e){return e&&(this.w=e,this.activeTable=e),this},e.prototype.connect=function(e){var t=this,n=this;return n.backend?new r.k(function(e,t){throw t(),Error()}):(n.backend=e||new o.T,new r.k(function(e,r){n.backend.x({u:n.u,r:n.r,a:n.a,g:n.g,j:n.f,O:t,S:function(t){e(t,n)},C:function(e){r&&r(e,n)}})}))},e.prototype.on=function(e,t){var n=this,r=n.w,o=0,i=e.split(" ");if(!n.y[r])for(n.y[r]={},n.y[r]["*"]=[];o--;)n.y[r][n.h[o]]=[];for(o=i.length;o--;)n.h.indexOf(i[o])!==-1&&n.y[r][i[o]].push(t);return n.R(),n},e.prototype.off=function(e){var t=this;for(var n in t.y)for(var r in t.y[n])t.y[n][r]=t.y[n][r].filter(function(t){return t!==e});return t.R(),t},e.prototype.R=function(){var e=this;this.b={},Object.keys(this.u).concat(["*"]).forEach(function(t){e.b[t]=e.h.reduce(function(n,r){return n+e.y[t][r].length},0)>0})},e.prototype.model=function(e){var t=this,n=t.w,r=t.h.length;if(!t.y[n])for(t.y[n]={},t.y[n]["*"]=[];r--;)t.y[n][t.h[r]]=[];return t.u[n]=e,t.a[n]=[],t.r[n]=[],t},e.prototype.views=function(e){return this.a[this.w]=e,this},e.prototype.getView=function(e,t){void 0===t&&(t={});for(var n,r=this,o=r.w,i=r.a[o].length;i--;)r.a[o][i].name===e&&(n=r.a[o][i]);if(!n)throw Error;return r.q=e,n.call.apply(r,[r.A(n.args?n.args:[],t),r])},e.prototype.A=function(e,t){var n=this,r=(n.w,{}),o=e.length?e.length:-1;if(o>0)for(;o--;){var i=e[o].split(":");i.length>1?r[i[0]]=n.P(i[1],t[i[0]]||null):r[i[0]]=t[i[0]]||null}return r},e.prototype.P=function(e,n){var r=typeof n;return{string:"string"!==r?String(n||""):n,int:"number"!==r||n%1!=0?parseInt(n||0):n,float:"number"!==r?parseFloat(n||0):n,array:Array.isArray(n)?t.t(n||[]):[],map:"object"===r?t.t(n||{}):{},bool:n===!0}[e]||n},e.prototype.actions=function(e){return this.r[this.w]=e,this},e.prototype.doAction=function(e,t){void 0===t&&(t={});for(var n,r=this,o=r.w,i=r.r[o].length;i--;)r.r[o][i].name===e&&(n=r.r[o][i]);if(!n)throw Error;return r.q=e,n.call.apply(r,[r.A(n.args?n.args:[],t),r])},e.prototype.newFunction=function(e,t,n){return this.g[e]={type:t,call:n},this},e.prototype.query=function(e,t){var n=this;this._=[];var r=e.toLowerCase();if(["select","upsert","delete","drop","show tables","describe"].indexOf(r)===-1)throw Error;var o=t||("select"===r||"delete"===r?[]:{});if("upsert"===e){var i={};this.u[this.w].forEach(function(e){o[e.key]&&(i[e.key]=n.P(e.type,o[e.key]))}),this.v[this.w]&&(i=this.v[this.w](i)),o=i}return this._.push({type:r,args:o}),this},e.prototype.where=function(e){return this.I("where",e)},e.prototype.orderBy=function(e){return this.I("orderby",e)},e.prototype.groupBy=function(e){return this.I("groupby",e)},e.prototype.having=function(e){return this.I("having",e)},e.prototype.join=function(e){return this.I("join",e)},e.prototype.limit=function(e){return this.I("limit",e)},e.prototype.offset=function(e){return this.I("offset",e)},e.prototype.I=function(e,t){return this._.push({type:e,args:t}),this},e.prototype.triggerEvent=function(e,t){var n=this;setTimeout(function(){for(var r,o,i=t.length,s=0;i--;)for(r=t[i],o=n.y[n.w][r].concat(n.y[n.w]["*"]),s=o.length;s--;)e.name=r,e.actionOrView=n.q||"",o[s](e,n);n.q=void 0},0)},e.prototype.default=function(e){var t={},n=this;return n.u[n.w].forEach(function(r){t[r.key]=e&&e[r.key]?e[r.key]:r.default,t[r.key]||(t[r.key]=n.P(r.type,null))}),t},e.prototype.exec=function(){var e=this,t=e.w;return e.b[t]&&(e.N=e._.map(function(e){switch(e.type){case"select":return[e.type];case"delete":case"upsert":case"drop":return[e.type,"change"];default:return[]}}).reduce(function(e,t){return e.concat(t)})),new r.k(function(n,r){if(!e.backend)throw r(),Error;var o=function(n,r,o,i,s){e.b[t]&&e.triggerEvent({name:"error",actionOrView:"",table:t,query:e._,time:(new Date).getTime(),result:n,changeType:o,changedRows:i},e.N),r(n,e)};e.backend.D({L:t,_:e._,M:e.q||"",S:function(e,t,r){o(e,n,t,r,!1)},C:function(t){e.N=["error"],r&&o(t,r,"error",[],!0)}})})},e.prototype.config=function(e){var t=this;return t.backend||t.f.push(e),t},e.prototype.extend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=this;if(n.backend)return n.backend.H?(e.unshift(n),n.backend.H.apply(n.backend,e)):void 0},e.prototype.loadJS=function(e){var t=this;return t.extend("before_import"),new r.k(function(n,o){r.k.all(e.map(function(e){return t.table(t.w).query("upsert",e).exec()})).then(function(e){t.extend("after_import"),n(e,t)})})},e.prototype.rowFilter=function(e){return this.v[this.w]=e,this},e.prototype.loadCSV=function(e){var t=this,n=[];return t.extend("before_import"),new r.k(function(o,i){r.k.all(e.split("\n").map(function(e,o){return new r.k(function(r,i){if(0===o)n=e.split(","),r();else{var s={},a=e.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)||[];a=a.map(function(e){return e.replace(/^"(.+(?="$))"$/,"$1")});for(var c=n.length;c--;)0!==a[c].indexOf("{")&&0!==a[c].indexOf("[")||(a[c]=JSON.parse(a[c].replace(/'/g,""))),s[n[c]]=a[c];t.table(t.w).query("upsert",s).exec().then(function(){r()})}})})).then(function(){t.extend("after_import"),o([],t)})})},e.uuid=function(){var e,t,n,r=function(){return"undefined"==typeof crypto?Math.round(Math.random()*Math.pow(2,16)):window.crypto.getRandomValues?(n=new Uint16Array(1),window.crypto.getRandomValues(n),n[0]):crypto.randomBytes?crypto.randomBytes(2).reduce(function(e,t){return t*e}):Math.round(Math.random()*Math.pow(2,16))},o="";return[o,o,o,o,o,o,o,o,o].reduce(function(n,i,s){for(e=r(),t=4===s?s:5===s?(e%16&3|8).toString(16):o,e=e.toString(16);e.length<4;)e="0"+e;return n+([3,4,5,6].indexOf(s)>=0?"-":o)+(t+e).slice(0,4)},o)},e.Q=function(e){return Math.abs(e.split("").reduce(function(t,n,r){return(t<<5)+t+e.charCodeAt(r)},0))},e.prototype.toCSV=function(e){var t=this;return new r.k(function(n,r){t.exec().then(function(r){var o=t._.filter(function(e){return"select"===e.type}).map(function(e){return e.args.length?e.args.map(function(e){return t.u[t.w].filter(function(t){return t.key===e})[0]}):t.u[t.w]})[0];e&&r.unshift(o.map(function(e){return e.key})),n(r.map(function(t,n){return e&&0===n?t:o.filter(function(e){return!!t[e.key]}).map(function(e){switch(e.type){case"map":case"array":return'"'+JSON.stringify(t[e.key]).replace(/"/g,"'")+'"';default:return t[e.key]}}).join(",")}).join("\n"),t)})})},e}();t.NanoSQLInstance=i;var s=new i;t.nSQL=function(e){return s.table(e)}},function(e,t,n){(function(e){function n(e,t,n){setTimeout(function(){var r;try{r=t.apply(null,n)}catch(t){return d.reject(e,t)}return r===e?d.reject(e,new TypeError):d.resolve(e,r),null})}function r(e){var t=e&&e.then;return!e||"object"!=typeof e&&"function"!=typeof e||"function"!=typeof t?null:function(){t.apply(e,arguments)}}function o(e,t){function n(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];s||(s=!0,d.reject(e,t))}function r(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];s||(s=!0,d.resolve(e,t))}function o(){t(r,n)}var s=!1,a=i(o);"error"===a.F&&n(a.B)}function i(e,t){var n={F:null,B:null};try{n.B=e(t),n.F="success"}catch(e){n.F="error",n.B=e}return n}var s=function(){},a="undefined"==typeof window,c=["UNHANDLED"],u=["REJECTED"],_=["FULFILLED"],l=["PENDING"],f=function(){function e(e){this.V=l,this.J=[],this.U=void 0,a&&(this.K=c),e!==s&&o(this,e)}return e.prototype.catch=function(e){return this.then(function(){},e)},e.prototype.then=function(t,r){if("function"!=typeof t&&this.V===_||"function"!=typeof r&&this.V===u)return this;var o=new e(s);if(a&&this.K===c&&(this.K=null),this.V!==l){n(o,this.V===_?t:r,this.U)}else this.J.push(new h(o,t,r));return o},e.resolve=function(t){return t instanceof this?t:d.resolve(new e(s),t)},e.reject=function(t){return d.reject(new e(s),t)},e.all=function(t){function n(e,t){function n(e){a[t]=e,++c!==o||i||(i=!0,d.resolve(_,a))}r.resolve(e).then(n,function(e){i||(i=!0,d.reject(_,e))})}var r=this,o=t.length,i=!1,a=new Array(o),c=0,u=-1,_=new e(s);if(!o)return this.resolve([]);for(;++u<o;)n(t[u],u);return _},e.race=function(t){function n(e){r.resolve(e).then(function(e){i||(i=!0,d.resolve(c,e))},function(e){i||(i=!0,d.reject(c,e))})}var r=this,o=t.length,i=!1,a=-1,c=new e(s);if(Array.isArray(t)!==!1)return this.reject(new TypeError);if(!o)return this.resolve([]);for(;++a<o;)n(t[a]);return c},e}();t.k=f;var h=function(){function e(e,t,n){this.z=e,"function"==typeof t&&(this.$=t,this.G=this.X),"function"==typeof n&&(this.W=n,this.Y=this.Z)}return e.prototype.G=function(e){d.resolve(this.z,e)},e.prototype.X=function(e){n(this.z,this.$,e)},e.prototype.Y=function(e){d.reject(this.z,e)},e.prototype.Z=function(e){n(this.z,this.W,e)},e}();t.ee=h;var d=function(){function t(){}return t.resolve=function(e,n){var s=i(r,n),a=s.B,c=-1,u=e.J.length;if("error"===s.F)return t.reject(e,s.B);if(a)o(e,a);else for(e.V=_,e.U=n;++c<u;)e.J[c].G(n);return e},t.reject=function(t,n){t.V=u,t.U=n,a&&t.K===c&&setTimeout(function(){t.K===c&&e.emit("unhandledRejection",n,t)},0);for(var r=-1,o=t.J.length;++r<o;)t.J[r].Y(n);return t},t}()}).call(t,n(2))},function(e,t){function n(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function o(e){if(_===setTimeout)return setTimeout(e,0);if((_===n||!_)&&setTimeout)return _=setTimeout,setTimeout(e,0);try{return _(e,0)}catch(t){try{return _.call(null,e,0)}catch(t){return _.call(this,e,0)}}}function i(e){if(l===clearTimeout)return clearTimeout(e);if((l===r||!l)&&clearTimeout)return l=clearTimeout,clearTimeout(e);try{return l(e)}catch(t){try{return l.call(null,e)}catch(t){return l.call(this,e)}}}function s(){p&&h&&(p=!1,h.length?d=h.concat(d):y=-1,d.length&&a())}function a(){if(!p){var e=o(s);p=!0;for(var t=d.length;t;){for(h=d,d=[];++y<t;)h&&h[y].run();y=-1,t=d.length}h=null,p=!1,i(e)}}function c(e,t){this.fun=e,this.array=t}function u(){}var _,l,f=e.exports={};!function(){try{_="function"==typeof setTimeout?setTimeout:n}catch(e){_=n}try{l="function"==typeof clearTimeout?clearTimeout:r}catch(e){l=r}}();var h,d=[],p=!1,y=-1;f.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];d.push(new c(e,t)),1!==d.length||p||o(a)},c.prototype.run=function(){this.fun.apply(null,this.array)},f.title="browser",f.browser=!0,f.env={},f.argv=[],f.version="",f.versions={},f.on=u,f.addListener=u,f.once=u,f.off=u,f.removeListener=u,f.removeAllListeners=u,f.emit=u,f.binding=function(e){throw new Error("process.binding is not supported")},f.cwd=function(){return"/"},f.chdir=function(e){throw new Error("process.chdir is not supported")},f.umask=function(){return 0}},function(e,t,n){var r=n(0),o=n(1),i=function(e,t){if(t.length){var n="*"!==e[0]?e[0]:null;return n||(n=Object.keys(t[0]).shift()||""),n}return""},s={SUM:{type:"aggregate",call:function(e,t,n){var r=0,o={},s=i(t,e);return s.length&&e.forEach(function(e){r+=parseInt(e[s])}),o[n]=r,[o]}},MIN:{type:"aggregate",call:function(e,t,n){var o=Number.MAX_VALUE,s=0,a={},c=i(t,e);return c.length&&e.forEach(function(e,t){var n=parseInt(e[c]);n<o&&(s=t,o=n)}),a=r.t(e[s]),a[n]=o,[a]}},MAX:{type:"aggregate",call:function(e,t,n){var o=Number.MIN_VALUE,s=0,a={},c=i(t,e);return c.length&&e.forEach(function(e,t){var n=parseInt(e[c]);n>o&&(s=t,o=n)}),a=r.t(e[s]),a[n]=o,[a]}},AVG:{type:"aggregate",call:function(e,t,n){var o=0,i={};return e.length&&(o=s.SUM.call(e,t,n)[0][n]/e.length,i=r.t(e[0])),i[n]=o,[i]}},COUNT:{type:"aggregate",call:function(e,t,n){var o=0,i={};return e.length&&(o="*"===t[0]?e.length:e.filter(function(e){return e[t[0]]}).length,i=r.t(e[0]),i[n]=o),[i]}}},a=function(){function e(){var e=this;e.u={},e.te={},e.ne=[],e.re=[],e.oe=0,e.ie=[0,0],e.se={},e.ae=!1}return e.prototype.ce=function(e,t){return this.te[e].ue[t][this.te[e]._e[t]]},e.prototype.le=function(){return this.te[this.w]},e.prototype.fe=function(e,t){var n=this,o=r.NanoSQLInstance.Q(e);n.u[o]=t,n.se[o]={},n.te[o]={he:"",de:"",pe:[],ye:[],be:e,ge:1,ve:[],_e:{},ue:{}};for(var i=n.u[o].length;i--;){var s=n.u[o][i];n.te[o].pe.unshift(s.key),n.te[o].ye[i]=s.default,s.props&&s.props.indexOf("pk")>=0&&(n.te[o].he=s.key,n.te[o].de=s.type)}return e},e.prototype.x=function(e){var t=this,n=[],o=!1,i=0;if(t.O=e.O,t.me=!!e.j.length&&(e.j[0].persistent||!1),Object.keys(e.u).forEach(function(r){n.push(t.fe(r,e.u[r]))}),t.we=r.NanoSQLInstance.Q(JSON.stringify(e.u)),Object.keys(e.g||[]).forEach(function(t){s[t]=e.g[t]}),t.me&&"undefined"!=typeof indexedDB){var a=indexedDB.open(String(t.we),1);a.onupgradeneeded=function(s){o=!0;var a=s.target.result,c=function(){if(i<n.length){var o=r.NanoSQLInstance.Q(n[i]),s=t.te[o].he?{keyPath:t.te[o].he}:{};a.createObjectStore(n[i],s),i++,c()}else e.S()};c()},a.onsuccess=function(s){if(t.ke=s.target.result,!o){var a=function(){if(i<n.length){var o=(r.NanoSQLInstance.Q(n[i]),t.ke.transaction(n[i],"readonly")),s=o.objectStore(n[i]),c=s.openCursor(),u=[];o.oncomplete=function(){t.O.table(n[i]).loadJS(u).then(function(){i++,a()})},c.onsuccess=function(e){var t=e.target.result;t&&(u.push(t.value),t.continue())}}else e.S()};a()}}}else e.S()},e.prototype.D=function(e){var t=this;t.ne.length?t.ne.push(e):(t.w=r.NanoSQLInstance.Q(e.L),new c(t).Te(e,function(e){t.ne.length&&t.D(t.ne.pop())}))},e.prototype.xe=function(e,t,n){var r=this;r.se[r.w]={},e.length&&n&&r.O.triggerEvent({name:"change",actionOrView:"",table:r.le().be,query:[],time:(new Date).getTime(),result:[{msg:n+" was performed.",type:n}],changedRows:e,changeType:t},["change"])},e.prototype.H=function(e,t){var n,r,i,s,a,c=this;c.ke&&c.le()&&(a=c.ke.transaction(c.le().be,"readwrite").objectStore(c.le().be));var u=function(e){var t=c.re[c.oe].Ee;n=c.re[c.oe].je.length;for(var r=[];n--;)i=c.re[c.oe].je[n],"int"===c.te[t].de&&(i=parseInt(i)),s=c.ce(t,i)||{},e>0&&r.push(s),c.te[t]._e[i]+=e,s=c.ce(t,i),e<0&&r.push(c.ce(t,i)),a&&(s?a.put(s):a.delete(i)),c.te[t]._e[i]<0&&(c.te[t]._e[i]=0);return r};return new o.k(function(e,n){switch(t){case"<":if(c.re.length&&c.oe!==c.re.length){var o=u(1),i=c.re[c.oe].Oe;switch(c.oe++,i){case"inserted":i="deleted";break;case"deleted":i="inserted"}c.xe(o,i,"undo"),e(!0)}else e(!1);break;case">":if(!c.re.length||c.oe<1)e(!1);else{c.oe--;var o=u(-1);c.xe(o,c.re[c.oe].Oe,"redo"),e(!0)}break;case"?":r=[c.re.length,c.re.length-c.oe],c.ie.join("+")!==r.join("+")&&(c.ie=r),e(c.ie);break;case"flush_db":c.ke&&indexedDB.deleteDatabase(String(c.we));break;case"before_import":c.ae=!0,e(!!c.ae);break;case"after_import":c.ae=!1,e(!!c.ae)}})},e}();t.T=a;var c=function(){function e(e){this.Se=e}return e.prototype.Te=function(e,t){var n=this,o=this;o.Ce=[],o.Re=void 0;var i=[];if(e._.forEach(function(t){["upsert","select","delete","drop"].indexOf(t.type)>=0?(o.Re=t,"select"===t.type&&(o.qe=r.NanoSQLInstance.Q(JSON.stringify(e._)))):["show tables","describe"].indexOf(t.type)>=0?i.push(t):o.Ce.push(t)}),i.length)switch(i[0].type){case"show tables":t(),e.S([{tables:Object.keys(this.Se.te).map(function(e){return n.Se.te[e].be})}],"info",[]);break;case"describe":var s,a=this.Se.w,c={};Object.keys(this.Se.te).forEach(function(e){parseInt(e)===n.Se.w&&(s=r.t(n.Se.u[e]),a=n.Se.te[e].be)}),c[a]=s,t(),e.S([c],"info",[])}else o.Ae(function(n,r,i){e.S(n,r,i),t(o)})},e.prototype.Pe=function(e){var t=this;return this.Se.u[this.Se.w].forEach(function(n){var r=e[n.key];["map","array"].indexOf(typeof r)>=0&&(e[n.key]=t.Pe(r))}),Object.freeze(e)},e.prototype.Ie=function(e){return this.Ce.filter(function(t){return t.type===e}).pop()},e.prototype.Ae=function(e){var t=this;if(t.Re){var n=[];switch(t.Ie("join")||"drop"===t.Re.type||(n=t.Ie("where")?t.Ne(t.Se.w,t.Se.le().ve.slice(),t.Ie("where").args):"upsert"!==t.Re.type?t.Se.le().ve.slice():[]),t.Re.type){case"upsert":this.De(n,e);break;case"select":this.Le(n,e);break;case"drop":case"delete":this.Me(n,e)}}},e.prototype.He=function(e){var t,n=this,o=n.Se.ce(n.Se.w,e),i=n.Re.args,s=function(){return n.Re&&"delete"===n.Re.type&&!i.length?"drop":n.Re?n.Re.type:""}();switch(s){case"upsert":t=n.Se.ae?o||{}:o?r.t(o):{},Object.keys(i).forEach(function(e){t[e]=i[e]}),n.Se.le().pe.forEach(function(e,r){var o=n.Se.le().ye[r];!t[e]&&o&&(t[e]=o)});break;case"delete":t=o?r.t(o):{},i.forEach(function(e){t[e]=null})}if(n.Se.ae?n.Se.le().ue[e][n.Se.le()._e[e]]=n.Pe(t):n.Se.le().ue[e].unshift(t?n.Pe(t):null),n.Se.ke){var a=n.Se.le().be,c=n.Se.ke.transaction(a,"readwrite").objectStore(a);"upsert"===s?c.put(t):c.delete(e)}},e.prototype.Qe=function(e,t,n){var r,o=this,i=this;e.length>0?(i.Se.oe>0&&i.Se.ae!==!0&&(i.Se.re=i.Se.re.filter(function(e,t){if(t<i.Se.oe){for(r=e.je.length;r--;)i.Se.te[e.Ee]._e[e.je[r]]=0,i.Se.te[e.Ee].ue[e.je[r]].shift();return!1}return!0}),i.Se.oe=0),i.Se.ae||i.Se.re.unshift({Ee:i.Se.w,je:e,Oe:t}),i.Se.xe([],""),n([{msg:e.length+" row(s) "+t}],t,e.map(function(e){return o.Se.ce(o.Se.w,e)||{}}))):n([{msg:"0 rows "+t}],t,[])},e.prototype.De=function(e,t){var n,o="",i=[],s=this.Re.args||{},a=this.Se.le(),c=a.he;if(this.Ie("where"))for(o="modified",i=e,n=e.length;n--;)this.He(e[n]);else{o="inserted",s[c]?"int"===a.de&&(a.ge=Math.max(s[c]+1,a.ge)):"int"===a.de?s[c]=a.ge++:"uint"===a.de&&(s[c]=r.NanoSQLInstance.uuid());var u=s[c]?String(s[c]):String(a.ve.length);i=[u],a.ue[u]||(a.ue[u]=[null],a._e[u]=0,a.ve.push(u)),this.He(u)}this.Qe(i,o,t)},e.prototype.Fe=function(){return this.Be?this.Be:this.Se.w},e.prototype.Le=function(e,t){var n=this;if(n.Se.se[n.Se.w][n.qe])return void t(n.Se.se[n.Se.w][n.qe],"none",[]);var o,i,a=["join","groupby","having","orderby","offset","limit"],c={},u=function(e,t,n){return Object.keys(n).reduce(function(r,o){return r?r:e[o]==t[o]?0:(e[o]>t[o]?1:-1)*("desc"===n[o]?-1:1)},0)},_=function(e,t,i){if(o=n.Ie(a[t]),1===t&&(e=e.map(function(e){return n.Se.ce(n.Fe(),e)}).filter(function(e){return e})),2===t){var _=[];if(l.length){var f=Object.keys(s).map(function(e){return e+"("}),h=[],d=!1;_=l.filter(function(e){return(f.reduce(function(t,n){return(e.indexOf(n)<0?0:1)+t},0)||0)>0||(h.push(e),!1)}).map(function(e){var t=e.match(/(.*)\((.*)\)/),n=t[1].trim(),r=(e.match(/\sAS\s(.*)/)||[]).pop()||n,o=t[2].split(",").map(function(e){return e.trim()});return"simple"===s[n].type&&r===n&&(r=o[0]),h.push(r),{call:n,args:o,as:r.trim(),type:s[n].type}});var p=[];if(_.length){var y=function(e){return _.sort(function(e,t){return e.type>t.type?1:-1}).reduce(function(t,n){var o=[];return o="aggregate"===n.type?s[n.call].call.apply(null,[e.slice(),n.args,n.as]):s[n.call].call.apply(null,[t,n.args,n.as]),t.length&&"aggregate"===n.type?(t=t.filter(function(e,t){return t<1}),t[0]=r.t(t[0]),t[0][n.as]=o[0][n.as],t):o},e.slice())},b=Object.keys(c);p=b.length?b.map(function(e){return y(c[e])}).reduce(function(e,t){return e=e.concat(t)},[]):y(e)}else p=e;var g=h.map(function(e){return e.match(/(.*)\sAS\s(.*)/)||e}).filter(function(e){return e})||[];g.length&&(p=p.map(function(e){d||(e=r.t(e));var t={};return g.forEach(function(n){"string"==typeof n?t[n]=e[n]:t[n[2]]=e[n[1]]}),t})),e=p}}if(!o)return i(e);switch(t){case 0:var v=void 0;"cross"!==o.args.type&&(v={Ve:o.args.where[0].split(".").pop(),Je:o.args.where[1],Ue:o.args.where[2].split(".").pop()});var m=n.Se.w,w=r.NanoSQLInstance.Q(o.args.table),k=n.Ke(o.args.type,m,n.Se.te[m].ve.slice(),w,n.Se.te[w].ve.slice(),v),T=n.Ie("where");T&&(k=n.Ne(n.Fe(),k,T.args)),i(k);break;case 1:var x=o.args,E={};x?(c=e.reduce(function(e,t){var n=Object.keys(x).reduce(function(e,n){return e+"."+String(t[n])},"").slice(1);return(e[n]=e[n]||[]).push(t),E[n]=Object.keys(x).reduce(function(e,n){return e[n]=t[n],e},{}),e},{}),i(Object.keys(c).sort(function(e,t){return u(E[e],E[t],x)}).reduce(function(e,t){return e.concat(c[t])},[]))):i(e);break;case 2:n.Se.te[n.qe]={ye:[],_e:{},ge:0,ve:[],pe:[],be:n.qe.toString(),he:"",de:"",ue:{}},n.Be=n.qe,e.forEach(function(e,t){n.Se.te[n.qe]._e[t]=0,n.Se.te[n.qe].ue[t]=[e],n.Se.te[n.qe].ve.push(t.toString())}),i(n.Ne(n.qe,n.Se.te[n.qe].ve,n.Ie("having").args).map(function(e){return n.Se.ce(n.qe,e)}).filter(function(e){return e}));break;case 3:i(e.sort(function(e,t){return u(e,t,o.args)}));break;case 4:i(e.filter(function(e,t){return!o||t>=o.args}));break;case 5:i(e.filter(function(e,t){return!o||t<o.args}))}};i=-1;var l=n.Re.args||[],f=function(e){i<a.length?(i++,_(e,i,function(e){f(e)})):(n.Ie("join")||(n.Se.se[n.Se.w][n.qe]=e),t(e,"none",[]))};f(e)},e.prototype.Me=function(e,t){var n,r="deleted",o=this,i=o.Re.args||[];for(n=e.length;n--;)o.He(e[n]);i.length&&(r="modified"),o.Qe(e,r,t)},e.prototype.Ne=function(e,t,n){var r,o=this,i=["AND","OR"],s=function(e,t){return e[0].concat(e[1]).sort().filter(function(e,n,r){var o=r.lastIndexOf(e);return"OR"===t||n!==o})},a=function(t,n){var r;return t.filter(function(t){return!!(r=o.Se.ce(e,t))&&0===o.ze(n[2],n[1],r[n[0]])})};return"string"==typeof n[0]?a(t,n):n.map(function(e){return i.indexOf(e)>=0?e:a(t.slice(),e)}).reduce(function(e,t,n){return i.indexOf(t)<0?0===n?t:s([e,t],r):(r=t,e)})},e.prototype.Ke=function(e,t,n,o,i,s){var a=JSON.stringify(s),c="left",u="right",_="outer",l=[],f=0,h={},d=this,p=[u,_].indexOf(e)>=0?i.slice():[];[t,o].forEach(function(e){var t=[];d.Se.u[e].forEach(function(n){t.push(n.key),l.push({key:d.Se.te[e].be+"."+n.key,type:n.type,default:n.default||null})}),h[e]={pe:t,be:d.Se.te[e].be}}),d.Se.fe(a,l),d.Be=r.NanoSQLInstance.Q(a);var y=function(e,n){var r=String(f++),i={},s=[e,n];[t,o].forEach(function(e,t){var n=s[t];h[e].pe.forEach(function(t){i[h[e].be+"."+t]=n?n[t]:null})}),d.Se.te[d.Be].ve.push(r),d.Se.te[d.Be]._e[r]=0,d.Se.te[d.Be].ue[r]=[i]},b=function(e,t){t.forEach(function(t){if(p.length){var n=p.indexOf(t);n>0&&p.splice(n,1)}y(e,d.Se.ce(o,t))})};return n.forEach(function(n,r){var a=d.Se.ce(t,n)||{},u=s?d.Ne(o,i.slice(),[s.Ue,s.Je,a[s.Ve]]):i.slice();u.length?b(a,u):[c,_].indexOf(e)>=0&&y(a,null)}),p.length&&b(null,p.slice()),d.Se.te[d.Be].ve.slice()},e.prototype.ze=function(e,t,n){switch(t){case"=":return n===e?0:1;case">":return n>e?0:1;case"<":return n<e?0:1;case"<=":return n<=e?0:1;case">=":return n>=e?0:1;case"IN":return e.indexOf(n)<0?1:0;case"NOT IN":return e.indexOf(n)<0?0:1;case"REGEX":case"LIKE":return n.search(e)<0?1:0;case"BETWEEN":return e[0]<n&&e[1]>n?0:1;default:return 0}},e}()},function(e,t,n){e.exports=n(0)}])});
!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var n in r)("object"==typeof exports?exports:e)[n]=r[n]}}(this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){e.exports=r(1)},function(e,t,r){"use strict";function n(e){return a.table(e)}var o=r(2),i=r(3),c=function(){function e(){var e=this;e.e={},e.t={},e.r={},e.n=[],e.o=[],e.i=["change","delete","upsert","drop","select","error"],e.a={},e.a["*"]={},e.i.forEach(function(t){e.a["*"][t]=[]}),e.s={},e.u=[]}return e.prototype.table=function(e){return e&&(this.f=e),this},e.prototype.connect=function(e){var t=this;return t.l=e||new i.SomeSQLMemDB,new o.TSPromise(function(e,r){t.l.connect(t.r,t.e,t.t,t.s,t.o,function(r){e(r,t)},function(e){r&&r(e,t)})})},e.prototype.on=function(e,t){var r=this,n=r.f;return r.a[n]||r.i.forEach(function(e){r.a[n][e]=[]}),e.split(" ").forEach(function(e){r.i.indexOf(e)!==-1&&r.a[n][e].push(t)}),r},e.prototype.off=function(e){for(var t in this.a)for(var r in this.a[t])this.a[t][r].filter(function(t){return t!==e});return this},e.prototype.alwaysApplyFilter=function(e){return this.u.indexOf(e)===-1&&this.u.push(e),this},e.prototype.model=function(e){var t=this,r=t.f;return t.a[r]={},t.a[r]["*"]=[],t.i.forEach(function(e){t.a[r][e]=[]}),t.r[r]=e,t.t[r]=[],t.e[r]=[],t},e.prototype.views=function(e){return this.t[this.f]=e,this},e.prototype.getView=function(e,t){void 0===t&&(t={});var r,n=this,o=n.f;if(n.t[o].forEach(function(t){t.name===e&&(r=t)}),!r)throw Error("View does not exist");return n._=e,r.call.apply(n,[n.h(r.args?r.args:[],t),n])},e.prototype.h=function(e,t){var r=this,n=(r.f,{});return e&&e.forEach(function(e){var o=e.split(":");o.length>1?n[o[0]]=r.d(o[1],t[o[0]]||null):n[o[0]]=t[o[0]]||null}),n},e.prototype.d=function(e,t){switch(["string","int","float","array","map","bool"].indexOf(e)){case 0:return String(t);case 1:return parseInt(t);case 2:return parseFloat(t);case 3:case 4:return JSON.parse(JSON.stringify(t));case 5:return t===!0;default:return""}},e.prototype.actions=function(e){return this.e[this.f]=e,this},e.prototype.doAction=function(e,t){void 0===t&&(t={});var r,n=this,o=n.f;if(n.e[o].forEach(function(t){t.name===e&&(r=t)}),!r)throw Error("Action does not exist");return n._=e,r.call.apply(n,[n.h(r.args?r.args:[],t),n])},e.prototype.addFilter=function(e,t){return this.s[e]=t,this},e.prototype.query=function(e,t){this.n=[];var r=e.toLowerCase();return["select","upsert","delete","drop"].indexOf(r)!==-1?this.n.push({type:r,args:t}):console.error("Invalid query '"+e+"'!"),this},e.prototype.where=function(e){return this.y("where",e)},e.prototype.orderBy=function(e){return this.y("orderby",e)},e.prototype.limit=function(e){return this.y("limit",e)},e.prototype.offset=function(e){return this.y("offset",e)},e.prototype.filter=function(e,t){return this.y("filter-"+e,t)},e.prototype.y=function(e,t){return this.n.push({type:e,args:t}),this},e.prototype.exec=function(){var e=this,t=e.f;e.v=e.n.map(function(e){switch(e.type){case"select":return[e.type];case"delete":case"upsert":case"drop":return[e.type,"change"];default:return[]}}).reduce(function(e,t){return e.concat(t)});var r=function(r){e.v.forEach(function(n){e.a[t][n].concat(e.a[t]["*"]).forEach(function(t){r.name=n,r.actionOrView=e._||"",t.apply(e,[r,e])})}),e._=void 0};return new o.TSPromise(function(n,o){var i=function(n,o,i){e.u.length&&i!==!0&&(n=e.u.reduce(function(t,r,o){return e.s[e.u[o]].apply(e,[n])},n)),r({name:"error",actionOrView:"",table:t,query:e.n,time:(new Date).getTime(),result:n}),o(n,e)};e.l.exec(t,e.n,e._||"",function(e){i(e,n,!1)},function(t){e.v=["error"],o&&i(t,o,!0)})})},e.prototype.extend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this;return r.l?r.l.extend?r.l.extend.apply(r,e):void 0:(r.o.push(e),this)},e.prototype.loadJS=function(e){var t=this;return o.TSPromise.all(e.map(function(e){return t.table(t.f).query("upsert",e).exec()}))},e.prototype.loadCSV=function(e){var t=this,r=[];return new o.TSPromise(function(n,i){o.TSPromise.all(e.split("\n").map(function(e,n){return new o.TSPromise(function(o,i){if(0===n)r=e.split(","),o();else{var c={},a=e.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)||[];a=a.map(function(e){return e.replace(/^"(.+(?="$))"$/,"$1")}),r.forEach(function(e,t){0!==a[t].indexOf("{")&&0!==a[t].indexOf("[")||(a[t]=JSON.parse(a[t].replace(/'/g,""))),c[e]=a[t]}),t.table(t.f).query("upsert",c).exec().then(function(){o()})}})})).then(function(){n([],t)})})},e.prototype.toCSV=function(e){var t=this;return new o.TSPromise(function(r,n){t.exec().then(function(n){var o=t.n.filter(function(e){return"select"===e.type}).map(function(e){return e.args?e.args.map(function(e){return t.r[t.f].filter(function(t){return t.key===e})[0]}):t.r[t.f]})[0];e&&n.unshift(o.map(function(e){return e.key})),r(n.map(function(t,r){return e&&0===r?t:o.filter(function(e){return!!t[e.key]}).map(function(e){switch(e.type){case"map":return'"'+JSON.stringify(t[e.key]).replace(/"/g,"'")+'"';case"array":return'"'+JSON.stringify(t[e.key]).replace(/"/g,"'")+'"';default:return JSON.stringify(t[e.key])}}).join(",")}).join("\n"),t)})})},e.uuid=function(e){return e?e:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,r="x"===e?t:3&t|8;return r.toString(16)})}()},e.hash=function(e){for(var t=5381,r=0;r<e.length;r++){var n=e.charCodeAt(r);t=(t<<5)+t+n}return String(t)},e}();t.SomeSQLInstance=c;var a=new c;t.SomeSQL=n},function(e,t){"use strict";var r="function",n=function(){function e(e){var t=this;e&&e(function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];t.resolve.apply(t,e)},function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];t.reject.apply(t,e)})}return e.prototype.resolve=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.x(1,e)},e.prototype.reject=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.x(-1,e)},e.prototype.x=function(t,n){var o=this;if(!o.g&&n[0]!==o){if(1===t&&n[0]&&(typeof n[0]===r||"object"==typeof n[0])&&typeof n[0].then===r)return void n[0].then.call(n[0],function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];o.resolve.apply(o,e)},function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];o.reject.apply(o,e)});o.g=t,o.b=n,o.w&&o.w.forEach(function(r){1===t&&e.T(r,o.b),t===-1&&e.k(r,o.b)})}},e.prototype.then=function(t,r){var n=new e,o=this,i={promise:n,successFunc:t,failFunc:r};return o.g?1===o.g?e.T(i,o.b):e.k(i,o.b):o.w?o.w.push(i):o.w=[i],n},e.prototype.catch=function(e){return this.then(function(){},e)},e.all=function(t){var r=[];return new e(function(e,n){t&&t.length?t.forEach(function(n){n.then(function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];r.push(n),r.length===t.length&&e(r)})}):e([])})},e.chain=function(t){var r=0,n=[];return new e(function(e){var o=function(i){r===t.length?e(n):i.then(function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];n.push(e),r++,o(t[r])})};o(t[r])})},e.race=function(t){return new e(function(e,r){t&&t.length?t.forEach(function(t){t.then(function(){for(var r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];e.apply(t,r)})}):e()})},e.T=function(t,r){e.x(1,t.successFunc,t,r)},e.k=function(t,r){t.failFunc&&e.x(-1,t.failFunc,t,r)},e.x=function(e,t,n,o){if(typeof t===r)try{n.promise.resolve(t.apply(n.promise,o))}catch(e){n.promise.reject(e)}else 1===e&&n.promise.resolve.apply(n.promise,o),e===-1&&n.promise.reject.apply(n.promise,o)},e}();t.TSPromise=n},function(e,t,r){"use strict";var n=r(1),o=r(2),i=function(){function e(){var e=this;e.s={},e.S={},e.O={},e.F={},e.K={},e.j=[],e.C()}return e.prototype.connect=function(e,t,r,n,o,i){var c=this;for(var a in e)c.q(a,e[a]);c.s=n,i()},e.prototype.q=function(e,t){this.F[e]={},this.O[e]={},this.S[e]=new c(t)},e.prototype.exec=function(e,t,r,i,c){var a=this;return void 0!==a.I?void a.j.push([e,t,r,i,c]):(a.f=e,a.N=[],a.I=void 0,a.A=n.SomeSQLInstance.hash(JSON.stringify(t)),a.K[a.A]=t,void o.TSPromise.all(t.map(function(e){return new o.TSPromise(function(t,r){a.n(e,t)})})).then(function(){a.J(function(e){i(e),a.I=void 0,a.j.length&&a.exec.apply(a,a.j.pop())})}))},e.prototype.n=function(e,t){["upsert","select","delete","drop"].indexOf(e.type)!==-1?this.I=e:this.N.push(e),t()},e.prototype.C=function(){var e=this,t=e.s;t.sum=function(t){return[{sum:t.map(function(t){return e.I?t[e.I.args[0]]:0}).reduce(function(e,t){return e+t},0)}]},t.first=function(e){return[e[0]]},t.last=function(e){return[e.pop()]},t.min=function(t){return[{min:t.map(function(t){return e.I?t[e.I.args[0]]:0}).sort(function(e,t){return e<t?-1:1})[0]}]},t.max=function(t){return[{max:t.map(function(t){return e.I?t[e.I.args[0]]:0}).sort(function(e,t){return e>t?-1:1})[0]}]},t.average=function(t){return[{average:e.Q("sum",t)[0].sum/t.length}]},t.count=function(e){return[{length:e.length}]}},e.prototype.Q=function(e,t,r){return this.s[e].apply(this,[t,r])},e.prototype.V=function(e){var t=this,r=t.N.filter(function(e){return 0===e.type.indexOf("filter-")});return r.length?r.reduce(function(e,n,o){return t.Q(r[o].type.replace("filter-",""),e,r[o].args)},e):e},e.prototype.P=function(e){var t=this;t.F[t.f]={},t.O[t.f]={}},e.prototype.J=function(e){var t=this,r=t.N.filter(function(e){return"where"===e.type}),n=r.length?r[0].args:void 0;if(!t.I)throw Error("No action specified!");var o,i=t.I.args,c=t.S[t.f],a=0;switch(t.I.type){case"upsert":if(n){o=t.L(c,n);var s=[];o.M.forEach(function(e){for(var t in i)c.W[e][t]=i[t];s.push(e),a++}),t.P(s)}else c.D(i),a++,t.F[t.f]={},t.O[t.f]={};e([{result:a+" row(s) upserted"}]);break;case"select":if(t.F[t.f][t.A])return void e(t.F[t.f][t.A]);o=n?t.L(c,n):c.R();var u=["ordr","ofs","lmt","clms"],f=function(e){return t.N.filter(function(t){return t.type===e}).pop()},l=u.reduce(function(e,t,r){switch(u[r]){case"ordr":var n=f("orderby");if(n){var o=n.args;return e.sort(function(e,t){for(var r=[],n=0,i=o;n<i.length;n++){var c=i[n];r.push(c)}return r.reduce(function(n,i,c){var a=r[c];return e[a]===t[a]?0+n:(e[a]>t[a]?1:-1)*("asc"===o[a]?1:-1)+n},0)})}case"ofs":var a=f("offset");if(a){var s=a.args;return e.filter(function(e,t){return t>=s})}case"lmt":var l=f("limit");if(l){var _=l.args;return e.filter(function(e,t){return t<_})}case"clms":if(i){var p=c.$.map(function(e){return e.key}).filter(function(e){return i.indexOf(e)===-1});return e.map(function(e){return p.forEach(function(t){return delete e[t]}),e})}default:return e}},o.B()),_=t.V(l);t.F[t.f][t.A]=_,t.O[t.f][t.A]=l.map(function(e){return e[o.G]}),e(_);break;case"delete":if(n){var p=[],h=t.L(c,n);h.M.forEach(function(e){c.X(e),p.push(e)}),t.P(p),e([{result:h.length+" row(s) deleted"}])}else t.q(t.f,t.S[t.f].$),e([{result:"Table Dropped"}]);break;case"drop":t.q(t.f,t.S[t.f].$),e([{result:"Table Dropped"}])}},e.prototype.L=function(e,t){var r=this;if(t&&t.length){if("string"==typeof t[0])return r.z(e.R(),t);var n,o=0;return t.map(function(t){return r.z(e.R(),t)}).reduce(function(e,r,i){if(0===i)return r;if(0===o)return n=t[i],o=1,e;if(1===o)switch(o=0,n){case"and":return e.H("inner",r);case"or":return e.H("outer",r);default:return e}return e})}return e.R()},e.prototype.z=function(e,t){var r=this,n=(t[0],t[1]),o=t[2];return e.M=e.M.filter(function(i){return 0===r.U(o,n,e.W[i][t[0]])}),e},e.prototype.U=function(e,t,r){switch(t){case"=":return r===e?0:1;case">":return r>e?0:1;case"<":return r<e?0:1;case"<=":return r<=e?0:1;case">=":return r>=e?0:1;case"IN":return e.indexOf(r)===-1?1:0;case"NOT IN":return e.indexOf(r)===-1?0:1;case"REGEX":case"LIKE":return r.search(e)===-1?1:0;default:return 0}},e}();t.SomeSQLMemDB=i;var c=function(){function e(e,t,r){var n=this;n.$=e,n.M=t||[],n.W={},n.Y=1,n.length=0,n.G=n.$.reduce(function(e,t){return t.props&&t.props.indexOf("pk")!==-1?(n.Z=t.type,t.key):e},""),r&&r.forEach(function(e){n.W[e[n.G]]=e})}return e.prototype.B=function(){var e=this;return e.M.map(function(t){return e.W[t]})},e.ee=function(e){return JSON.parse(JSON.stringify(e))},e.prototype.D=function(e){var t=this;if(e=JSON.parse(JSON.stringify(e)),t.$.forEach(function(t){e[t.key]=e[t.key]||t.default||void 0}),e[t.G])t.W[e[t.G]]=e;else{switch(t.Z){case"int":e[t.G]=t.Y,t.Y++;break;case"uuid":e[t.G]=n.SomeSQLInstance.uuid()}t.M.push(e[t.G]),t.W[e[t.G]]=e,t.length=t.M.length}},e.prototype.X=function(e){this.M.splice(this.M.indexOf(e),1)},e.prototype.H=function(e,t,r,n){var o=this,i=[];i=r?r:[o.G,t.G];var c=[this,t];return"inner"===e&&c.sort(function(e,t){return e.length>t.length?-1:1}),c[0].M.forEach(function(t){var r;if(c[1].M.forEach(function(e){void 0===r&&c[0].W[t][i[0]]===c[1].W[t][i[1]]&&(r=c[1].W[t])}),void 0===r)switch(e){case"inner":c[0].X(t)}else switch(e){case"outer":c[1].D(r)}}),"outer"===e&&c[0].M.sort(function(e,t){return e>t?1:-1}),c[0]},e.prototype.R=function(){var t=new e(this.$,e.ee(this.M),e.ee(this.B()));return t.Y=this.Y,t.length=this.length,t},e}()}])});
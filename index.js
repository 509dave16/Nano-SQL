!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var n=e();for(var r in n)("object"==typeof exports?exports:t)[r]=n[r]}}(this,function(){return function(t){function e(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return t[r].call(i.exports,i,i.exports,e),i.loaded=!0,i.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){t.exports=n(1)},function(t,e,n){"use strict";function r(t){return f.init(t)}var i=this&&this.t||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},o=n(2),s=n(3),c=n(4),u=function(){function t(){var t=this;t.e=new o.tsMap,t.n=new o.tsMap,t.r=new o.tsMap,t.i=[],t.o=["change","delete","upsert","drop","select","error"],t.s=new o.tsMap,t.s.set("*",new o.tsMap),t.o.forEach(function(e){t.s.get("*").set(e,[])}),t.u=new o.tsMap}return t.prototype.init=function(t){return t&&(this.a=t),this},t.prototype.connect=function(t){var e=this;return e.f=t||new c.someSQL_MemDB,new a(e,function(t,n){e.f.connect(e.r,e.e,e.n,e.u,t,n)})},t.prototype.on=function(t,e){var n=this;return t.split(" ").forEach(function(t){n.o.indexOf(t)!=-1&&n.s.get(n.a).get(t).push(e)}),this},t.prototype.model=function(t){var e=this,n=e.a;return e.s.set(n,new o.tsMap),e.s.get(n).set("*",[]),e.o.forEach(function(t){e.s.get(n).set(t,[])}),e.r.set(n,t),e.n.set(n,{}),e.e.set(n,{}),this},t.prototype.views=function(t){return this.n.set(this.a,t),this},t.prototype.getView=function(t,e){var n=this,r=n.a,i=n.n.get(r)[t];return n.l=t,i[1].apply(n,[n._(i[0],e)])},t.prototype._=function(t,e){var n=this,r=(n.a,{});return t.forEach(function(t){var i=t.split(":");i.length>1?r[i[0]]=n.h(i[1],e[i[0]]):r[i[0]]=e[i[0]]}),r},t.prototype.h=function(t,e){switch(["string","int","float","array","map"].indexOf(t)){case 0:return String(e);case 1:return parseInt(e);case 2:return parseFloat(e);case 3:case 4:return JSON.parse(JSON.stringify(e));default:return""}},t.prototype.actions=function(t){return this.e.set(this.a,t),this},t.prototype.doAction=function(t,e){var n=this,r=n.e.get(n.a)[t];return n.l=t,r[1].apply(n,[n._(r[0],e)])},t.prototype.addFilter=function(t,e){return this.u.set(t,e),this},t.prototype.query=function(t,e){this.i=[];var n=t.toLowerCase();return["select","upsert","delete","drop"].indexOf(n)!=-1&&this.i.push(new o.tsMap([["type",n],["args",e]])),this},t.prototype.where=function(t){return this.d("where",t)},t.prototype.orderBy=function(t){return this.d("orderby",t)},t.prototype.limit=function(t){return this.d("limit",t)},t.prototype.offset=function(t){return this.d("offset",t)},t.prototype.filter=function(t,e){return this.d("filter-"+t,e)},t.prototype.d=function(t,e){return this.i.push(new o.tsMap([["type",t],["args",e]])),this},t.prototype.exec=function(){var t=this,e=t.a;t.y=t.i.map(function(t){switch(t.get("type")){case"select":return[t.get("type")];case"delete":case"upsert":case"drop":return[t.get("type"),"change"];default:return[]}}).reduce(function(t,e){return t.concat(e)});var n=function(n){t.y.forEach(function(r){t.s.get(e).get(r).concat(t.s.get("*").get(r)).forEach(function(e){n.name=r,n.actionOrView=t.l,e.apply(t,[n])})}),t.l=void 0};return new a(t,function(r,i){t.f.exec(e,t.i,t.l,function(i){n({table:e,query:t.i.map(function(t){return t.toJSON()}),time:(new Date).getTime(),result:i}),r(i)},function(r){t.y=["error"],n({table:e,query:t.i.map(function(t){return t.toJSON()}),time:(new Date).getTime(),result:r}),i(r)})})},t.prototype.custom=function(t,e){var n=this;return new a(n,function(r,i){n.f.custom?n.f.custom.apply(n,[t,e,r,i]):r()})},t.prototype.loadJS=function(t){var e=this;return s.tsPromise.all(t.map(function(t){return e.init(e.a).query("upsert",t).exec()}))},t.prototype.loadCSV=function(t){var e=this,n=[];return new a(e,function(r,i){s.tsPromise.all(t.split("\n").map(function(t,r){return new a(e,function(i,o){if(0==r)n=t.split(","),i();else{var s={},c=t.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g).map(function(t){return t.replace(/^"(.+(?="$))"$/,"$1")});n.forEach(function(t,e){0!=c[e].indexOf("{")&&0!=c[e].indexOf("[")||(c[e]=JSON.parse(c[e].replace(/'/g,'"'))),s[t]=c[e]}),e.init(e.a).query("upsert",c).exec().then(function(){i()})}})})).then(function(){r()})})},t.prototype.toCSV=function(t){var e=this;return new a(e,function(n,r){e.exec().then(function(r){var i=e.i.filter(function(t){return"select"==t.get("type")}).map(function(t){return t.get("args")?t.get("args").map(function(t){return e.r.get(e.a).filter(function(e){return e.key==t})[0]}):e.r.get(e.a)})[0];t&&r.unshift(i.map(function(t){return t.key})),n(r.map(function(e,n){return t&&0==n?e:i.filter(function(t){return!!e[t.key]}).map(function(t){switch(t.type){case"map":return'"'+JSON.stringify(e[t.key]).replace(/"/g,"'")+'"';case"array":return'"'+JSON.stringify(e[t.key]).replace(/"/g,"'")+'"';default:return JSON.stringify(e[t.key])}}).join(",")}).join("\n"))})})},t.uuid=function(t){return t?t:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,n="x"==t?e:3&e|8;return n.toString(16)})}()},t.hash=function(t){for(var e=5381,n=0;n<t.length;n++){var r=t.charCodeAt(n);e=(e<<5)+e+r}return String(e)},t}();e.someSQL_Instance=u;var a=function(t){function e(e,n){var r=t.call(this,n)||this;return r.scope=e,r}return i(e,t),e.prototype.then=function(t,n){var r=this;return new e(r.scope,function(e,i){r.done(function(n){if("function"==typeof t)try{n=t.apply(r.scope,[n])}catch(t){return void i(t)}e(n)},function(t){if("function"==typeof n){try{t=n.apply(r.scope,[t])}catch(t){return void i(t)}e(t)}else i(t)})})},e}(s.tsPromise),f=new u;e.someSQL=r},function(t,e){"use strict";var n=function(){function t(t){var e=this;e.g=[],e.v=[],e.x=[],e.length=0,t&&t.forEach(function(t,n){e.set(t[0],t[1])})}return t.prototype.fromJSON=function(t){for(var e in t)t.hasOwnProperty(e)&&this.set(e,t[e])},t.prototype.toJSON=function(){var t={},e=this;return e.keys().forEach(function(n){t[String(n)]=e.get(n)}),t},t.prototype.entries=function(){return[].slice.call(this.g)},t.prototype.keys=function(){return[].slice.call(this.v)},t.prototype.values=function(){return[].slice.call(this.x)},t.prototype.has=function(t){return this.v.indexOf(t)>-1},t.prototype.get=function(t){var e=this.v.indexOf(t);return e>-1?this.x[e]:void 0},t.prototype.set=function(t,e){var n=this,r=this.v.indexOf(t);r>-1?(n.g[r][1]=e,n.x[r]=e):(n.g.push([t,e]),n.v.push(t),n.x.push(e)),n.length=n.size()},t.prototype.size=function(){return this.g.length},t.prototype.clear=function(){var t=this;t.v.length=t.x.length=t.g.length=0,t.length=t.size()},t.prototype.delete=function(t){var e=this,n=e.v.indexOf(t);return n>-1&&(e.v.splice(n,1),e.x.splice(n,1),e.g.splice(n,1),e.length=e.size(),!0)},t.prototype.forEach=function(t){var e=this;e.v.forEach(function(n){t(e.get(n),n)})},t.prototype.map=function(t){var e=this;return this.v.map(function(n){return t(e.get(n),n)})},t.prototype.filter=function(t){var e=this;return e.v.forEach(function(n){0==t(e.get(n),n)&&e.delete(n)}),this},t.prototype.clone=function(){return new t(JSON.parse(JSON.stringify(this.g)))},t}();e.tsMap=n},function(t,e){"use strict";var n=function(){function t(t){this.s=[],this.b=!1,this.w=!1,this.k=!1,t(this.O.bind(this),this.S.bind(this))}return t.resolve=function(e){return new t(function(t){t(e)})},t.reject=function(e){return new t(function(t,n){n(e)})},t.race=function(e){var n=!1;return new t(function(t,r){e.forEach(function(e){e.then(function(e){n||(t(e),n=!0)}).catch(function(t){r(t),n=!0})})})},t.chain=function(e){var n,r=0,i=[],o=function(t){r==e.length?n(i):t.then(function(t){i.push(t),r++,o(e[r])})};return new t(function(t){n=t,o(e[r])})},t.all=function(e){return new t(function(t,n){var r=e.length,i=[],o=!1;e.forEach(function(e,s){e.then(function(e){o||(r--,i[s]=e,0==r&&t(i))}).catch(function(t){n(t),o=!0})})})},t.prototype.done=function(t,e){this.k?setTimeout(this.T.bind(this,t,e),0):this.s.push({onSuccess:t,onFail:e})},t.prototype.then=function(e,n){var r=this;return new t(function(t,i){r.done(function(n){if("function"==typeof e)try{n=e(n)}catch(t){return void i(t)}t(n)},function(e){if("function"==typeof n){try{e=n(e)}catch(t){return void i(t)}t(e)}else i(e)})})},t.prototype.catch=function(t){return this.then(null,t)},t.prototype.T=function(t,e){this.b?e(this.M):t(this.M)},t.prototype.O=function(e){this.w||(this.w=!0,e instanceof t?e.done(this.N.bind(this),function(t){this.b=!0,this.N(t)}.bind(this)):this.N(e))},t.prototype.S=function(t){this.w||(this.w=!0,this.b=!0,this.N(t))},t.prototype.N=function(t){this.k=!0,this.M=t,setTimeout(this.s.forEach.bind(this.s,function(t){this.T(t.onSuccess,t.onFail)},this),0)},t}();e.tsPromise=n},function(t,e,n){"use strict";var r=n(1),i=n(3),o=n(2),s=function(){function t(t,e,n){var r=this;r.q=t,r.J=e||[],r.j=n||[],r.F=1,r.length=0,r.A=r.q.reduce(function(t,e){return e.props&&e.props.indexOf("pk")!=-1?(r.C=e.type,e.key):t},"")}return t.K=function(t){return JSON.parse(JSON.stringify(t))},t.prototype.V=function(t){return this.j[this.J.indexOf(t)]},t.prototype.W=function(t,e){this.j[this.J.indexOf(t)]=e},t.prototype.L=function(t){var e=this;if(t[e.A])e.W(t[e.A],t);else{switch(e.C){case"int":t[e.A]=e.F,e.F++;break;case"uuid":t[e.A]=r.someSQL_Instance.uuid()}e.J.push(t[e.A]),e.j.push(t),e.length=e.J.length}},t.prototype.P=function(t){var e=this;return e.J.forEach(function(n){t.apply(e,[e.V(n),n])||e.I(n)}),e.length=e.J.length,this},t.prototype.Q=function(t){var e=this;return e.J.forEach(function(n){t.apply(e,[e.V(n),n])}),e},t.prototype.z=function(t){var e=this,n=[],r=-1;return e.J.sort(function(r,i){var o=t.apply(e,[e.V(r),e.V(i)]);return n.push(o),o}),e.j.sort(function(t,e){return r++,n[r]}),e},t.prototype.D=function(t,e,n,r){var i=this,o=[];o=n?n:[i.A,e.A];[this,e].sort(function(t,e){return t.length>e.length?-1:1});switch(t){case"inner":var s=[this,e].sort(function(t,e){return t.length>e.length?-1:1});return s[0].P(function(t,e){var n=!1;return s[1].Q(function(e,r){0==n&&t[o[0]]==e[o[1]]&&(n=!0)}),n});case"outer":return e.Q(function(t,e){var n=!1;i.Q(function(e,r){0==n&&e[o[0]]==t[o[1]]&&(n=!0)}),n||i.L(t)}),i.z(function(t,e){return t[n[0]]>e[n[0]]?1:-1}),i}},t.prototype.I=function(t){var e=this,n=e.J.indexOf(t);e.J.splice(n,1),e.j.splice(n,1),e.length=e.J.length},t.prototype.$=function(){var e=new t(this.q,t.K(this.J),t.K(this.j));return e.F=this.F,e.length=this.length,e},t}(),c=function(){function t(){var t=this;t.u=new o.tsMap,t.B=new o.tsMap,t.R()}return t.prototype.connect=function(t,e,n,r,i){var o=this;t.forEach(function(t,e){o.G(e,t)}),r.forEach(function(t,e){o.u.set(e,t)}),i()},t.prototype.G=function(t,e){this.B.set(t,new s(e))},t.prototype.exec=function(t,e,n,o,s){var c=this;c.a=t,c.H=[],c.U=null,c.X=r.someSQL_Instance.hash(JSON.stringify(e)),i.tsPromise.all(e.map(function(t){return new i.tsPromise(function(e,n){c.i(t,e)})})).then(function(){c.Y(o)})},t.prototype.i=function(t,e){["upsert","select","delete","drop"].indexOf(t.get("type"))!=-1?this.U=t:this.H.push(t),e()},t.prototype.R=function(){var t=this,e=t.u;e.set("sum",function(e){return e.map(function(e){return e[t.U.get("args")[0]]}).reduce(function(t,e){return t+e},0)}),e.set("first",function(t){return t[0]}),e.set("last",function(t){return t.pop()}),e.set("min",function(e){return e.map(function(e){return e[t.U.get("args")[0]]}).sort(function(t,e){return t<e?-1:1})[0]}),e.set("max",function(e){return e.map(function(e){return e[t.U.get("args")[0]]}).sort(function(t,e){return t>e?-1:1})[0]}),e.set("average",function(e){return t.Z("sum",e)/e.length}),e.set("count",function(t){return t.length})},t.prototype.Z=function(t,e,n){return this.u.get(t).apply(this,[e,n])},t.prototype.tt=function(t){var e=this,n=e.H.filter(function(t){return 0==t.get("type").indexOf("filter-")});return n.length?n.reduce(function(t,r,i){return e.Z(n[i].get("type").replace("filter-",""),t,n[i].get("args"))},t):t},t.prototype.Y=function(t){var e,n=this,r=n.H.filter(function(t){return"where"==t.get("type")}),i=r.length?r[0].get("args"):void 0,o=n.U.get("args"),s=n.B.get(n.a),c=0;switch(n.U.get("type")){case"upsert":i?(e=n.et(s,i),e.Q(function(t,e){for(var n in o)s.V(e)[n]=o[n];c++})):(s.L(o),c++),t(c+" row(s) upserted");break;case"select":e=i?n.et(s,i):s.$();var u=["ordr","ofs","lmt","clms"],a=function(t){return n.H.filter(function(e){return e.get("type")==t}).pop()};t(n.tt(u.reduce(function(t,e,n){switch(u[n]){case"ordr":if(a("orderby")){var r=a("orderby");return t.sort(function(t,e){return r.map(function(n,r){return t[r]==e[r]?0:(t[r]>e[r]?1:-1)*("asc"==n?1:-1)})})}case"ofs":if(a("offset")){var i=a("offset").get("args");return t.filter(function(t,e){return e>=i})}case"lmt":if(a("limit")){var c=a("limit").get("args");return t.filter(function(t,e){return e<c})}case"clms":if(o){var f=s.q.map(function(t){return t.key}).filter(function(t){return o.indexOf(t)==-1});return t.map(function(t){return f.forEach(function(e){return delete t[e]}),t})}default:return t}},e.j)));break;case"delete":if(i){var f=n.et(s,i);f.Q(function(t,e){s.I(e)}),t(f.length+" row(s) deleted")}else n.G(n.a,n.B.get(n.a).q),t("Table dropped.");break;case"drop":n.G(n.a,n.B.get(n.a).q),t("Table dropped.")}},t.prototype.et=function(t,e){var n=this;if(e&&e.length){if("string"==typeof e[0])return n.nt(t.$(),e);var r=0,i=null;return e.map(function(e){return n.nt(t.$(),e)}).reduce(function(t,o,s){return 0==s?o:0==r?(i=e[s],r=1,t):1==r?(r=0,n.rt(i,t,o)):void 0})}return t.$()},t.prototype.rt=function(t,e,n){switch(t){case"and":return e.D("inner",n);case"or":return e.D("outer",n);default:return e}},t.prototype.nt=function(t,e){var n=this,r=e[0],i=e[1],o=e[2];return t.P(function(t){return 0==n.it(o,i,t[r])})},t.prototype.it=function(t,e,n){switch(e){case"=":return n==t?0:1;case">":return n>t?0:1;case"<":return n<t?0:1;case"<=":return n<=t?0:1;case">=":return n>=t?0:1;case"IN":return t.indexOf(n)==-1?1:0;case"NOT IN":return t.indexOf(n)==-1?0:1;case"LIKE":return n.search(t)==-1?1:0;default:return 0}},t}();e.someSQL_MemDB=c}])});
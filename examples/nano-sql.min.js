!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(window,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=24)}([function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(1);t.Promise="undefined"!=typeof window&&window.Promise?window.Promise:"undefined"!=typeof global&&global.Promise?global.Promise:r.Promise,t._assign=function(e){return e?JSON.parse(JSON.stringify(e)):null},t.fastCHAIN=function(e,n){return new t.Promise(function(t,i){if(e&&e.length){var o=[],s=function(){o.length<e.length?n(e[o.length],o.length,function(e){o.push(e),r.setFast(s)}):t(o)};s()}else t([])})},t.fastRACE=function(e,n){return new t.Promise(function(t,r){if(e&&e.length){var i=!1,o=0,s=function(){o<e.length&&(n(e[o],o,function(e){i||(i=!0,t([e]))}),o++,s())};s()}else t([])})},t.fastALL=function(e,n){return t.Promise.all((e||[]).map(function(e,r){return new t.Promise(function(t,i){n(e,r,function(e){t(e)})})}))};var i="undefined"==typeof window?"":navigator.userAgent||"";t.isSafari=0!==i.length&&(/^((?!chrome|android).)*safari/i.test(i)||/iPad|iPhone|iPod/.test(i)&&!window.MSStream),t.isMSBrowser=0!==i.length&&(i.indexOf("MSIE ")>0||i.indexOf("Trident/")>0||i.indexOf("Edge/")>0),t.isAndroid=/Android/.test(i),t.random16Bits=function(){if("undefined"==typeof crypto)return Math.round(Math.random()*Math.pow(2,16));if(crypto.getRandomValues){var e=new Uint16Array(1);return crypto.getRandomValues(e),e[0]}return"undefined"!=typeof global&&global._crypto.randomBytes?global._crypto.randomBytes(2).reduce(function(e,t){return t*e}):Math.round(Math.random()*Math.pow(2,16))},t.timeid=function(e){for(var n=Math.round((new Date).getTime()/(e?1:1e3)).toString();n.length<(e?13:10);)n="0"+n;return n+"-"+(t.random16Bits()+t.random16Bits()).toString(16)},t.intersect=function(e,t){return!(!e||!t)&&!(!e.length||!t.length)&&(e||[]).filter(function(e){return-1!==(t||[]).indexOf(e)}).length>0},t.uuid=function(){var e,n,r="";return[r,r,r,r,r,r,r,r].reduce(function(i,o,s){for(e=t.random16Bits(),n=3===s?4:4===s?(e%16&3|8).toString(16):r,e=e.toString(16);e.length<4;)e="0"+e;return i+([2,3,4,5].indexOf(s)>-1?"-":r)+(n+e).slice(0,4)},r)};var o={int:function(e){return e},uuid:t.uuid,timeId:function(){return t.timeid()},timeIdms:function(){return t.timeid(!0)}};t.hash=function(e){for(var t=5381,n=e.length;n;)t=33*t^e.charCodeAt(--n);return(t>>>0).toString(16)},t.generateID=function(e,t){return o[e]?o[e](t||1):""},t.cleanArgs=function(e,n){for(var r={},i=e.length;i--;){var o=e[i].split(":");o.length>1?r[o[0]]=t.cast(o[1],n[o[0]]||void 0):r[o[0]]=n[o[0]]||void 0}return r},t.isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},t.cast=function(e,n){if("any"===e||"blob"===e)return n;var r=typeof n;if("undefined"===r||null===n)return n;var i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},o=function(e,n){switch(e){case"safestr":return o("string",n).replace(/[&<>"'`=\/]/gim,function(e){return i[e]});case"int":return"number"!==r||n%1!=0?parseInt(n||0):n;case"number":case"float":return"number"!==r?parseFloat(n||0):n;case"any[]":case"array":return Array.isArray(n)?n:[];case"uuid":case"timeId":case"timeIdms":case"string":return"string"!==r?String(n):n;case"object":case"obj":case"map":return t.isObject(n)?n:{};case"boolean":case"bool":return!0===n}return n},s=o(String(e||"").toLowerCase(),n);if(-1!==e.indexOf("[]")){var a=e.slice(0,e.lastIndexOf("[]"));return(n||[]).map(function(e){return t.cast(a,e)})}return void 0!==s?["int","float","number"].indexOf(e)>-1&&isNaN(s)?0:s:void 0},t.sortedInsert=function(e,n,r,i){return e.length?(e.splice(t.binarySearch(e,n),0,n),e):(e.push(n),e)},t.binarySearch=function(e,t,n,r){var i,o=0,s=e.length-1;if(t<e[o])return 0;if(t>e[s])return s+1;if(s<=2147483647)for(;o<=s;){if(e[i=o+s>>1]===t)return i;e[i]<t?o=i+1:s=i-1}else for(;o<=s;){if(e[i=Math.floor((o+s)/2)]===t)return i;e[i]<t?o=i+1:s=i-1}return i},t.removeDuplicates=function(e){if(!e.length)return[];for(var t=[e[0]],n=1;n<e.length;n++)e[n]!==e[n-1]&&t.push(e[n]);return t},t.deepFreeze=function(e){return Object.getOwnPropertyNames(e||{}).forEach(function(n){var r=e[n];"object"==typeof r&&null!==r&&(e[n]=t.deepFreeze(r))}),Object.freeze(e)};var s={};t.objQuery=function(e,t,n){var r=function(e,t,n){return e[t]&&n?r(e,t+1,n[e[t]]):n},i=e+(n?"1":"0");if(s[i])return r(s[i],0,t);var o=[];if(o=e.indexOf("[")>-1?[].concat.apply([],e.split(".").map(function(e){return e.match(/([^\[]+)|\[([^\]]+)\]\[/gim)||e})).map(function(e){return e.replace(/\[|\]/gim,"")}):e.split("."),n){var a=o.shift()+"."+o.shift();o.unshift(a)}return s[i]=o,r(s[i],0,t)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=0,i={},o=Array.prototype.slice,s="undefined"!=typeof window&&window.setImmediate?window.setImmediate:!("undefined"==typeof global||!global.setImmediate)&&global.setImmediate,a="undefined"!=typeof window&&window.postMessage&&window.addEventListener,u="undefined"!=typeof window&&window.Promise?window.Promise:!("undefined"==typeof global||!global.Promise)&&global.Promise,c=function(e){return e[0].apply(null,o.call(e,1))};a&&window.addEventListener("message",function(e){var t,n=e.data;"string"==typeof n&&0===n.indexOf("setMsg")&&(t=i[n])&&(delete i[n],c(t))});t.setFast=s?function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];s(function(){c(e)})}:u?function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];u.resolve().then(function(){c(e)})}:a?function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=r++,o="setMsg"+n;return i[o]=e,window.postMessage(o,"*"),n}:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];setTimeout(function(){c(e)},0)};var f=function(){},l=["R"],h=["F"],_=["P"],p=function(){function e(e){this._state=_,this._queue=[],this._outcome=void 0,e!==f&&v(this,e)}return e.doPolyFill=function(){"undefined"!=typeof global&&(global.Promise||(global.Promise=this)),"undefined"!=typeof window&&(window.Promise||(window.Promise=this))},e.prototype.catch=function(e){return this.then(function(){},e)},e.prototype.then=function(t,n){if("function"!=typeof t&&this._state===h||"function"!=typeof n&&this._state===l)return this;var r=new e(f);return this._state!==_?y(r,this._state===h?t:n,this._outcome):this._queue.push(new d(r,t,n)),r},e.resolve=function(t){return t instanceof this?t:b._resolve(new e(f),t)},e.reject=function(t){return b._reject(new e(f),t)},e.all=function(t){return new e(function(e,n){var r=[];if(t.length)for(var i=function(n,i,o){void 0!==o?r.push(o):r.push(i),r.length==t.length&&e(r)},o=function(e){t[e].then(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];i(0,e,void 0)}).catch(function(e){i(0,void 0,e)})},s=0;s<t.length;s++)o(s);else e([])})},e.race=function(t){var n,r=t.length,i=!1,o=-1,s=new e(f);if(!1!==Array.isArray(t))return this.reject(new TypeError);if(!r)return this.resolve([]);for(;++o<r;)n=t[o],this.resolve(n).then(function(e){i||(i=!0,b._resolve(s,e))},function(e){i||(i=!0,b._reject(s,e))});return s},e}();t.Promise=p;var d=function(){function e(e,t,n){this._promise=e,"function"==typeof t&&(this._onFulfilled=t,this._callFulfilled=this._otherCallFulfilled),"function"==typeof n&&(this._onRejected=n,this._callRejected=this._otherCallRejected)}return e.prototype._callFulfilled=function(e){b._resolve(this._promise,e)},e.prototype._otherCallFulfilled=function(e){y(this._promise,this._onFulfilled,e)},e.prototype._callRejected=function(e){b._reject(this._promise,e)},e.prototype._otherCallRejected=function(e){y(this._promise,this._onRejected,e)},e}();function y(e,n,r){t.setFast(function(){var t;try{t=n.apply(null,r)}catch(t){return b._reject(e,t)}return t===e?b._reject(e,new TypeError):b._resolve(e,t),null})}t._QueueItem=d;var b=function(){function e(){}return e._resolve=function(t,n){var r=m(g,n),i=r._value,o=-1,s=t._queue.length;if("error"===r._status)return e._reject(t,r._value);if(i)v(t,i);else for(t._state=h,t._outcome=n;++o<s;)t._queue[o]._callFulfilled(n);return t},e._reject=function(e,t){e._state=l,e._outcome=t;for(var n=-1,r=e._queue.length;++n<r;)e._queue[n]._callRejected(t);return e},e}();function g(e){var t=e&&e.then;return!e||"object"!=typeof e&&"function"!=typeof e||"function"!=typeof t?null:function(){t.apply(e,arguments)}}function v(e,t){var n=!1;function r(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];n||(n=!0,b._reject(e,t))}function i(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];n||(n=!0,b._resolve(e,t))}var o=m(function(){t(i,r)});"error"===o._status&&r(o._value)}function m(e,t){var n={_status:null,_value:null};try{n._value=e(t),n._status="success"}catch(e){n._status="error",n._value=e}return n}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(){function e(){this._sorted=[],this._exists={},this.ai=1,this.doAI=!1}return e.prototype.set=function(e){var t=this;if(this._sorted=e||[],this._exists={},this._sorted.forEach(function(e,n){t._exists[String(e)]=!0}),this.doAI&&this._sorted.length){var n=this._sorted.length;this.ai=this._sorted[n-1]+1}},e.prototype.getLocation=function(e,t){var n=this.indexOf(e);return-1!==n?n:r.binarySearch(this._sorted,e,t)},e.prototype.add=function(e){if(!this._exists[e])if(this._exists[String(e)]=!0,this.doAI)parseInt(e)>=this.ai&&this.ai++,this._sorted.push(e);else{var t=r.binarySearch(this._sorted,e);this._sorted.splice(t,0,e)}},e.prototype.keys=function(){return this._sorted},e.prototype.indexOf=function(e){return this._exists[String(e)]?r.binarySearch(this._sorted,e):-1},e.prototype.remove=function(e){if(this._exists[String(e)]){this._exists[String(e)]=!1;var t=r.binarySearch(this._sorted,e);this._sorted.splice(t,1)}},e}();t.DatabaseIndex=i},function(e,t,n){var r=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=n(0),s=n(2),a=function(){function e(e){this._pkKey={},this._pkType={},this._dbIndex={},this._size=1e3*(e||0)*1e3}return e.prototype.setID=function(e){this._id=e},e.prototype.connect=function(e){var t=this;this._db=window.openDatabase(this._id,"1.0",this._id,this._size||o.isAndroid?5e6:1),o.fastALL(Object.keys(this._pkKey),function(e,n,r){t._sql(!0,"CREATE TABLE IF NOT EXISTS "+e+" (id BLOB PRIMARY KEY UNIQUE, data TEXT)",[],function(){t._sql(!1,"SELECT id FROM "+e,[],function(n){for(var i=[],o=0;o<n.rows.length;o++)i.push(n.rows.item(o).id);i=i.sort(),t._dbIndex[e].set(i),r()})})}).then(e)},e.prototype._chkTable=function(e){if(-1===Object.keys(this._pkType).indexOf(e))throw Error("No table "+e+" found!");return e},e.prototype.makeTable=function(e,t){var n=this;this._dbIndex[e]=new s.DatabaseIndex,t.forEach(function(t){t.props&&t.props.indexOf("pk")>-1&&(n._pkType[e]=t.type,n._pkKey[e]=t.key),t.props&&t.props.indexOf("ai")>-1&&t.props.indexOf("pk")>-1&&"int"===t.type&&(n._dbIndex[e].doAI=!0)})},e.prototype._sql=function(e,t,n,r){var i=function(e){e.executeSql(t,n,function(e,t){r(t)},function(e,r){return console.error(t,n,r),!1})};e?this._db.transaction(i):this._db.readTransaction(i)},e.prototype.write=function(e,t,n,i){if(!(t=t||o.generateID(this._pkType[e],this._dbIndex[e].ai)))throw new Error("nSQL: Can't add a row without a primary key!");var s,a,u=!1;if(-1===this._dbIndex[e].indexOf(t)&&(u=!0,this._dbIndex[e].add(t)),u){var c=r({},n,((s={})[this._pkKey[e]]=t,s));this._sql(!0,"INSERT into "+this._chkTable(e)+" (id, data) VALUES (?, ?)",[t,JSON.stringify(c)],function(e){i(c)})}else{var f=r({},n,((a={})[this._pkKey[e]]=t,a));this._sql(!0,"UPDATE "+this._chkTable(e)+" SET data = ? WHERE id = ?",[JSON.stringify(f),t],function(){i(f)})}},e.prototype.delete=function(e,t,n){-1!==this._dbIndex[e].indexOf(t)&&this._dbIndex[e].remove(t),this._sql(!0,"DELETE FROM "+this._chkTable(e)+" WHERE id = ?",[t],function(){n()})},e.prototype.read=function(e,t,n){this._sql(!1,"SELECT data FROM "+this._chkTable(e)+" WHERE id = ?",[t],function(e){e.rows.length?n(JSON.parse(e.rows.item(0).data)):n(void 0)})},e.prototype.batchRead=function(e,t,n){this._sql(!1,"SELECT data from "+this._chkTable(e)+" WHERE id IN ("+t.map(function(e){return"?"}).join(", ")+") ORDER BY id",t,function(e){for(var t=e.rows.length,r=[];t--;)r.unshift(JSON.parse(e.rows.item(t).data));n(r)})},e.prototype.rangeRead=function(e,t,n,r,o,s){var a=this,u=this._dbIndex[e].keys(),c=-1===[typeof r,typeof o].indexOf("undefined"),f=c?[r,o]:[];if(u.length){s&&c&&(f=f.map(function(t){return a._dbIndex[e].getLocation(t)}));var l=f[0]||0,h=[],_=f[0],p="SELECT data from "+this._chkTable(e);if(f.length){for(u[_];_<=f[1];)h.push(u[_]),_++;p+=" WHERE id IN ("+h.map(function(e){return"?"}).join(", ")+")"}p+=" ORDER BY id",this._sql(!1,p,h,function(e){var r=0,o=function(){e.rows.length>r?t(JSON.parse(e.rows.item(r).data),l,function(){l++,++r%500==0?i.setFast(o):o()}):n()};o()})}else n()},e.prototype.drop=function(e,t){var n=new s.DatabaseIndex;n.doAI=this._dbIndex[e].doAI,this._dbIndex[e]=n,this._sql(!0,"DELETE FROM "+this._chkTable(e),[],function(e){t()})},e.prototype.getIndex=function(e,t,n){n(t?this._dbIndex[e].keys().length:this._dbIndex[e].keys())},e.prototype.destroy=function(e){var t=this;o.fastALL(Object.keys(this._dbIndex),function(e,n,r){t.drop(e,r)}).then(e)},e}();t._WebSQLStore=a},function(e,t,n){var r=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=n(0),s=n(2),a=function(){function e(){this._pkKey={},this._pkType={},this._dbIndex={}}return e.prototype.connect=function(e){var t=this,n=indexedDB.open(this._id,1),r=!1,i={};n.onupgradeneeded=function(e){r=!0,t._db=e.target.result,Object.keys(t._dbIndex).forEach(function(e){t._db.createObjectStore(e,{keyPath:t._pkKey[e]}),i[e]=[]})},n.onsuccess=function(n){t._db=n.target.result,r?e():o.fastALL(Object.keys(t._dbIndex),function(e,n,r){var i,o,s;i=e,o=function(n){t._dbIndex[e].set(n),r()},s=[],t.store(i,"readonly",function(e,t){t.openCursor().onsuccess=function(e){var t=e.target.result;t&&(s.push(t.key),t.continue())},e.oncomplete=function(){o(s)}})}).then(function(){e()})}},e.prototype.store=function(e,t,n){var r=this._db.transaction(e,t);n(r,r.objectStore(e))},e.prototype.setID=function(e){this._id=e},e.prototype.makeTable=function(e,t){var n=this;this._dbIndex[e]=new s.DatabaseIndex,t.forEach(function(t){t.props&&o.intersect(["pk","pk()"],t.props)&&(n._pkType[e]=t.type,n._pkKey[e]=t.key,t.props&&o.intersect(["ai","ai()"],t.props)&&("int"===t.type||"number"===t.type)&&(n._dbIndex[e].doAI=!0))})},e.prototype.write=function(e,t,n,i){if(!(t=t||o.generateID(this._pkType[e],this._dbIndex[e].ai)))throw new Error("nSQL: Can't add a row without a primary key!");-1===this._dbIndex[e].indexOf(t)&&this._dbIndex[e].add(t);var s,a=r({},n,((s={})[this._pkKey[e]]=t,s));this.store(e,"readwrite",function(e,t){t.put(a),e.oncomplete=function(e){i(a)}})},e.prototype.delete=function(e,t,n){-1!==this._dbIndex[e].indexOf(t)&&this._dbIndex[e].remove(t),this.store(e,"readwrite",function(e,r){e.oncomplete=function(e){n()},e.onerror=function(e){n()},"_clear_"===t?r.clear():r.delete(t)})},e.prototype.read=function(e,t,n){-1!==this._dbIndex[e].indexOf(t)?this.store(e,"readonly",function(e,r){var i=r.get(t);i.onsuccess=function(){n(i.result)}}):n(null)},e.prototype.rangeRead=function(e,t,n,r,o,s){var a=this._dbIndex[e].keys(),u=-1===[typeof r,typeof o].indexOf("undefined"),c=u?[r,o]:[0,a.length-1];if(a.length){var f=s&&u?r:a[c[0]],l=s&&u?o:a[c[1]];this.store(e,"readonly",function(e,r){var o=[],s=u?r.openCursor(IDBKeyRange.bound(f,l)):r.openCursor();e.oncomplete=function(e){var r=0,s=function(){o[r]?t(o[r],r,function(){++r%500==0?i.setFast(s):s()}):n()};s()},s.onsuccess=function(e){var t=e.target.result;t&&(o.push(t.value),t.continue())}})}else n()},e.prototype.drop=function(e,t){var n=this,r=new s.DatabaseIndex;r.doAI=this._dbIndex[e].doAI,this._dbIndex[e]=r,this.delete(e,"_clear_",function(){var r=new s.DatabaseIndex;r.doAI=n._dbIndex[e].doAI,n._dbIndex[e]=r,t()})},e.prototype.getIndex=function(e,t,n){n(t?this._dbIndex[e].keys().length:this._dbIndex[e].keys())},e.prototype.destroy=function(e){var t=this;o.fastALL(Object.keys(this._dbIndex),function(e,n,r){t.drop(e,r)}).then(e)},e}();t._IndexedDBStore=a},function(e,t,n){var r=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=n(0),s=n(2),a=function(){function e(e){this._pkKey={},this._pkType={},this._rows={},this._dbIndex={},this._ls=e||!1}return e.prototype.connect=function(e){e()},e.prototype.setID=function(e){this._id=e},e.prototype.makeTable=function(e,t){var n=this;this._rows[e]={},this._dbIndex[e]=new s.DatabaseIndex,t.forEach(function(t){if(t.props&&o.intersect(["pk","pk()"],t.props)&&(n._pkType[e]=t.type,n._pkKey[e]=t.key),t.props&&o.intersect(["pk","pk()"],t.props)&&o.intersect(["ai","ai()"],t.props)&&"int"===t.type&&(n._dbIndex[e].doAI=!0),n._ls){var r=localStorage.getItem(n._id+"*"+e+"_idx");r&&n._dbIndex[e].set(JSON.parse(r))}})},e.prototype.write=function(e,t,n,i){if(!(t=t||o.generateID(this._pkType[e],this._dbIndex[e].ai)))throw new Error("nSQL: Can't add a row without a primary key!");if(-1===this._dbIndex[e].indexOf(t)&&(this._dbIndex[e].add(t),this._ls&&localStorage.setItem(this._id+"*"+e+"_idx",JSON.stringify(this._dbIndex[e].keys()))),this._ls){var s=r({},n,((a={})[this._pkKey[e]]=t,a));localStorage.setItem(this._id+"*"+e+"__"+t,JSON.stringify(s)),i(s)}else s=r({},n,((u={})[this._pkKey[e]]=t,u)),this._rows[e][t]=o.deepFreeze(s),i(s);var a,u},e.prototype.delete=function(e,t,n){-1!==this._dbIndex[e].indexOf(t)&&(this._dbIndex[e].remove(t),this._ls&&localStorage.setItem(this._id+"*"+e+"_idx",JSON.stringify(this._dbIndex[e].keys()))),this._ls?localStorage.removeItem(this._id+"*"+e+"__"+t):delete this._rows[e][t],n()},e.prototype.read=function(e,t,n){if(this._ls){var r=localStorage.getItem(this._id+"*"+e+"__"+t);n(r?JSON.parse(r):void 0)}else n(this._rows[e][t])},e.prototype.rangeRead=function(e,t,n,r,o,s){var a=this,u=this._dbIndex[e].keys().sort(function(e,t){return e>t?1:-1}),c=-1===[typeof r,typeof o].indexOf("undefined"),f=c?[r,o]:[0,u.length-1];if(u.length){s&&c&&(f=f.map(function(t){var n=a._dbIndex[e].indexOf(t);return-1!==n?n:a._dbIndex[e].getLocation(t)}));var l=f[0],h=0,_=function(){l++,++h%500==0?i.setFast(p):p()},p=function(){if(l<=f[1])if(a._ls){var r=localStorage.getItem(a._id+"*"+e+"__"+u[l]);t(r?JSON.parse(r):void 0,l,_)}else t(a._rows[e][u[l]],l,_);else n()};p()}else n()},e.prototype.drop=function(e,t){var n=this;this._ls?(localStorage.setItem(this._id+"*"+e+"_idx",JSON.stringify([])),this._dbIndex[e].keys().forEach(function(t){localStorage.removeItem(n._id+"*"+e+"__"+t)})):this._rows[e]={};var r=new s.DatabaseIndex;r.doAI=this._dbIndex[e].doAI,this._dbIndex[e]=r,t()},e.prototype.getIndex=function(e,t,n){n(t?this._dbIndex[e].keys().length:this._dbIndex[e].keys())},e.prototype.destroy=function(e){var t=this;o.fastALL(Object.keys(this._dbIndex),function(e,n,r){t.drop(e,r)}).then(e)},e}();t._SyncStore=a},function(e,t,n){var r=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=n(23),s=n(22),a=n(21),u=n(0),c=n(20),f=n(12),l=1.51,h=["_util"],_=function(){function e(){this.version=l,this._onConnectedCallBacks=[];var e=this;e.isConnected=!1,e._actions={},e._views={},e.dataModels={},e._events=["*","change","delete","upsert","drop","select","error"],e._hasEvents={},e.tableNames=[],e.plugins=[],e.hasPK={},e.skipPurge={},e.toRowFns={},e.tablePKs={},e.toColFns={},e.toColRules={},e.rowFilters={},e._randoms=[],e._randomPtr=0,e.hasAnyEvents=!1;for(var t=0;t<200;t++)e._randoms.push(u.random16Bits().toString(16));e._callbacks={},e._callbacks["*"]=new a.ReallySmallEvents,e.iB=new c.NanoSQLDefaultBackend;var n={models:{},actions:{},views:{},config:{},parent:this};e.iB.willConnect&&e.iB.willConnect(n,function(){e.iB.didConnect&&e.iB.didConnect(n,function(){})})}return e.prototype.rowFilter=function(e){return this.rowFilters[this.sTable]=e,this},e.prototype.toColumn=function(e){return this.toColFns[this.sTable]||(this.toColFns[this.sTable]={}),this.toColFns[this.sTable]=e,this},e.prototype.toRow=function(e){return this.toRowFns[this.sTable]||(this.toRowFns[this.sTable]={}),this.toRowFns[this.sTable]=e,this},e.prototype.fastRand=function(){return this._randomPtr++,this._randomPtr>=this._randoms.length&&(this._randomPtr=0),this._randoms[this._randomPtr]},e.prototype.table=function(e){return e&&(this.sTable=e),this},e.prototype.connect=function(){var e=this,t=this;return new u.Promise(function(n,r){var i={models:t.dataModels,actions:t._actions,views:t._views,config:t._config,parent:e};i.models[h[0]]=[{key:"key",type:"string",props:["pk","ai"]},{key:"value",type:"any"}],t._config&&t._config.history&&e.use(new f._NanoSQLHistoryPlugin(t._config.historyMode)),t._config&&!1===t._config.mode||e.use(new c.NanoSQLDefaultBackend),u.fastCHAIN(t.plugins,function(e,t,n){e.willConnect?e.willConnect(i,function(e){i=e,n()}):n()}).then(function(){t.dataModels=i.models,t._actions=i.actions,t._views=i.views,t._config=i.config,Object.keys(t.dataModels).forEach(function(e){var n=!1;t.dataModels[e]=t.dataModels[e].filter(function(e){return"*"!==e.key||"*"!==e.type||(n=!0,!1)}),t.skipPurge[e]=n}),t.plugins.forEach(function(e){e.didExec&&(t.pluginHasDidExec=!0)}),t.tableNames=Object.keys(t.dataModels);var e=function(){u.fastALL(t.plugins,function(e,t,n){e.didConnect?e.didConnect(i,function(){n()}):n()}).then(function(){t.isConnected=!0,t._onConnectedCallBacks.length&&t._onConnectedCallBacks.forEach(function(e){return e()}),n(t.tableNames)})},r=function(n){t.query("upsert",{key:"version",value:t.version}).manualExec({table:"_util"}).then(function(){n?t.extend("rebuild_idx").then(function(){e()}):e()})};t.query("select").where(["key","=","version"]).manualExec({table:"_util"}).then(function(t){t.length?t[0].value<=1.21?r(!0):t[0].value<l?r(!1):e():r(!0)})})})},e.prototype.getActions=function(e){return this._actions[e].map(function(e){return{name:e.name,args:e.args}})},e.prototype.getViews=function(e){return this._views[e].map(function(e){return{name:e.name,args:e.args}})},e.prototype.getConfig=function(){return this._config},e.prototype.avFilter=function(e){return this._AVMod=e,this},e.prototype.use=function(e){return this.plugins.push(e),this},e.prototype.on=function(e,t){var n=this,r=n.sTable,i=n._events.length,o=e.split(" ");if(Array.isArray(r))return this;for(n._callbacks[r]||(n._callbacks[r]=new a.ReallySmallEvents),i=o.length;i--;)-1!==n._events.indexOf(o[i])&&n._callbacks[r].on(o[i],t);return n._refreshEventChecker()},e.prototype.off=function(e,t){var n=this,r=e.split(" "),i=r.length,o=n.sTable;if(Array.isArray(o))return this;for(;i--;)-1!==n._events.indexOf(r[i])&&n._callbacks[o].off(r[i],t);return n._refreshEventChecker()},e.prototype._refreshEventChecker=function(){var e=this;return this._hasEvents={},Object.keys(this._callbacks).concat(["*"]).forEach(function(t){e._hasEvents[t]=e._events.reduce(function(n,r){return n+(e._callbacks[t]&&e._callbacks[t].eventListeners[r]?e._callbacks[t].eventListeners[r].length:0)},0)>0}),this.hasAnyEvents=!1,Object.keys(this._hasEvents).forEach(function(t){e.hasAnyEvents=e.hasAnyEvents||e._hasEvents[t]}),this},e.prototype.model=function(e,t,n){var r=this,i=this,o=i.sTable;if(Array.isArray(o))return this;i._callbacks[o]||(i._callbacks[o]=new a.ReallySmallEvents);var s=!1;if(!n){if(-1!==["string","safestr","timeId","timeIdms","uuid","int","float","number","array","map","bool","blob","any"].indexOf(o.replace(/\W/gim,""))||0===o.indexOf("_")||null!==o.match(/[\(\)\]\[\.]/g))throw Error("Invalid Table Name! https://docs.nanosql.io/setup/data-models");(e||[]).forEach(function(e){if(null!==e.key.match(/[\(\)\]\[\.]/g)||0===e.key.indexOf("_"))throw Error("Invalid Data Model! https://docs.nanosql.io/setup/data-models")})}return i.toColRules[o]={},(e||[]).forEach(function(e){e.props&&e.props.forEach(function(t){if(-1!==t.indexOf("from=>")&&-1!==t.indexOf("(")){var n=t.replace("from=>","").split("(").shift(),r=t.replace("from=>","").split("(").pop().replace(")","").split(",").map(function(e){return e.trim()});i.toColRules[o][e.key]=[n].concat(r)}0===t.indexOf("toColumn.")&&(n=t.replace(/toColumn\.(.*)\(.*\)/gim,"$1"),r=t.replace(/toColumn\..*\((.*)\)/gim,"$1").split(",").map(function(e){return e.trim()}),i.toColRules[o][e.key]=[n].concat(r))}),e.props&&u.intersect(["pk","pk()"],e.props)&&(r.tablePKs[o]=e.key,s=!0)}),this.hasPK[o]=s,s||(this.tablePKs[o]="_id_",e.unshift({key:"_id_",type:"uuid",props:["pk"]})),i.dataModels[o]=e,i._views[o]=[],i._actions[o]=[],i},e.prototype.views=function(e){return Array.isArray(this.sTable)?this:(this._views[this.sTable]=e,this)},e.prototype.getView=function(e,t){return void 0===t&&(t={}),Array.isArray(this.sTable)?new u.Promise(function(e,t){return t()}):this._doAV("View",this._views[this.sTable],e,t)},e.prototype.actions=function(e){return Array.isArray(this.sTable)?this:(this._actions[this.sTable]=e,this)},e.prototype.doAction=function(e,t){return Array.isArray(this.sTable)?new u.Promise(function(e,t){return t()}):this._doAV("Action",this._actions[this.sTable],e,t)},e.prototype.queryFilter=function(e){return this.queryMod=e,this},e.prototype._doAV=function(e,t,n,r){var i=this,o=this,s=t.reduce(function(e,t){return t.name===n?t:e},null);return s?(o._activeAV=n,o._AVMod?new u.Promise(function(t,n){o._AVMod(i.sTable,e,o._activeAV||"",r,function(e){s.call(s.args?u.cleanArgs(s.args,e):{},o).then(t).catch(n)},function(e){n(e)})}):s.call(s.args?u.cleanArgs(s.args,r):{},o)):new u.Promise(function(e,t){return t("Action/View Not Found!")})},e.prototype.query=function(e,t){var n=this._activeAV;return this._activeAV=void 0,new o._NanoSQLQuery(this,this.sTable,e,t,n)},e.prototype.onConnected=function(e){this.isConnected?e():this._onConnectedCallBacks.push(e)},e.prototype.triggerEvent=function(e){var t=this;if(t._hasEvents["*"]||t._hasEvents[e.table]){if("*"===e.table)return this;i.setFast(function(){e.types.forEach(function(n){t._callbacks["*"].trigger(n,e,t),t._callbacks["*"].trigger("*",e,t),e.table&&t._callbacks[e.table]&&t._callbacks[e.table].trigger(n,e,t)})})}return t},e.prototype.default=function(e){var t={},n=this;return Array.isArray(n.sTable)?{}:(n.dataModels[n.sTable].forEach(function(n){t[n.key]=e&&e[n.key]?e[n.key]:n.default,void 0===t[n.key]&&(t[n.key]=u.cast(n.type,null))}),t)},e.prototype.rawDump=function(e){var t=this;return new u.Promise(function(n,i){var o={};u.fastCHAIN(t.plugins,function(t,n,i){t.dumpTables?t.dumpTables(e).then(function(e){o=r({},o,e),i(o)}):i()}).then(function(){n(o)})})},e.prototype.rawImport=function(e,t){var n=this;return new u.Promise(function(r,i){u.fastCHAIN(n.plugins,function(n,r,i){n.importTables?n.importTables(e,t||function(e){}).then(i):i()}).then(function(){r()})})},e.prototype.disconnect=function(){return u.fastCHAIN(this.plugins,function(e,t,n){e.willDisconnect?e.willDisconnect(n):n()})},e.prototype.doTransaction=function(e){var t=this,n=this,i=[],o=u.random16Bits().toString(16);return new u.Promise(function(a,c){n.plugins.length?u.fastCHAIN(n.plugins,function(e,t,n){e.transactionBegin?e.transactionBegin(o,n):n()}).then(function(){Array.isArray(n.sTable)||e(function(e){var t=e||n.sTable;return{query:function(e,n){return new s._NanoSQLTransactionQuery(e,n,t,i,o)}}},function(){var e=[];u.fastCHAIN(i,function(t,i,s){e.push(t.table),n.query(t.action,t.actionArgs).manualExec(r({},t,{table:t.table,transaction:!0,queryID:o})).then(s)}).then(function(r){u.fastCHAIN(t.plugins,function(e,t,n){e.transactionEnd?e.transactionEnd(o,n):n()}).then(function(){e.filter(function(e,t,n){return n.indexOf(e)===t}).forEach(function(e){0!==e.indexOf("_")&&n.triggerEvent({query:i[0],table:e,time:(new Date).getTime(),result:r,types:["transaction"],actionOrView:"",notes:[],transactionID:o,affectedRowPKS:[],affectedRows:[]})}),a(r)})})})}):c("Nothing to do, no plugins!")})},e.prototype.config=function(e){return this._config=e,this},e.prototype.extend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=this;return new u.Promise(function(t,r){if(n.plugins.length){var i=e,o=[];u.fastCHAIN(n.plugins,function(e,t,n){e.extend?e.extend(function(e,t){i=e,o=t,n()},i,o):n()}).then(function(){t(o)})}else r("No plugins!")})},e.prototype.loadJS=function(e,t,n,r){var i=this;return n?this.doTransaction(function(n,r){t.forEach(function(t){n(e).query("upsert",t).exec()}),r()}):new u.Promise(function(n,o){u.fastCHAIN(t,function(n,o,s){r&&r(Math.round((o+1)/t.length*1e4)/100),i.query("upsert",n).manualExec({table:e}).then(s)}).then(function(e){n(e.map(function(e){return e.shift()}))})})},e.prototype.loadCSV=function(e,t,n,r,i){var o=this,s=[],a=t.split(/\r?\n|\r|\t/gm).map(function(e,t){if(0!==t){var n={},i=e.match(/(,)|(["|\[|\{].*?["|\]|\}]|[^",\s]+)(?=\s*,|\s*$)/g)||[],o=!1;","===i[0]&&i.unshift("");for(var a=function(){var e=!1;if(i.forEach(function(t,n){e||","===t&&(void 0!==i[n+1]&&","!==i[n+1]||(e=!0,i.splice(n+1,0,"")))}),e)return"break";o=!0};!o&&"break"!==a(););i=i.filter(function(e,t){return t%2==0});for(var u=s.length;u--;)i[u]&&(1===i[u].indexOf("{")||1===i[u].indexOf("[")?i[u]=JSON.parse(i[u].slice(1,i[u].length-1).replace(/'/gm,'"')):0===i[u].indexOf('"')&&(i[u]=i[u].slice(1,i[u].length-1).replace(/\"\"/gim,'"')),n[s[u]]=i[u]);return r?r(n):n}s=e.split(",")}).filter(function(e){return e});return n?this.doTransaction(function(t,n){a.forEach(function(n){t(e).query("upsert",n).exec()}),n()}):new u.Promise(function(t,n){u.fastCHAIN(a,function(t,n,r){i&&i(Math.round((n+1)/a.length*1e4)/100),o.query("upsert",t).manualExec({table:e}).then(r)}).then(function(e){t(e.map(function(e){return e.shift()}))})})},e}();t.NanoSQLInstance=_,_.functions={COUNT:{type:"A",call:function(e,t,n,r){t(r&&"*"!==r?e.filter(function(e){return u.objQuery(r,e,n)}).length:e.length)}},MAX:{type:"A",call:function(e,t,n,r){if(e.length){var i=u.objQuery(r,e[0])||0;e.forEach(function(e){u.objQuery(r,e,n),u.objQuery(r,e)>i&&(i=u.objQuery(r,e,n))}),t(i)}else t(0)}},MIN:{type:"A",call:function(e,t,n,r){if(e.length){var i=u.objQuery(r,e[0],n)||0;e.forEach(function(e){var t=u.objQuery(r,e,n);t<i&&(i=t)}),t(i)}else t(0)}},AVG:{type:"A",call:function(e,t,n,r){t(e.reduce(function(e,t){return e+(u.objQuery(r,t,n)||0)},0)/e.length)}},SUM:{type:"A",call:function(e,t,n,r){t(e.reduce(function(e,t){return e+(u.objQuery(r,t,n)||0)},0))}},LOWER:{type:"S",call:function(e,t,n,r){t(e.map(function(e){return String(u.objQuery(r,e,n)).toLowerCase()}))}},UPPER:{type:"S",call:function(e,t,n,r){t(e.map(function(e){return String(u.objQuery(r,e,n)).toUpperCase()}))}},CAST:{type:"S",call:function(e,t,n,r,i){t(e.map(function(e){return u.cast(i,u.objQuery(r,e,n))}))}},ABS:{type:"S",call:function(e,t,n,r){t(e.map(function(e){return Math.abs(u.objQuery(r,e,n))}))}},CEIL:{type:"S",call:function(e,t,n,r){t(e.map(function(e){return Math.ceil(u.objQuery(r,e,n))}))}},POW:{type:"S",call:function(e,t,n,r,i){t(e.map(function(e){return Math.pow(u.objQuery(r,e,n),parseInt(i))}))}},ROUND:{type:"S",call:function(e,t,n,r){t(e.map(function(e){return Math.round(u.objQuery(r,e,n))}))}},SQRT:{type:"S",call:function(e,t,n,r){t(e.map(function(e){return Math.sqrt(u.objQuery(r,e,n))}))}}};var p=new _;t.nSQL=function(e){return p.table(e)},"undefined"!=typeof window&&(window["nano-sql"]={nSQL:t.nSQL,NanoSQLInstance:_})},,,,,,function(e,t,n){var r=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(0),o=["_hist","_hist_ptr","_id"],s=function(){function e(e){this.historyModeArgs=e,this._tablePkKeys={},this._tablePkTypes={},this._tableKeys={}}return e.prototype.willConnect=function(e,t){var n=this;this.parent=e.parent;var s={};Object.keys(e.models).forEach(function(t){if(0!==t.indexOf("_")){var r=i._assign(e.models[t]).map(function(e){return e.props&&i.intersect(["pk","pk()"],e.props)&&(n._tablePkKeys[t]=e.key,n._tablePkTypes[t]=e.type,n._tableKeys[t]={}),delete e.props,delete e.default,e});r.unshift({key:"_id",type:"timeIdms",props:["pk"]}),s["_"+t+"__hist_rows"]=r,s["_"+t+"__hist_idx"]=[{key:"id",type:n._tablePkTypes[t],props:["pk"]},{key:"histRows",type:"timeIdms[]"},{key:"histPtr",type:"number"}]}});var a="string"!=typeof this.historyModeArgs,u=[{key:"id",type:"timeIdms",props:["pk"]},{key:"table",type:"string"},{key:"keys",type:"any[]"}],c=[{key:"id",type:"timeIdms",props:["pk"]},{key:"ptr",type:"int"}];"database"!==this.historyModeArgs&&this.historyModeArgs?("database"!==this.historyModeArgs||a)&&(this.historyModes={},a?this.historyModes=i._assign(this.historyModeArgs):Object.keys(this._tablePkKeys).forEach(function(e){n.historyModes[e]=n.historyModeArgs}),Object.keys(this.historyModes).forEach(function(e){"table"===n.historyModes[e]&&(s["_"+e+"__hist"]=u,s["_"+e+"__hist_ptr"]=c)})):(s[o[0]]=u,s[o[1]]=c),e.models=r({},e.models,s),t(e)},e.prototype._histTable=function(e){return e?this.historyModes?"table"===this.historyModes[e]?"_"+e+"__hist":null:"_hist":"__null"},e.prototype._generateHistoryPointers=function(e,t){var n=this,r=this._histTable(e);r?this.parent.query("select").manualExec({table:r+"_ptr"}).then(function(o){o.length?t():n.parent.query("upsert",{id:i.timeid(!0),table:e,ptr:0}).manualExec({table:r+"_ptr"}).then(t)}):t()},e.prototype.didConnect=function(e,t){var n=this,r=function(){i.fastALL(Object.keys(n._tableKeys),function(e,t,r){n.parent.extend("idx","_"+e+"__hist_idx").then(function(t){t.forEach(function(t){n._tableKeys[e][t]=!0}),n.historyModes?n._generateHistoryPointers(e,r):r()})}).then(t)};this.historyModes?r():this.parent.query("select").manualExec({table:"_hist_ptr"}).then(function(e){e.length?r():n.parent.query("upsert",{id:i.timeid(!0),table:"",ptr:0}).manualExec({table:"_hist_ptr"}).then(r)})},e.prototype._purgeRowHistory=function(e,t,n,r){var o=this,s="_"+e+"__hist_rows",a="_"+e+"__hist_idx";i.fastALL(t,function(t,n,u){o.parent.query("select").where(["id","=",t]).manualExec({table:a}).then(function(n){if(n.length){var c=Object.isFrozen(n[0])?i._assign(n[0]):n[0],f=[];if(r)f=f.concat(c.histRows.filter(function(e){return-1!==e})),c.histPtr=0,c.histRows=[];else{for(;c.histPtr--;)f.push(c.histRows.shift());c.histPtr=0}f.length?o.parent.query("upsert",c).comment("History Purge").where(["id","=",t]).manualExec({table:a}).then(function(){o.parent.query("delete").comment("History Purge").where(["_id","IN",f]).manualExec({table:s}).then(function(){r?o.parent.query("select").where([o._tablePkKeys[e],"=",t]).manualExec({table:e}).then(function(n){o._unshiftSingleRow(e,["change"],t,n[0],!1,u)}):u()})}):u()}else u()})}).then(n)},e.prototype._purgeTableHistory=function(e,t,n){var r=this;this.parent.query("select").manualExec({table:e+"_ptr"}).then(function(o){var s=Object.isFrozen(o[0])?i._assign(o[0]):o[0];if(n||s.ptr>0){var a=r.parent.query("select");n||a.range(-1*s.ptr,0),a.manualExec({table:e}).then(function(o){if(o.length){var a={};o.forEach(function(e){a[e.table]||(a[e.table]=[]),a[e.table]=a[e.table].concat(e.keys)}),i.fastALL(Object.keys(a),function(e,t,i){r._purgeRowHistory(e,a[e],i,n)}).then(function(){r.parent.query("delete").comment("History Purge").where(["id","IN",o.map(function(e){return e.id})]).manualExec({table:e}).then(function(){s.ptr=0,r.parent.query("upsert",s).comment("History Purge").where(["id","=",s.id]).manualExec({table:e+"_ptr"}).then(t)})})}else t()})}else t()})},e.prototype._purgeParentHistory=function(e,t,n){if(this.historyModes){var r=this._histTable(e);r?this._purgeTableHistory(r,n):this._purgeRowHistory(e,t,n)}else this._purgeTableHistory("_hist",n)},e.prototype._purgeAllHistory=function(e,t,n){if(this.historyModes){var r=this._histTable(e);r?this._purgeTableHistory(r,n,!0):this._purgeRowHistory(e,[t],n,!0)}else this._purgeTableHistory("_hist",n,!0)},e.prototype.didExec=function(e,t){var n=this;e.table&&0!==e.table.indexOf("_")&&e.types.indexOf("change")>-1&&-1===e.query.comments.indexOf("History Write")?this._purgeParentHistory(e.table,e.affectedRowPKS,function(){i.fastALL(e.affectedRows,function(t,r,i){var o=t[n._tablePkKeys[e.table]];n._tableKeys[e.table][o]?n._unshiftSingleRow(e.table,e.types,o,t,!1,function(e){i(o)}):(n._tableKeys[e.table][o]=!0,n._unshiftSingleRow(e.table,e.types,o,t,!0,function(t){n.parent.query("upsert",{id:o,histRows:[t,-1],histPtr:0}).manualExec({table:"_"+e.table+"__hist_idx"}).then(function(){i(o)})}))}).then(function(r){n._unshiftParent(e,r,t)})}):t(e)},e.prototype._unshiftParent=function(e,t,n){var r=this._histTable(e.table);r?this.parent.query("upsert",{id:i.timeid(!0),table:e.table,keys:t}).manualExec({table:r}).then(function(){n(e)}):n(e)},e.prototype._unshiftSingleRow=function(e,t,n,o,s,a){var u=this,c="_"+e+"__hist_idx",f=i.timeid(!0),l=function(e){u.parent.query("select").where(["id","=",n]).manualExec({table:c}).then(function(t){var r=Object.isFrozen(t[0])?i._assign(t[0]):t[0];r.histRows.unshift(e),u.parent.query("upsert",r).where(["id","=",n]).manualExec({table:c}).then(function(){a(e)})})};t.indexOf("delete")>-1||t.indexOf("drop")>-1?l(-1):this.parent.query("upsert",r({_id:f},o)).manualExec({table:"_"+e+"__hist_rows"}).then(function(){s?a(f):l(f)})},e.prototype.extend=function(e,t,n){if("hist"===t[0]){var r=t[1],i=t[2],o=t[3];switch(r){case"<":case">":this._shiftHistory(r,i,o,function(n){e(t,[n])});break;case"?":this._queryHistory(i,o,function(n){e(t,n)});break;case"rev":this._getRevisionHistory(i,o,function(n){e(t,n)});break;case"clear":this._purgeAllHistory(i,o,function(){e(t,n)})}}else e(t,n)},e.prototype._getRevisionHistory=function(e,t,n){var r=this,s="_"+e+"__hist_idx";this.parent.query("select").where(["id","=",t]).manualExec({table:s}).then(function(t){var s=t[0].histRows.filter(function(e){return-1!==e});r.parent.query("select").where(["_id","IN",s]).manualExec({table:"_"+e+"__hist_rows"}).then(function(e){var r={};e.forEach(function(e){r[e[o[2]]]=Object.isFrozen(e)?i._assign(e):e,delete r[e[o[2]]][o[2]]}),n([{pointer:t[0].histRows.length-t[0].histPtr-1,revisions:t[0].histRows.reverse().map(function(e){return-1===e?null:r[e]})}])})})},e.prototype._getTableHistory=function(e,t){var n=this;this.parent.extend("idx.length",e).then(function(r){n.parent.query("select").manualExec({table:e+"_ptr"}).then(function(e){e.length?t([r,r-e[0].ptr]):t([0,0])})})},e.prototype._queryHistory=function(e,t,n){if(this.historyModes){var r=this._histTable(e);if(r){if(!e)throw Error("Need a table to query this history!");this._getTableHistory(r,n)}else{if(!t)throw Error("Need a row primary key to query this history!");var i="_"+e+"__hist_idx";this.parent.query("select").where(["id","=",t]).manualExec({table:i}).then(function(e){var t=e[0];n([t.histRows.length,t.histRows.length-t.histPtr-1])})}}else this._getTableHistory("_hist",function(e){n(e)})},e.prototype._shiftTableHistory=function(e,t,n){var r=this;this.parent.query("select").manualExec({table:t+"_ptr"}).then(function(o){var s=i._assign(o[0]);s.ptr+="<"===e?1:-1,s.ptr<0&&(s.ptr=0),r.parent.extend("idx.length",t).then(function(a){s.ptr>a&&(s.ptr=a),o[0].ptr!==s.ptr?r.parent.query("select").range(-1,"<"===e?o[0].ptr:s.ptr).manualExec({table:t}).then(function(o){r.parent.query("upsert",s).manualExec({table:t+"_ptr"}).then(function(){i.fastALL(o[0].keys,function(t,n,i){r._shiftRowHistory(e,o[0].table,t,i)}).then(function(e){n(e.indexOf(!0)>-1)})})}):n(!1)})})},e.prototype._shiftRowHistory=function(e,t,n,r){var o=this,s=function(e){o.parent.query("upsert",e).where([o._tablePkKeys[t],"=",n]).manualExec({table:"_"+t+"__hist_idx"}).then(function(){r(!0)})};this.parent.query("select").where([this._tablePkKeys[t],"=",n]).manualExec({table:"_"+t+"__hist_idx"}).then(function(a){var u=i._assign(a[0]);if(u.histPtr+="<"===e?1:-1,u.histPtr<0&&(u.histPtr=0),u.histPtr>u.histRows.length-1&&(u.histPtr=u.histRows.length-1),u.histPtr!==a[0].histPtr){var c=u.histRows[u.histPtr];-1===c?o.parent.query("delete").comment("History Write").where([o._tablePkKeys[t],"=",n]).manualExec({table:t}).then(function(){s(u)}):o.parent.query("select").where(["_id","=",c]).manualExec({table:"_"+t+"__hist_rows"}).then(function(e){o.parent.query("upsert",e[0]).comment("History Write").manualExec({table:t}).then(function(){s(u)})})}else r(!1)})},e.prototype._shiftHistory=function(e,t,n,r){if(this.historyModes){var i=this._histTable(t);if(i){if(!t)throw Error("Need a table to change this history!");this._shiftTableHistory(e,i,r)}else{if(!n)throw Error("Need a row primary key to change this history!");this._shiftRowHistory(e,t,n,r)}}else this._shiftTableHistory(e,"_hist",r)},e}();t._NanoSQLHistoryPlugin=s},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(t){this._trie=e._create(t)}return e.prototype.getIndex=function(){return this._trie},e.prototype.setIndex=function(e){this._trie=e},e.prototype.addWord=function(t){return t.toLowerCase().split("").reduce(function(t,n,r,i){return e._append(t,n,r,i)},this._trie),this},e.prototype.removeWord=function(t){var n=e._checkPrefix(this._trie,t),r=n.prefixFound,i=n.prefixNode;return r&&delete i.$,this},e.prototype.getWords=function(){return e._recursePrefix(this._trie,"")},e.prototype.getPrefix=function(t){if(t=t.toLowerCase(),!this._isPrefix(t))return[];var n=e._checkPrefix(this._trie,t).prefixNode;return e._recursePrefix(n,t)},e.prototype._isPrefix=function(t){return e._checkPrefix(this._trie,t).prefixFound},e._append=function(e,t,n,r){return e[t]=e[t]||{},e=e[t],n===r.length-1&&(e.$=1),e},e._checkPrefix=function(e,t){return{prefixFound:t.toLowerCase().split("").every(function(t,n){return!!e[t]&&(e=e[t])}),prefixNode:e}},e._create=function(t){return(t||[]).reduce(function(t,n){return n.toLowerCase().split("").reduce(e._append,t),t},{})},e._recursePrefix=function(t,n,r){void 0===r&&(r=[]);var i=n;for(var o in t)"$"===o&&(r.push(i),i=""),e._recursePrefix(t[o],n+o,r);return r.sort()},e}();t.Trie=n},function(e,t,n){var r=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(13),o=n(0),s=n(5),a=n(4),u=n(3),c=function(){function e(e,t){if(this._tableNames=[],this._nsql=e,this._mode=t.persistent?"PERM":t.mode||"TEMP",this._id=t.id,this._size=t.size||5,this.adapters=[],this.models={},this.tableInfo={},this._trieIndexes={},this._tableNames=[],this._doCache=t.cache||!0,this._cache={},this.adapters[0]={adapter:null,waitForWrites:!0},"string"==typeof this._mode)switch("PERM"===this._mode&&(this._mode=this._detectStorageMethod()||this._mode),this._mode){case"IDB":case"IDB_WW":this.adapters[0].adapter=new a._IndexedDBStore;break;case"WSQL":this.adapters[0].adapter=new u._WebSQLStore(this._size);break;case"LS":this.adapters[0].adapter=new s._SyncStore(!0);break;case"TEMP":this.adapters[0].adapter=new s._SyncStore(!1)}else this.adapters[0].adapter=this._mode}return e.prototype.init=function(e,t){var n=this;this._id||(this._id=o.hash(JSON.stringify(e)).toString()),this.models=this._createIndexTables(e),this._tableNames=Object.keys(this.models),this.adapters.forEach(function(e){e.adapter.setID(n._id)}),this._tableNames.forEach(function(t){n._newTable(t,e[t])}),this._relFromTable={},this._relToTable={},this._relationColumns={},this._columnsAreTables={},this._tableNames.forEach(function(e){n.tableInfo[e]._viewTables=Object.keys(n.tableInfo).reduce(function(t,r){return r===e?t:(-1!==Object.keys(n.tableInfo[r]._views).indexOf(e)&&t.push({table:r,column:n.tableInfo[r]._views[e].pkColumn}),t)},[]);var t=n.models[e].length;n._relFromTable[e]={},n._relationColumns[e]=[],n._relToTable[e]=[],n._columnsAreTables[e]={};for(var r=function(){var r=n.models[e][t];if(-1!==n._tableNames.indexOf(r.type.replace("[]",""))){var i="";n._columnsAreTables[e][r.key]={_toTable:r.type.replace("[]",""),_thisType:-1===r.type.indexOf("[]")?"single":"array"},r.props&&(r.props.forEach(function(e){-1!==e.indexOf("ref=>")&&(i=e.replace("ref=>","")),0===e.indexOf("orm(")&&(i=e.replace(/orm\((.*)\)/gim,"$1"))}),i&&(n._hasORM=!0,n._relationColumns[e].push(r.key),n._relFromTable[e][r.key]={_toTable:r.type.replace("[]",""),_toColumn:i.replace("[]",""),_toType:-1===i.indexOf("[]")?"single":"array",_thisType:-1===r.type.indexOf("[]")?"single":"array"}))}};t--;)r()}),Object.keys(this._relFromTable).forEach(function(e){Object.keys(n._relFromTable[e]).forEach(function(t){var r=n._relFromTable[e][t];n._relToTable[r._toTable].push({_thisColumn:r._toColumn,_thisType:r._toType,_fromTable:e,_fromColumn:t,_fromType:r._thisType})})}),o.fastALL(this.adapters,function(e,t,r){e.adapter.connect(function(){e.adapter.setNSQL&&e.adapter.setNSQL(n._nsql),r()})}).then(function(){o.fastALL(Object.keys(n._trieIndexes),function(e,t,r){var i=n._trieIndexes[e];Object.keys(i).length?o.fastALL(Object.keys(i),function(t,r,i){var o="_"+e+"_idx_"+t;n.adapters[0].adapter.getIndex(o,!1,function(r){r.forEach(function(r){n._trieIndexes[e][t].addWord(String(r))}),i()})}).then(r):r()}).then(function(){t(n.models)})})},e.prototype.rebuildIndexes=function(e,t){var n=this,r=(new Date).getTime();o.fastALL(Object.keys(this.tableInfo),function(t,r,i){if("_ALL_"!==e&&e!==t||0===t.indexOf("_"))i();else{var s=n.tableInfo[t]._secondaryIndexes;o.fastALL(s,function(e,r,i){var o="_"+t+"_idx_"+e;n._drop(o,i)}).then(function(){var e=n.tableInfo[t]._pk,r={};s.forEach(function(e){r[e]={}}),n._read(t,function(t,n,i){t[e]?(s.forEach(function(n){t[n]&&(r[n][t[n]]||(r[n][t[n]]=[]),r[n][t[n]].push(t[e]))}),i(!1)):i(!1)},function(){o.fastALL(s,function(e,i,s){var a="_"+t+"_idx_"+e;o.fastALL(Object.keys(r[e]),function(t,i,o){n.adapterWrite(a,t,{id:t,rows:r[e][t].sort()},o)}).then(s)}).then(function(){i()})})})}}).then(function(){t((new Date).getTime()-r)})},e.prototype._secondaryIndexKey=function(e){return o.isObject(e)||Array.isArray(e)?JSON.stringify(e).substr(0,12):"number"==typeof e?e:String(e).substr(0,32)},e.prototype._detectStorageMethod=function(){return"undefined"==typeof window?"LVL":o.isSafari?"WSQL":"undefined"!=typeof indexedDB?"IDB":"undefined"!=typeof window&&void 0!==window.openDatabase?"WSQL":"LS"},e.prototype._secondaryIndexRead=function(e,t,n,r){var i=this;this.adapters[0].adapter.read("_"+e+"_idx_"+t,this._secondaryIndexKey(n),function(t){void 0!==t&&null!==t?i._read(e,t.rows||[],r):r([])})},e.prototype._rangeRead=function(e,t,n,r,i){var o=[];this.adapters[0].adapter.rangeRead(e,function(e,t,n){o.push(e),n()},function(){i(o)},t,n,r)},e.prototype._read=function(e,t,n){var r=this;if(Array.isArray(t)){var i=this.adapters[0].adapter.batchRead;i?i.apply(this.adapters[0].adapter,[e,t,n]):o.fastALL(t,function(t,n,i){r.adapters[0].adapter.read(e,t,i)}).then(function(e){n(e.filter(function(e){return e}))})}else{var s=[];"function"!=typeof t||this.adapters[0].adapter.rangeRead(e,function(e,n,r){t(e,n,function(t){t&&s.push(e),r()})},function(){n(s)})}},e.prototype._trieRead=function(e,t,n,r){var i=this,s=this._trieIndexes[e][t].getPrefix(n);o.fastALL(s,function(n,r,o){i._secondaryIndexRead(e,t,n,o)}).then(function(e){r([].concat.apply([],e))})},e.prototype._clearSecondaryIndexes=function(e,t,n,r,i){var s=this;o.fastALL(this.tableInfo[e]._secondaryIndexes.filter(function(e){return-1===r.indexOf(e)}),function(r,i,a){var u=s._secondaryIndexKey(n[r]),c="_"+e+"_idx_"+r;s.adapters[0].adapter.read(c,u,function(e){if(e){var n=e.rows.indexOf(t);if(-1!==n){var r=e?Object.isFrozen(e)?o._assign(e):e:{id:null,rows:[]};r.rows.splice(n,1),r.rows.sort(),r.rows=o.removeDuplicates(r.rows),s.adapterWrite(c,r.id,r,a)}else a()}else a()})}).then(i)},e.prototype._setSecondaryIndexes=function(e,t,n,r,i){var s=this;o.fastALL(this.tableInfo[e]._secondaryIndexes.filter(function(e){return-1===r.indexOf(e)}),function(r,i,a){var u=s._secondaryIndexKey(n[r]);if(u){s._trieIndexes[e][r]&&s._trieIndexes[e][r].addWord(String(n[r]));var c="_"+e+"_idx_"+r;s.adapters[0].adapter.read(c,u,function(e){var n=e?Object.isFrozen(e)?o._assign(e):e:{id:u,rows:[]};n.rows.push(t),n.rows.sort(),n.rows=o.removeDuplicates(n.rows),s.adapterWrite(c,u,n,a)})}else a()}).then(i)},e.prototype._write=function(e,t,n,i,o){var s,a=this;if(n){var u=r({},n,i,((s={})[this.tableInfo[e]._pk]=t,s)),c=Object.keys(u).filter(function(e){return u[e]===n[e]});this.tableInfo[e]._secondaryIndexes.length?this._clearSecondaryIndexes(e,t,n,c,function(){a._setSecondaryIndexes(e,t,u,c,function(){a.adapterWrite(e,t,u,o)})}):this.adapterWrite(e,t,u,o)}else this.adapterWrite(e,t,i,function(t){a.tableInfo[e]._secondaryIndexes.length?a._setSecondaryIndexes(e,t[a.tableInfo[e]._pk],i,[],function(){o(t)}):o(t)})},e.prototype._delete=function(e,t,n){var r=this;if(!t)throw new Error("nSQL: Can't delete without a primary key!");this.adapters[0].adapter.read(e,t,function(i){r._clearSecondaryIndexes(e,t,i,[],function(){r.adapterDelete(e,t,function(){n(i)})})})},e.prototype._drop=function(e,t){var n=this,r=Object.keys(this.tableInfo[e]._searchColumns).map(function(t){return"_"+e+"_search_tokens_"+t});r=(r=(r=r.concat(Object.keys(this.tableInfo[e]._searchColumns).map(function(t){return"_"+e+"_search_"+t}))).concat(Object.keys(this.tableInfo[e]._searchColumns).map(function(t){return"_"+e+"_search_fuzzy_"+t}))).concat(this.tableInfo[e]._secondaryIndexes.map(function(t){return"_"+e+"_idx_"+t})),o.fastALL(r,function(e,t,r){n.adapterDrop(e,r)}).then(function(){n._trieIndexes[e]={},n.tableInfo[e]._trieColumns.forEach(function(t){n._trieIndexes[e][t]=new i.Trie([])}),n.adapterDrop(e,t)})},e.prototype._createIndexTables=function(e){return Object.keys(e).forEach(function(t){var n=!1,r=!1,i="";if(e[t].forEach(function(s){s.props&&s.props.length&&(o.intersect(["pk","pk()"],s.props)&&(i=s.key),o.intersect(["trie","idx","idx()","trie()"],s.props)&&(n=!0,e["_"+t+"_idx_"+s.key]=[{key:"id",type:-1!==["number","float","int"].indexOf(s.type)?s.type:"string",props:["pk"]},{key:"rows",type:"any[]"}]),s.props.forEach(function(n){-1!==n.indexOf("search(")&&(r=!0,e["_"+t+"_search_"+s.key]=[{key:"wrd",type:"string",props:["pk"]},{key:"rows",type:"any[]"}],e["_"+t+"_search_fuzzy_"+s.key]=[{key:"wrd",type:"string",props:["pk"]},{key:"rows",type:"any[]"}],e["_"+t+"_search_tokens_"+s.key]=[{key:"id",type:i,props:["pk"]},{key:"hash",type:"string"},{key:"tokens",type:"any[]"}])}))}),(n||r)&&!i)throw new Error("nSQL: Tables with secondary indexes or search() must have a primary key!")}),e},e.prototype._newTable=function(e,t){var n=this;this.tableInfo[e]={_pk:"",_pkType:"",_keys:[],_defaults:[],_secondaryIndexes:[],_hasDefaults:!1,_trieColumns:[],_name:e,_views:{},_viewTables:[],_searchColumns:{}},this._cache[e]={},this._trieIndexes[e]={},this.adapters.forEach(function(n){n.adapter.makeTable(e,t)});for(var r=this.models[e].length,s=function(){var t=a.models[e][r];if(a.tableInfo[e]._keys.unshift(t.key),void 0!==t.default&&(a.tableInfo[e]._defaults[t.key]=t.default,a.tableInfo[e]._hasDefaults=!0),t.props&&t.props.length){var s=!1;t.props.forEach(function(r){if(-1!==r.indexOf("from=>")){n._hasViews=!0;var i=t.type;"from=>GHOST"!==r&&"from=>LIVE"!==r&&(i=r.replace("from=>","").split(".").shift()),n.tableInfo[e]._views[i]||(n.tableInfo[e]._views[i]={pkColumn:"",mode:"",columns:[]}),"from=>GHOST"===r||"from=>LIVE"===r?(s=!0,n.tableInfo[e]._views[i].pkColumn=t.key,n.tableInfo[e]._views[i].mode=r.replace("from=>","")):n.tableInfo[e]._views[i].columns.push({thisColumn:t.key,otherColumn:r.replace("from=>","").split(".").pop()})}0===r.indexOf("search(")&&(n.tableInfo[e]._searchColumns[t.key]=r.replace(/search\((.*)\)/gim,"$1").split(",").map(function(e){return e.trim()}))}),o.intersect(["pk","pk()"],t.props)&&(a.tableInfo[e]._pk=t.key,a.tableInfo[e]._pkType=t.type),(o.intersect(["trie","idx","idx()","trie()"],t.props)||s)&&a.tableInfo[e]._secondaryIndexes.push(t.key),o.intersect(["trie","trie()"],t.props)&&(a.tableInfo[e]._trieColumns.push(t.key),a._trieIndexes[e][t.key]=new i.Trie([]))}},a=this;r--;)s();return e},e.prototype.adapterWrite=function(e,t,n,r,i){var s;o.fastALL(this.adapters,function(r,i,o){r.waitForWrites?r.adapter.write(e,t,n,function(e){s=e,o()}):(o(),r.adapter.write(e,t,n,function(e){}))}).then(function(){r(s)}).catch(function(e){i&&i(e)})},e.prototype.adapterDelete=function(e,t,n,r){o.fastALL(this.adapters,function(n,r,i){n.waitForWrites?n.adapter.delete(e,t,function(){i()}):(i(),n.adapter.delete(e,t,function(){}))}).then(function(){n()}).catch(function(e){r&&r(e)})},e.prototype.adapterDrop=function(e,t,n){o.fastALL(this.adapters,function(t,n,r){t.waitForWrites?t.adapter.drop(e,function(){r()}):(r(),t.adapter.drop(e,function(){}))}).then(function(){t()}).catch(function(e){n&&n(e)})},e}();t._NanoSQLStorage=c},function(e,t,n){"use strict";e.exports=function(e,t,n){var o,s,a,u,c,f,l,h;if(e===t)return 0;if(o=e.length,s=t.length,0===o)return s;if(0===s)return o;for(n&&(e=e.toLowerCase(),t=t.toLowerCase()),l=0;l<o;)i[l]=e.charCodeAt(l),r[l]=++l;for(h=0;h<s;)for(a=t.charCodeAt(h),u=c=h++,l=-1;++l<o;)f=a===i[l]?c:c+1,c=r[l],r[l]=u=c>u?f>u?u+1:f:f>c?c+1:f;return u};var r=[],i=[]},function(e,t,n){"use strict";e.exports=function(e,t){var n=t.length,r=e.length;if(r>n)return!1;if(r===n)return e===t;e:for(var i=0,o=0;i<r;i++){for(var s=e.charCodeAt(i);o<n;)if(t.charCodeAt(o++)===s)continue e;return!1}return!0}},function(e,t,n){"use strict";e.exports=function(e){var t,n;return(e=String(e).toLowerCase()).length<3?e:(e.charCodeAt(0)===r&&(t=!0,e="Y"+e.substr(1)),v.test(e)?e=e.substr(0,e.length-2):g.test(e)&&(e=e.substr(0,e.length-1)),(n=b.exec(e))?s.test(n[1])&&(e=e.substr(0,e.length-1)):(n=d.exec(e))&&c.test(n[1])&&(e=n[1],y.test(e)?e+="e":m.test(e)?e=e.substr(0,e.length-1):f.test(e)&&(e+="e")),(n=_.exec(e))&&c.test(n[1])&&(e=n[1]+"i"),(n=w.exec(e))&&s.test(n[1])&&(e=n[1]+i[n[2]]),(n=x.exec(e))&&s.test(n[1])&&(e=n[1]+o[n[2]]),(n=q.exec(e))?u.test(n[1])&&(e=n[1]):(n=p.exec(e))&&u.test(n[1])&&(e=n[1]),(n=h.exec(e))&&(u.test(n[1])||a.test(n[1])&&!f.test(n[1]))&&(e=n[1]),l.test(e)&&u.test(e)&&(e=e.substr(0,e.length-1)),t&&(e="y"+e.substr(1)),e)};var r="y".charCodeAt(0),i={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},o={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},s=new RegExp("^([^aeiou][^aeiouy]*)?([aeiouy][aeiou]*)([^aeiou][^aeiouy]*)"),a=new RegExp("^([^aeiou][^aeiouy]*)?([aeiouy][aeiou]*)([^aeiou][^aeiouy]*)([aeiouy][aeiou]*)?$"),u=new RegExp("^([^aeiou][^aeiouy]*)?(([aeiouy][aeiou]*)([^aeiou][^aeiouy]*)){2,}"),c=new RegExp("^([^aeiou][^aeiouy]*)?[aeiouy]"),f=new RegExp("^([^aeiou][^aeiouy]*)[aeiouy][^aeiouwxy]$"),l=/ll$/,h=/^(.+?)e$/,_=/^(.+?)y$/,p=/^(.+?(s|t))(ion)$/,d=/^(.+?)(ed|ing)$/,y=/(at|bl|iz)$/,b=/^(.+?)eed$/,g=/^.+?[^s]s$/,v=/^.+?(ss|i)es$/,m=/([^aeiouylsz])\1$/,w=new RegExp("^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$"),x=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,q=new RegExp("^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$")},function(e,t,n){"use strict";e.exports=function(e){var t,n,f,l,h="",_=0;function p(e){h+=e}function d(t){return e.charAt(_+t).toUpperCase()}function y(e){return function(){return d(e)}}if(!(e=String(e||"")))return"";for(n=y(1),f=y(0),l=y(-1);!c(f());){if(!f())return"";_++}switch(f()){case"A":"E"===n()?(p("E"),_+=2):(p("A"),_++);break;case"G":case"K":case"P":"N"===n()&&(p("N"),_+=2);break;case"W":"R"===n()?(p(n()),_+=2):"H"===n()?(p(f()),_+=2):a(n())&&(p("W"),_+=2);break;case"X":p("S"),_++;break;case"E":case"I":case"O":case"U":p(f()),_++}for(;f();)if(t=1,!c(f())||f()===l()&&"C"!==f())_+=t;else{switch(f()){case"B":"M"!==l()&&p("B");break;case"C":s(n())?"I"===n()&&"A"===d(2)?p(r):"S"!==l()&&p("S"):"H"===n()?(p(r),t++):p("K");break;case"D":"G"===n()&&s(d(2))?(p("J"),t++):p("T");break;case"G":"H"===n()?o(d(-3))||"H"===d(-4)||(p("F"),t++):"N"===n()?!c(d(2))||"E"===d(2)&&"D"===d(3)||p("K"):s(n())&&"G"!==l()?p("J"):p("K");break;case"H":a(n())&&!u(l())&&p("H");break;case"K":"C"!==l()&&p("K");break;case"P":"H"===n()?p("F"):p("P");break;case"Q":p("K");break;case"S":"I"!==n()||"O"!==d(2)&&"A"!==d(2)?"H"===n()?(p(r),t++):p("S"):p(r);break;case"T":"I"!==n()||"O"!==d(2)&&"A"!==d(2)?"H"===n()?(p(i),t++):"C"===n()&&"H"===d(2)||p("T"):p(r);break;case"V":p("F");break;case"W":a(n())&&p("W");break;case"X":p("KS");break;case"Y":a(n())&&p("Y");break;case"Z":p("S");break;case"F":case"J":case"L":case"M":case"N":case"R":p(f())}_+=t}return h};var r="X",i="0";function o(e){return"B"===(e=f(e))||"D"===e||"H"===e}function s(e){return"E"===(e=f(e))||"I"===e||"Y"===e}function a(e){return"A"===(e=f(e))||"E"===e||"I"===e||"O"===e||"U"===e}function u(e){return"C"===(e=f(e))||"G"===e||"P"===e||"S"===e||"T"===e}function c(e){var t=function(e){return f(e).charCodeAt(0)}(e);return t>=65&&t<=90}function f(e){return String(e).charAt(0).toUpperCase()}},function(e,t,n){var r=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(6),o=n(0),s=n(18),a=n(17),u=n(16),c=n(15),f={select:function(e,t){e._select(t)},upsert:function(e,t){e._upsert(t)},delete:function(e,t){e._delete(t)},drop:function(e,t){e._drop(t)},"show tables":function(e,t){e._query.result=Object.keys(e._store.tableInfo),t(e._query)},describe:function(e,t){"string"==typeof e._query.table?(e._query.result=o._assign(e._store.models[e._query.table]),t(e._query)):t(e._query)}},l=function(){function e(e){this._store=e}return e.prototype.doQuery=function(e,t){this._query=e,this._isInstanceTable=Array.isArray(e.table),f[e.action](this,t)},e.prototype._getRows=function(e){this._isInstanceTable?new p(this._query).getRows(e):new _(this,this._query,this._store,function(t){e(t.filter(function(e){return e}))})},e.prototype._select=function(e){var t=this;this._hash=o.hash(JSON.stringify(r({},this._query,{queryID:null})));var n=!this._query.join&&!this._query.orm&&this._store._doCache&&!Array.isArray(this._query.table);if(n&&this._store._cache[this._query.table][this._hash])return this._query.result=this._store._cache[this._query.table][this._hash],void e(this._query);this._getRows(function(r){["having","orderBy","offset","limit","actionArgs","groupBy","orm","join"].filter(function(e){return t._query[e]}).length?new h(t._query,t._store)._executeQueryArguments(r,function(i){n&&(t._store._cache[t._query.table][t._hash]=r),t._query.result=i,e(t._query)}):(n&&(t._store._cache[t._query.table][t._hash]=r),t._query.result=r,e(t._query))})},e.prototype._updateORMRows=function(e,t,n,r,i){var s=this;this._store.tableInfo[e._fromTable]._pk,this._store._read(e._fromTable,t,function(t){o.fastALL(t,function(t,i,a){var u=Object.isFrozen(t)?o._assign(t):t;if("array"===e._fromType){u[e._fromColumn]=u[e._fromColumn]||[];var c=u[e._fromColumn].indexOf(r);n?-1===c?u[e._fromColumn].push(r):a():-1!==c?u[e._fromColumn].splice(c,1):a(),u[e._fromColumn].sort()}else u[e._fromColumn]=n?r:null;s._store._nsql.query("upsert",u).comment("_orm_skip").manualExec({table:e._fromTable}).then(a)}).then(i)})},e.prototype._syncORM=function(e,t,n,r){var i=this;if(this._store._hasORM){var s=this._store._relToTable[this._query.table];if(-1===this._query.comments.indexOf("_orm_skip"))if(s&&s.length){for(var a=Math.max(t.length,n.length),u=[];a--;)u.push(" ");o.fastCHAIN(u,function(r,a,u){o.fastALL(s,function(r,s,u){var c,f;switch(e){case"del":var l=t[a][i._store.tableInfo[i._query.table]._pk],h="array"===r._thisType?t[a][r._thisColumn]||[]:[t[a][r._thisColumn]].filter(function(e){return e});i._updateORMRows(r,h,!1,l,u);break;case"add":var _=n[a][i._store.tableInfo[i._query.table]._pk];if(t[a])if(c=t[a][r._thisColumn],f=n[a][r._thisColumn],Array.isArray(c)&&Array.isArray(f)?c.length===f.length&&c.filter(function(e,t){return e!==f[t]}).length>0:c===f)u();else if("array"===r._thisType){var p=(n[a][r._thisColumn]||[]).filter(function(e){return-1===(t[a][r._thisColumn]||[]).indexOf(e)}),d=(t[a][r._thisColumn]||[]).filter(function(e){return-1===(n[a][r._thisColumn]||[]).indexOf(e)});o.fastALL([p,d],function(e,t,n){i._updateORMRows(r,e,0===t,_,n)}).then(u)}else{var y=function(){null!==n[a][r._thisColumn]&&void 0!==n[a][r._thisColumn]?i._updateORMRows(r,[n[a][r._thisColumn]],!0,_,u):u()};null!==t[a][r._thisColumn]&&void 0!==t[a][r._thisColumn]?i._updateORMRows(r,[t[a][r._thisColumn]],!1,_,y):y()}else{var b="array"===r._thisType?n[a][r._thisColumn]||[]:[n[a][r._thisColumn]].filter(function(e){return e});b&&b.length?i._updateORMRows(r,b,!0,_,u):u()}}}).then(u)}).then(r)}else r();else r()}else r()},e.prototype._tokenizer=function(e,t){var n=this._store.tableInfo[this._query.table]._searchColumns[e];if(!n)return[];var r=this._store._nsql.getConfig().tokenizer;if(r){var i=r(this._query.table,e,n,t);if(!1!==i)return i}var o=(t||"").toLowerCase().replace(/[^\w\s]|_/gim,"").replace(/\r?\n|\r|\t/gim,"").replace(/\s+/g," ").split(" ");switch(n[1]){case"english":return o.map(function(e,t){return{o:e,w:s(a(e)),i:t}});case"english-stem":return o.map(function(e,t){return{o:e,w:a(e),i:t}});case"english-meta":return o.map(function(e,t){return{o:e,w:s(e),i:t}})}return o.map(function(e,t){return{o:e,w:e,i:t}})},e.prototype._clearFromSearchIndex=function(e,t,n){var r=this,i=this._query.table,s=Object.keys(this._store.tableInfo[i]._searchColumns);if(0!==s.length){var a="_"+i+"_search_tokens_";o.fastALL(s,function(n,s,u){var c={};r._tokenizer(n,t[n]).forEach(function(e){c[e.w]=e.o}),r._store.adapters[0].adapter.read(a+n,e,function(t){t?o.fastALL(["_search_","_search_fuzzy_"],function(s,a,u){var f={};t.tokens.forEach(function(e){f[e.w]||(0===a&&(f[e.w]=!0),1===a&&(f[c[e.w]]=!0))}),o.fastALL(Object.keys(f),function(t,a,u){t?r._store.adapters[0].adapter.read("_"+i+s+n,t,function(a){a?(Object.isFrozen(a)&&(a=o._assign(a)),a.rows=a.rows.filter(function(t){return t.id!==e}),r._store.adapterWrite("_"+i+s+n,t,a,u)):u()}):u()}).then(u)}).then(function(){r._store.adapters[0].adapter.delete(a+n,e,u)}):u()})}).then(n)}else n()},e.prototype._updateSearchIndex=function(e,t,n){var r=this,i=this._query.table,s=Object.keys(this._store.tableInfo[i]._searchColumns);if(0!==s.length&&o.intersect(Object.keys(t),s)){var a="_"+i+"_search_tokens_";o.fastALL(s,function(n,s,u){-1===[void 0,null].indexOf(t[n])?r._store.adapters[0].adapter.read(a+n,e,function(s){var c=s||{id:e,hash:"1505",tokens:[]},f=o.hash(t[n]);if(f!==c.hash){var l={},h=r._tokenizer(n,t[n]),_=c.tokens.map(function(e){return e.i+"-"+e.w}),p=h.map(function(e){return e.i+"-"+e.w});h.forEach(function(e){l[e.w]=e.o});var d=p.filter(function(e){return-1===_.indexOf(e)}),y=_.filter(function(e){return-1===p.indexOf(e)});o.fastCHAIN([y,d],function(t,s,a){var u={};t.forEach(function(e){var t=e.split(/-(.+)/),n={w:t[1],i:parseInt(t[0])};u[n.w]||(u[n.w]=[]),u[n.w].push(n)}),o.fastALL(Object.keys(u),function(t,a,c){o.fastALL(["_search_","_search_fuzzy_"],function(a,c,f){(0===c?t:l[t])?r._store.adapters[0].adapter.read("_"+i+a+n,0===c?t:l[t],function(_){var p=_||{wrd:t,rows:[]};switch(Object.isFrozen(p)&&(p=o._assign(p)),s){case 0:p.rows.forEach(function(t,n){t.id===e&&p.rows.splice(n,1)});break;case 1:p.rows.push({id:e,i:u[t].map(function(e){return e.i}),l:h.length})}r._store.adapterWrite("_"+i+a+n,0===c?t:l[t],p,f)}):f()}).then(c)}).then(a)}).then(function(){r._store.adapterWrite(a+n,e,{id:e,hash:f,tokens:h.map(function(e){return{w:e.w,i:e.i}})},u)})}else u()}):u()}).then(n)}else n()},e.prototype._updateRowViews=function(e,t,n){var r=this;this._store._hasViews?null!==e&&void 0!==e?o.fastALL(Object.keys(this._store.tableInfo[this._query.table]._views),function(n,i,o){var s=r._store.tableInfo[r._query.table]._views[n].pkColumn;if(void 0!==e[s]){if(e[s]!==t[s])return null===e[s]?(r._store.tableInfo[r._query.table]._views[n].columns.forEach(function(t){e[t.thisColumn]=null}),void o()):void r._store._read(n,[e[s]],function(t){if(!t.length&&"LIVE"===r._store.tableInfo[r._query.table]._views[n].mode)return r._store.tableInfo[r._query.table]._views[n].columns.forEach(function(t){e[t.thisColumn]=null}),void o();r._store.tableInfo[r._query.table]._views[n].columns.forEach(function(n){e[n.thisColumn]=t[0][n.otherColumn]}),o()});o()}else o()}).then(function(){n(e)}):n(e||{}):n(e)},e.prototype._updateRemoteViews=function(e,t,n){var r=this,i=this._store.tableInfo[this._query.table]._pk;o.fastALL(e,function(e,n,s){o.fastALL(r._store.tableInfo[r._query.table]._viewTables,function(n,s,a){t&&"GHOST"===r._store.tableInfo[n.table]._views[r._query.table].mode?a():r._store._secondaryIndexRead(n.table,n.column,e[i],function(i){if(i.length){var s=r._store.tableInfo[n.table]._views[r._query.table].columns,u=r._store.tableInfo[n.table]._views[r._query.table].pkColumn;o.fastALL(i,function(i,o,a){var c=s.length,f=!1;if(t){if("LIVE"===r._store.tableInfo[n.table]._views[r._query.table].mode)for(f=!0,i[u]=null;c--;)i[s[c].otherColumn]=null}else for(;c--;)i[s[c].otherColumn]!==e[s[c].thisColumn]&&(i[s[c].otherColumn]=e[s[c].thisColumn],f=!0);if(f){var l=r._store.tableInfo[n.table]._pk;r._store.adapterWrite(n.table,i[l],i,a)}else a()}).then(a)}else a()})}).then(s)}).then(n)},e.prototype._doAfterQuery=function(e,t,n){var r=this;this._store._hasViews&&this._store.tableInfo[this._query.table]._viewTables.length?this._updateRemoteViews(e,t,function(){n(r._query)}):n(this._query)},e.prototype._upsert=function(e){var t=this,n=this._store.tableInfo[this._query.table]._pk;if(this._isInstanceTable)this._getRows(function(n){t._query.result=t._query.table.map(function(e){return-1===n.indexOf(e)?e:r({},t._query.actionArgs,e)}),e(t._query)});else if(this._query.where)this._getRows(function(r){r.length?o.fastCHAIN(r,function(e,r,i){t._updateSearchIndex(e[n],e,function(){t._updateRowViews(t._query.actionArgs||{},e,function(r){t._store.tableInfo[t._query.table]._hasDefaults&&Object.keys(t._store.tableInfo[t._query.table]._defaults).forEach(function(n){void 0===e[n]&&void 0===r[n]&&(r[n]=t._store.tableInfo[t._query.table]._defaults[n])}),t._store._write(t._query.table,e[n],e,r,i)})})}).then(function(i){var o=i.map(function(e){return e[n]});t._store._cache[t._query.table]={},t._query.result=[{msg:i.length+" row(s) modfied.",affectedRowPKS:o,affectedRows:i}],t._syncORM("add",r,i,function(){t._doAfterQuery(i,!1,e)})}):(t._query.result=[{msg:"0 row(s) modfied.",affectedRowPKS:[],affectedRows:[]}],e(t._query))});else{var i=this._query.actionArgs||{};this._store._cache[this._query.table]={};var s=function(r){t._updateRowViews(i,r,function(o){t._store.tableInfo[t._query.table]._hasDefaults&&Object.keys(t._store.tableInfo[t._query.table]._defaults).forEach(function(e){void 0===(r||{})[e]&&void 0===o[e]&&(o[e]=t._store.tableInfo[t._query.table]._defaults[e])}),t._store._write(t._query.table,i[n],r,o,function(i){t._updateSearchIndex(i[n],i,function(){t._query.result=[{msg:"1 row inserted.",affectedRowPKS:[i[n]],affectedRows:[i]}],t._store._hasORM?t._syncORM("add",[r].filter(function(e){return e}),[i],function(){t._doAfterQuery([i],!1,e)}):t._doAfterQuery([i],!1,e)})})})};void 0!==i[n]&&-1===this._query.comments.indexOf("_rebuild_search_index_")?this._store._read(this._query.table,[i[n]],function(e){e.length?s(e[0]):s(null)}):s(null)}},e.prototype._delete=function(e){var t=this;this._isInstanceTable?this._query.where?this._getRows(function(n){t._query.result=t._query.table.filter(function(e){return-1===n.indexOf(e)}),e(t._query)}):(this._query.result=[],e(this._query)):this._query.where?this._getRows(function(n){(n=n.filter(function(e){return e})).length?o.fastALL(n,function(e,n,r){t._clearFromSearchIndex(e[t._store.tableInfo[t._query.table]._pk],e,function(){t._store._delete(t._query.table,e[t._store.tableInfo[t._query.table]._pk],r)})}).then(function(r){t._store._cache[t._query.table]={};var i=n.map(function(e){return e[t._store.tableInfo[t._query.table]._pk]});t._query.result=[{msg:n.length+" row(s) deleted.",affectedRowPKS:i,affectedRows:n}],t._syncORM("del",n,[],function(){t._doAfterQuery(n,!0,e)})}):(t._query.result=[{msg:"0 row(s) deleted.",affectedRowPKS:[],affectedRows:[]}],e(t._query))}):this._drop(e)},e.prototype._drop=function(e){var t=this;if(this._isInstanceTable)return this._query.result=[],void e(this._query);this._store._rangeRead(this._query.table,void 0,void 0,!1,function(n){t._store._cache[t._query.table]={},t._query.table,t._store._drop(t._query.table,function(){t._query.result=[{msg:"'"+t._query.table+"' table dropped.",affectedRowPKS:n.map(function(e){return e[t._store.tableInfo[t._query.table]._pk]}),affectedRows:n}],t._syncORM("del",n,[],function(){t._doAfterQuery(n,!0,e)})})})},e}();t._NanoSQLStorageQuery=l;var h=function(){function e(e,t){this.q=e,this.s=t,this._groupByColumns=[]}return e.prototype._join=function(e,t){var n=this;if(this.q.join){var r={};"cross"!==this.q.join.type&&this.q.join.where&&(r={_left:this.q.join.where[0],_check:this.q.join.where[1],_right:this.q.join.where[2]});var i=this.q.table,o=this.q.join.table;this._doJoin(this.q.join.type,i,o,r,function(e){n.q.where?t(e.filter(function(e,t){return Array.isArray(n.q.where)?d(e,n.q.where||[],t,!0):n.q.where(e,t)})):n.q.range?t(e.filter(function(e,t){return n.q.range&&n.q.range[0]>=t&&n.q.range[0]+n.q.range[1]-1<=t})):t(e)})}else t(e)},e.prototype._groupByKey=function(e,t){return e.reduce(function(e,n){return-1!==n.indexOf(".length")?e+"."+String((t[n.replace(".length","")]||[]).length):e+"."+String(t[n])},"").slice(1)},e.prototype._groupBy=function(e){var t=this,n=this.q.groupBy||{},r=e.sort(function(e,r){return t._sortObj(e,r,n,!0)});return r.forEach(function(e,r){var i=Object.keys(n).map(function(t){return String(e[t])||""}).join(".");t._sortGroups||(t._sortGroups={}),t._sortGroups[i]||(t._sortGroups[i]=[]),t._sortGroups[i].push(r)}),r},e.prototype._having=function(e){var t=this;return e.filter(function(e,n){return Array.isArray(t.q.having)?d(e,t.q.having||[],n,!0):t.q.having(e,n)})},e.prototype._orderBy=function(e){var t=this;return e.sort(function(e,n){return t._sortObj(e,n,t.q.orderBy||{},!1)})},e.prototype._offset=function(e){var t=this;return e.filter(function(e,n){return!t.q.offset||n>=t.q.offset})},e.prototype._limit=function(e){var t=this;return e.filter(function(e,n){return!t.q.limit||n<t.q.limit})},e.prototype._orm=function(e,t){var n=this,r=this.q.orm?this.q.orm.map(function(e){return"string"==typeof e?{key:e,limit:5}:e}):[];o.fastALL(e,function(e,t,s){e=Object.isFrozen(e)?o._assign(e):e,o.fastALL(r,function(t,r,o){if(e[t.key]&&e[t.key].length){var s=n.s._columnsAreTables[n.q.table][t.key];s?n.s._nsql.query("select").where([n.s.tableInfo[s._toTable]._pk,"array"===s._thisType?"IN":"=",e[t.key]]).manualExec({table:s._toTable}).then(function(n){var r=i.nSQL().query("select",t.select);t.where&&r.where(t.where),void 0!==t.limit&&r.limit(t.limit),void 0!==t.offset&&r.offset(t.offset),t.orderBy&&r.orderBy(t.orderBy),t.groupBy&&r.groupBy(t.groupBy),r.manualExec({table:n}).then(function(r){n.filter(function(e){return e}).length?e[t.key]="array"===s._thisType?r:r[0]:e[t.key]="array"===s._thisType?[]:void 0,o()})}):o()}else o()}).then(function(){s(e)})}).then(t)},e.prototype._doJoin=function(e,t,n,r,i){var o="left",s="right",a="outer",u=this,c=u.s.tableInfo[e===s?n:t],f=u.s.tableInfo[e===s?t:n],l=function(e,t){return[c,f].reduce(function(n,r,i){return r._keys.forEach(function(o){n[r._name+"."+o]=((0===i?e:t)||{})[o]}),n},{})},h=[],_=r&&r._right&&r._right.split(".").pop()||"",p={},y=[];u.s._read(c._name,function(t,n,i){var b=!1;u.s._read(f._name,function(n,i,o){var u;r&&"cross"!==e?d(((u={})[c._name]=t,u[f._name]=n,u),[r._left,r._check,e===s?t[_]:n[_]],0)?(e===a&&(p[i]=!0),h.push(l(t,n)),b=!0):e===a&&(y[i]=n):(h.push(l(t,n)),b=!0),o(!1)},function(){!b&&[o,s,a].indexOf(e)>-1&&h.push(l(t,null)),i(!1)})},function(){if(e===a){for(var t=y.filter(function(e,t){return!p[t]}),n=0;n<t.length;)h.push(l(null,t[n])),n++;i(h)}else i(h)})},e.prototype._sortObj=function(e,t,n,r){return Object.keys(n).reduce(function(i,s){var a=r?o.objQuery(s,e):e[s],u=r?o.objQuery(s,t):t[s];return i||(a===u?0:(a>u?1:-1)*("desc"===n[s]?-1:1))},0)},e.prototype._mutateRows=function(e,t){var n=this,r=this.q.actionArgs,s={},a={};if(r&&r.length){var u=!1,c={};r.forEach(function(e){if(-1!==e.indexOf("(")){var t=(e.match(/^.*\(/g)||[""])[0].replace(/\(|\)/g,"").toUpperCase(),n=i.NanoSQLInstance.functions[t],r=1===e.split(" AS ").length?t:(e.split(" AS ").pop()||"").trim();if(!n)throw new Error("nSQL: '"+t+"' is not a valid function!");"A"===n.type&&(u=!0),c[e]={fn:n,key:r}}}),o.fastALL(r,function(t,r,i){if(t.indexOf("(")>-1){var f=(t.match(/\(.*\)/g)||[""])[0].replace(/\(|\)/g,"").split(",").map(function(e){return e.trim()});n._sortGroups&&u?o.fastALL(Object.keys(n._sortGroups),function(r,i,o){var s;a[r]||(a[r]={}),(s=c[t].fn).call.apply(s,[e.filter(function(e,t){return n._sortGroups[r].indexOf(t)>-1}),function(e){a[r][c[t].key]=e,o()},void 0!==n.q.join].concat(f))}).then(i):(l=c[t].fn).call.apply(l,[e,function(e){s[c[t].key]=e,i()},void 0!==n.q.join].concat(f))}else i();var l}).then(function(){var i=function(e,t,i){var s={};return r.forEach(function(r){var a=r.indexOf("(")>-1,u=a?c[r].fn.type:"";if(r.indexOf(" AS ")>-1){var f=r.split(" AS "),l=a?c[r].key:f[0].trim();s[f[1]]=a?"A"===u?i[l]:i[l][t]:o.objQuery(l,e,void 0!==n.q.join)}else l=a?c[r].key:r,s[r]=a?"A"===u?i[l]:i[l][t]:o.objQuery(l,e,void 0!==n.q.join)}),s};if(!e.length&&u){var f=[{}];return Object.keys(c).forEach(function(e){void 0!==s[c[e].key]&&(f[0][e]=s[c[e].key])}),void t(f)}if(n._sortGroups&&u){var l=[];Object.keys(n._sortGroups).forEach(function(t){var r=e.filter(function(e,r){return n._sortGroups[t].indexOf(r)>-1}).filter(function(e,t){return t<1});r&&r.length&&l.push(i(r[0],0,a[t]))}),t(l)}else t(u?e.filter(function(e,t){return t<1}).map(function(e,t){return i(e,t,s)}):e.map(function(e,t){return i(e,t,s)}))})}else t(e)},e.prototype._executeQueryArguments=function(e,t){var n=this,r=function(){n.q.having&&(e=n._having(e)),n.q.orderBy&&(e=n._orderBy(e)),n.q.offset&&(e=n._offset(e)),n.q.limit&&(e=n._limit(e)),t(e)},i=function(){n.q.actionArgs&&n.q.actionArgs.length?n._mutateRows(e,function(t){e=t,r()}):r()},o=function(){n.q.groupBy&&(e=n._groupBy(e)),n.q.orm?n._orm(e,function(t){e=t,i()}):i()};this.q.join?this._join(e,function(t){e=t,o()}):o()},e}();t._MutateSelection=h;var _=function(){function e(e,t,n,r){var i=this;if(this.qu=e,this.q=t,this.s=n,this.q.join&&this.q.orm)throw new Error("nSQL: Cannot do a JOIN and ORM command at the same time!");if([this.q.where,this.q.range,this.q.trie].filter(function(e){return e}).length>1)throw new Error("nSQL: Can only have ONE of Trie, Range or Where!");if(this.q.join)r([]);else if(this.q.trie&&this.q.trie.column&&this.q.trie.search)this._selectByTrie(r);else if(this.q.range&&this.q.range.length)this._selectByRange(r);else if(this.q.where&&this.q.where.length&&Array.isArray(this.q.where))if("string"==typeof this.q.where[0]?0===this._isOptimizedWhere(this.q.where):0===(this.q.where||[]).reduce(function(e,t,n){return n%2==1?e:e+i._isOptimizedWhere(t)},0))this._selectByKeysOrSeach(this.q.where,r);else{var o=this._isSubOptimizedWhere(this.q.where);if(o>0){var s=this.q.where.slice(0,o),a=this.q.where.slice(o+1);this._selectByKeysOrSeach(s,function(e){r(e.filter(function(e,t){return d(e,a,t)}))})}else this._fullTableScan(r)}else this._fullTableScan(r)}return e.prototype._selectByKeysOrSeach=function(e,t){var n=this,r=this.s.tableInfo[this.q.table]._pk;if(e&&"string"==typeof e[0])this._selectRowsByIndexOrSearch(e,t);else if(e){var i=[],s="";o.fastCHAIN(e,function(e,t,r){if("string"==typeof e)return s=e,void r();n._selectRowsByIndexOrSearch(e,function(e){if("AND"===s){for(var t={},o=e.length;o--;)t[e[o][n.s.tableInfo[n.q.table]._pk]]=!0;i=i.filter(function(e){return t[e[n.s.tableInfo[n.q.table]._pk]]})}else i=i.concat(e);r()})}).then(function(){var e=[];t(i.filter(function(t){return-1===e.indexOf(t[r])&&(e.push(t[r]),!0)}))})}},e.prototype._selectRowsByIndexOrSearch=function(e,t){var n=this;if(0!==e[0].indexOf("search("))if("BETWEEN"!==e[1]){var i=[];switch(e[1]){case"IN":i=e[2];break;case"=":i=[e[2]]}e[0]===this.s.tableInfo[this.q.table]._pk?this.s._read(this.q.table,i,t):o.fastALL(i,function(t,r,i){n.s._secondaryIndexRead(n.q.table,e[0],t,i)}).then(function(e){t([].concat.apply([],e))})}else{var s=e[0]===this.s.tableInfo[this.q.table]._pk?"":e[0];if(s){var a="_"+this.q.table+"_idx_"+s;this.s._rangeRead(a,e[2][0],e[2][1],!0,function(e){for(var r=[],i=e.length;i--;)r=r.concat(e[i].rows);n.s._read(n.q.table,r,t)})}else this.s._rangeRead(this.q.table,e[2][0],e[2][1],!0,function(e){t(e)})}else{var f=0;-1!==e[1].indexOf(">")?f=parseFloat(e[1].replace(">",""))+1e-4:-1!==e[1].indexOf("<")&&(f=-1*parseFloat(e[1].replace("<",""))+1e-4);var l=e[0].replace(/search\((.*)\)/gim,"$1").split(",").map(function(e){return e.trim()}),h={},_={};o.fastALL(l,function(t,r,i){var s=n.qu._tokenizer(t,e[2]),a=n.s.tableInfo[n.q.table]._searchColumns[t],l={},p=[],d={},y={};s.forEach(function(e){d[e.w]=e.o,y[e.o]=e.w}),o.fastALL(["_search_","_search_fuzzy_"],function(e,r,i){var a="_"+n.q.table+e+t;switch(r){case 0:o.fastALL(s,function(e,t,r){n.s.adapters[0].adapter.read(a,e.w,function(t){t?(t.rows.forEach(function(t){l[t.id]||(l[t.id]={}),p.push(t.i[0]),l[t.id][e.w]=t}),r()):r()})}).then(i);break;case 1:if(0===f)return void i();n.s.adapters[0].adapter.getIndex(a,!1,function(e){var t=[];e.forEach(function(e){s.forEach(function(n){u(n.o,e)&&(_[n.o]=e,d[e]=n.o,t.push(e))})}),t=t.filter(function(e,t,n){return n.indexOf(e)===t}),o.fastALL(t,function(e,t,r){n.s.adapters[0].adapter.read(a,e,function(t){t?(t.rows.forEach(function(t){var n=!1;if(l[t.id]?-1!==p.indexOf(t.i[0])&&(n=!0):l[t.id]={},!n){var r=y[e]||e;l[t.id][r]=t}}),r()):r()})}).then(i)})}}).then(function(){Object.keys(l).forEach(function(e){if(0!==f||Object.keys(l[e]).length===s.length){h[e]||(h[e]={weight:0,locations:{}});var n=0,r=Object.keys(l[e]).map(function(t){return n=l[e][t].l,d[t]&&(h[e].weight+=5),{word:d[t]||t,loc:l[e][t].i}}),i=r.reduce(function(e,t){return e+t.loc.length},0);if(h[e].weight+=i/n+parseInt(a[0]),h[e].locations[t]=r,0!==f)s.forEach(function(t){var n=l[e][t.w];n&&n.i.forEach(function(n){Object.keys(l[e]).forEach(function(r){r!==t.w&&l[e][r].i.forEach(function(t){var r=Math.abs(t-n);r&&(h[e].weight+=10/(10*r))})})}),_[t.o]&&r.forEach(function(n){if(_[t.o]===n.word){var r=c(t.o,n.word);h[e].weight+=r<=1?10:10/(5*r)}})});else if(s.length>1){var o=[];Object.keys(l[e]).forEach(function(t){t===s[0].w&&(o=l[e][t].i)});var u=!0;o.forEach(function(t,n){var r=s[n+1];r&&Object.keys(l[e]).forEach(function(n){if(n===r.w){var i=r.i+t;-1===l[e][n].i.indexOf(i)&&(u=!1)}})}),u||delete h[e]}}else delete l[e]}),i()})}).then(function(e){for(var i=0,s=Object.keys(h),a=s.length;a--;)i=Math.max(i,h[s[a]].weight);for(a=s.length;a--;)h[s[a]].weight=h[s[a]].weight/i;o.fastALL(s.filter(function(e){return 0===f||(f>0?f<h[e].weight:!(f<0)||-1*f>h[e].weight)}),function(e,t,r){n.s.adapters[0].adapter.read(n.q.table,e,r)}).then(function(e){var i=n.s.tableInfo[n.q.table]._pk;(e=e.filter(function(e){return e})).forEach(function(e){var t=e[i];Object.keys(h[t].locations).forEach(function(r){var i=n.qu._tokenizer(r,e[r]).map(function(e){return e.o});h[t].locations[r].forEach(function(e){e.loc.forEach(function(n){var r=c(i[n],e.word);h[t].weight+=r<=1?10:10/(10*r)})})})});for(var o=0,s=Object.keys(h),a=s.length;a--;)o=Math.max(o,h[s[a]].weight);for(a=s.length;a--;)h[s[a]].weight=h[s[a]].weight/o;t(e.filter(function(e){return 0===f||(f>0?f<h[e[i]].weight:!(f<0)||-1*f>h[e[i]].weight)}).map(function(e){return r({},e,{_weight:h[e[i]].weight,_locations:h[e[i]].locations})}))})})}},e.prototype._selectByRange=function(e){var t=this;if(this.q.range){var n=this.q.range;n[0]>0?this.s._rangeRead(this.q.table,n[1],n[1]+n[0]-1,!1,e):this.s.adapters[0].adapter.getIndex(this.q.table,!0,function(r){for(var i=r+n[0]-n[1],o=i,s=Math.abs(n[0])-1;s--;)o++;t.s._rangeRead(t.q.table,i,o,!1,e)})}else e([])},e.prototype._selectByTrie=function(e){this.q.trie?this.s._trieRead(this.q.table,this.q.trie.column,this.q.trie.search,e):e([])},e.prototype._fullTableScan=function(e){var t=this,n=void 0!==this.q.where,r=n&&Array.isArray(this.q.where),i=this.s.tableInfo[this.q.table]._pk,s=[],a=[],u=function(){t.s._read(t.q.table,function(e,o,a){a(!n||(r?d(e,t.q.where,o,!1,s,i):t.q.where(e,o)))},function(t){s.length?e(t.map(function(e){return a[e[i]]?a[e[i]]:e})):e(t)})},c=this.q.where||[];r&&"string"!=typeof c[0]?o.fastCHAIN(c,function(e,n,r){-1!==e[0].indexOf("search(")?t.qu._store._nsql.query("select").where(e).manualExec({table:t.q.table}).then(function(e){s[n]=e,e.forEach(function(e){a[e[i]]=e}),r()}):r()}).then(function(){u()}):u()},e.prototype._isSubOptimizedWhere=function(e){var t=this;if("string"==typeof e[0])return 0;if(0===this._isOptimizedWhere(e[0])){var n=0;return e.forEach(function(r,i){i%2==0&&0===t._isOptimizedWhere(r)&&e[i+1]&&(n=i+1)}),"AND"!==e[n]?0:n}return 0},e.prototype._isOptimizedWhere=function(e){var t=this.s.tableInfo[this.q.table],n=e[0]||"",r=e[1]||"";return!(["=","IN","BETWEEN"].indexOf(e[1])>-1||-1!==n.indexOf("search(")&&("="===r||-1!==r.indexOf(">")||-1!==r.indexOf("<")))||n!==t._pk&&-1===t._secondaryIndexes.indexOf(n)&&-1===n.indexOf("search(")?1:0},e}();t._RowSelection=_;var p=function(){function e(e){this.q=e}return e.prototype.getRows=function(e){var t=this;if(this.q.join||this.q.orm||this.q.trie)throw new Error("nSQL: Cannot do a JOIN, ORM or TRIE command with instance table!");if(this.q.range&&this.q.range.length){var n,r,i=this.q.range;n=i[0]<0?this.q.table.length+i[0]-i[1]:i[1];var o=Math.abs(i[0])-1;for(r=n;o--;)r++;e(this.q.table.filter(function(e,t){return t>=n&&t<=r}))}else e(this.q.table.filter(function(e,n){return!t.q.where||(Array.isArray(t.q.where)?d(e,t.q.where||[],n):t.q.where(e,n))}))},e}();t.InstanceSelection=p;var d=function(e,t,n,r,i,o){if("string"!=typeof t[0]){var s,a,u=-1!==t.indexOf("OR");return t.reduce(function(t,n,c){if(void 0!==s)return s;if(c%2==1)return a=n,t;var f;return f=-1!==n[0].indexOf("search(")&&i?-1!==i[c].map(function(e){return e[o]}).indexOf(e[o]):v(n,e,r||!1),u||!1!==f?0===c?f:"AND"===a?t&&f:t||f:s=!1},!1)}return v(t,e,r||!1)},y={},b={},g={},v=function(e,t,n){void 0===b[e[0]]&&(b[e[0]]=0===e[0].indexOf("levenshtein(")?e[0].replace(/levenshtein\((.*,.*)\)/gim,"$1").split(",").map(function(e){return e.trim()}):[]);var r=function(e,t){return y[t]||(y[t]=new RegExp("^"+t.replace(/\%/gm,".*").replace(/\_/gm,".")+"$","gmi")),null!==e.match(y[t])},i=e[2],s=function(){if(b[e[0]]&&b[e[0]].length){var r=((i=o.objQuery(b[e[0]][1],t,n))||"")+"::"+b[e[0]][0];return g[r]||(g[r]=c(i||"",b[e[0]][0])),g[r]}var i=o.objQuery(e[0],t,n);return["LIKE","NOT LIKE"].indexOf(a)>-1?String(i||""):i}(),a=e[1];switch(i){case"NULL":return-1!==[void 0,null].indexOf(s);case"NOT NULL":return-1===[void 0,null].indexOf(s)}switch(a){case"=":return s===i;case"!=":return s!==i;case">":return s>i;case"<":return s<i;case"<=":return s<=i;case">=":return s>=i;case"IN":return!((i||[]).indexOf(s)<0);case"NOT IN":return(i||[]).indexOf(s)<0;case"REGEX":return null!==s.match(i);case"LIKE":return r(s,i);case"NOT LIKE":return!r(s,i);case"BETWEEN":return i[0]<=s&&i[1]>=s;case"HAVE":return!((s||[]).indexOf(i)<0);case"NOT HAVE":return(s||[]).indexOf(i)<0;case"INTERSECT":return(s||[]).filter(function(e){return(i||[]).indexOf(e)>-1}).length>0;case"NOT INTERSECT":return 0===(s||[]).filter(function(e){return(i||[]).indexOf(e)>-1}).length;default:return!1}}},function(e,t,n){var r=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(6),o=n(19),s=n(0),a=n(14),u=n(1),c=function(){function e(){this._queryPool=[],this._queryPtr=0}return e.prototype.willConnect=function(e,t){this.parent=e.parent,this._store=new a._NanoSQLStorage(e.parent,r({},e.config)),this._store.init(e.models,function(n){e.models=r({},e.models,n),t(e)})},e.prototype.doExec=function(e,t){e.state="complete",new o._NanoSQLStorageQuery(this._store).doQuery(e,t)},e.prototype.dumpTables=function(e){var t=this;return new s.Promise(function(n,r){var i={},o=e&&e.length?e:Object.keys(t._store.tableInfo);s.fastALL(o,function(e,n,r){i[e]=[],t._store.adapters[0].adapter.rangeRead(e,function(t,n,r){i[e].push(t),r()},r)}).then(function(){n(i)})})},e.prototype.importTables=function(e,t){var n=this;return new s.Promise(function(r,i){var o=0,a=0;Object.keys(e).forEach(function(t){o+=(e[t]||[]).length||0}),s.fastALL(Object.keys(e),function(r,i,s){var c=n._store.tableInfo[r]._pk,f=(e[r]||[]).length||0,l=0,h=function(){if(l<f){var i=e[r][l];l++,a++,i[c]?n._store.adapterWrite(r,i[c],i,function(){t(Math.round((a+1)/o*1e4)/100),l%500==0?u.setFast(h):h()}):(t(Math.round((a+1)/o*1e4)/100),l%500==0?u.setFast(h):h())}else s()};h()}).then(function(){r()})})},e.prototype.willDisconnect=function(e){s.fastALL(this._store.adapters||[],function(e,t,n){e.disconnect?e.disconnect(n):n()}).then(e)},e.prototype.extend=function(e,t,n){var r=this;switch(t[0]){case"clone":var o=new i.NanoSQLInstance;Object.keys(this.parent.dataModels).forEach(function(e){o.table(e).model(r.parent.dataModels[e],[],!0)}),o.config({id:this._store._id,mode:t[1]}).connect().then(function(){s.fastCHAIN(Object.keys(r.parent.dataModels),function(e,t,n){console.log("Importing "+e+"..."),r.parent.rawDump([e]).then(function(e){return o.rawImport(e)}).then(n)}).then(function(){e(t,[])})});break;case"flush":var a;a=t[1]?[t[1]]:this.parent.tableNames,s.fastCHAIN(a,function(e,t,n){r._store._drop(e,n)}).then(function(){e(t,a)});break;case"get_adapter":t[1]?e(t,[this._store.adapters[t[1]].adapter]):e(t,[this._store.adapters[0].adapter]);break;case"idx.length":case"idx":var u=t[1];Object.keys(this._store.tableInfo).indexOf(u)>-1?this._store.adapters[0].adapter.getIndex(u,"idx"!==t[0],function(n){e(t,n)}):e(t,[]);break;case"rebuild_search":var c=t[1]?[t[1]]:Object.keys(r._store.tableInfo),f=t[2];s.fastALL(c,function(e,t,n){var i=0,o=0;s.fastALL(c,function(e,t,n){r._store.adapters[0].adapter.getIndex(e,!0,function(e){i+=e,n()})}).then(function(){var t=Object.keys(r._store.tableInfo[e]._searchColumns).map(function(t){return"_"+e+"_search_tokens_"+t});t=(t=t.concat(Object.keys(r._store.tableInfo[e]._searchColumns).map(function(t){return"_"+e+"_search_"+t}))).concat(Object.keys(r._store.tableInfo[e]._searchColumns).map(function(t){return"_"+e+"_search_fuzzy_"+t})),s.fastALL(t,function(e,t,n){r._store.adapterDrop(e,n)}).then(function(){r._store.adapters[0].adapter.rangeRead(e,function(t,n,s){r.parent.query("upsert",t).comment("_rebuild_search_index_").manualExec({table:e}).then(function(){f&&f(Math.round((o+1)/i*1e4)/100),o++,s()})},n)})})}).then(function(){e(t,[])});break;case"rebuild_idx":t[1]?this._store.rebuildIndexes(t[1],function(n){e(t,[n])}):s.fastALL(Object.keys(this._store.tableInfo),function(e,t,n){r._store.rebuildIndexes(e,n)}).then(function(n){e(t,n)});break;default:e(t,n)}},e}();t.NanoSQLDefaultBackend=c},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this.eventListeners={}}return e.prototype.on=function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)},e.prototype.off=function(e,t){var n=this;this.eventListeners[e]&&this.eventListeners[e].length&&this.eventListeners[e].forEach(function(r,i){r===t&&n.eventListeners[e].splice(i,1)})},e.prototype.trigger=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.eventListeners[e]&&this.eventListeners[e].forEach(function(e){return e.apply(void 0,t)})},e}();t.ReallySmallEvents=n,t.RSE=new n},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t,n,r,i){this.thisQ={state:"pending",table:n,action:e,actionArgs:t,queryID:i,transaction:!0,result:[],comments:[]},this._queries=r}return e.prototype.where=function(e){return this.thisQ.where=e,this},e.prototype.exec=function(){this._queries.push(this.thisQ)},e}();t._NanoSQLTransactionQuery=n},function(e,t,n){var r=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(0),o={affectedRowPKS:[],affectedRows:[]},s=function(e,t){1!==e._db.plugins.length||e._db.hasAnyEvents?i.fastCHAIN(e._db.plugins,function(t,n,r){t.doExec?t.doExec(e._query,function(t){e._query=t||e._query,r()}):r()}).then(function(){if(e._db.hasPK[e._query.table]?t(e._query.result):t(e._query.result.map(function(e){return r({},e,{_id_:void 0})})),e._db.hasAnyEvents||e._db.pluginHasDidExec){var n=function(){switch(e._query.action){case"select":return[e._query.action];case"delete":case"upsert":case"drop":return[e._query.action,"change"];default:return[]}}(),s=e._query.result&&e._query.result.length,a={table:e._query.table,query:e._query,time:Date.now(),result:e._query.result,notes:[],types:n,actionOrView:e._AV,transactionID:e._query.transaction?e._query.queryID:void 0,affectedRowPKS:s?(e._query.result[0]||o).affectedRowPKS:[],affectedRows:s?(e._query.result[0]||o).affectedRows:[]};i.fastCHAIN(e._db.plugins,function(e,t,n){e.didExec?e.didExec(a,function(e){a=e,n()}):n()}).then(function(){e._db.triggerEvent(a)})}}):e._db.plugins[0].doExec(e._query,function(n){e._query=n,e._db.hasPK[e._query.table]?t(e._query.result):t(e._query.result.map(function(e){return r({},e,{_id_:void 0})}))})},a={},u=function(){function e(e,t,n,r,i){this._db=e,this._AV=i||"",this._query={table:t,comments:[],state:"pending",queryID:Date.now()+"."+this._db.fastRand(),action:n,actionArgs:r,result:[]}}return e.prototype.where=function(e){return this._query.where=e,this},e.prototype.range=function(e,t){return this._query.range=[e,t],this},e.prototype.on=function(e){return this._query.on=e,this},e.prototype.debounce=function(e){return this._query.debounce=e||250,this},e.prototype.orm=function(e){return this._query.orm=e,this},e.prototype.orderBy=function(e){return this._query.orderBy=e,this},e.prototype.groupBy=function(e){return this._query.groupBy=e,this},e.prototype.having=function(e){return e.length&&Array.isArray(e)||(this._error="Having condition requires an array!"),this._query.having=e,this},e.prototype.join=function(e){if(Array.isArray(this._query.table))throw Error("Can't JOIN with instance table!");return e.table&&e.type||(this._error="Join command requires table and type arguments!"),this._query.join=e,this},e.prototype.limit=function(e){return this._query.limit=e,this},e.prototype.trieSearch=function(e,t){return this._query.trie={column:e,search:t},this},e.prototype.comment=function(e){return this._query.comments.push(e),this},e.prototype.extend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this._query.extend=e,this},e.prototype.offset=function(e){return this._query.offset=e,this},e.prototype.toCSV=function(e){var t=this,n=this;return new i.Promise(function(r,i){n.exec().then(function(i){var o=[];i.length||r("",n);var s=[];"string"==typeof t._query.table?s=t._db.dataModels[t._query.table].map(function(e){return e.key}):i.forEach(function(e){var t=Object.keys(e);t.length>s.length&&(s=t)}),e&&o.push(s.join(",")),i.forEach(function(e){o.push(s.map(function(t){return null===e[t]||void 0===e[t]?"":"string"==typeof e[t]?'"'+e[t].replace(/\"/g,'""')+'"':"object"==typeof e[t]?'"'+JSON.stringify(e[t]).replace(/\"/g,"'")+'"':e[t]}).join(","))}),r(o.join("\r\n"),n)})})},e.prototype.manualExec=function(e){return this._query=r({},this._query,e),this.exec()},e.prototype.denormalizationQuery=function(e){var t=this;return new i.Promise(function(n,r){switch(e){case"tocolumn":var o={};t._query.actionArgs&&t._query.actionArgs.length?Object.keys(t._db.toColRules[t._query.table]).filter(function(e){return-1!==t._query.actionArgs.indexOf(e)}).forEach(function(e){o[e]=t._db.toColRules[t._query.table][e]}):o=t._db.toColRules[t._query.table],t._query.action="select",t._query.actionArgs=void 0;var a=Object.keys(o);s(t,function(e){i.fastCHAIN(e,function(e,n,r){Object.isFrozen(e)&&(e=i._assign(e)),i.fastALL(a,function(n,r,i){var s=t._db.toColFns[t._query.table][o[n][0]];s?s.apply(null,[e[n],function(t){e[n]=t,i()}].concat(o[n].filter(function(e,t){return t>0}).map(function(t){return e[t]}))):i()}).then(function(){t._db.query("upsert",e).manualExec({table:t._query.table}).then(r).catch(r)})}).then(function(){n({msg:e.length+" rows modified"})})});break;case"torow":var u=(t._query.actionArgs||"").replace("()","");if(!t._db.toRowFns[t._query.table]||!t._db.toRowFns[t._query.table][u])return void r("No function "+t._query.actionArgs+" found to perform updates!");var c=t._db.toRowFns[t._query.table][u],f=t._db.tablePKs[t._query.table];if(t._query.on&&t._query.on.length)return void i.fastALL(t._query.on,function(e,n,r){c(e,{},function(n){n[f]=e,t._db.query("upsert",n).manualExec({table:t._query.table}).then(r).catch(r)})}).then(function(){n([{msg:(t._query.on||[]).length+" rows modified or added."}])});t._query.action="select",t._query.actionArgs=void 0,s(t,function(e){i.fastALL(e,function(e,n,r){Object.isFrozen(e)&&(e=i._assign(e)),c(e[f],e,function(n){n[f]=e[f],t._db.query("upsert",n).manualExec({table:t._query.table}).then(r).catch(r)})}).then(function(){n({msg:e.length+" rows modified"})})})}})},e.prototype.exec=function(){var e=this;if("*"!==this._query.table){var t=this,n=this._query.action.toLowerCase();if(["tocolumn","torow"].indexOf(n)>-1){if(this._query.debounce){var r=i.hash(JSON.stringify([this._query.table,n,this._query.actionArgs,this._query.on,this._query.where].filter(function(e){return e})));return new i.Promise(function(t,i){a[r]&&clearTimeout(a[r]),a[r]=setTimeout(function(){e.denormalizationQuery(n).then(t)},e._query.debounce)})}return this.denormalizationQuery(n)}if(!(["select","upsert","delete","drop","show tables","describe"].indexOf(n)>-1))throw Error("nSQL: No valid database action!");var o=this._query.actionArgs||("select"===n||"delete"===n?[]:{});if("upsert"===n){this._db.rowFilters[this._query.table]&&(o=this._db.rowFilters[this._query.table](o));for(var u={},c=this._db.dataModels[this._query.table],f=0;f<c.length;)void 0!==o[c[f].key]&&(u[c[f].key]=i.cast(c[f].type,o[c[f].key])),f++;if(this._db.skipPurge[this._query.table]){var l=c.map(function(e){return e.key});Object.keys(o).filter(function(e){return-1===l.indexOf(e)}).forEach(function(e){u[e]=o[e]})}o=u}return this._query.action=n,this._query.actionArgs=this._query.actionArgs?o:void 0,new i.Promise(function(n,r){Array.isArray(e._query.table)?e._db.iB.doExec&&e._db.iB.doExec(e._query,function(e){n(e.result)}):(!0!==t._db.isConnected&&"_util"!==t._query.table&&(t._error="nSQL: Database not connected, can't do a query!"),t._db.plugins.length||(t._error="nSQL: No plugins, nothing to do!"),t._error?r(t._error):e._db.queryMod?e._db.queryMod(e._query,function(t){e._query=t,s(e,n)}):s(e,n))})}},e}();t._NanoSQLQuery=u},function(e,t,n){e.exports=n(6)}])});
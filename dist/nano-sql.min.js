!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.e?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=6)}([function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(2),o=n(1);t.t=function(e){return JSON.parse(JSON.stringify(e))};var i=function(){function e(){var e=this;e.r={},e.a={},e._={},e.u=[],e.f=[],e.h=["change","delete","upsert","drop","select","error"],e.y={},e.b={},e.g={},e.y["*"]={},e.v=[];for(var t=e.h.length;t--;)e.y["*"][e.h[t]]=[];e.x={},e.k={}}return e.prototype.table=function(e){return e&&(this.w=e),this},e.prototype.connect=function(e){var t=this,n=this;return n.backend?new o.O(function(e,t){throw t(),Error()}):(n.backend=e||new r.I,new o.O(function(e,r){n.backend.S({_:n._,r:n.r,a:n.a,x:n.x,P:n.u,N:t,T:function(t){e(t,n)},j:function(e){r&&r(e,n)}})}))},e.prototype.on=function(e,t){var n=this,r=n.w,o=0,i=e.split(" ");if(!n.y[r])for(n.y[r]={},n.y[r]["*"]=[];o--;)n.y[r][n.h[o]]=[];for(o=i.length;o--;)-1!==n.h.indexOf(i[o])&&n.y[r][i[o]].push(t);return n.D(),n},e.prototype.off=function(e){var t=this;for(var n in t.y)for(var r in t.y[n])t.y[n][r]=t.y[n][r].filter(function(t){return t!==e});return t.D(),t},e.prototype.D=function(){var e=this;this.g={},Object.keys(this._).concat(["*"]).forEach(function(t){e.g[t]=e.h.reduce(function(n,r){return n+(e.y[t]?e.y[t][r].length:0)},0)>0})},e.prototype.model=function(e){var t=this,n=t.w,r=t.h.length;if(!t.y[n])for(t.y[n]={},t.y[n]["*"]=[];r--;)t.y[n][t.h[r]]=[];return t._[n]=e,t.v.push(n),t.a[n]=[],t.r[n]=[],t},e.prototype.views=function(e){return this.a[this.w]=e,this},e.prototype.getView=function(e,t){return void 0===t&&(t={}),this.A("View",this.a[this.w],e,t)},e.prototype.cleanArgs=function(e,t){var n=this,r=(n.w,{}),o=e.length?e.length:-1;if(o>0)for(;o--;){var i=e[o].split(":");i.length>1?r[i[0]]=n.L(i[1],t[i[0]]||null):r[i[0]]=t[i[0]]||null}return r},e.prototype.L=function(e,n){var r=this,o={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},i=typeof n,a=function(e,n){switch(e){case"safestr":return a("string",n).replace(/[&<>"'`=\/]/g,function(e){return o[e]});case"int":return"number"!==i||n%1!=0?parseInt(n||0):n;case"float":return"number"!==i?parseFloat(n||0):n;case"any[]":case"array":return Array.isArray(n)?t.t(n||[]):[];case"uuid":case"timeId":case"timeIdms":case"string":return null===n?"":"string"!==i?String(n):n;case"map":return"object"===i?t.t(n||{}):{};case"bool":return!0===n}return n},s=a(e,n);if(-1!==e.indexOf("[]")){var _=e.slice(0,e.lastIndexOf("[]"));return(n||[]).map(function(e){return r.L(_,e)})}if(void 0!==s)return-1!==["int","float"].indexOf(e)&&isNaN(s)?0:s},e.prototype.actions=function(e){return this.r[this.w]=e,this},e.prototype.doAction=function(e,t){return this.A("Action",this.r[this.w],e,t)},e.prototype.A=function(e,t,n,r){var i=this,a=this,s=t.reduce(function(e,t){return t.name===n?t:e},null);if(!s)return new o.O(function(e,t){return t("Action/View Not Found!")});a.M=n;var _=s.args?a.cleanArgs(s.args,r):{};return a.C?new o.O(function(t,n){a.C(i.w,e,a.M||"",_,function(e){!!s&&s.call(e,a).then(function(e){t(e,a)})},function(e){n(e)})}):s.call(_,a)},e.prototype.newFunction=function(e,t,n){return this.x[e]={type:t,call:n},this},e.prototype.query=function(e,t,n){var r=this,o=new s(r.w,r,r.M);r.M=void 0;var i=e.toLowerCase();if(-1===["select","upsert","delete","drop","show tables","describe"].indexOf(i))throw Error;var a=t||("select"===i||"delete"===i?[]:{});if(-1!==["upsert","delete","drop"].indexOf(i)&&r.f.push(r.w),"delete"===e&&!n){var _={};r._[r.w].forEach(function(e){-1!==r.v.indexOf(e.type.replace("[]",""))&&(a[e.key]=void 0)}),a=_}if("upsert"===e){var c={};n?c=a:r._[r.w].forEach(function(e){if(-1!==r.v.indexOf(e.type.replace("[]",""))&&(a[e.key]=void 0),void 0!==a[e.key]){var t=r.L(e.type,a[e.key]);void 0!==t&&(c[e.key]=t)}}),r.k[r.w]&&(c=r.k[r.w](c)),a=c}return o.R={type:i,args:a},o},e.prototype.updateORM=function(e,t,n){return new a(this,this.w,e,t,n)},e.prototype.defaultORM=function(e){return this.b[this.w]=e,this},e.prototype.triggerEvent=function(e,t){var n=this;setTimeout(function(){for(var r,o,i=t.length,a=0;i--;)for(r=t[i],o=n.y[e.table][r].concat(n.y[e.table]["*"]),a=o.length;a--;)e.name=r,o[a](e,n)},0)},e.prototype.default=function(e){var t={},n=this;return n._[n.w].forEach(function(r){t[r.key]=e&&e[r.key]?e[r.key]:r.default,t[r.key]||(t[r.key]=n.L(r.type,null))}),t},e.prototype.beginTransaction=function(){if(this.doingTransaction=!0,this.f=[],this.backend.q)return this.backend.q("start")},e.prototype.endTransaction=function(){var e=this;if(this.doingTransaction=!1,this.f.forEach(function(t){0!==t.indexOf("_")&&e.triggerEvent({table:t,query:[],time:(new Date).getTime(),result:[],name:"change",actionOrView:"",changeType:"transaction",changedRows:[]},["change"])}),this.backend.q)return this.backend.q("end")},e.prototype.queryFilter=function(e){return this.F=e,this},e.prototype.avFilter=function(e){return this.C=e,this},e.prototype.config=function(e){var t=this;return t.backend||t.u.push(e),t},e.prototype.extend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=this;if(n.backend)return n.backend.Q?(e.unshift(n),n.backend.Q.apply(n.backend,e)):void 0},e.prototype.loadJS=function(e,t){var n=this;return n.beginTransaction(),new o.O(function(r,o){var i=0,a=[],s=function(){i<t.length?t[i]?n.table(e).query("upsert",t[i]).exec().then(function(e){a.push(e),i++,s()}):(i++,s()):(n.endTransaction(),r(a,n))};s()})},e.prototype.rowFilter=function(e){return this.k[this.w]=e,this},e.prototype.loadCSV=function(e,t){var n=this,r=[];return n.beginTransaction(),console.log("CSV"),new o.O(function(i,a){o.O.all(t.split("\n").map(function(t,i){return new o.O(function(o,a){if(0===i)r=t.split(","),o();else{for(var s={},_=t.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)||[],c=r.length;c--;)1===_[c].indexOf("{")||1===_[c].indexOf("[")?_[c]=JSON.parse(_[c].slice(1,_[c].length-1).replace(/'/gm,'"')):0===_[c].indexOf('"')&&(_[c]=_[c].slice(1,_[c].length-1)),s[r[c]]=_[c];n.table(e).query("upsert",s).exec().then(function(){o()})}})})).then(function(){n.endTransaction(),i([],n)})})},e.B=function(){if("undefined"==typeof crypto)return Math.round(Math.random()*Math.pow(2,16));if(crypto.getRandomValues){var e=new Uint16Array(1);return crypto.getRandomValues(e),e[0]}return"undefined"!==global&&global.V.randomBytes?global.V.randomBytes(2).reduce(function(e,t){return t*e}):Math.round(Math.random()*Math.pow(2,16))},e.timeid=function(e){var t=this;t.K||(t.K=6e4*(new Date).getTimezoneOffset());for(var n=Math.round(((new Date).getTime()+t.K)/(e?1:1e3)).toString();n.length<(e?13:10);)n="0"+n;return n+"-"+(t.B()+t.B()).toString(16)},e.uuid=function(){var e,t,n=this,r="";return[r,r,r,r,r,r,r,r,r].reduce(function(o,i,a){for(e=n.B(),t=4===a?a:5===a?(e%16&3|8).toString(16):r,e=e.toString(16);e.length<4;)e="0"+e;return o+([3,4,5,6].indexOf(a)>=0?"-":r)+(t+e).slice(0,4)},r)},e.J=function(e){return Math.abs(e.split("").reduce(function(t,n,r){return(t<<5)+t+e.charCodeAt(r)},0))},e}();t.NanoSQLInstance=i;var a=function(){function e(e,t,n,r,o){this.W=e,this.H=t,this.R=n,this.z=r||"",this.U=o||[]}return e.prototype.where=function(e){return this.X=e,this},e.prototype.rebuild=function(e){var n=this;n.W.beginTransaction();var r=n.W._[n.H].filter(function(e){return-1!==n.W.v.indexOf(e.type.replace("[]",""))}).map(function(e){var t=e.type.replace("[]","");return{key:e.key,tablePK:n.W._[t].reduce(function(e,t){return t.props&&-1!==t.props.indexOf("pk")?t.key:e},""),table:t,type:-1===e.type.indexOf("[]")?"single":"array"}}),i=n.W._[n.H].reduce(function(e,t){return t.props&&-1!==t.props.indexOf("pk")?t.key:e},""),a=0,s=function(){n.W.table(n.H).query("select").range(1,a).exec().then(function(_){_.length?o.O.all(r.map(function(e){return new o.O(function(r,o){var a;a=void 0===_[0][e.key]?"single"===e.type?"":[]:t.t(_[0][e.key]),"single"===e.type&&(a=[a]),a=a.filter(function(e,t,n){return n.indexOf(e)===t}),n.W.table(e.table).query("select").where([e.tablePK,"IN",a]).exec().then(function(t){var r=t.length?t.map(function(t){return t[e.tablePK]}):[];return n.W.table(n.H).updateORM("set",e.key,r).where([i,"=",_[0][i]]).exec()}).then(function(){r()})})})).then(function(){a++,s()}):(n.W.endTransaction(),e(a))})};s()},e.prototype.exec=function(){var e=this;return new o.O(function(n,r){if("rebuild"===e.R)return e.rebuild(n);var i=e.W._[e.H].filter(function(e){return e.props&&-1!==e.props.indexOf("pk")})[0].key,a=e.W._[e.H].filter(function(t){return t.key===e.z})[0],s=a.type.replace("[]",""),_=e.W._[s].filter(function(e){return e.props&&-1!==e.props.indexOf("pk")})[0].key,c=-1!==a.type.indexOf("[]"),u=a.props&&a.props.filter(function(e){return-1!==e.indexOf("orm::")})[0],l="single";u&&(u=u.replace("orm::",""),l=-1===e.W._[s].filter(function(e){return e.key===u})[0].type.indexOf("[]")?"single":"array"),i&&i.length&&_&&_.length||r("Relation models require a primary key!");var f=e.W.table(e.H).query("select");e.X&&f.where(e.X),f.exec().then(function(r){var a=0,f=function(){if(a<r.length){var d=t.t(r[a]),p=[];switch(void 0!==d[e.z]&&(p=d[e.z]),Array.isArray(p)||(p=[p]),e.R){case"set":case"add":c?(void 0===d[e.z]&&(d[e.z]=[]),Array.isArray(d[e.z])||(d[e.z]=[]),"set"===e.R?d[e.z]=e.U:(d[e.z]=d[e.z].concat(e.U),d[e.z]=d[e.z].filter(function(e,t,n){return n.indexOf(e)===t}))):d[e.z]=e.U[0];break;case"delete":if(c){var h=d[e.z].indexOf(r[a][i]);-1!==h&&(d[e.z]=d[e.z].splice(h,1))}else d[e.z]="";break;case"drop":d[e.z]=c?[]:void 0}var y=function(t,n){e.W.table(s).query("upsert",t,!0).exec().then(n)},b=function(){return o.O.all(p.map(function(n){return new o.O(function(o,c){e.W.table(s).query("select").where([_,"=",n]).exec().then(function(e){if(!e.length)return void o();var n=t.t(e[0]);if(Array.isArray(n[u])){var s=n[u].indexOf(r[a][i]);-1!==s&&(n[u]=n[u].splice(s,1))}else n[u]="";y(n,o)})})}))};e.W.table(e.H).query("upsert",d,!0).exec().then(function(){if(u)switch(e.R){case"set":case"add":var n=0,o=function(){n<e.U.length?e.W.table(s).query("select").where([_,"=",e.U[n]]).exec().then(function(s){if(!s.length)return n++,void o();var _=t.t(s[0]);void 0===_[u]&&(_[u]="array"===l?[]:""),"array"===l?(Array.isArray(_[u])||(_[u]=[]),_[u].push(r[a][i]),_[u]=_[u].filter(function(e,t,n){return n.indexOf(e)===t}),y(_,function(){n++,o()})):_[u]&&_[u].length?e.W.table(e.H).query("select").where([i,"=",_[u]]).exec().then(function(s){var c=t.t(s[0]);Array.isArray(c[e.z])?-1===c[e.z].indexOf(_[u])&&(c[e.z]=c[e.z].splice(c[e.z].indexOf(_[u]),1)):c[e.z]="",e.W.table(e.H).query("upsert",c,!0).where([i,"=",_[u]]).exec().then(function(){_[u]=r[a][i],y(_,function(){n++,o()})})}):(_[u]=r[a][i],y(_,function(){n++,o()}))}):(a++,f())};o();break;case"delete":case"drop":b().then(function(){a++,f()})}else a++,f()})}else n(a)};f()})})},e}();t.G=a;var s=function(){function e(e,t,n){this.W=t,this.$=[],this.Y=e,this.Z=n||""}return e.prototype.where=function(e){return e.length&&Array.isArray(e)||(this.ee="Where condition requires an array!"),this.te("where",e)},e.prototype.range=function(e,t){return this.te("range",[e,t])},e.prototype.orm=function(e){return this.te("orm",e)},e.prototype.orderBy=function(e){return this.te("orderby",e)},e.prototype.groupBy=function(e){return this.te("groupby",e)},e.prototype.having=function(e){return e.length&&Array.isArray(e)||(this.ee="Having condition requires an array!"),this.te("having",e)},e.prototype.join=function(e){return e.table&&e.type||(this.ee="Join command requires table and type arguments!"),this.te("join",e)},e.prototype.limit=function(e){return this.te("limit",e)},e.prototype.trieSearch=function(e,t){return this.te("trie",[e,t])},e.prototype.offset=function(e){return this.te("offset",e)},e.prototype.te=function(e,t){return this.$.push({type:e,args:t}),this},e.prototype.toCSV=function(e){var n=this;return new o.O(function(r,o){n.exec().then(function(o){o=t.t(o);var i=n.R.args.length?n.R.args.map(function(e){return n.W._[n.Y].filter(function(t){return t.key===e})[0]}):n.W._[n.Y];e&&o.unshift(i.map(function(e){return e.key})),r(o.map(function(t,n){return e&&0===n?t:i.filter(function(e){return!!t[e.key]}).map(function(e){var n=e.type;switch(-1!==n.indexOf("[]")&&(n="any[]"),n){case"map":case"any[]":case"array":return'"'+JSON.stringify(t[e.key]).replace(/"/g,"'")+'"';case"string":case"safestr":return'"'+t[e.key].replace(/"/g,'"')+'"';default:return t[e.key]}}).join(",")}).join("\n"),n)})})},e.prototype.exec=function(){var e=this,t=e.Y;return e.W.g[t]&&(e.W.ne=function(){switch(e.R.type){case"select":return[e.R.type];case"delete":case"upsert":case"drop":return[e.R.type,"change"];default:return[]}}()),new o.O(function(n,r){if(e.ee)throw r(e.ee),Error;if(!e.W.backend)throw r(),Error;var o=function(n,r,o,i,a){e.W.g[t]&&e.W.triggerEvent({name:"error",actionOrView:e.Z,table:t,query:[e.R].concat(e.$),time:(new Date).getTime(),result:n,changeType:o,changedRows:i},e.W.ne),r(n,e.W)},i={table:t,query:[e.R].concat(e.$),viewOrAction:e.Z,onSuccess:function(t,r,i){e.W.doingTransaction?n(t,e.W):o(t,n,r,i)},onFail:function(t){e.W.doingTransaction?n(t,e.W):(e.W.ne=["error"],r&&o(t,r,"error",[]))}};e.W.F?e.W.F(i,function(t){e.W.backend.re(t)}):e.W.backend.re(i)})},e}();t.oe=s;var _=new i;t.nSQL=function(e){return _.table(e)}},function(e,t,n){"use strict";function r(e,n,r){t.setFast(function(){var t;try{t=n.apply(null,r)}catch(t){return m.ie(e,t)}return t===e?m.ie(e,new TypeError):m.ae(e,t),null})}function o(e){var t=e&&e.then;return!e||"object"!=typeof e&&"function"!=typeof e||"function"!=typeof t?null:function(){t.apply(e,arguments)}}function i(e,t){function n(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];i||(i=!0,m.ie(e,t))}function r(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];i||(i=!0,m.ae(e,t))}function o(){t(r,n)}var i=!1,s=a(o);"error"===s.se&&n(s._e)}function a(e,t){var n={se:null,_e:null};try{n._e=e(t),n.se="success"}catch(e){n.se="error",n._e=e}return n}Object.defineProperty(t,"__esModule",{value:!0});var s=0,_={},c=!0,u=Array.prototype.slice,l=function(e){var t=e[0];switch(e.length){case 1:return t();case 2:return t(e[1]);case 3:return t(e[1],e[2])}return t.apply(window,u.call(e,1))},f=function(e){var t,n=e.data;"string"==typeof n&&0==n.indexOf("setIlMessage")&&(t=_[n])&&(delete _[n],l(t))},d=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=s++,r="setIlMessage"+n;return _[r]=e,c&&(c=!1,window.addEventListener("message",f)),window.postMessage(r,"*"),n};t.setFast="undefined"==typeof process?d:setImmediate;var p=function(){},h=["R"],y=["F"],b=["P"],g=function(){function e(e){this.ce=b,this.ue=[],this.le=void 0,e!==p&&i(this,e)}return e.prototype.catch=function(e){return this.then(function(){},e)},e.prototype.then=function(t,n){if("function"!=typeof t&&this.ce===y||"function"!=typeof n&&this.ce===h)return this;var o=new e(p);return this.ce!==b?r(o,this.ce===y?t:n,this.le):this.ue.push(new v(o,t,n)),o},e.resolve=function(t){return t instanceof this?t:m.ae(new e(p),t)},e.reject=function(t){return m.ie(new e(p),t)},e.all=function(t){var n=this,r=t.length,o=!1,i=new Array(r),a=0,s=-1,_=new e(p);if(!r)return this.resolve([]);for(;++s<r;)!function(e,t){function s(e){i[t]=e,++a!==r||o||(o=!0,m.ae(_,i))}n.resolve(e).then(s,function(e){o||(o=!0,m.ie(_,e))})}(t[s],s);return _},e.race=function(t){var n=this,r=t.length,o=!1,i=-1,a=new e(p);if(!1!==Array.isArray(t))return this.reject(new TypeError);if(!r)return this.resolve([]);for(;++i<r;)!function(e){n.resolve(e).then(function(e){o||(o=!0,m.ae(a,e))},function(e){o||(o=!0,m.ie(a,e))})}(t[i]);return a},e}();t.O=g;var v=function(){function e(e,t,n){this.fe=e,"function"==typeof t&&(this.de=t,this.pe=this.he),"function"==typeof n&&(this.ye=n,this.be=this.ge)}return e.prototype.pe=function(e){m.ae(this.fe,e)},e.prototype.he=function(e){r(this.fe,this.de,e)},e.prototype.be=function(e){m.ie(this.fe,e)},e.prototype.ge=function(e){r(this.fe,this.ye,e)},e}();t.ve=v;var m=function(){function e(){}return e.ae=function(t,n){var r=a(o,n),s=r._e,_=-1,c=t.ue.length;if("error"===r.se)return e.ie(t,r._e);if(s)i(t,s);else for(t.ce=y,t.le=n;++_<c;)t.ue[_].pe(n);return t},e.ie=function(e,t){e.ce=h,e.le=t;for(var n=-1,r=e.ue.length;++n<r;)e.ue[n].be(t);return e},e}()},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=n(1),i=n(5),a=n(3);t.me=function(e){return["_utility","_historyPoints","_pointer","_historyDataRowIDs","_id"][e]};var s=function(){function e(){var e=this;e.xe=[],e.ke={}}return e.prototype.S=function(e){var t=this;t.we=r.NanoSQLInstance.J(JSON.stringify(e._)).toString(),t.N=e.N,t.Oe=new i.Ie(t,e)},e.prototype.re=function(e){var t=this;new a.oe(t).Se(e)},e.prototype.Pe=function(e,t,n,r){var o=this;o.ke[e]={},t.length&&r&&o.N.triggerEvent({name:"change",actionOrView:"",table:o.Oe.Ee[e].Ne,query:[],time:(new Date).getTime(),result:[{msg:r+" was performed.",type:r}],changedRows:t,changeType:n},["change"])},e.prototype.Te=function(e,t){if(!e)return e;var n=this;return t&&n.Oe._[t].forEach(function(t){var r=e[t.key];(["map","array"].indexOf(t.type)>=0||t.type.indexOf("[]")>=0)&&(e[t.key]=n.Te(r))}),Object.freeze(e)},e.prototype.q=function(e){var t=this;return"start"===e&&(t.Oe.je={},t.Oe.De=!0),"end"===e&&(t.Oe.De=!1,t.Oe.Ae(),t.N.v.forEach(function(e){t.Pe(r.NanoSQLInstance.J(e),[],"transaction")})),!!t.Oe.De},e.prototype.Q=function(e,n){var i,a,s=this,c=function(e,n){var o={},a=s.Oe.Le-s.Oe.Me;s.Oe.Ce(t.me(1),s.Oe.Re[a],function(a){(new _).loop(a,function(n,a){var c=n.tableID,u=s.Oe.Ee[c],l=[];(new _).loop(n.rowKeys,function(a,_){"int"===u.qe&&(a=parseInt(a)),s.Oe.Fe(u.Ne,a,function(f){s.Oe.Fe("_"+u.Ne+"_hist__meta",a,function(f){f=r.t(f),f[0][t.me(2)]=(f[0][t.me(2)]||0)+e;var d=f[0][t.me(3)][f[0][t.me(2)]];s.Oe.Qe("_"+u.Ne+"_hist__meta",a,f[0],function(){s.Oe.Fe("_"+u.Ne+"_hist__data",d,function(e){var t=e[0]?r.t(e[0]):null;s.Oe.Qe(u.Ne,a,t,function(){l.push(t),o[c]||(o[c]={type:n.type,rows:[]}),o[c].rows=o[c].rows.concat(l),i++,_()})})})})})}).then(a)}).then(function(){n(o)})})};return new o.O(function(e,t){switch(n){case"<":s.Oe.Le&&s.Oe.Me!==s.Oe.Le?c(1,function(t){s.Oe.Me++,s.Oe.Be("w","historyPoint",s.Oe.Me),Object.keys(t).forEach(function(e){var n=t[e].type;switch(n){case"inserted":n="deleted";break;case"deleted":n="inserted"}s.Pe(parseInt(e),t[e].rows,n,"undo")}),e(!0)}):e(!1);break;case">":!s.Oe.Le||s.Oe.Me<1?e(!1):(s.Oe.Me--,s.Oe.Be("w","historyPoint",s.Oe.Me),c(-1,function(t){Object.keys(t).forEach(function(e){s.Pe(parseInt(e),t[e].rows,t[e].type,"redo")}),e(!0)}));break;case"?":a=[s.Oe.Le,s.Oe.Le-s.Oe.Me],s.Oe.Ve.join("+")!==a.join("+")&&(s.Oe.Ve=a),e(s.Oe.Ve);break;case"flush_history":case"flush_db":s.Oe.Be("w","historyPoint",0),s.Oe.Be("w","historyLength",0),s.Oe.Me=0,s.Oe.Le=0,Object.keys(s.Oe.Ee).forEach(function(e){var t;0===s.Oe.Ee[parseInt(e)].Ne.indexOf("_")?t=[]:(t=s.Oe.Ee[parseInt(e)].Ke,t=Object.keys(t).map(function(e){return t[e]})),s.Pe(parseInt(e),t,"remove","clear")}),"flush_db"===n?s.Oe.Je("all",e):s.Oe.Je("hist",e)}})},e}();t.I=s;var _=function(){function e(){}return e.prototype.loop=function(e,t){return new o.O(function(n,r){var o=0,i=[],a=function(){o<e.length?t(e[o],function(e){i.push(e),o++,a()}):n(i)};a()})},e}();t.We=_},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=n(2),i=n(1),a=function(e,t,n,o,i){var a=n[0];0===o[0]&&(i[a]=-1===e?Number.MAX_VALUE:Number.MIN_VALUE);var s={};if(s=(-1===e?parseFloat(t[a])<parseFloat(i[a]):parseFloat(t[a])>parseFloat(i[a]))?t:i,o[0]===o[1]){var _=r.t(s);return _[-1===e?"MIN":"MAX"]=s[a],_}return s};t.x={SUM:{type:"aggregate",call:function(e,t,n,o){if(0===n[0]&&(o=0),o+=parseInt(e[t[0]]),n[0]===n[1]){var i=r.t(e);return i.SUM=o,i}return o}},MIN:{type:"aggregate",call:function(e,t,n,r){return a(-1,e,t,n,r)}},MAX:{type:"aggregate",call:function(e,t,n,r){return a(1,e,t,n,r)}},AVG:{type:"aggregate",call:function(e,t,n,o){if(0===n[0]&&(o=0),o+=parseInt(e[t[0]]),n[0]===n[1]){var i=r.t(e);return i.AVG=o/(n[1]+1)||o,i}return o}},COUNT:{type:"aggregate",call:function(e,t,n,o){if(0===n[0]&&(o=0),"*"===t[0]?o++:o+=e[t[0]]?1:0,n[0]===n[1]){var i=r.t(e);return i.COUNT=o,i}return o}}};var s=function(){function e(e){this.W=e}return e.prototype.Se=function(e){var t=this;t.He=r.NanoSQLInstance.J(e.table),t.ze=[],t.Ue=void 0;var n=[];if(e.query.forEach(function(o){["upsert","select","delete","drop"].indexOf(o.type)>=0?(t.Ue=o,"select"===o.type&&(t.Xe=r.NanoSQLInstance.J(JSON.stringify(e.query)))):["show tables","describe"].indexOf(o.type)>=0?n.push(o):t.ze.push(o)}),n.length)switch(n[0].type){case"show tables":e.onSuccess([{tables:Object.keys(t.W.Oe.Ee).map(function(e){return t.W.Oe.Ee[e].Ne})}],"info",[]);break;case"describe":var o,i=t.He,a={};Object.keys(t.W.Oe.Ee).forEach(function(e){parseInt(e)===t.He&&(o=r.t(t.W.Oe._[e]),i=t.W.Oe.Ee[e].Ne)}),a[i]=o,e.onSuccess([a],"info",[])}else t.Ge(function(t,n,r){e.onSuccess(t,n,r)})},e.prototype.$e=function(e){return this.ze.filter(function(t){return t.type===e}).pop()},e.prototype.Ge=function(e){var t=this;if(t.Ue){var n=function(n){if(t.Ue)switch(t.Ue.type){case"upsert":t.Qe(n,e);break;case"select":t.Ye(n,e);break;case"drop":var o=0,i=r.Ze.slice(),a=function(){o<i.length?t.W.Oe.Fe(r.Ne,i[o],function(e){t.et(e,function(){o++,a()})}):e([],"drop",i.map(function(e){return{}}))};a();break;case"delete":t.et(n,e)}},r=t.W.Oe.Ee[t.He];if(t.$e("join")||"drop"===t.Ue.type)n([]);else if(t.$e("where")){var i=t.$e("where").args,a=function(e){return-1===["=","IN","BETWEEN"].indexOf(e[1])||e[0]!==r.tt&&-1===r.nt.indexOf(e[0])?1:0},s=function(e,n){var o=e[0]===r.tt?r.Ne:"_"+r.Ne+"_idx_"+e[0],i=e[0]!==r.tt;switch(e[1]){case"=":t.W.Oe.Fe(o,i?String(e[2]).toLowerCase():e[2],function(e){n(e)});break;case"IN":t.W.Oe.Ce(o,i?String(e[2]).toLowerCase():e[2],function(e){n(e)});break;case"BETWEEN":i&&e[2].map(function(e){return String(e).toLowerCase()}),t.W.Oe.rt(o,e[0],e[2],n)}};if("string"==typeof i[0]?0===a(i):0===i.reduce(function(e,t,n){return n%2==1?e:e+a(t)},0))if("string"==typeof i[0])s(i,n);else{var _=[];(new o.We).loop(i,function(e,t){s(e,function(e){_=_.concat(e),t()})}).then(function(){n(_)})}else t.W.Oe.Fe(r.Ne,function(e){return e&&t.ot(e,i)},function(e){n(e)})}else if(t.$e("range")){var c=t.$e("range").args;t.it(c[0],c[1],n)}else if(t.$e("trie")){var u=t.$e("trie").args,l=r.at[u[0]].getPrefix(u[1]),f="_"+r.Ne+"_idx_"+u[0];t.W.Oe.Ce(f,l,function(e){n(e)})}else"upsert"!==t.Ue.type?t.W.Oe.Fe(r.Ne,"all",function(e){n(e)}):n([])}},e.prototype.it=function(e,t,n){var r=this,o=r.W.Oe.Ee[r.He],i=o.Ze[t],a=o.Ze[t+(e-1)];i?r.W.Oe.rt(o.Ne,o.tt,[i,a],function(e){n(e)}):n([])},e.prototype.st=function(e,t){var n=this,i=n.W.Oe.Ee[n.He],a=n.Ue.args,s={},_=function(){return n.Ue?n.Ue.type:""}(),c=function(e,t){if(0!==i.Ne.indexOf("_")){var o=[],a=function(r,a,s){n.W.Oe.Fe(r,a,function(_){var c=[];_.length&&_[0].rowPK&&(c=c.concat(_[0].rowPK)),t||c.push(e[i.tt]),c=c.filter(function(n,r){return c.indexOf(n)===r||!(t&&n===e[i.tt])}),c.length?n.W.Oe.Qe(r,a,{id:a,rowPK:c},function(){}):(o.push(s),n.W.Oe._t(r,a))},!0)};i.nt.forEach(function(t){var o="_"+i.Ne+"_idx_"+t,_=String(e[t]).toLowerCase(),c=String(s[t]).toLowerCase();_!==c&&s[t]?n.W.Oe.Fe(o,c,function(e){var s=e[0]?r.t(e[0].rowPK||[]):[],u=s.indexOf(c[i.tt]);-1!==u&&s.splice(u,1),n.W.Oe.Qe(o,c,{id:c,rowPK:s},function(){a(o,_,t)})}):void 0!==e[t]&&a(o,_,t)}),i.ct.forEach(function(t){var r=String(e[t]).toLocaleLowerCase();-1!==o.indexOf(t)?n.W.Oe.Ee[n.He].at[t].removeWord(r):n.W.Oe.Ee[n.He].at[t].addWord(r)})}},u=function(r){"upsert"===_?n.W.Oe.Qe(i.Ne,e,r,function(){t()}):n.W.Oe._t(i.Ne,e,function(){t()})};if(n.W.Oe.De)return void("upsert"===_?(n.W.Oe.Ee[n.He].ut.forEach(function(e,t){var n=i.lt[t];void 0===a[e]&&void 0!==n&&(a[e]=n)}),u(a)):u({}));n.W.Oe.Fe(i.Ne,e,function(t){s=t[0]||{};var l=r.t(t[0]||{}),f=!1,d=function(t){0!==i.Ne.indexOf("_")&&n.W.Oe.ft&&i.tt.length&&n.W.Oe.Fe("_"+i.Ne+"_hist__meta",e,function(a){a.length&&a[0]?a=r.t(a):(a[0]={},a[0][o.me(2)]=0,a[0][o.me(3)]=[],a[0].id=e),a[0][o.me(3)].unshift(t),n.W.Oe.Qe("_"+i.Ne+"_hist__meta",e,a[0])}),c("upsert"===_?l:{}),u(l)},p=function(){if(!f&&0!==i.Ne.indexOf("_")&&n.W.Oe.ft){var e="_"+i.Ne+"_hist__data",t=r.NanoSQLInstance.J(e);l[o.me(4)]=n.W.Oe.Ee[t].Ze.length,n.W.Oe.Qe(e,null,l,function(e){d(e)})}else d(0)};switch(_){case"upsert":Object.getOwnPropertyNames(a).forEach(function(e){l[e]=a[e]});var h=n.W.Oe.Ee[n.He];h.ut.forEach(function(e,t){var n=h.lt[t];l[e]||void 0===n||(l[e]=n)}),p();break;case"delete":case"drop":a&&a.length&&"drop"!==_?(a.forEach(function(e){l[e]=null}),p()):(f=!0,l={},n.W.Oe.Ee[n.He].dt.length?n.W.Oe.Ee[n.He].dt.forEach(function(t){if(t.pt.length){var o=n.W.Oe.Ee[r.NanoSQLInstance.J(t.Y)].tt,i=s[t.ht]||[];Array.isArray(i)||(i=[i]),n.W.N.table(t.Y).updateORM("delete",t.pt,[e]).where([o,"IN",i]).exec().then(function(){p()})}else p()}):p())}})},e.prototype.yt=function(e,t,n){var i=this,a=this,s=0,_=0;if(a.W.Oe.De)return void n([],"trans",[]);if(e.length>0){var c=function(){var r=a.W.Oe.Ee[i.He];a.W.Pe(a.He,[],""),a.W.Oe.Ce(r.Ne,e,function(r){n([{msg:e.length+" row(s) "+t}],t,r)})},u=function(){if(a.W.Oe.ft){a.W.Oe.De||0!==a.W.Oe.Me||a.W.Oe.Le++,a.W.Oe.Be("w","historyLength",a.W.Oe.Le),a.W.Oe.Be("w","historyPoint",a.W.Oe.Me);var n=a.W.Oe.Le-a.W.Oe.Me;a.W.Oe.Qe(o.me(1),null,{historyPoint:n,tableID:a.He,rowKeys:e,type:t},function(e){a.W.Oe.Re[n]||(a.W.Oe.Re[n]=[]),a.W.Oe.Re[n].push(e),c()})}else c()};if(a.W.Oe.ft)if(a.W.Oe.Me>0){for(var l=[],f=a.W.Oe.Le-a.W.Oe.Me+1;a.W.Oe.Re[f];)l=l.concat(a.W.Oe.Re[f].slice()),delete a.W.Oe.Re[f],f++;a.W.Oe.Ce(o.me(1),l,function(e){_=0;var t=function(){if(!(_<e.length))return a.W.Oe.Le-=a.W.Oe.Me,a.W.Oe.Me=0,void u();var n=a.W.Oe.Ee[e[_].tableID].Ne;s=0;var i=function(){s<e[_].rowKeys.length?a.W.Oe.Fe("_"+n+"_hist__meta",e[_].rowKeys[s],function(t){t[0]=r.t(t[0]),t[0][o.me(2)]=0;var c=t[0][o.me(3)].shift();a.W.Oe.Qe("_"+n+"_hist__meta",e[_].rowKeys[s],t[0],function(){c?a.W.Oe._t("_"+n+"_hist__data",c,function(){s++,i()}):(s++,i())})}):(_++,t())};a.W.Oe._t(o.me(1),e[_].id,function(){i()})};t()})}else u();else u()}else n([{msg:"0 rows "+t}],t,[])},e.prototype.Qe=function(e,t){var n,r=this,i="",a=[],s=r.Ue.args||{},_=r.W.Oe.Ee[r.He],c=_.tt;if(r.$e("where")){i="modified",a=e.map(function(e){return e[_.tt]}),n=0;var u=function(){n<e.length?r.st(e[n][c],function(){n++,u()}):r.yt(a,i,t)};u()}else{i="inserted",s[c]?"int"===_.qe&&(_.bt=Math.max(s[c]+1,_.bt)):s[c]=r.W.Oe.gt(_.qe,r.He);var l=s[c]?s[c]:_.Ze.length;if(a=[l],!_.vt.getPrefix(String(l)).length){var f=r.W.Oe.Ee[r.He].Ne;if(0!==f.indexOf("_")&&r.W.Oe.ft){var d="_"+f+"_hist__meta",p={};p[o.me(2)]=0,p[o.me(3)]=[0],r.W.Oe.Qe(d,l,p)}}r.st(l,function(){r.yt(a,i,t)})}},e.prototype.mt=function(){return this.xt?this.xt:this.He},e.prototype.Ye=function(e,n){var o=this;o.W.ke[o.He][o.Xe];var a,s,_=["join","groupby","having","orderby","offset","limit","orm"],c={},u=function(e,t,n){return Object.keys(n).reduce(function(r,o){var i=e[o],a=t[o];return"length"===o.split(".").pop()&&(i=e[o.replace(".length","")].length,a=t[o.replace(".length","")].length),r||(i===a?0:(i>a?1:-1)*("desc"===n[o]?-1:1))},0)},l=function(e,n,s){if(a=o.$e(_[n]),2===n){var l=[];if(f.length){var d=Object.keys(t.x).map(function(e){return e+"("}),p=[];l=f.filter(function(e){return(d.reduce(function(t,n){return(e.indexOf(n)<0?0:1)+t},0)||0)>0||(p.push(e),!1)}).map(function(e){var n=e.match(/(.*)\((.*)\)/),r=n[1].trim(),o=(e.match(/\sAS\s(.*)/)||[]).pop()||r,i=n[2].split(",").map(function(e){return e.trim()});return"simple"===t.x[r].type&&o===r&&(o=i[0]),p.push(o),{name:r,args:i,as:o.trim(),type:t.x[r].type}});var h=[];if(l.length){var y,b=function(e){return l.sort(function(e,t){return e.type>t.type?1:-1}).reduce(function(n,r){var o=n.length-1;if("aggregate"===r.type){var i=e.slice();o=i.length-1,i=[i.reduce(function(e,n,i){return t.x[r.name].call(n,r.args,[i,o],e)},{})],y&&(i[0][y]=n[0][y]),n=i,y=r.name}else n=n.map(function(e,n){return t.x[r.name].call(e,r.args,[n,o])});return r.name!==r.as?p.push(r.name+" AS "+r.as):p.push(r.name),n},e.slice())},g=Object.keys(c);h=g.length?g.map(function(e){return y=null,b(c[e])}).reduce(function(e,t){return e=e.concat(t)},[]):b(e)}else h=e;var v=p.map(function(e){return e.match(/(.*)\sAS\s(.*)/)||e}).filter(function(e){return e})||[];v.length&&(h=h.map(function(e){e=r.t(e);var t={};return v.forEach(function(n){if("string"==typeof n)if(-1!==n.indexOf(".length")){var r=n.replace(".length","");t[n]=(e[r]||[]).length}else t[n]=e[n];else if(-1!==n[1].indexOf(".length")){var r=n[1].replace(".length","");t[n[2]]=(e[r]||[]).length}else t[n[2]]=e[n[1]]}),t})),e=h}}if(!a)return s(e);switch(n){case 0:var m=void 0;"cross"!==a.args.type&&(m={kt:a.args.where[0],wt:a.args.where[1],Ot:a.args.where[2]});var x=o.He,k=r.NanoSQLInstance.J(a.args.table),w=o.$e("where"),O=o.$e("range");o.It(a.args.type,x,k,m,function(e){w?s(e.filter(function(e){return o.ot(e,w.args)})):O?o.it(O.args[0],O.args[1],s):s(e)});break;case 1:var I=a.args,S={};I?(c=e.reduce(function(e,t){var n=Object.keys(I).reduce(function(e,n){return-1!==n.indexOf(".length")?e+"."+String((t[n.replace(".length","")]||[]).length):e+"."+String(t[n])},"").slice(1);return(e[n]=e[n]||[]).push(t),S[n]=Object.keys(I).reduce(function(e,n){if(-1!==n.indexOf(".length")){var r=n.replace(".length","");e[r]=(t[r]||[]).length}else e[n]=t[n];return e},{}),e},{}),s(Object.keys(c).sort(function(e,t){return u(S[e],S[t],I)}).reduce(function(e,t){return e.concat(c[t])},[]))):s(e);break;case 2:s(e.filter(function(e){return o.ot(e,o.$e("having").args)}));break;case 3:s(e.sort(function(e,t){return u(e,t,a.args)}));break;case 4:s(e.filter(function(e,t){return!a||t>=a.args}));break;case 5:s(e.filter(function(e,t){return!a||t<a.args}));break;case 6:var P=[];a.args&&(P=a.args);var N=o.W.Oe.N.N.b[o.W.Oe.Ee[o.He].Ne];o.$e("join")?s(e):i.O.all(e.map(function(t,n){return e[n]=r.t(t),i.O.all(o.W.Oe.Ee[o.He].dt.map(function(a){var s=a.ht;if(f&&f.length&&f.forEach(function(e){var t=e.split(" ");t[0]===a.ht&&"AS"===t[1]&&(s=t[2])}),void 0===t[s])return new i.O(function(e){return e()});var _=o.W.Oe.Ee[r.NanoSQLInstance.J(a.Y)].tt;return new i.O(function(r,i){var c=void 0;if(N&&(c=N(a.ht,e[n])),P.length&&P.forEach(function(e){"string"!=typeof e&&(e.key!==a.ht&&e.key&&"*"!==e.key||(c=e))}),!c&&-1===P.indexOf(a.ht))return void r();var u=t[s];if(void 0===u)return e[n][s]="single"===a.St?void 0:[],void r();"single"===a.St&&(u=[u]);var l=o.W.N.table(a.Y).query("select");if(c)if(c.where||c.orderBy)c.where?"string"==typeof c.where[0]?l.where([[_,"IN",u],"AND",c.where]):(c.where.push("AND"),c.where.push([_,"IN",u]),l.where(c.where)):l.where([_,"IN",u]),c.orderBy&&l.orderBy(c.orderBy),l.limit(c.limit||5).offset(c.offset||0);else{var f=c.offset||0,d=c.limit||0;l.where([_,"IN",u.filter(function(e,t){return t>=f&&t<f+d})])}else l.where([_,"IN",u.filter(function(e,t){return t<5})]);l.exec().then(function(t){e[n][s]="single"===a.St?t[0]:t,r()})})}))})).then(function(){s(e)})}};s=-1;var f=o.Ue.args||[],d=function(e){s<_.length?(s++,l(e,s,function(e){d(e)})):(e=e.filter(function(e){return e}),!o.$e("join")&&o.$e("orm"),n(e,"none",[]))};d(e)},e.prototype.et=function(e,t){var n,r="deleted",o=this,i=o.Ue.args||[],a=o.W.Oe.Ee[o.He].tt;n=0;var s=function(){n<e.length?o.st(e[n][a],function(){n++,s()}):(i.length&&(r="modified"),o.yt(e.map(function(e){return e[a]}),r,t))};s()},e.prototype.ot=function(e,t){var n=this,r=["AND","OR"],o=function(t){if(-1!==t.indexOf(".length")){var n=e[t.replace(".length","")];return Array.isArray(n)?n.length:0}return e[t]};if("string"!=typeof t[0]){var i;return t.reduce(function(e,t,a){if(-1!==r.indexOf(t))return i=t,e;var s=0===n.Pt(t[2],t[1],o(t[0]));return 0===a?s:"AND"===i?e&&s:e||s},!0)}return 0===n.Pt(t[2],t[1],o(t[0]))},e.prototype.It=function(e,t,n,r,o){var i="outer",a=this,s=a.W.Oe.Ee[t],_=a.W.Oe.Ee[n],c=function(e,t){return[s,_].reduce(function(n,r,o){return r.ut.forEach(function(i){n[r.Ne+"."+i]=((0===o?e:t)||{})[i]}),n},{})},u=[],l=[];a.W.Oe.Fe(s.Ne,"all",function(t){a.W.Oe.Fe(_.Ne,"all",function(n){t.forEach(function(t){var o=n.map(function(e){var n=c(t,e);if(!r)return n;var o=a.ot(n,[r.kt,r.wt,n[r.Ot]]);return o&&l.push(e[_.tt]),o?n:null}).filter(function(e){return e});o.length?u=u.concat(o):["left",i].indexOf(e)>=0&&u.push(c(t,null))}),l=l.sort().filter(function(e,t,n){return!t||e!==n[t-1]}),["right",i].indexOf(e)>=0&&n.filter(function(e){return-1===l.indexOf(e[_.tt])}).forEach(function(e){u.push(c(null,e))}),o(u)})})},e.prototype.Pt=function(e,t,n){var r=function(e){return"LIKE"===t&&"string"==typeof e?e.toLowerCase():e},o=r(n),i=r(e);switch(t){case"=":return o===i?0:1;case">":return o>i?0:1;case"<":return o<i?0:1;case"<=":return o<=i?0:1;case">=":return o>=i?0:1;case"IN":return i.indexOf(o)<0?1:0;case"NOT IN":return i.indexOf(o)<0?0:1;case"REGEX":return o.search(i)<0?1:0;case"LIKE":return o.indexOf(i)<0?1:0;case"BETWEEN":return i[0]<=o&&i[1]>=o?0:1;case"HAVE":return(o||[]).indexOf(i)<0?1:0;default:return 1}},e}();t.oe=s},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n={END_WORD:"$",PERMS_MIN_LEN:2},r=function(){function e(t){this.Nt=e.Et(t)}return e.prototype.addWord=function(t){var n=function(t,n,r,o){return e.Tt(t,n,r,o)};return t.toLowerCase().split("").reduce(n,this.Nt),this},e.prototype.removeWord=function(t){var r=e.jt(this.Nt,t),o=r.prefixFound,i=r.prefixNode;return o&&delete i[n.END_WORD],this},e.prototype.getWords=function(){return e.Dt(this.Nt,"")},e.prototype.getPrefix=function(t){if(t=t.toLowerCase(),!this.At(t))return[];var n=e.jt(this.Nt,t).prefixNode;return e.Dt(n,t)},e.prototype.At=function(t){return e.jt(this.Nt,t).prefixFound},e.Tt=function(e,t,r,o){return e[t]=e[t]||{},e=e[t],r===o.length-1&&(e[n.END_WORD]=1),e},e.jt=function(e,t){return{prefixFound:t.toLowerCase().split("").every(function(t,n){return!!e[t]&&(e=e[t])}),prefixNode:e}},e.Et=function(t){return t.reduce(function(t,n){return n.toLowerCase().split("").reduce(e.Tt,t),t},{})},e.Dt=function(t,r,o){void 0===o&&(o=[]);var i=r;for(var a in t)a===n.END_WORD&&(o.push(i),i=""),e.Dt(t[a],r+a,o);return o.sort()},e}();t.Trie=r},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=n(2),i=n(3),a=n(1),s=n(4),_=function(){function e(e,t){this.Lt=t,this.init(e,t)}return e.prototype.init=function(e,t){var n=this;n._={},n.Ee={},n.Mt={},n.Me=0,n.Le=0,n.Ve=[0,0],n.De=!1,n.ft=!0,n.Ct=!0,n.Rt=!1,n.qt={},n.Re={},n.Ft=0,n.N=e,t.P.length&&(n.Rt=void 0!==t.P[0].persistent&&t.P[0].persistent,n.ft=void 0===t.P[0].history||t.P[0].history,n.Ct=void 0===t.P[0].memory||t.P[0].memory,t.P[0].size,n.Ft={IDB:1,LS:2,LVL:4}[t.P[0].mode]||0,t.P[0].rebuildIndexes&&(n.Qt=!0),t.P[0].id&&(n.N.we=String(t.P[0].id)));var s=!1,_=0,c=!0;Object.keys(t._).forEach(function(e){var n={key:"x",type:"x"},i=[];t._[e].forEach(function(e){e.props&&-1!==e.props.indexOf("pk")&&(n=r.t(e)),!e.props||-1===e.props.indexOf("idx")&&-1===e.props.indexOf("trie")||i.push(e)}),"x"!==n.key&&"x"!==n.type&&(t._["_"+e+"_hist__data"]=r.t(t._[e]).map(function(e){return delete e.props,e}),t._["_"+e+"_hist__data"].unshift({key:o.me(4),type:"int"}),t._["_"+e+"_hist__meta"]=[n,{key:"_pointer",type:"int",default:0},{key:"_historyDataRowIDs",type:"array"}]),i.length&&"x"!==n.key&&"x"!==n.type&&i.forEach(function(r){t._["_"+e+"_idx_"+r.key]=[{key:"id",type:r.type,props:["pk"]},{key:"rowPK",type:n.type}]})}),t._[o.me(1)]=[{key:"id",type:"int",props:["ai","pk"]},{key:"tableID",type:"int"},{key:"historyPoint",type:"int"},{key:"rowKeys",type:"array"},{key:"type",type:"string"}],t._[o.me(0)]=[{key:"key",type:"string",props:["pk"]},{key:"value",type:"blob"}];var u,l,f=Object.keys(t._);Object.keys(t._).forEach(function(e){n.Bt(e,t._[e])}),Object.keys(t.x||{}).forEach(function(e){i.x[e]=t.x[e]});var d=function(){n.Qt?a.O.all(Object.keys(t._).map(function(e){return new a.O(function(t,r){n.Vt(e,function(){t()})})})).then(function(){n.Kt(t.T)}):n.Kt(t.T)},p=function(){var e=Object.keys(t._),r=0;if(n.Ft=l,u&&(n.Fe(o.me(0),"all",function(e){e.forEach(function(e){n.Be("w",e.key,e.value),"historyPoint"===e.key&&(n.Me=e.value||0),"historyLength"===e.key&&(n.Le=e.value||0)})}),n.Fe(o.me(1),"all",function(e){e.forEach(function(e){n.Re[e.historyPoint]||(n.Re[e.historyPoint]=[]),n.Re[e.historyPoint].push(e.id)})})),c){var i=function(){r<e.length?-1!==e[r].indexOf("_hist__data")?n.Qe(e[r],0,null,function(){r++,i()}):(r++,i()):(n.ft=u,d())};i()}else n.ft=u,d()};if(l=n.Ft,n.Rt)if(0!==n.Ft)switch(n.Ft){case 1:"undefined"==typeof indexedDB&&(n.Ft=0);break;case 2:"undefined"==typeof localStorage&&(n.Ft=0);break;case 4:"undefined"!=typeof window&&(n.Ft=0)}else"undefined"!=typeof window&&("undefined"!=typeof localStorage&&(n.Ft=2),"undefined"!=typeof indexedDB&&(n.Ft=1)),"undefined"!=typeof global&&void 0!==global.Jt&&void 0!==global.Wt&&(n.Ft=4);else n.Ft=0;u=n.ft,l=n.Ft,n.Ft=0;var h=function(e,t){var o=function(){if(_<f.length){var i=r.NanoSQLInstance.J(f[_]);e(f[_],i,n.Ee[i]),_++,o()}else t()};o()},y=function(e){c=!1;var t=0,o=function(){if(!(t<f.length))return void(e.cleanup?e.cleanup(function(){p()}):p());var i=r.NanoSQLInstance.J(f[t]);if(!u&&(-1!==f[t].indexOf("_hist__data")||-1!==f[t].indexOf("_hist__meta")))return t++,void o();n.Ct?e.requestTable(f[t],function(e){-1!==f[t].indexOf("_hist__data")?(n.Ee[i].Ze.push(0),n.Ee[i].vt.addWord("0"),n.Ee[i].Ke[0]=null,n.Ee[i].bt++,n.N.N.loadJS(f[t],e).then(function(){t++,o()})):n.N.N.loadJS(f[t],e).then(function(){t++,o()})}):n.Ct&&!e.forceIndex||e.requestIndex(f[t],function(e){n.N.Oe.Ee[i].Ze=e,n.N.Oe.Ee[i].bt=e.reduce(function(e,t){return Math.max(e,parseInt(t)||0)},0),n.N.Oe.Ee[i].bt++,t++,o()})};o()};switch(l){case 0:p();break;case 1:var b=indexedDB.open(n.N.we,1);b.onupgradeneeded=function(e){s=!0;var t=e.target.result,r=e.target.transaction;n.Ht=t,h(function(e,n,r){var o=r.tt?{keyPath:r.tt}:{};t.createObjectStore(e,o)},function(){r.oncomplete=function(){p()}})},b.onsuccess=function(e){if(n.Ht=e.target.result,!s){var t=function(e,t){var r=[],o=n.Ht.transaction(e,"readonly");o.objectStore(e).openCursor().onsuccess=function(e){var t=e.target.result;t&&(r.push(n.Ct?t.value:t.key),t.continue())},o.oncomplete=function(){t(r)}};y({requestIndex:function(e,n){t(e,n)},requestTable:function(e,n){t(e,n)}})}};break;case 2:localStorage.getItem("dbID")!==n.N.we?(localStorage.setItem("dbID",n.N.we),h(function(e,t,n){localStorage.setItem(e,JSON.stringify([]))},function(){p()})):y({forceIndex:!0,requestIndex:function(e,t){t(JSON.parse(localStorage.getItem(e)||"[]"))},requestTable:function(e,t){var n=[];JSON.parse(localStorage.getItem(e)||"[]").forEach(function(t){n.push(JSON.parse(localStorage.getItem(e+"-"+t)||""))}),t(n)}})}},e.prototype.Vt=function(e,t){var n=this,o=r.NanoSQLInstance.J(e),i=0,s=n.Ee[o].nt;this.Fe(e,"all",function(r){var _=n.Ee[o].tt,c=function(){if(i<r.length){var o=0,u=function(){if(o<s.length){var t=s[o],l="_"+e+"_idx_"+t,f=String(r[i][t]).toLowerCase();n.Fe(l,f,function(e){var s=[r[i][_]];e.length&&e[0].rowPK&&(s=s.concat(e[0].rowPK).filter(function(e,t){return s.indexOf(e)===t})),n.Qe(l,f,{id:r[i][t],rowPK:s},function(){o++,a.setFast(u)})},!0)}else i++,a.setFast(c)};u()}else t()};c()})},e.prototype.Kt=function(e){var t={},n=0,o=this;if(Object.keys(o.Ee).forEach(function(e){var r=o.Ee[e].Ne;0!==r.indexOf("_")&&o.Ee[e].ct.length&&(t[r]=o.Ee[e].ct,n++)}),0===n)e();else{var i=Object.keys(t),a=0,s=function(){if(a<i.length){var n=r.NanoSQLInstance.J(i[a]);o.Fe(i[a],"all",function(e){e.forEach(function(e,r){t[i[a]].forEach(function(t){e[t]&&o.Ee[n].at[t].addWord(e[t])})}),a++,s()})}else e()};s()}},e.prototype.Ae=function(){var e=this;4!==e.Ft&&function(){Object.keys(e.je).forEach(function(t){e.Vt(t,function(){})})}(),e.Ft},e.prototype.Je=function(e,t){var n=this,i=Object.keys(n.Ee).map(function(e){return n.Ee[e].Ne}),a=0,s=function(){var e=0,a=function(){if(e<i.length)if(-1!==i[e].indexOf("_hist__meta")){var s=String(i[e]).slice(1).replace("_hist__meta",""),_=r.NanoSQLInstance.J(s),c=n.Ee[_].tt;n.Fe(s,"all",function(t){t.forEach(function(t,r){var a={};a[o.me(2)]=0,a[o.me(3)]=[r+1],n.Qe(i[e],t[c],a),n.Qe("_"+s+"_hist__data",r+1,t)}),e++,a()})}else e++,a();else t()};a()},_=function(){if(a<i.length){var r=!1;"hist"!==e||i[a]!==o.me(1)&&-1===i[a].indexOf("_hist__meta")&&-1===i[a].indexOf("_hist__data")||(r=!0),"all"===e&&"_utility"!==i[a]&&(r=!0),r?n._t(i[a],"all",function(){-1!==i[a].indexOf("_hist__data")&&n.Qe(i[a],0,null),a++,_()}):(a++,_())}else"hist"===e?s():t()};_()},e.prototype._t=function(e,t,n){var o=this,i=r.NanoSQLInstance.J(e),a=[];if("all"===t?(a=o.Ee[i].Ze.slice(),o.Ee[i].Ze=[],o.Ee[i].vt=new s.Trie([])):(a.push(t),o.Ee[i].vt.removeWord(String(t)),o.Ee[i].Ze.splice(o.Ee[i].Ze.indexOf(t),1)),o.Ct&&("all"===t?o.Ee[i].Ke={}:delete o.Ee[i].Ke[t],0===o.Ft&&n))return n(!0);if(o.Ft>0){var _=0,c=function(){if(_<a.length)switch(o.Ft){case 1:o.Ht.transaction(e,"readwrite").objectStore(e).delete(a[_]),_++,c();break;case 2:localStorage.setItem(e,JSON.stringify(o.Ee[i].Ze)),localStorage.removeItem(e+"-"+String(a[_])),_++,c();break;default:_++,c()}else n&&n(!0)};c()}},e.prototype.gt=function(e,t){switch(e){case"int":return this.Ee[t].bt++;case"uuid":return r.NanoSQLInstance.uuid();case"timeId":return r.NanoSQLInstance.timeid();case"timeIdms":return r.NanoSQLInstance.timeid(!0)}return""},e.prototype.Qe=function(e,t,n,i){var a=this;Object.isFrozen(n)&&(n=r.t(n));var s=r.NanoSQLInstance.J(e);void 0!==t&&null!==t||(a._[s].forEach(function(e){e.props&&-1!==e.props.indexOf("pk")&&(t=a.gt(e.type,s))}),t||(t=parseInt(a.Ee[s].Ze[a.Ee[s].Ze.length-1]||"0")+1)),0!==e.indexOf("_")&&n?delete n[o.me(4)]:-1!==e.indexOf("_hist__data")&&n&&(t=n[o.me(4)]),"int"===a.Ee[s].qe&&(t=parseInt(t));var _=a.Ee[s].tt;if(_&&_.length&&n&&void 0===n[_]&&(n[_]=t),a.Ee[s].vt.getPrefix(String(t)).length||(a.Ee[s].vt.addWord(String(t)),a.Ee[s].Ze.push(t)),a.Ct&&(a.Ee[s].Ke[t]=a.N.Te(n,s),0===a.Ft&&i))return i(t);switch(a.Ft){case 1:var c=a.Ht.transaction(e,"readwrite"),u=c.objectStore(e);_.length&&n?u.put(n):-1!==e.indexOf("_hist__data")?u.put(n,t):(n&&u.put(n),n||u.delete(t)),c.oncomplete=function(){i&&i(t)};break;case 2:localStorage.setItem(e+"-"+String(t),n?JSON.stringify(n):""),localStorage.setItem(e,JSON.stringify(a.Ee[s].Ze)),i&&i(t)}},e.prototype.zt=function(e,t,n,r){var o=this,i=0===e.indexOf("_")&&-1!==e.indexOf("_idx_");if(!i||r)n(t);else{var a=i?e.slice(1,e.indexOf("_idx_")):"",s=t.reduce(function(e,t){return e.concat(t.rowPK)},[]),_=[],c=0,u=function(){c<s.length?o.Fe(a,s[c],function(e){_=_.concat(e),c++,u()}):n(_)};u()}},e.prototype.Ce=function(e,t,n){var r=this,o=[],i=0,a=function(){i<t.length?r.Fe(e,t[i],function(e){o=o.concat(e),i++,a()}):n(o)};a()},e.prototype.rt=function(e,t,n,o){var i=this,a=this,s=r.NanoSQLInstance.J(e);if(0===a.Ft||2===a.Ft){var _=a.Ee[s].Ze.indexOf(n[0]),c=[];if(-1===_)return void o(c);var u=function(){var t=a.Ee[s].Ze[_];if(!t)return void o(c);t<=n[1]?a.Fe(e,t,function(e){c=c.concat(e),_++,u()}):o(c)};return void u()}var l=[];switch(a.Ft){case 1:var f=a.Ht.transaction(e,"readonly"),d=f.objectStore(e),p=d.openCursor(IDBKeyRange.bound(n[0],n[1]));f.oncomplete=function(){i.zt(e,l,o)},p.onsuccess=function(e){var t=e.target.result;t&&(l.push(t.value),t.continue())}}},e.prototype.Fe=function(e,t,n,o){var i=this,a=this,s=r.NanoSQLInstance.J(e);if(a.Ct){var _=a.Ee[s].Ke;if("all"===t||"function"==typeof t){var c=Object.keys(_).map(function(e){return _[e]});"all"===t?a.zt(e,c.filter(function(e){return e}),n,o):a.zt(e,c.filter(function(e){return t(e)}),n,o)}else a.zt(e,[_[t]].filter(function(e){return e}),n,o)}else switch(a.Ft){case 1:var u=a.Ht.transaction(e,"readonly"),l=u.objectStore(e);if("all"===t||"function"==typeof t){var f=l.openCursor(),d=[];u.oncomplete=function(){i.zt(e,d,n,o)},f.onsuccess=function(e){var n=e.target.result;n&&("all"!==t?t(n.value)&&d.push(n.value):d.push(n.value),n.continue())}}else{var p=l.get(t);p.onsuccess=function(t){i.zt(e,[p.result],n,o)}}break;case 2:if("all"===t||"function"==typeof t){var h=a.Ee[s].Ze.map(function(t){var n=localStorage.getItem(e+"-"+t);return n&&n.length?JSON.parse(n):null});"all"!==t?this.zt(e,h.filter(function(e){return t(e)}),n,o):this.zt(e,h,n,o)}else{var y=localStorage.getItem(e+"-"+t);this.zt(e,[y&&y.length?JSON.parse(y):null],n,o)}}},e.prototype.Be=function(e,t,n){var r=this;return"r"===e?r.qt[t]?r.qt[t].value:null:(r.Qe(o.me(0),t,{key:t,value:n}),r.Be[t]={key:t,value:n},n)},e.prototype.Bt=function(e,t){var n=this,o=r.NanoSQLInstance.J(e);n._[o]=t,n.N.ke[o]={},n.Ee[o]={tt:"",qe:"",ut:[],dt:[],lt:[],nt:[],ct:[],at:{},Ne:e,bt:1,Ze:[],vt:new s.Trie([]),Ke:{}};for(var i=n._[o].length;i--;)!function(){var e=n._[o][i];if(n.Ee[o].ut.unshift(e.key),n.Ee[o].lt[i]=e.default,e.props&&e.props.indexOf("pk")>=0&&(n.Ee[o].tt=e.key,n.Ee[o].qe=e.type),e.props&&(e.props.indexOf("idx")>=0||e.props.indexOf("trie")>=0)&&n.Ee[o].nt.push(e.key),e.props&&e.props.indexOf("trie")>=0&&(n.Ee[o].ct.push(e.key),n.Ee[o].at[e.key]=new s.Trie([])),e.props&&-1!==n.N.N.v.indexOf(e.type.replace("[]",""))){var t="";e.props.forEach(function(e){-1!==e.indexOf("orm::")&&(t=e.replace("orm::",""))}),n.Ee[o].dt.push({Y:e.type.replace("[]",""),ht:e.key,pt:t,St:-1===e.type.indexOf("[]")?"single":"array"})}}();return e},e}();t.Ie=_},function(e,t,n){e.exports=n(0)}])});
!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.e?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=5)}([function(e,t,n){var r=n(3),o=n(1);t.t=function(e){return JSON.parse(JSON.stringify(e))};var i=function(){function e(){var e=this;e.r={},e.a={},e._={},e.u=[],e.f=["change","delete","upsert","drop","select","error"],e.h={},e.y={},e.h["*"]={};for(var t=e.f.length;t--;)e.h["*"][e.f[t]]=[];e.b={},e.g={}}return e.prototype.table=function(e){return e&&(this.v=e,this.activeTable=e),this},e.prototype.connect=function(e){var t=this,n=this;return n.backend?new o.k(function(e,t){throw t(),Error()}):(n.backend=e||new r.w,new o.k(function(e,r){n.backend.S({_:n._,r:n.r,a:n.a,b:n.b,O:n.u,x:t,I:function(t){e(t,n)},j:function(e){r&&r(e,n)}})}))},e.prototype.on=function(e,t){var n=this,r=n.v,o=0,i=e.split(" ");if(!n.h[r])for(n.h[r]={},n.h[r]["*"]=[];o--;)n.h[r][n.f[o]]=[];for(o=i.length;o--;)n.f.indexOf(i[o])!==-1&&n.h[r][i[o]].push(t);return n.D(),n},e.prototype.off=function(e){var t=this;for(var n in t.h)for(var r in t.h[n])t.h[n][r]=t.h[n][r].filter(function(t){return t!==e});return t.D(),t},e.prototype.D=function(){var e=this;this.y={},Object.keys(this._).concat(["*"]).forEach(function(t){e.y[t]=e.f.reduce(function(n,r){return n+(e.h[t]?e.h[t][r].length:0)},0)>0})},e.prototype.model=function(e){var t=this,n=t.v,r=t.f.length;if(!t.h[n])for(t.h[n]={},t.h[n]["*"]=[];r--;)t.h[n][t.f[r]]=[];return t._[n]=e,t.a[n]=[],t.r[n]=[],t},e.prototype.views=function(e){return this.a[this.v]=e,this},e.prototype.getView=function(e,t){void 0===t&&(t={});for(var n,r=this,o=r.v,i=r.a[o].length;i--;)r.a[o][i].name===e&&(n=r.a[o][i]);if(!n)throw Error;return r.T=e,n.call.apply(r,[r.N(n.args?n.args:[],t),r])},e.prototype.N=function(e,t){var n=this,r=(n.v,{}),o=e.length?e.length:-1;if(o>0)for(;o--;){var i=e[o].split(":");i.length>1?r[i[0]]=n.P(i[1],t[i[0]]||null):r[i[0]]=t[i[0]]||null}return r},e.prototype.P=function(e,n){var r=typeof n;return{string:"string"!==r?String(n||""):n,int:"number"!==r||n%1!=0?parseInt(n||0):n,float:"number"!==r?parseFloat(n||0):n,array:Array.isArray(n)?t.t(n||[]):[],map:"object"===r?t.t(n||{}):{},bool:n===!0}[e]||n},e.prototype.actions=function(e){return this.r[this.v]=e,this},e.prototype.doAction=function(e,t){void 0===t&&(t={});for(var n,r=this,o=r.v,i=r.r[o].length;i--;)r.r[o][i].name===e&&(n=r.r[o][i]);if(!n)throw Error;return r.T=e,n.call.apply(r,[r.N(n.args?n.args:[],t),r])},e.prototype.newFunction=function(e,t,n){return this.b[e]={type:t,call:n},this},e.prototype.query=function(e,t){var n=this,r=new a(this.v,this),o=e.toLowerCase();if(["select","upsert","delete","drop","show tables","describe"].indexOf(o)===-1)throw Error;var i=t||("select"===o||"delete"===o?[]:{});if("upsert"===e){var s={};this._[this.v].forEach(function(e){i[e.key]&&(s[e.key]=n.P(e.type,i[e.key]))}),this.g[this.v]&&(s=this.g[this.v](s)),i=s}return r.L={type:o,args:i},r},e.prototype.triggerEvent=function(e,t){var n=this;setTimeout(function(){for(var r,o,i=t.length,a=0;i--;)for(r=t[i],o=n.h[n.v][r].concat(n.h[n.v]["*"]),a=o.length;a--;)e.name=r,e.actionOrView=n.T||"",o[a](e,n);n.T=void 0},0)},e.prototype.default=function(e){var t={},n=this;return n._[n.v].forEach(function(r){t[r.key]=e&&e[r.key]?e[r.key]:r.default,t[r.key]||(t[r.key]=n.P(r.type,null))}),t},e.prototype.beginTransaction=function(){if(this.backend.A)return this.backend.A("start")},e.prototype.endTransaction=function(){if(this.backend.A)return this.backend.A("end")},e.prototype.queryFilter=function(e){return this.C=e,this},e.prototype.config=function(e){var t=this;return t.backend||t.u.push(e),t},e.prototype.extend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=this;if(n.backend)return n.backend.M?(e.unshift(n),n.backend.M.apply(n.backend,e)):void 0},e.prototype.loadJS=function(e,t){var n=this;return n.beginTransaction(),new o.k(function(r,o){var i=0,a=[],s=function(){i<t.length?t[i]?n.table(e).query("upsert",t[i]).exec().then(function(e){a.push(e),i++,s()}):(i++,s()):(n.endTransaction(),r(a,n))};s()})},e.prototype.rowFilter=function(e){return this.g[this.v]=e,this},e.prototype.loadCSV=function(e,t){var n=this,r=[];return n.beginTransaction(),new o.k(function(i,a){o.k.all(t.split("\n").map(function(t,i){return new o.k(function(o,a){if(0===i)r=t.split(","),o();else{var s={},_=t.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)||[];_=_.map(function(e){return e.replace(/^"(.+(?="$))"$/,"$1")});for(var c=r.length;c--;)0!==_[c].indexOf("{")&&0!==_[c].indexOf("[")||(_[c]=JSON.parse(_[c].replace(/'/g,""))),s[r[c]]=_[c];n.table(e).query("upsert",s).exec().then(function(){o()})}})})).then(function(){n.endTransaction(),i([],n)})})},e.uuid=function(){var e,t,n,r=function(){return"undefined"==typeof crypto?Math.round(Math.random()*Math.pow(2,16)):crypto.getRandomValues?(n=new Uint16Array(1),crypto.getRandomValues(n),n[0]):crypto.randomBytes?crypto.randomBytes(2).reduce(function(e,t){return t*e}):Math.round(Math.random()*Math.pow(2,16))},o="";return[o,o,o,o,o,o,o,o,o].reduce(function(n,i,a){for(e=r(),t=4===a?a:5===a?(e%16&3|8).toString(16):o,e=e.toString(16);e.length<4;)e="0"+e;return n+([3,4,5,6].indexOf(a)>=0?"-":o)+(t+e).slice(0,4)},o)},e.Q=function(e){return Math.abs(e.split("").reduce(function(t,n,r){return(t<<5)+t+e.charCodeAt(r)},0))},e}();t.NanoSQLInstance=i;var a=function(){function e(e,t){this.q=t,this.F=[],this.R=e}return e.prototype.where=function(e){return this.B("where",e)},e.prototype.orderBy=function(e){return this.B("orderby",e)},e.prototype.groupBy=function(e){return this.B("groupby",e)},e.prototype.having=function(e){return this.B("having",e)},e.prototype.join=function(e){return this.B("join",e)},e.prototype.limit=function(e){return this.B("limit",e)},e.prototype.offset=function(e){return this.B("offset",e)},e.prototype.B=function(e,t){return this.F.push({type:e,args:t}),this},e.prototype.toCSV=function(e){var t=this;return new o.k(function(n,r){t.exec().then(function(r){var o=t.L.args.length?t.L.args.map(function(e){return t.q._[t.R].filter(function(t){return t.key===e})[0]}):t.q._[t.R];e&&r.unshift(o.map(function(e){return e.key})),n(r.map(function(t,n){return e&&0===n?t:o.filter(function(e){return!!t[e.key]}).map(function(e){switch(e.type){case"map":case"array":return'"'+JSON.stringify(t[e.key]).replace(/"/g,"'")+'"';default:return t[e.key]}}).join(",")}).join("\n"),t)})})},e.prototype.exec=function(){var e=this,t=e.R;return e.q.y[t]&&(e.q.J=function(){switch(e.L.type){case"select":return[e.L.type];case"delete":case"upsert":case"drop":return[e.L.type,"change"];default:return[]}}()),new o.k(function(n,r){if(!e.q.backend)throw r(),Error;var o=function(n,r,o,i,a){e.q.y[t]&&e.q.triggerEvent({name:"error",actionOrView:"",table:t,query:[e.L].concat(e.F),time:(new Date).getTime(),result:n,changeType:o,changedRows:i},e.q.J),r(n,e.q)},i={table:t,query:[e.L].concat(e.F),viewOrAction:e.q.T||"",onSuccess:function(e,t,r){o(e,n,t,r,!1)},onFail:function(t){e.q.J=["error"],r&&o(t,r,"error",[],!0)}};e.q.C?e.q.C(i,function(t){e.q.backend.V(t)}):e.q.backend.V(i)})},e}();t.H=a;var s=new i;t.nSQL=function(e){return s.table(e)}},function(e,t,n){"use strict";function r(e,t,n){setTimeout(function(){var r;try{r=t.apply(null,n)}catch(t){return d.K(e,t)}return r===e?d.K(e,new TypeError):d.U(e,r),null})}function o(e){var t=e&&e.then;return!e||"object"!=typeof e&&"function"!=typeof e||"function"!=typeof t?null:function(){t.apply(e,arguments)}}function i(e,t){function n(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];i||(i=!0,d.K(e,t))}function r(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];i||(i=!0,d.U(e,t))}function o(){t(r,n)}var i=!1,s=a(o);"error"===s.z&&n(s.X)}function a(e,t){var n={z:null,X:null};try{n.X=e(t),n.z="success"}catch(e){n.z="error",n.X=e}return n}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){},_=["R"],c=["F"],u=["P"],l=function(){function e(e){this.$=u,this.G=[],this.W=void 0,e!==s&&i(this,e)}return e.prototype.catch=function(e){return this.then(function(){},e)},e.prototype.then=function(t,n){if("function"!=typeof t&&this.$===c||"function"!=typeof n&&this.$===_)return this;var o=new e(s);if(this.$!==u){r(o,this.$===c?t:n,this.W)}else this.G.push(new f(o,t,n));return o},e.resolve=function(t){return t instanceof this?t:d.U(new e(s),t)},e.reject=function(t){return d.K(new e(s),t)},e.all=function(t){function n(e,t){function n(e){a[t]=e,++_!==o||i||(i=!0,d.U(u,a))}r.resolve(e).then(n,function(e){i||(i=!0,d.K(u,e))})}var r=this,o=t.length,i=!1,a=new Array(o),_=0,c=-1,u=new e(s);if(!o)return this.resolve([]);for(;++c<o;)n(t[c],c);return u},e.race=function(t){function n(e){r.resolve(e).then(function(e){i||(i=!0,d.U(_,e))},function(e){i||(i=!0,d.K(_,e))})}var r=this,o=t.length,i=!1,a=-1,_=new e(s);if(Array.isArray(t)!==!1)return this.reject(new TypeError);if(!o)return this.resolve([]);for(;++a<o;)n(t[a]);return _},e}();t.k=l;var f=function(){function e(e,t,n){this.Y=e,"function"==typeof t&&(this.Z=t,this.ee=this.te),"function"==typeof n&&(this.ne=n,this.re=this.oe)}return e.prototype.ee=function(e){d.U(this.Y,e)},e.prototype.te=function(e){r(this.Y,this.Z,e)},e.prototype.re=function(e){d.K(this.Y,e)},e.prototype.oe=function(e){r(this.Y,this.ne,e)},e}();t.ie=f;var d=function(){function e(){}return e.U=function(t,n){var r=a(o,n),s=r.X,_=-1,u=t.G.length;if("error"===r.z)return e.K(t,r.X);if(s)i(t,s);else for(t.$=c,t.W=n;++_<u;)t.G[_].ee(n);return t},e.K=function(e,t){e.$=_,e.W=t;for(var n=-1,r=e.G.length;++n<r;)e.G[n].re(t);return e},e}()},function(e,t,n){var r=n(0),o=function(e,t,n,o,i){var a=n[0];0===o[0]&&(i[a]=e===-1?Number.MAX_VALUE:Number.MIN_VALUE);var s={};if(s=(e===-1?parseFloat(t[a])<parseFloat(i[a]):parseFloat(t[a])>parseFloat(i[a]))?t:i,o[0]===o[1]){var _=r.t(s);return _[e===-1?"MIN":"MAX"]=s[a],_}return s};t.b={SUM:{type:"aggregate",call:function(e,t,n,o){if(0===n[0]&&(o=0),o+=parseInt(e[t[0]]),n[0]===n[1]){var i=r.t(e);return i.SUM=o,i}return o}},MIN:{type:"aggregate",call:function(e,t,n,r){return o(-1,e,t,n,r)}},MAX:{type:"aggregate",call:function(e,t,n,r){return o(1,e,t,n,r)}},AVG:{type:"aggregate",call:function(e,t,n,o){if(0===n[0]&&(o=0),o+=parseInt(e[t[0]]),n[0]===n[1]){var i=r.t(e);return i.AVG=o/(n[1]+1)||o,i}return o}},COUNT:{type:"aggregate",call:function(e,t,n,o){if(0===n[0]&&(o=0),"*"===t[0]?o++:o+=e[t[0]]?1:0,n[0]===n[1]){var i=r.t(e);return i.COUNT=o,i}return o}}};var i=function(){function e(e){this.q=e}return e.prototype.ae=function(e,t){var n=this;n.se=r.NanoSQLInstance.Q(e.table),n._e=[],n.ce=void 0;var o=[];if(e.query.forEach(function(t){["upsert","select","delete","drop"].indexOf(t.type)>=0?(n.ce=t,"select"===t.type&&(n.ue=r.NanoSQLInstance.Q(JSON.stringify(e.query)))):["show tables","describe"].indexOf(t.type)>=0?o.push(t):n._e.push(t)}),o.length)switch(o[0].type){case"show tables":t(),e.onSuccess([{tables:Object.keys(n.q.fe.le).map(function(e){return n.q.fe.le[e].de})}],"info",[]);break;case"describe":var i,a=n.se,s={};Object.keys(n.q.fe.le).forEach(function(e){parseInt(e)===n.se&&(i=r.t(n.q.fe._[e]),a=n.q.fe.le[e].de)}),s[a]=i,t(),e.onSuccess([s],"info",[])}else n.pe(function(r,o,i){e.onSuccess(r,o,i),t(n)})},e.prototype.he=function(e){return this._e.filter(function(t){return t.type===e}).pop()},e.prototype.pe=function(e){var t=this,n=this;if(n.ce){var r=function(r){if(n.ce)switch(n.ce.type){case"upsert":t.ye(r,e);break;case"select":t.be(r,e);break;case"drop":case"delete":t.ge(r,e)}},o=this.q.fe.le[n.se].de;n.he("join")||"drop"===n.ce.type?r([]):n.he("where")?n.q.fe.ve(o,function(e){return e&&n.me(e,n.he("where").args)},function(e){r(e)}):n.ce&&"upsert"!==n.ce.type?n.q.fe.ve(o,"all",function(e){r(e)}):r([])}},e.prototype.ke=function(e,t){var n=this,o=n.q.fe.le[n.se].de;n.q.fe.ve(o,e,function(i){var a={},s=i[0]||{},_=n.ce.args,c=function(){return n.ce&&"delete"===n.ce.type&&!_.length?"drop":n.ce?n.ce.type:""}(),u=!1;switch(c){case"upsert":a=s?r.t(s):{},Object.keys(_).forEach(function(e){a[e]=_[e]});var l=n.q.fe.le[n.se];l.we.forEach(function(e,t){var n=l.Se[t];!a[e]&&n&&(a[e]=n)});break;case"delete":a=s?r.t(s):{},_&&_.length?_.forEach(function(e){a[e]=null}):(u=!0,a={})}var f=function(){0!==o.indexOf("_")&&n.q.fe.Oe&&n.q.fe.ve("_"+o+"_hist__meta",parseInt(e),function(t){t[0].xe.unshift(d),n.q.fe.ye("_"+o+"_hist__meta",parseInt(e),t[0])}),"upsert"===c?n.q.fe.ye(o,e,a,function(){t()}):n.q.fe.Ie(o,e,function(){t()})},d=0;!u&&0!==o.indexOf("_")&&n.q.fe.Oe?n.q.fe.ye("_"+o+"_hist__data",null,a,function(e){d=parseInt(e),f()}):f()})},e.prototype.je=function(e,t,n){var o=this,i=this,a=0,s=0;if(e.length>0){var _=function(){if(i.q.fe.Oe)i.q.fe.De||0!==i.q.fe.Ee||i.q.fe.Te++,i.q.fe.Ne("w","historyLength",i.q.fe.Te),i.q.fe.Ne("w","historyPoint",i.q.fe.Ee),i.q.fe.ye("_historyPoints",null,{historyPoint:i.q.fe.Te-i.q.fe.Ee,tableID:i.se,rowKeys:e.map(function(e){return parseInt(e)}),type:t},function(r){var a=i.q.fe.le[o.se];i.q.Pe(i.se,[],""),i.q.fe.ve(a.de,function(t){return t&&e.indexOf(t[a.Le])!==-1},function(r){n([{msg:e.length+" row(s) "+t}],t,r)})});else{var r=i.q.fe.le[o.se];i.q.Pe(i.se,[],""),i.q.fe.ve(r.de,function(t){return t&&e.indexOf(t[r.Le])!==-1},function(r){n([{msg:e.length+" row(s) "+t}],t,r)})}};i.q.fe.Oe&&i.q.fe.Ee>0&&i.q.fe.De!==!0?i.q.fe.ve("_historyPoints",function(e){return e.historyPoint>i.q.fe.Te-i.q.fe.Ee},function(e){s=0;var t=function(){if(!(s<e.length))return i.q.fe.Te-=i.q.fe.Ee,i.q.fe.Ee=0,void _();var n=i.q.fe.le[e[s].tableID].de;a=0;var o=function(){a<e[s].rowKeys.length?i.q.fe.ve("_"+n+"_hist__meta",e[s].rowKeys[a],function(t){t[0]=r.t(t[0]),t[0].Ae=0;var _=t[0].xe.shift();i.q.fe.ye("_"+n+"_hist__meta",e[s].rowKeys[a],t[0],function(){_?i.q.fe.Ie("_"+n+"_hist__data",_,function(){a++,o()}):(a++,o())})}):(s++,t())};i.q.fe.Ie("_historyPoints",e[s].id,function(){o()})};t()}):_()}else n([{msg:"0 rows "+t}],t,[])},e.prototype.ye=function(e,t){var n,o=this,i="",a=[],s=o.ce.args||{},_=o.q.fe.le[o.se],c=_.Le;if(o.he("where")){i="modified",a=e.map(function(e){return e[_.Le]}),n=0;var u=function(){n<e.length?o.ke(e[n][c],function(){n++,u()}):o.je(a,i,t)};u()}else{i="inserted",s[c]?"int"===_.Ce&&(_.Me=Math.max(s[c]+1,_.Me)):"int"===_.Ce?s[c]=_.Me++:"uuid"===_.Ce&&(s[c]=r.NanoSQLInstance.uuid());var l=s[c]?String(s[c]):String(_.Qe.length);if(a=[l],_.Qe.indexOf(l)===-1){var f=this.q.fe.le[o.se].de;if(0!==f.indexOf("_")){var d="_"+f+"_hist__meta";o.q.fe.ye(d,l,{Ae:0,xe:[0]})}_.Qe.push(l)}o.ke(l,function(){o.je(a,i,t)})}},e.prototype.qe=function(){return this.Fe?this.Fe:this.se},e.prototype.be=function(e,n){var o=this;if(o.q.Re[o.se][o.ue])return void n(o.q.Re[o.se][o.ue],"none",[]);var i,a,s=["join","groupby","having","orderby","offset","limit"],_={},c=function(e,t,n){return Object.keys(n).reduce(function(r,o){return r?r:e[o]===t[o]?0:(e[o]>t[o]?1:-1)*("desc"===n[o]?-1:1)},0)},u=function(e,n,a){if(i=o.he(s[n]),2===n){var u=[];if(l.length){var f=Object.keys(t.b).map(function(e){return e+"("}),d=[];u=l.filter(function(e){return(f.reduce(function(t,n){return(e.indexOf(n)<0?0:1)+t},0)||0)>0||(d.push(e),!1)}).map(function(e){var n=e.match(/(.*)\((.*)\)/),r=n[1].trim(),o=(e.match(/\sAS\s(.*)/)||[]).pop()||r,i=n[2].split(",").map(function(e){return e.trim()});return"simple"===t.b[r].type&&o===r&&(o=i[0]),d.push(o),{name:r,args:i,as:o.trim(),type:t.b[r].type}});var p=[];if(u.length){var h,y=function(e){return u.sort(function(e,t){return e.type>t.type?1:-1}).reduce(function(n,r){var o=n.length-1;if("aggregate"===r.type){var i=e.slice();o=i.length-1,i=[i.reduce(function(e,n,i){return t.b[r.name].call(n,r.args,[i,o],e)},{})],h&&(i[0][h]=n[0][h]),n=i,h=r.name}else n=n.map(function(e,n){return t.b[r.name].call(e,r.args,[n,o])});return r.name!==r.as?d.push(r.name+" AS "+r.as):d.push(r.name),n},e.slice())},b=Object.keys(_);p=b.length?b.map(function(e){return y(_[e])}).reduce(function(e,t){return e=e.concat(t)},[]):y(e)}else p=e;var g=d.map(function(e){return e.match(/(.*)\sAS\s(.*)/)||e}).filter(function(e){return e})||[];g.length&&(p=p.map(function(e){e=r.t(e);var t={};return g.forEach(function(n){"string"==typeof n?t[n]=e[n]:t[n[2]]=e[n[1]]}),t})),e=p}}if(!i)return a(e);switch(n){case 0:var v=void 0;"cross"!==i.args.type&&(v={Be:i.args.where[0].split(".").pop(),Je:i.args.where[1],Ve:i.args.where[2].split(".").pop()});var m=o.se,k=r.NanoSQLInstance.Q(i.args.table),w=o.he("where");o.He(i.args.type,m,k,v,function(e){a(w?e.filter(function(e){return o.me(e,w.args)}):e)});break;case 1:var S=i.args,O={};S?(_=e.reduce(function(e,t){var n=Object.keys(S).reduce(function(e,n){return e+"."+String(t[n])},"").slice(1);return(e[n]=e[n]||[]).push(t),O[n]=Object.keys(S).reduce(function(e,n){return e[n]=t[n],e},{}),e},{}),a(Object.keys(_).sort(function(e,t){return c(O[e],O[t],S)}).reduce(function(e,t){return e.concat(_[t])},[]))):a(e);break;case 2:a(e.filter(function(e){return o.me(e,o.he("having").args)}));break;case 3:a(e.sort(function(e,t){return c(e,t,i.args)}));break;case 4:a(e.filter(function(e,t){return!i||t>=i.args}));break;case 5:a(e.filter(function(e,t){return!i||t<i.args}))}};a=-1;var l=o.ce.args||[],f=function(e){a<s.length?(a++,u(e,a,function(e){f(e)})):(e=e.filter(function(e){return e}),o.he("join")||(o.q.Re[o.se][o.ue]=e),n(e,"none",[]))};f(e)},e.prototype.ge=function(e,t){var n,r="deleted",o=this,i=o.ce.args||[],a=o.q.fe.le[o.se].Le;n=0;var s=function(){n<e.length?o.ke(e[n][a],function(){n++,s()}):(i.length&&(r="modified"),o.je(e.map(function(e){return e[a]}),r,t))};s()},e.prototype.me=function(e,t){var n=this,r=["AND","OR"];if("string"!=typeof t[0]){var o;return t.reduce(function(t,i,a){if(r.indexOf(i)!==-1)return o=i,t;var s=0===n.Ke(i[2],i[1],e[i[0]]);return 0===a?s:"AND"===o?t&&s:t||s},!0)}return 0===n.Ke(t[2],t[1],e[t[0]])},e.prototype.He=function(e,t,n,r,o){var i="outer",a=this,s=a.q.fe.le[t],_=a.q.fe.le[n],c=function(e,t){return[s,_].reduce(function(n,r,o){return r.we.forEach(function(i){n[r.de+"."+i]=((0===o?e:t)||{})[i]}),n},{})},u=[],l=[];a.q.fe.ve(s.de,"all",function(t){a.q.fe.ve(_.de,"all",function(n){t.forEach(function(t){var o=n.filter(function(e){if(!r)return!0;var n=c(t,e),o=a.me(n,[r.Be,r.Je,r.Ve]);return o&&l.push(e[_.Le]),o});o.length?u=u.concat(o):["left",i].indexOf(e)>=0&&u.push(c(t,null))}),l=l.sort().filter(function(e,t,n){return!t||e!==n[t-1]}),["right",i].indexOf(e)>=0&&n.filter(function(e){return l.indexOf(e[_.Le])===-1}).forEach(function(e){u.push(c(null,e))}),o(u)})})},e.prototype.Ke=function(e,t,n){switch(t){case"=":return n===e?0:1;case">":return n>e?0:1;case"<":return n<e?0:1;case"<=":return n<=e?0:1;case">=":return n>=e?0:1;case"IN":return e.indexOf(n)<0?1:0;case"NOT IN":return e.indexOf(n)<0?0:1;case"REGEX":case"LIKE":return n.search(e)<0?1:0;case"BETWEEN":return e[0]<n&&e[1]>n?0:1;default:return 0}},e}();t.H=i},function(e,t,n){var r=n(0),o=n(1),i=n(4),a=n(2),s=function(){function e(){var e=this;e.Ue=[],e.Re={}}return e.prototype.S=function(e){var t=this;t.ze=r.NanoSQLInstance.Q(JSON.stringify(e._)),t.x=e.x,t.fe=new i.Xe(t,e)},e.prototype.V=function(e){var t=this;new a.H(t).ae(e,function(e){})},e.prototype.Pe=function(e,t,n,r){var o=this;o.Re[e]={},t.length&&r&&o.x.triggerEvent({name:"change",actionOrView:"",table:o.fe.le[e].de,query:[],time:(new Date).getTime(),result:[{msg:r+" was performed.",type:r}],changedRows:t,changeType:n},["change"])},e.prototype.$e=function(e,t){if(!e)return e;var n=this;return n.fe._[t].forEach(function(r){var o=e[r.key];["map","array"].indexOf(typeof o)>=0&&(e[r.key]=n.$e(o,t))}),Object.freeze(e)},e.prototype.A=function(e){return"start"===e&&(this.fe.De=!0),"end"===e&&(this.fe.De=!1),!!this.fe.De},e.prototype.M=function(e,t){var n,i,a,s,_=this,c=function(e,t){var o={},i=_.fe.Te-_.fe.Ee;_.fe.ve("_historyPoints",function(e){return e.historyPoint===i},function(i){a=0;var c=function(){if(a<i.length){n=0;var u=i[a].tableID,l=_.fe.le[u],f=[],d=function(){n<i[a].rowKeys.length?(s=i[a].rowKeys[n],"int"===l.Ce&&(s=parseInt(s)),_.fe.ve(l.de,s,function(t){e>0&&f.push(t[0]),_.fe.ve("_"+l.de+"_hist__meta",s,function(t){t=r.t(t),t[0].Ae+=e;var c=t[0].xe[t[0].Ae];_.fe.ye("_"+l.de+"_hist__meta",s,t[0],function(){_.fe.ve("_"+l.de+"_hist__data",c,function(t){var c=t[0]?r.t(t[0]):null;_.fe.ye(l.de,s,c,function(){e<0&&f.push(c),o[u]||(o[u]={type:i[a].type,rows:[]}),o[u].rows=o[u].rows.concat(f),n++,d()})})})})})):(a++,c())};d()}else t(o)};c()})};return new o.k(function(e,n){switch(t){case"<":_.fe.Te&&_.fe.Ee!==_.fe.Te?c(1,function(t){_.fe.Ee++,_.fe.Ne("w","historyPoint",_.fe.Ee),Object.keys(t).forEach(function(e){var n=t[e].type;switch(n){case"inserted":n="deleted";break;case"deleted":n="inserted"}_.Pe(parseInt(e),t[e].rows,n,"undo")}),e(!0)}):e(!1);break;case">":!_.fe.Te||_.fe.Ee<1?e(!1):(_.fe.Ee--,_.fe.Ne("w","historyPoint",_.fe.Ee),c(-1,function(t){Object.keys(t).forEach(function(e){_.Pe(parseInt(e),t[e].rows,t[e].type,"redo")}),e(!0)}));break;case"?":i=[_.fe.Te,_.fe.Te-_.fe.Ee],_.fe.Ge.join("+")!==i.join("+")&&(_.fe.Ge=i),e(_.fe.Ge);break;case"flush_db":Object.keys(_.fe.le).forEach(function(e){var t=_.fe.le[parseInt(e)].We;_.Pe(parseInt(e),Object.keys(t).map(function(e){return t[e]}),"remove","clear")}),_.fe.Ye(e);break;case"flush_history":_.fe.Ze(e)}})},e}();t.w=s},function(e,t,n){var r=n(0),o=n(2),i=function(e){return["_utility","_historyPoints"][e]},a=function(){function e(e,t){this.et=t,this.init(e,t)}return e.prototype.init=function(e,t){var n=this;n._={},n.le={},n.tt={},n.Ee=0,n.Te=0,n.Ge=[0,0],n.De=!1,n.Oe=!0,n.nt=!0,n.rt=!1,n.ot={},n.it=0,n.x=e;t.O.length&&(n.rt=void 0!==t.O[0].persistent&&t.O[0].persistent,n.Oe=void 0===t.O[0].history||t.O[0].history,n.nt=void 0===t.O[0].memory||t.O[0].memory,t.O[0].size||5,n.it={IDB:1,LS:2,LVL:4}[t.O[0].mode]||0);var a=!1,s=0,_=!0;Object.keys(t._).forEach(function(e){t._["_"+e+"_hist__data"]=r.t(t._[e]),t._["_"+e+"_hist__data"]=t._["_"+e+"_hist__data"].map(function(e){return delete e.props,e}),t._["_"+e+"_hist__meta"]=[{key:"id",type:"int",props:["ai","pk"]},{key:"_pointer",type:"int"},{key:"_historyDataRowIDs",type:"array"}]}),t._[i(0)]=[{key:"key",type:"string",props:["pk"]},{key:"value",type:"blob"}],t._[i(1)]=[{key:"id",type:"int",props:["ai","pk"]},{key:"tableID",type:"int"},{key:"historyPoint",type:"int"},{key:"rowKeys",type:"array"},{key:"type",type:"string"}];var c,u,l=Object.keys(t._);Object.keys(t._).forEach(function(e){n.at(e,t._[e])}),Object.keys(t.b||[]).forEach(function(e){o.b[e]=t.b[e]});var f=function(){var e=Object.keys(t._),r=0;if(n.it=u,c&&n.ve(i(0),"all",function(e){e.forEach(function(e){n.Ne("w",e.key,e.value),"historyPoint"===e.key&&(n.Ee=e.value||0),"historyLength"===e.key&&(n.Te=e.value||0)})}),_){var o=function(){r<e.length?e[r].indexOf("_hist__data")!==-1?n.ye(e[r],0,null,function(){r++,o()}):(r++,o()):(n.Oe=c,t.I())};o()}else n.Oe=c,t.I()};if(u=n.it,n.rt)if(0!==n.it)switch(n.it){case 1:"undefined"==typeof indexedDB&&(n.it=0);break;case 2:"undefined"==typeof localStorage&&(n.it=0);break;case 3:n.it=0;break;case 4:"undefined"!=typeof window&&(n.it=0)}else"undefined"!=typeof window&&("undefined"!=typeof localStorage&&(n.it=2),"undefined"!=typeof indexedDB&&(n.it=1)),"undefined"!=typeof levelup&&"undefined"!=typeof fs&&(n.it=4);else n.it=0,f();switch(c=n.Oe,u=n.it,n.it=0,n.Oe=!1,u){case 1:var d=indexedDB.open(String(n.x.ze),1);d.onupgradeneeded=function(e){a=!0;var t=e.target.result,o=e.target.transaction;n.st=t;var i=function(){if(s<l.length){var e=r.NanoSQLInstance.Q(l[s]),a=n.le[e].Le?{keyPath:n.le[e].Le}:{};t.createObjectStore(n.le[e].de,a),s++,i()}else o.oncomplete=function(){f()}};i()},d.onsuccess=function(e){if(n.st=e.target.result,!a){_=!1;var t=function(){if(s>=l.length)return void f();if(!c&&(l[s].indexOf("_hist__data")!==-1||l[s].indexOf("_hist__meta")!==-1))return s++,void t();if(s<l.length){var e=r.NanoSQLInstance.Q(l[s]),o=n.st.transaction(l[s],"readonly"),i=o.objectStore(l[s]),a=i.openCursor(),_=[];o.oncomplete=function(){n.nt?l[s].indexOf("_hist__data")!==-1?(n.le[e].Qe.push("0"),n.le[e].We[0]=null,n.le[e].Me++,n.x.x.loadJS(l[s],_).then(function(){s++,t()})):n.x.x.loadJS(l[s],_).then(function(){s++,t()}):(n.le[e].Qe=_,n.le[e].Me=_.reduce(function(e,t){return Math.max(parseInt(t),e)},0)+1,s++,t())},a.onsuccess=function(e){var t=e.target.result;t&&(_.push(n.nt?t.value:t.key),t.continue())}}};t()}};break;case 2:if(localStorage.getItem("dbID")!==String(n.x.ze))localStorage.clear(),localStorage.setItem("dbID",String(n.x.ze)),l.forEach(function(e){r.NanoSQLInstance.Q(e);localStorage.setItem(e,JSON.stringify([]))}),f();else if(_=!1,l.forEach(function(e){var t=r.NanoSQLInstance.Q(e),o=JSON.parse(localStorage.getItem(e)||"[]");n.le[t].Qe=o,n.nt||(n.le[t].Me=o.reduce(function(e,t){return Math.max(parseInt(t),e)},0)+1)}),n.nt){var p=0,h=function(){if(p<l.length){var e=[];if(!c&&(l[p].indexOf("_hist__data")!==-1||l[s].indexOf("_hist__meta")!==-1))return p++,void h();JSON.parse(localStorage.getItem(l[p])||"[]").forEach(function(t){e.push(JSON.parse(localStorage.getItem(l[p]+"-"+t)||""))}),n.x.x.loadJS(l[p],e).then(function(){p++,h()})}else f()};h()}else f()}},e.prototype.Ze=function(e){var t=this,n=Object.keys(t.le),r=0;!function(){r<n.length?(n[r].indexOf("_hist__meta"),n[r].indexOf("_hist__data"),n[r]):e()}()},e.prototype.Ie=function(e,t,n){var o=this,i=r.NanoSQLInstance.Q(e);if(o.le[i].Qe.splice(o.le[i].Qe.indexOf(String(t)),1),o.nt&&(console.log(o.le),delete o.le[i].We[t],0===o.it&&n))return n(!0);switch(o.it){case 1:o.st.transaction(e,"readwrite").objectStore(e).delete(t),n&&n(!0);break;case 2:localStorage.removeItem(e+"-"+String(t)),localStorage.setItem(e,JSON.stringify(o.le[i].Qe)),n&&n(!0)}},e.prototype.ye=function(e,t,n,o){var i=this,a=r.NanoSQLInstance.Q(e);void 0!==t&&null!==t||(i._[a].forEach(function(e){e.props&&e.props.indexOf("pk")!==-1&&(t="uuid"===e.type?r.NanoSQLInstance.uuid():i.le[a].Me++)}),t||(t=parseInt(i.le[a].Qe[i.le[a].Qe.length-1]||"0")+1)),"int"===i.le[a].Ce&&(t=parseInt(t));var s=i.le[a].Le;if(s&&s.length&&n&&!n[s]&&(n[s]=t),i.le[a]&&i.le[a].Qe.indexOf(String(t))===-1&&i.le[a].Qe.push(String(t)),i.nt&&i.le[a]&&(i.le[a].We[t]=i.x.$e(n,a),0===i.it&&o))return o(t);switch(i.it){case 1:var _=i.st.transaction(e,"readwrite"),c=_.objectStore(e);s.length&&n?c.put(n):e.indexOf("_hist__data")!==-1?c.put(n,t):(n&&c.put(n),n||c.delete(t)),_.oncomplete=function(){o&&o(t)};break;case 2:localStorage.setItem(e+"-"+String(t),n?JSON.stringify(n):""),localStorage.setItem(e,JSON.stringify(i.le[a].Qe)),o&&o(t)}},e.prototype.ve=function(e,t,n){var o=this,i=r.NanoSQLInstance.Q(e);if(o.nt&&o.le[i]){var a=o.le[i].We;if("all"===t||"function"==typeof t){var s=Object.keys(a).map(function(e){return a[e]});n("all"===t?s.filter(function(e){return e}):s.filter(function(e){return t(e)}))}else n([a[t]].filter(function(e){return e}))}else switch(o.it){case 1:var _=o.st.transaction(e,"readonly"),c=_.objectStore(e);if("all"===t||"function"==typeof t){var u=c.openCursor(),l=[];_.oncomplete=function(){n(l)},u.onsuccess=function(e){var n=e.target.result;n&&("all"!==t?t(n.value)&&l.push(n.value):l.push(n.value),n.continue())}}else{var f=c.get(t);f.onsuccess=function(e){n([f.result])}}break;case 2:if("all"===t||"function"==typeof t){var d=o.le[i].Qe.map(function(t){var n=localStorage.getItem(e+"-"+t);return n&&n.length?JSON.parse(n):null});n("all"!==t?d.filter(function(e){return t(e)}):d)}else{var p=localStorage.getItem(e+"-"+t);n([p&&p.length?JSON.parse(p):null])}break;case 4:if("all"===t||"function"==typeof t){var h=[];o.tt[e].createValueStream().on("data",function(e){h.push(JSON.parse(e))}).on("end",function(){n("all"!==t?h.filter(function(e){return t(e)}):h)})}else o.tt[e].get(String(t),function(e,t){n(e?[null]:[JSON.parse(t)])})}},e.prototype.Ye=function(e){var t=this;switch(t.et.I=e,t.et.j=function(){},t.it){case 0:t.init(t.x,t.et);break;case 1:indexedDB.deleteDatabase(String(t.x.ze)).onsuccess=function(){t.init(t.x,t.et)};break;case 2:localStorage.clear(),t.init(t.x,t.et)}e&&e(!0)},e.prototype.Ne=function(e,t,n){return"r"===e?this.ot[t]?this.ot[t].value:null:(this.ye(i(0),t,{key:t,value:n}),this.Ne[t]={key:t,value:n},n)},e.prototype.at=function(e,t){var n=this,o=r.NanoSQLInstance.Q(e);n._[o]=t,n.x.Re[o]={},n.le[o]={Le:"",Ce:"",we:[],Se:[],de:e,Me:1,Qe:[],We:{}};for(var i=n._[o].length;i--;){var a=n._[o][i];n.le[o].we.unshift(a.key),n.le[o].Se[i]=a.default,a.props&&a.props.indexOf("pk")>=0&&(n.le[o].Le=a.key,n.le[o].Ce=a.type)}return e},e.prototype._t=function(){return"undefined"!=typeof navigator&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent)},e.prototype.ct=function(){var e=["iPad","iPhone","iPod"];if("undefined"!=typeof navigator&&navigator.platform)for(;e.length;)if(navigator.platform.indexOf(e.pop())!==-1)return!0;return!1},e}();t.Xe=a},function(e,t,n){e.exports=n(0)}])});
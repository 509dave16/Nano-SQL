!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){e.exports=n(1)},function(e,t,n){"use strict";function r(e){return f.init(e)}var i=this&&this.e||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},o=n(2),s=n(3),c=n(4),u=function(){function e(){var e=this;e.t=new o.tsMap,e.n=new o.tsMap,e.r=new o.tsMap,e.i=[],e.o=["change","delete","upsert","drop","select","error"],e.s=new o.tsMap,e.s.set("*",new o.tsMap),e.o.forEach(function(t){e.s.get("*").set(t,[])}),e.u=new o.tsMap}return e.prototype.init=function(e){return e&&(this.a=e),this},e.prototype.connect=function(e){var t=this;return t.f=e||new c.someSQL_MemDB,new a(t,function(e,n){t.f.connect(t.r,t.t,t.n,t.u,e,n)})},e.prototype.on=function(e,t){var n=this;return e.split(" ").forEach(function(e){n.o.indexOf(e)!=-1&&n.s.get(n.a).get(e).push(t)}),this},e.prototype.model=function(e){var t=this,n=t.a;return t.s.set(n,new o.tsMap),t.s.get(n).set("*",[]),t.o.forEach(function(e){t.s.get(n).set(e,[])}),t.r.set(n,e),t.n.set(n,{}),t.t.set(n,{}),this},e.prototype.views=function(e){return this.n.set(this.a,e),this},e.prototype.getView=function(e,t){var n=this,r=n.a,i=n.n.get(r)[e];return n.l=e,i[1].apply(n,[n._(i[0],t)])},e.prototype._=function(e,t){var n=this,r=(n.a,{});return e.forEach(function(e){var i=e.split(":");i.length>1?r[i[0]]=n.h(i[1],t[i[0]]):r[i[0]]=t[i[0]]}),r},e.prototype.h=function(e,t){switch(["string","int","float","array","map"].indexOf(e)){case 0:return String(t);case 1:return parseInt(t);case 2:return parseFloat(t);case 3:case 4:return JSON.parse(JSON.stringify(t));default:return""}},e.prototype.actions=function(e){return this.t.set(this.a,e),this},e.prototype.doAction=function(e,t){var n=this,r=n.t.get(n.a)[e];return n.l=e,r[1].apply(n,[n._(r[0],t)])},e.prototype.addFilter=function(e,t){return this.u.set(e,t),this},e.prototype.query=function(e,t){this.i=[];var n=e.toLowerCase();return["select","upsert","delete","drop"].indexOf(n)!=-1&&this.i.push(new o.tsMap([["type",n],["args",t]])),this},e.prototype.where=function(e){return this.d("where",e)},e.prototype.orderBy=function(e){return this.d("orderby",e)},e.prototype.limit=function(e){return this.d("limit",e)},e.prototype.offset=function(e){return this.d("offset",e)},e.prototype.filter=function(e,t){return this.d("filter-"+e,t)},e.prototype.d=function(e,t){return this.i.push(new o.tsMap([["type",e],["args",t]])),this},e.prototype.exec=function(){var e=this,t=e.a;e.y=e.i.map(function(e){switch(e.get("type")){case"select":return[e.get("type")];case"delete":case"upsert":case"drop":return[e.get("type"),"change"];default:return[]}}).reduce(function(e,t){return e.concat(t)});var n=function(n){e.y.forEach(function(r){e.s.get(t).get(r).concat(e.s.get("*").get(r)).forEach(function(t){n.name=r,n.actionOrView=e.l,t.apply(e,[n])})}),e.l=void 0};return new a(e,function(r,i){e.f.exec(t,e.i,e.l,function(i){n({table:t,query:e.i.map(function(e){return e.toJSON()}),time:(new Date).getTime(),result:i}),r(i)},function(r){e.y=["error"],n({table:t,query:e.i.map(function(e){return e.toJSON()}),time:(new Date).getTime(),result:r}),i(r)})})},e.prototype.custom=function(e,t){var n=this;return new a(n,function(r,i){n.f.custom?n.f.custom.apply(n,[e,t,r,i]):r()})},e.prototype.loadJS=function(e){var t=this;return s.tsPromise.all(e.map(function(e){return t.init(t.a).query("upsert",e).exec()}))},e.prototype.loadCSV=function(e){var t=this,n=[];return new a(t,function(r,i){s.tsPromise.all(e.split("\n").map(function(e,r){return new a(t,function(i,o){if(0==r)n=e.split(","),i();else{var s={},c=e.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g).map(function(e){return e.replace(/^"(.+(?="$))"$/,"$1")});n.forEach(function(e,t){0!=c[t].indexOf("{")&&0!=c[t].indexOf("[")||(c[t]=JSON.parse(c[t].replace(/'/g,'"'))),s[e]=c[t]}),t.init(t.a).query("upsert",c).exec().then(function(){i()})}})})).then(function(){r()})})},e.prototype.toCSV=function(e){var t=this;return new a(t,function(n,r){t.exec().then(function(r){var i=t.i.filter(function(e){return"select"==e.get("type")}).map(function(e){return e.get("args")?e.get("args").map(function(e){return t.r.get(t.a).filter(function(t){return t.key==e})[0]}):t.r.get(t.a)})[0];e&&r.unshift(i.map(function(e){return e.key})),n(r.map(function(t,n){return e&&0==n?t:i.filter(function(e){return!!t[e.key]}).map(function(e){switch(e.type){case"map":return'"'+JSON.stringify(t[e.key]).replace(/"/g,"'")+'"';case"array":return'"'+JSON.stringify(t[e.key]).replace(/"/g,"'")+'"';default:return JSON.stringify(t[e.key])}}).join(",")}).join("\n"))})})},e.uuid=function(e){return e?e:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})}()},e.hash=function(e){for(var t=5381,n=0;n<e.length;n++){var r=e.charCodeAt(n);t=(t<<5)+t+r}return String(t)},e}();t.someSQL_Instance=u;var a=function(e){function t(t,n){var r=e.call(this,n)||this;return r.scope=t,r}return i(t,e),t.prototype.then=function(e,n){var r=this;return new t(r.scope,function(t,i){r.done(function(n){if("function"==typeof e)try{n=e.apply(r.scope,[n])}catch(e){return void i(e)}t(n)},function(e){if("function"==typeof n){try{e=n.apply(r.scope,[e])}catch(e){return void i(e)}t(e)}else i(e)})})},t}(s.tsPromise),f=new u;t.someSQL=r},function(e,t){"use strict";var n=function(){function e(e){var t=this;t.g=[],t.v=[],t.x=[],t.length=0,e&&e.forEach(function(e,n){t.set(e[0],e[1])})}return e.prototype.fromJSON=function(e){for(var t in e)e.hasOwnProperty(t)&&this.set(t,e[t])},e.prototype.toJSON=function(){var e={},t=this;return t.keys().forEach(function(n){e[String(n)]=t.get(n)}),e},e.prototype.entries=function(){return[].slice.call(this.g)},e.prototype.keys=function(){return[].slice.call(this.v)},e.prototype.values=function(){return[].slice.call(this.x)},e.prototype.has=function(e){return this.v.indexOf(e)>-1},e.prototype.get=function(e){var t=this.v.indexOf(e);return t>-1?this.x[t]:void 0},e.prototype.set=function(e,t){var n=this,r=this.v.indexOf(e);r>-1?(n.g[r][1]=t,n.x[r]=t):(n.g.push([e,t]),n.v.push(e),n.x.push(t)),n.length=n.size()},e.prototype.size=function(){return this.g.length},e.prototype.clear=function(){var e=this;e.v.length=e.x.length=e.g.length=0,e.length=e.size()},e.prototype.delete=function(e){var t=this,n=t.v.indexOf(e);return n>-1&&(t.v.splice(n,1),t.x.splice(n,1),t.g.splice(n,1),t.length=t.size(),!0)},e.prototype.forEach=function(e){var t=this;t.v.forEach(function(n){e(t.get(n),n)})},e.prototype.map=function(e){var t=this;return this.v.map(function(n){return e(t.get(n),n)})},e.prototype.filter=function(e){var t=this;return t.v.forEach(function(n){0==e(t.get(n),n)&&t.delete(n)}),this},e.prototype.clone=function(){return new e(JSON.parse(JSON.stringify(this.g)))},e}();t.tsMap=n},function(e,t){"use strict";var n=function(){function e(e){this.s=[],this.b=!1,this.w=!1,this.k=!1,e(this.O.bind(this),this.T.bind(this))}return e.resolve=function(t){return new e(function(e){e(t)})},e.reject=function(t){return new e(function(e,n){n(t)})},e.race=function(t){var n=!1;return new e(function(e,r){t.forEach(function(t){t.then(function(t){n||(e(t),n=!0)}).catch(function(e){r(e),n=!0})})})},e.chain=function(t){var n,r=0,i=[],o=function(e){r==t.length?n(i):e.then(function(e){i.push(e),r++,o(t[r])})};return new e(function(e){n=e,o(t[r])})},e.all=function(t){return new e(function(e,n){var r=t.length,i=[],o=!1;t.forEach(function(t,s){t.then(function(t){o||(r--,i[s]=t,0==r&&e(i))}).catch(function(e){n(e),o=!0})})})},e.prototype.done=function(e,t){this.k?setTimeout(this.S.bind(this,e,t),0):this.s.push({onSuccess:e,onFail:t})},e.prototype.then=function(t,n){var r=this;return new e(function(e,i){r.done(function(n){if("function"==typeof t)try{n=t(n)}catch(e){return void i(e)}e(n)},function(t){if("function"==typeof n){try{t=n(t)}catch(e){return void i(e)}e(t)}else i(t)})})},e.prototype.catch=function(e){return this.then(null,e)},e.prototype.S=function(e,t){this.b?t(this.M):e(this.M)},e.prototype.O=function(t){this.w||(this.w=!0,t instanceof e?t.done(this.K.bind(this),function(e){this.b=!0,this.K(e)}.bind(this)):this.K(t))},e.prototype.T=function(e){this.w||(this.w=!0,this.b=!0,this.K(e))},e.prototype.K=function(e){this.k=!0,this.M=e,setTimeout(this.s.forEach.bind(this.s,function(e){this.S(e.onSuccess,e.onFail)},this),0)},e}();t.tsPromise=n},function(e,t,n){"use strict";var r=n(1),i=n(3),o=n(2),s=function(){function e(e,t,n){var r=this;r.N=e,r.q=t||[],r.J=n||[],r.j=1,r.length=0,r.F=r.N.reduce(function(e,t){return t.props&&t.props.indexOf("pk")!=-1?(r.C=t.type,t.key):e},"")}return e.I=function(e){return JSON.parse(JSON.stringify(e))},e.prototype.A=function(e){return this.J[this.q.indexOf(e)]},e.prototype.V=function(e,t){this.J[this.q.indexOf(e)]=t},e.prototype.W=function(e){var t=this;if(e[t.F])t.V(e[t.F],e);else{switch(t.C){case"int":e[t.F]=t.j,t.j++;break;case"uuid":e[t.F]=r.someSQL_Instance.uuid()}t.q.push(e[t.F]),t.J.push(e),t.length=t.q.length}},e.prototype.L=function(e){var t=this;return t.q.forEach(function(n){e.apply(t,[t.A(n),n])||t.P(n)}),t.length=t.q.length,this},e.prototype.Q=function(e){var t=this;return t.q.forEach(function(n){e.apply(t,[t.A(n),n])}),t},e.prototype.z=function(e){var t=this,n=[],r=-1;return t.q.sort(function(r,i){var o=e.apply(t,[t.A(r),t.A(i)]);return n.push(o),o}),t.J.sort(function(e,t){return r++,n[r]}),t},e.prototype.D=function(e,t,n,r){var i=this,o=[];o=n?n:[i.F,t.F];[this,t].sort(function(e,t){return e.length>t.length?-1:1});switch(e){case"inner":var s=[this,t].sort(function(e,t){return e.length>t.length?-1:1});return s[0].L(function(e,t){var n=!1;return s[1].Q(function(t,r){0==n&&e[o[0]]==t[o[1]]&&(n=!0)}),n});case"outer":return t.Q(function(e,t){var n=!1;i.Q(function(t,r){0==n&&t[o[0]]==e[o[1]]&&(n=!0)}),n||i.W(e)}),i.z(function(e,t){return e[n[0]]>t[n[0]]?1:-1}),i}},e.prototype.P=function(e){var t=this,n=t.q.indexOf(e);t.q.splice(n,1),t.J.splice(n,1),t.length=t.q.length},e.prototype.$=function(){var t=new e(this.N,e.I(this.q),e.I(this.J));return t.j=this.j,t.length=this.length,t},e}(),c=function(){function e(){var e=this;e.u=new o.tsMap,e.B=new o.tsMap,e.R=new o.tsMap,e.G=new o.tsMap,e.H()}return e.prototype.connect=function(e,t,n,r,i){var o=this;e.forEach(function(e,t){o.U(t,e)}),r.forEach(function(e,t){o.u.set(t,e)}),i()},e.prototype.U=function(e,t){this.G.set(e,new o.tsMap),this.R.set(e,new o.tsMap),this.B.set(e,new s(t))},e.prototype.exec=function(e,t,n,o,s){var c=this;c.a=e,c.X=[],c.Y=null,c.Z=r.someSQL_Instance.hash(JSON.stringify(t)),i.tsPromise.all(t.map(function(e){return new i.tsPromise(function(t,n){c.i(e,t)})})).then(function(){c.ee(o)})},e.prototype.i=function(e,t){["upsert","select","delete","drop"].indexOf(e.get("type"))!=-1?this.Y=e:this.X.push(e),t()},e.prototype.H=function(){var e=this,t=e.u;t.set("sum",function(t){return t.map(function(t){return t[e.Y.get("args")[0]]}).reduce(function(e,t){return e+t},0)}),t.set("first",function(e){return e[0]}),t.set("last",function(e){return e.pop()}),t.set("min",function(t){return t.map(function(t){return t[e.Y.get("args")[0]]}).sort(function(e,t){return e<t?-1:1})[0]}),t.set("max",function(t){return t.map(function(t){return t[e.Y.get("args")[0]]}).sort(function(e,t){return e>t?-1:1})[0]}),t.set("average",function(t){return e.te("sum",t)/t.length}),t.set("count",function(e){return e.length})},e.prototype.te=function(e,t,n){return this.u.get(e).apply(this,[t,n])},e.prototype.ne=function(e){var t=this,n=t.X.filter(function(e){return 0==e.get("type").indexOf("filter-")});return n.length?n.reduce(function(e,r,i){return t.te(n[i].get("type").replace("filter-",""),e,n[i].get("args"))},e):e},e.prototype.re=function(e){var t=this;e.forEach(function(e){t.R.get(t.a).forEach(function(e,n){e.indexOf(n)!=-1&&(t.R.get(t.a).delete(n),t.G.get(t.a).delete(n))})})},e.prototype.ee=function(e){var t,n=this,r=n.X.filter(function(e){return"where"==e.get("type")}),i=r.length?r[0].get("args"):void 0,s=n.Y.get("args"),c=n.B.get(n.a),u=0;switch(n.Y.get("type")){case"upsert":if(i){t=n.ie(c,i);var a=[];t.Q(function(e,t){for(var n in s)c.A(t)[n]=s[n];a.push(t),u++}),n.re(a)}else c.W(s),u++,n.G.set(n.a,new o.tsMap),n.R.set(n.a,new o.tsMap);e(u+" row(s) upserted");break;case"select":if(n.G.get(n.a).has(n.Z))return void e(n.G.get(n.a).get(n.Z));t=i?n.ie(c,i):c.$();var f=["ordr","ofs","lmt","clms"],l=function(e){return n.X.filter(function(t){return t.get("type")==e}).pop()},p=f.reduce(function(e,t,n){switch(f[n]){case"ordr":if(l("orderby")){var r=l("orderby");return e.sort(function(e,t){return r.map(function(n,r){return e[r]==t[r]?0:(e[r]>t[r]?1:-1)*("asc"==n?1:-1)})})}case"ofs":if(l("offset")){var i=l("offset").get("args");return e.filter(function(e,t){return t>=i})}case"lmt":if(l("limit")){var o=l("limit").get("args");return e.filter(function(e,t){return t<o})}case"clms":if(s){var u=c.N.map(function(e){return e.key}).filter(function(e){return s.indexOf(e)==-1});return e.map(function(e){return u.forEach(function(t){return delete e[t]}),e})}default:return e}},t.J),_=n.ne(p);n.G.get(n.a).set(n.Z,_),n.R.get(n.a).set(n.Z,p.map(function(e){return e[t.F]})),e(_);break;case"delete":if(i){var h=[],d=n.ie(c,i);d.Q(function(e,t){c.P(t),h.push(t)}),n.re(h),e(d.length+" row(s) deleted")}else n.U(n.a,n.B.get(n.a).N),e("Table dropped.");break;case"drop":n.U(n.a,n.B.get(n.a).N),e("Table dropped.")}},e.prototype.ie=function(e,t){var n=this;if(t&&t.length){if("string"==typeof t[0])return n.oe(e.$(),t);var r=0,i=null;return t.map(function(t){return n.oe(e.$(),t)}).reduce(function(e,o,s){return 0==s?o:0==r?(i=t[s],r=1,e):1==r?(r=0,n.se(i,e,o)):void 0})}return e.$()},e.prototype.se=function(e,t,n){switch(e){case"and":return t.D("inner",n);case"or":return t.D("outer",n);default:return t}},e.prototype.oe=function(e,t){var n=this,r=t[0],i=t[1],o=t[2];return e.L(function(e){return 0==n.ce(o,i,e[r])})},e.prototype.ce=function(e,t,n){switch(t){case"=":return n==e?0:1;case">":return n>e?0:1;case"<":return n<e?0:1;case"<=":return n<=e?0:1;case">=":return n>=e?0:1;case"IN":return e.indexOf(n)==-1?1:0;case"NOT IN":return e.indexOf(n)==-1?0:1;case"LIKE":return n.search(e)==-1?1:0;default:return 0}},e}();t.someSQL_MemDB=c}])});
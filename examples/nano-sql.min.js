!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.e?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=8)}([function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(2),o=n(1),i=n(6),a=n(7);t.t=function(e){return JSON.parse(JSON.stringify(e))};var s=function(){function e(){var e=this;e.r={},e.a={},e._={},e.u=[],e.f=[],e.h=["*","change","delete","upsert","drop","select","error"],e.y={},e.b={},e.g={},e.y["*"]={},e.v=[];for(var t=e.h.length;t--;)e.y["*"][e.h[t]]=[];e.x={},e.w={}}return e.prototype.table=function(e){return e&&(this.sTable=e),this},e.prototype.connect=function(e){var t=this,n=this;return n.backend?new o.k(function(e,t){throw t(),Error()}):(n.backend=e||new r.I,new o.k(function(e,r){n.backend.O({_:n._,r:n.r,a:n.a,x:n.x,S:n.u,N:t,D:function(t){e(t,n)},P:function(e){r&&r(e,n)}})}))},e.prototype.on=function(e,t){var n=this,r=n.sTable,o=n.h.length,i=e.split(" ");if(!n.y[r])for(n.y[r]={},n.y[r]["*"]=[];o--;)n.y[r][n.h[o]]=[];for(o=i.length;o--;)-1!==n.h.indexOf(i[o])&&n.y[r][i[o]].push(t);return n.L(),n},e.prototype.off=function(e){var t=this;for(var n in t.y)for(var r in t.y[n])t.y[n][r]=t.y[n][r].filter(function(t){return t!==e});return t.L(),t},e.prototype.L=function(){var e=this;this.g={},Object.keys(this._).concat(["*"]).forEach(function(t){e.g[t]=e.h.reduce(function(n,r){return n+(e.y[t]?e.y[t][r].length:0)},0)>0})},e.prototype.model=function(e){var t=this,n=t.sTable,r=t.h.length;if(!t.y[n])for(t.y[n]={},t.y[n]["*"]=[];r--;)t.y[n][t.h[r]]=[];return t._[n]=e,t.v.push(n),t.a[n]=[],t.r[n]=[],t},e.prototype.views=function(e){return this.a[this.sTable]=e,this},e.prototype.getView=function(e,t){return void 0===t&&(t={}),this.j("View",this.a[this.sTable],e,t)},e.prototype.cleanArgs=function(e,t){var n=this,r=(n.sTable,{}),o=e.length?e.length:-1;if(o>0)for(;o--;){var i=e[o].split(":");i.length>1?r[i[0]]=n.T(i[1],t[i[0]]||null):r[i[0]]=t[i[0]]||null}return r},e.prototype.T=function(e,n){var r=this,o={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},i=typeof n,a=function(e,n){switch(e){case"safestr":return a("string",n).replace(/[&<>"'`=\/]/g,function(e){return o[e]});case"int":return"number"!==i||n%1!=0?parseInt(n||0):n;case"float":return"number"!==i?parseFloat(n||0):n;case"any[]":case"array":return Array.isArray(n)?t.t(n||[]):[];case"uuid":case"timeId":case"timeIdms":case"string":return null===n?"":"string"!==i?String(n):n;case"map":return"object"===i?t.t(n||{}):{};case"bool":return!0===n}return n},s=a(e,n);if(-1!==e.indexOf("[]")){var _=e.slice(0,e.lastIndexOf("[]"));return(n||[]).map(function(e){return r.T(_,e)})}if(void 0!==s)return-1!==["int","float"].indexOf(e)&&isNaN(s)?0:s},e.prototype.actions=function(e){return this.r[this.sTable]=e,this},e.prototype.doAction=function(e,t){return this.j("Action",this.r[this.sTable],e,t)},e.prototype.j=function(e,t,n,r){var i=this,a=this,s=t.reduce(function(e,t){return t.name===n?t:e},null);if(!s)return new o.k(function(e,t){return t("Action/View Not Found!")});a.A=n;var _=s.args?a.cleanArgs(s.args,r):{};return a.M?new o.k(function(t,n){a.M(i.sTable,e,a.A||"",_,function(e){!!s&&s.call(e,a).then(function(e){t(e,a)})},function(e){n(e)})}):s.call(_,a)},e.prototype.newFunction=function(e,t,n){return this.x[e]={type:t,call:n},this},e.prototype.query=function(e,t,n){var r=this,o=new i.q(r.sTable,r,r.A);r.A=void 0;var a=e.toLowerCase();if(-1===["select","upsert","delete","drop","show tables","describe"].indexOf(a))throw Error;var s=t||("select"===a||"delete"===a?[]:{});if(-1!==["upsert","delete","drop"].indexOf(a)&&r.f.push(r.sTable),"delete"===e&&!n){var _={};r._[r.sTable].forEach(function(e){-1!==r.v.indexOf(e.type.replace("[]",""))&&(s[e.key]=void 0)}),s=_}if("upsert"===e){var c={};r._[r.sTable].forEach(function(e){if(n||-1!==r.v.indexOf(e.type.replace("[]",""))&&(s[e.key]=void 0),void 0!==s[e.key]){var t=r.T(e.type,s[e.key]);void 0!==t&&(c[e.key]=t)}}),r.w[r.sTable]&&(c=r.w[r.sTable](c)),s=c}return o.Q={type:a,args:s},o},e.prototype.updateORM=function(e,t,n){return new i.C(this,this.sTable,e,t,n)},e.prototype.defaultORM=function(e){return this.b[this.sTable]=e,this},e.prototype.triggerEvent=function(e,t){var n=this;setTimeout(function(){for(var r,o,i=t.length,a=0;i--;)for(r=t[i],o=n.y[e.table][r].concat(n.y[e.table]["*"]),a=o.length;a--;)e.name=r,o[a](e,n)},0)},e.prototype.default=function(e){var t={},n=this;return n._[n.sTable].forEach(function(r){t[r.key]=e&&e[r.key]?e[r.key]:r.default,t[r.key]||(t[r.key]=n.T(r.type,null))}),t},e.prototype.doTransaction=function(t){var n=this,r=[],i=e.random16Bits();return new o.k(function(o,s){n.backend.R("start",i).then(function(){t(function(e){var t=e||n.sTable;return{query:function(e,n){return new a.F(e,n,t,r)},updateORM:function(e,n,o){return"rebuild"===e?void 0:new a.B(r,t,e,n,o)}}},function(){e.chain(r.map(function(e){return function(t){if("std"===e.type)n.table(e.table).query(e.action,e.actionArgs,!0).tID(i).manualExec(e.table,e.query||[]).then(t);else{var r=n.table(e.table).updateORM(e.action,e.column,e.relationIDs).tID(i),o=e.where;o&&r.where(o),r.exec().then(t)}}}))(function(){n.backend.R("end",i).then(function(e){n.f.forEach(function(e){0!==e.indexOf("_")&&n.triggerEvent({table:e,query:[],time:(new Date).getTime(),result:[],name:"change",actionOrView:"",changeType:"transaction",changedRows:[],changedRowPKS:[]},["change"])}),o(e)})})})})})},e.prototype.queryFilter=function(e){return this.V=e,this},e.prototype.avFilter=function(e){return this.M=e,this},e.prototype.config=function(e){var t=this;return t.backend||t.u.push(e),t},e.prototype.extend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=this;if(n.backend)return n.backend.K?(e.unshift(n),n.backend.K.apply(n.backend,e)):void 0},e.prototype.loadJS=function(n,r,i){void 0===i&&(i=!0);var a=this;return i?a.doTransaction(function(e,t){r.forEach(function(t){e(n).query("upsert",t).exec()}),t()}):new o.k(function(o,i){e.chain(r.map(function(e){return function(r){t.nSQL(n).query("upsert",e).exec().then(r)}}))(function(e){o(e.map(function(e){return e.shift()}))})})},e.prototype.rowFilter=function(e){return this.w[this.sTable]=e,this},e.prototype.loadCSV=function(n,r,i){void 0===i&&(i=!0);var a=this,s=[],_=r.split("\n").map(function(e,t){if(0===t)return void(s=e.split(","));for(var n={},r=e.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)||[],o=s.length;o--;)1===r[o].indexOf("{")||1===r[o].indexOf("[")?r[o]=JSON.parse(r[o].slice(1,r[o].length-1).replace(/'/gm,'"')):0===r[o].indexOf('"')&&(r[o]=r[o].slice(1,r[o].length-1)),n[s[o]]=r[o];return n}).filter(function(e){return e});return i?a.doTransaction(function(e,t){_.forEach(function(t){e(n).query("upsert",t).exec()}),t()}):new o.k(function(r,o){e.chain(_.map(function(e){return function(r){t.nSQL(n).query("upsert",e).exec().then(r)}}))(function(e){r(e.map(function(e){return e.shift()}))})})},e.random16Bits=function(){if("undefined"==typeof crypto)return Math.round(Math.random()*Math.pow(2,16));if(crypto.getRandomValues){var e=new Uint16Array(1);return crypto.getRandomValues(e),e[0]}return"undefined"!==global&&global.H.randomBytes?global.H.randomBytes(2).reduce(function(e,t){return t*e}):Math.round(Math.random()*Math.pow(2,16))},e.chain=function(e){return function(t){var n=[],r=0;e.length||t([]);var i=function(){r<e.length?e[r](function(e){n.push(e),r++,o.setFast(i)}):t(n)};i()}},e.timeid=function(e){var t=this;t.J||(t.J=6e4*(new Date).getTimezoneOffset());for(var n=Math.round(((new Date).getTime()+t.J)/(e?1:1e3)).toString();n.length<(e?13:10);)n="0"+n;return n+"-"+(t.random16Bits()+t.random16Bits()).toString(16)},e.uuid=function(){var e,t,n=this,r="";return[r,r,r,r,r,r,r,r,r].reduce(function(o,i,a){for(e=n.random16Bits(),t=4===a?a:5===a?(e%16&3|8).toString(16):r,e=e.toString(16);e.length<4;)e="0"+e;return o+([3,4,5,6].indexOf(a)>=0?"-":r)+(t+e).slice(0,4)},r)},e.W=function(e){return Math.abs(e.split("").reduce(function(t,n,r){return(t<<5)+t+e.charCodeAt(r)},0))},e}();t.NanoSQLInstance=s;var _=new s;t.nSQL=function(e){return _.table(e)}},function(e,t,n){"use strict";function r(e,n,r){t.setFast(function(){var t;try{t=n.apply(null,r)}catch(t){return m.z(e,t)}return t===e?m.z(e,new TypeError):m.U(e,t),null})}function o(e){var t=e&&e.then;return!e||"object"!=typeof e&&"function"!=typeof e||"function"!=typeof t?null:function(){t.apply(e,arguments)}}function i(e,t){function n(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];i||(i=!0,m.z(e,t))}function r(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];i||(i=!0,m.U(e,t))}function o(){t(r,n)}var i=!1,s=a(o);"error"===s.X&&n(s.G)}function a(e,t){var n={X:null,G:null};try{n.G=e(t),n.X="success"}catch(e){n.X="error",n.G=e}return n}Object.defineProperty(t,"__esModule",{value:!0});var s=0,_={},c=!0,u=Array.prototype.slice,f=function(e){var t=e[0];switch(e.length){case 1:return t();case 2:return t(e[1]);case 3:return t(e[1],e[2])}return t.apply(window,u.call(e,1))},l=function(e){var t,n=e.data;"string"==typeof n&&0==n.indexOf("setIlMessage")&&(t=_[n])&&(delete _[n],f(t))},d=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=s++,r="setIlMessage"+n;return _[r]=e,c&&(c=!1,window.addEventListener("message",l)),window.postMessage(r,"*"),n};t.setFast="undefined"==typeof process?d:setImmediate;var p=function(){},h=["R"],y=["F"],b=["P"],g=function(){function e(e){this.$=b,this.Y=[],this.Z=void 0,e!==p&&i(this,e)}return e.prototype.catch=function(e){return this.then(function(){},e)},e.prototype.then=function(t,n){if("function"!=typeof t&&this.$===y||"function"!=typeof n&&this.$===h)return this;var o=new e(p);return this.$!==b?r(o,this.$===y?t:n,this.Z):this.Y.push(new v(o,t,n)),o},e.resolve=function(t){return t instanceof this?t:m.U(new e(p),t)},e.reject=function(t){return m.z(new e(p),t)},e.all=function(t){return new e(function(e,n){var r=[];if(!t.length)return void e([]);for(var o=function(n,o,i){void 0!==i?r.push(i):r.push(o),r.length==t.length&&e(r)},i=0;i<t.length;i++)!function(e){t[e].then(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];o(0,e,void 0)}).catch(function(e){o(0,void 0,e)})}(i)})},e.race=function(t){var n=this,r=t.length,o=!1,i=-1,a=new e(p);if(!1!==Array.isArray(t))return this.reject(new TypeError);if(!r)return this.resolve([]);for(;++i<r;)!function(e){n.resolve(e).then(function(e){o||(o=!0,m.U(a,e))},function(e){o||(o=!0,m.z(a,e))})}(t[i]);return a},e}();t.k=g;var v=function(){function e(e,t,n){this.ee=e,"function"==typeof t&&(this.te=t,this.ne=this.re),"function"==typeof n&&(this.oe=n,this.ie=this.ae)}return e.prototype.ne=function(e){m.U(this.ee,e)},e.prototype.re=function(e){r(this.ee,this.te,e)},e.prototype.ie=function(e){m.z(this.ee,e)},e.prototype.ae=function(e){r(this.ee,this.oe,e)},e}();t.se=v;var m=function(){function e(){}return e.U=function(t,n){var r=a(o,n),s=r.G,_=-1,c=t.Y.length;if("error"===r.X)return e.z(t,r.G);if(s)i(t,s);else for(t.$=y,t.Z=n;++_<c;)t.Y[_].ne(n);return t},e.z=function(e,t){e.$=h,e.Z=t;for(var n=-1,r=e.Y.length;++n<r;)e.Y[n].ie(t);return e},e}()},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=n(1),i=n(5),a=n(3);t._e=function(e){return["_utility","_historyPoints","_pointer","_historyDataRowIDs","_id"][e]};var s=function(){function e(){var e=this;e.ce=[],e.ue={}}return e.prototype.O=function(e){var t=this;t.fe=r.NanoSQLInstance.W(JSON.stringify(e._)).toString(),t.N=e.N,t.le=new i.de(t,e)},e.prototype.pe=function(e){var t=this;new a.q(t).he(e)},e.prototype.ye=function(e,t,n,r,o){var i=this;i.ue[e]={},t.length&&o&&i.N.triggerEvent({name:"change",actionOrView:"",table:i.le.ge[e].be,query:[],time:(new Date).getTime(),result:[{msg:o+" was performed.",type:o}],changedRows:t,changedRowPKS:n,changeType:r},["change"])},e.prototype.ve=function(e,t){if(!e)return e;var n=this;return t&&n.le._[t].forEach(function(t){var r=e[t.key];(["map","array"].indexOf(t.type)>=0||t.type.indexOf("[]")>=0)&&(e[t.key]=n.ve(r))}),Object.freeze(e)},e.prototype.R=function(e,t){var n=this;return new o.k(function(o,i){"start"===e&&(n.le.me.push(t),o()),"end"===e&&n.le.xe(t).then(function(e){var i=n.le.me.indexOf(t);-1!==i&&n.le.me.splice(i,1),n.N.v.forEach(function(e){n.ye(r.NanoSQLInstance.W(e),[],[],"transaction")}),o(e)})})},e.prototype.K=function(e,n){var i,a,s=this,_=function(e,n){var o={},a=s.le.we-s.le.ke;s.le.Ie(t._e(1),s.le.Oe[a],function(a){r.NanoSQLInstance.chain(a.map(function(n){return function(a){var _=n.tableID,c=s.le.ge[_],u=[];r.NanoSQLInstance.chain(n.rowKeys.map(function(a){return function(f){o[_]||(o[_]={type:n.type,rows:[],affectedPKS:n.rowKeys}),s.le.Se("_"+c.be+"_hist__meta",a,function(n){n=r.t(n),n[0][t._e(2)]=(n[0][t._e(2)]||0)+e;var l=n[0][t._e(3)][n[0][t._e(2)]];s.le.Ne("_"+c.be+"_hist__meta",a,n[0],function(){s.le.Se("_"+c.be+"_hist__data",l,function(e){var t={};e.length&&c.De.forEach(function(n){t[n]=e[0][n]}),s.le.Ne(c.be,a,e.length?t:null,function(){u.push(t),o[_].rows=o[_].rows.concat(u),i++,f()})})})})}}))(a)}}))(function(){n(o)})})};return new o.k(function(e,t){switch(n){case"<":s.le.we&&s.le.ke!==s.le.we?_(1,function(t){s.le.ke++,s.le.Pe("w","historyPoint",s.le.ke),Object.keys(t).forEach(function(e){var n=t[e].type;switch(n){case"inserted":n="deleted";break;case"deleted":n="inserted"}s.ye(parseInt(e),t[e].rows,t[e].affectedPKS,n,"undo")}),e(!0)}):e(!1);break;case">":!s.le.we||s.le.ke<1?e(!1):(s.le.ke--,s.le.Pe("w","historyPoint",s.le.ke),_(-1,function(t){Object.keys(t).forEach(function(e){s.ye(parseInt(e),t[e].rows,t[e].affectedPKS,t[e].type,"redo")}),e(!0)}));break;case"?":a=[s.le.we,s.le.we-s.le.ke],s.le.Le.join("+")!==a.join("+")&&(s.le.Le=a),e(s.le.Le);break;case"flush_history":case"flush_db":s.le.Pe("w","historyPoint",0),s.le.Pe("w","historyLength",0),s.le.ke=0,s.le.we=0,Object.keys(s.le.ge).forEach(function(e){var t;t=0===s.le.ge[parseInt(e)].be.indexOf("_")?[]:s.le.ge[parseInt(e)].Ee,s.ye(parseInt(e),t.map(function(e){return null}),t,"remove","clear")}),"flush_db"===n?s.le.je("all",e):s.le.je("hist",e)}})},e}();t.I=s},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=n(2),i=n(1),a=function(e,t,n,o,i){var a=n[0];0===o[0]&&(i[a]=-1===e?Number.MAX_VALUE:Number.MIN_VALUE);var s={};if(s=(-1===e?parseFloat(t[a])<parseFloat(i[a]):parseFloat(t[a])>parseFloat(i[a]))?t:i,o[0]===o[1]){var _=r.t(s);return _[-1===e?"MIN":"MAX"]=s[a],_}return s};t.x={SUM:{type:"aggregate",call:function(e,t,n,o){if(0===n[0]&&(o=0),o+=parseInt(e[t[0]]),n[0]===n[1]){var i=r.t(e);return i.SUM=o,i}return o}},MIN:{type:"aggregate",call:function(e,t,n,r){return a(-1,e,t,n,r)}},MAX:{type:"aggregate",call:function(e,t,n,r){return a(1,e,t,n,r)}},AVG:{type:"aggregate",call:function(e,t,n,o){if(0===n[0]&&(o=0),o+=parseInt(e[t[0]]),n[0]===n[1]){var i=r.t(e);return i.AVG=o/(n[1]+1)||o,i}return o}},COUNT:{type:"aggregate",call:function(e,t,n,o){if(0===n[0]&&(o=0),"*"===t[0]?o++:o+=e[t[0]]?1:0,n[0]===n[1]){var i=r.t(e);return i.COUNT=o,i}return o}}};var s=function(){function e(e){this.Te=e}return e.prototype.he=function(e){var t=this;t.Ae=r.NanoSQLInstance.W(e.table),t.Me=[],t.qe=void 0,t.Qe=e;var n=[];if(e.query.forEach(function(o){["upsert","select","delete","drop"].indexOf(o.type)>=0?(t.qe=o,"select"===o.type&&(t.Ce=r.NanoSQLInstance.W(JSON.stringify(e.query)))):["show tables","describe","count"].indexOf(o.type)>=0?n.push(o):t.Me.push(o)}),n.length)switch(n[0].type){case"show tables":e.onSuccess([{tables:Object.keys(t.Te.le.ge).map(function(e){return t.Te.le.ge[e].be})}],"info",[],[]);break;case"describe":e.onSuccess([{name:t.Te.le.ge[t.Ae].be,models:r.t(t.Te.le._[t.Ae]),primaryKey:t.Te.le.ge[t.Ae].Re,count:t.Te.le.ge[t.Ae].Ee.length}],"info",[],[])}else t.Fe(function(t,n,r,o){e.onSuccess(t,n,r,o)})},e.prototype.Be=function(e){return this.Me.filter(function(t){return t.type===e}).pop()},e.prototype.Fe=function(e){var t=this;if(t.qe){var n=function(n){if(t.qe)switch(t.qe.type){case"upsert":t.Ne(n,e);break;case"select":t.Ve(n,e);break;case"drop":var r=0,i=o.Ee.slice(),a=function(){r<i.length?t.Te.le.Se(o.be,i[r],function(e){t.Ke(e,function(){r++,a()})}):e([],"drop",i.map(function(e){return{}}),i)};a();break;case"delete":t.Ke(n,e)}},o=t.Te.le.ge[t.Ae];if(t.Be("join")||"drop"===t.qe.type)n([]);else if(t.Be("where")){var i=t.Be("where").args,a=function(e){return-1===["=","IN","BETWEEN"].indexOf(e[1])||e[0]!==o.Re&&-1===o.He.indexOf(e[0])?1:0},s=function(e,n){var r=e[0]===o.Re?o.be:"_"+o.be+"_idx_"+e[0],i=e[0]!==o.Re;switch(e[1]){case"=":t.Te.le.Se(r,i?String(e[2]).toLowerCase():e[2],function(e){n(e)});break;case"IN":t.Te.le.Ie(r,i?String(e[2]).toLowerCase():e[2],function(e){n(e)});break;case"BETWEEN":i&&e[2].map(function(e){return String(e).toLowerCase()}),t.Te.le.Je(r,e[0],e[2],n)}};if("string"==typeof i[0]?0===a(i):0===i.reduce(function(e,t,n){return n%2==1?e:e+a(t)},0))if("string"==typeof i[0])s(i,n);else{var _=[],c="";r.NanoSQLInstance.chain(i.map(function(e){return function(t){if("OR"===e||"AND"===e)return c=e,void t();s(e,function(e){if("AND"===c){var n=e.map(function(e){return e[o.Re]});_=_.filter(function(e){return-1!==n.indexOf(e[o.Re])})}else _=_.concat(e);t()})}}))(function(){n(_)})}else t.Te.le.Se(o.be,function(e){return e&&t.We(e,i)},n)}else if(t.Be("range")){var u=t.Be("range").args;t.ze(u[0],u[1],n)}else if(t.Be("trie")){var f=t.Be("trie").args,l=o.Ue[f[0]].getPrefix(f[1]),d="_"+o.be+"_idx_"+f[0];t.Te.le.Ie(d,l,function(e){n(e)})}else"upsert"!==t.qe.type?t.Te.le.Se(o.be,"all",function(e){n(e)}):n([])}},e.prototype.ze=function(e,t,n){var r=this,o=r.Te.le.ge[r.Ae],i=o.Ee[t],a=o.Ee[t+(e-1)];i?r.Te.le.Je(o.be,o.Re,[i,a],function(e){n(e)}):n([])},e.prototype.Xe=function(e,t){var n=this,i=n.Te.le.ge[n.Ae],a=n.qe.args,s={},_=function(){return n.qe?n.qe.type:""}(),c=function(r){"upsert"===_?n.Te.le.Ne(i.be,e,r,function(){t()},n.Qe.transactionID):n.Te.le.Ge(i.be,e,function(){t()},n.Qe.transactionID)};if(n.Qe.transactionID)return void("upsert"===_?(n.Te.le.ge[n.Ae].De.forEach(function(e,t){var n=i.$e[t];void 0===a[e]&&void 0!==n&&(a[e]=n)}),c(a)):c({}));n.Te.le.Se(i.be,e,function(t){s=t[0]||{};var u=r.t(t[0]||{}),f=!1,l=function(t){0!==i.be.indexOf("_")&&n.Te.le.Ye&&i.Re.length&&n.Te.le.Se("_"+i.be+"_hist__meta",e,function(a){a=r.t(a),a[0][o._e(3)].unshift(t),n.Te.le.Ne("_"+i.be+"_hist__meta",e,a[0],function(){})}),n.Te.le.Ze("upsert"===_?u:{},n.Ae,function(){c(u)})},d=function(){!f&&0!==i.be.indexOf("_")&&n.Te.le.Ye?n.Te.le.et(n.Ae,u,n.Qe.transactionID,l):l(0)};switch(_){case"upsert":Object.getOwnPropertyNames(a).forEach(function(e){u[e]=a[e]});var p=n.Te.le.ge[n.Ae];p.De.forEach(function(e,t){var n=p.$e[t];void 0===u[e]&&void 0!==n&&(u[e]=n)}),d();break;case"delete":case"drop":a&&a.length&&"drop"!==_?(a.forEach(function(e){u[e]=null}),d()):(f=!0,u={},n.Te.le.ge[n.Ae].tt.length?r.NanoSQLInstance.chain(n.Te.le.ge[n.Ae].tt.map(function(t){return function(o){if(t.nt.length){var i=n.Te.le.ge[r.NanoSQLInstance.W(t.rt)].Re,a=s[t.ot]||[];Array.isArray(a)||(a=[a]),n.Te.N.table(t.rt).query("select").where([i,"IN",a]).exec().then(function(i){r.NanoSQLInstance.chain(i.map(function(o){return function(i){var a=r.t(o);if(a[t.nt])if(Array.isArray(a[t.nt])){var s=a[t.nt].indexOf(e);if(-1===s)return void i();a[t.nt].splice(s,1)}else a[t.nt]="";n.Te.N.table(t.rt).query("upsert",a,!0).exec().then(i)}}))(o)})}else o()}}))(d):d())}})},e.prototype.it=function(e,t,n){var r=this;if(r.Qe.transactionID)return void n([],"trans",[],[]);e.length>0?r.Te.le.at(r.Ae,e,t,function(){var o=r.Te.le.ge[r.Ae];r.Te.ye(r.Ae,[],[],""),r.Te.le.Ie(o.be,e,function(r){n([{msg:e.length+" row(s) "+t}],t,r,e)})}):n([{msg:"0 rows "+t}],t,[],[])},e.prototype.Ne=function(e,t){var n,r=this,i="",a=[],s=r.qe.args||{},_=r.Te.le.ge[r.Ae],c=_.Re;if(r.Be("where")){i="modified",a=e.map(function(e){return e[_.Re]}),n=0;var u=function(){n<e.length?r.Xe(e[n][c],function(){n++,u()}):r.it(a,i,t)};u()}else{i="inserted",s[c]?"int"===_.st&&(_._t=Math.max(s[c]+1,_._t)):s[c]=r.Te.le.ct(_.st,r.Ae);var f=s[c]?s[c]:_.Ee.length;if(a=[f],!_.ut.getPrefix(String(f)).length){var l=r.Te.le.ge[r.Ae].be;if(0!==l.indexOf("_")&&r.Te.le.Ye){var d="_"+l+"_hist__meta",p={};p[o._e(2)]=0,p[o._e(3)]=[0],r.Te.le.Ne(d,f,p,function(){},r.Qe.transactionID)}}r.Xe(f,function(){r.it(a,i,t)})}},e.prototype.ft=function(){return this.lt?this.lt:this.Ae},e.prototype.Ve=function(e,n){var o=this;if(o.Te.ue[o.Ae][o.Ce])return void n(o.Te.ue[o.Ae][o.Ce],"none",[],[]);var a,s,_=["join","groupby","having","orderby","offset","limit","orm"],c={},u=function(e,t,n){return Object.keys(n).reduce(function(r,o){var i=e[o],a=t[o];return"length"===o.split(".").pop()&&(i=e[o.replace(".length","")].length,a=t[o.replace(".length","")].length),r||(i===a?0:(i>a?1:-1)*("desc"===n[o]?-1:1))},0)},f=function(e,n,s){if(a=o.Be(_[n]),2===n){var f=[];if(l.length){var d=Object.keys(t.x).map(function(e){return e+"("}),p=[];f=l.filter(function(e){return(d.reduce(function(t,n){return(e.indexOf(n)<0?0:1)+t},0)||0)>0||(p.push(e),!1)}).map(function(e){var n=e.match(/(.*)\((.*)\)/),r=n[1].trim(),o=(e.match(/\sAS\s(.*)/)||[]).pop()||r,i=n[2].split(",").map(function(e){return e.trim()});return"simple"===t.x[r].type&&o===r&&(o=i[0]),p.push(o),{name:r,args:i,as:o.trim(),type:t.x[r].type}});var h=[];if(f.length){var y,b=function(e){return f.sort(function(e,t){return e.type>t.type?1:-1}).reduce(function(n,r){var o=n.length-1;if("aggregate"===r.type){var i=e.slice();o=i.length-1,i=[i.reduce(function(e,n,i){return t.x[r.name].call(n,r.args,[i,o],e)},{})],y&&(i[0][y]=n[0][y]),n=i,y=r.name}else n=n.map(function(e,n){return t.x[r.name].call(e,r.args,[n,o])});return r.name!==r.as?p.push(r.name+" AS "+r.as):p.push(r.name),n},e.slice())},g=Object.keys(c);h=g.length?g.map(function(e){return y=null,b(c[e])}).reduce(function(e,t){return e=e.concat(t)},[]):b(e)}else h=e;var v=p.map(function(e){return e.match(/(.*)\sAS\s(.*)/)||e}).filter(function(e){return e})||[];v.length&&(h=h.map(function(e){e=r.t(e);var t={};return v.forEach(function(n){if("string"==typeof n)if(-1!==n.indexOf(".length")){var r=n.replace(".length","");t[n]=(e[r]||[]).length}else t[n]=e[n];else if(-1!==n[1].indexOf(".length")){var r=n[1].replace(".length","");t[n[2]]=(e[r]||[]).length}else t[n[2]]=e[n[1]]}),t})),e=h}}if(!a)return s(e);switch(n){case 0:var m=void 0;"cross"!==a.args.type&&(m={dt:a.args.where[0],pt:a.args.where[1],ht:a.args.where[2]});var x=o.Ae,w=r.NanoSQLInstance.W(a.args.table),k=o.Be("where"),I=o.Be("range");o.yt(a.args.type,x,w,m,function(e){k?s(e.filter(function(e){return o.We(e,k.args)})):I?o.ze(I.args[0],I.args[1],s):s(e)});break;case 1:var O=a.args,S={};O?(c=e.reduce(function(e,t){var n=Object.keys(O).reduce(function(e,n){return-1!==n.indexOf(".length")?e+"."+String((t[n.replace(".length","")]||[]).length):e+"."+String(t[n])},"").slice(1);return(e[n]=e[n]||[]).push(t),S[n]=Object.keys(O).reduce(function(e,n){if(-1!==n.indexOf(".length")){var r=n.replace(".length","");e[r]=(t[r]||[]).length}else e[n]=t[n];return e},{}),e},{}),s(Object.keys(c).sort(function(e,t){return u(S[e],S[t],O)}).reduce(function(e,t){return e.concat(c[t])},[]))):s(e);break;case 2:s(e.filter(function(e){return o.We(e,o.Be("having").args)}));break;case 3:s(e.sort(function(e,t){return u(e,t,a.args)}));break;case 4:s(e.filter(function(e,t){return!a||t>=a.args}));break;case 5:s(e.filter(function(e,t){return!a||t<a.args}));break;case 6:var N=[];a.args&&(N=a.args);var D=o.Te.le.N.N.b[o.Te.le.ge[o.Ae].be];o.Be("join")?s(e):i.k.all(e.map(function(t,n){return e[n]=r.t(t),i.k.all(o.Te.le.ge[o.Ae].tt.map(function(a){var s=a.ot;if(l&&l.length&&l.forEach(function(e){var t=e.split(" ");t[0]===a.ot&&"AS"===t[1]&&(s=t[2])}),void 0===t[s])return new i.k(function(e){return e()});var _=o.Te.le.ge[r.NanoSQLInstance.W(a.rt)].Re;return new i.k(function(r,i){var c=void 0;if(D&&(c=D(a.ot,e[n])),N.length&&N.forEach(function(e){"string"!=typeof e&&(e.key!==a.ot&&e.key&&"*"!==e.key||(c=e))}),!c&&-1===N.indexOf(a.ot))return void r();var u=t[s];if(void 0===u)return e[n][s]="single"===a.bt?void 0:[],void r();"single"===a.bt&&(u=[u]);var f=o.Te.N.table(a.rt).query("select");if(c)if(c.where||c.orderBy)c.where?"string"==typeof c.where[0]?f.where([[_,"IN",u],"AND",c.where]):(c.where.push("AND"),c.where.push([_,"IN",u]),f.where(c.where)):f.where([_,"IN",u]),c.orderBy&&f.orderBy(c.orderBy),f.limit(c.limit||5).offset(c.offset||0);else{var l=c.offset||0,d=c.limit||0;f.where([_,"IN",u.filter(function(e,t){return t>=l&&t<l+d})])}else f.where([_,"IN",u.filter(function(e,t){return t<5})]);f.exec().then(function(t){e[n][s]="single"===a.bt?t[0]:t,r()})})}))})).then(function(){s(e)})}};s=-1;var l=o.qe.args||[],d=function(e){s<_.length?(s++,f(e,s,function(e){d(e)})):(e=e.filter(function(e){return e}),o.Be("join")||o.Be("orm")||(o.Te.ue[o.Ae][o.Ce]=e),n(e,"none",[],[]))};d(e)},e.prototype.Ke=function(e,t){var n,r="deleted",o=this,i=o.qe.args||[],a=o.Te.le.ge[o.Ae].Re;n=0;var s=function(){n<e.length?o.Xe(e[n][a],function(){n++,s()}):(i.length&&(r="modified"),o.it(e.map(function(e){return e[a]}),r,t))};s()},e.prototype.We=function(e,t){var n=this,r=["AND","OR"],o=function(t){if(-1!==t.indexOf(".length")){var n=e[t.replace(".length","")];return Array.isArray(n)?n.length:0}return e[t]};if("string"!=typeof t[0]){var i,a=!1,s=!1;return t.reduce(function(e,t,_){if(e&&s)return!0;if(-1!==r.indexOf(t))return i=t,e;var c=0===n.gt(t[2],t[1],o(t[0]));return 0===_?c:"AND"===i?(a=!0,e&&c):(s=!0,e||c)},!0)}return 0===n.gt(t[2],t[1],o(t[0]))},e.prototype.yt=function(e,t,n,r,o){var i="outer",a=this,s=a.Te.le.ge[t],_=a.Te.le.ge[n],c=function(e,t){return[s,_].reduce(function(n,r,o){return r.De.forEach(function(i){n[r.be+"."+i]=((0===o?e:t)||{})[i]}),n},{})},u=[],f=[];a.Te.le.Se(s.be,"all",function(t){a.Te.le.Se(_.be,"all",function(n){t.forEach(function(t){var o=n.map(function(e){var n=c(t,e);if(!r)return n;var o=a.We(n,[r.dt,r.pt,n[r.ht]]);return o&&f.push(e[_.Re]),o?n:null}).filter(function(e){return e});o.length?u=u.concat(o):["left",i].indexOf(e)>=0&&u.push(c(t,null))}),f=f.sort().filter(function(e,t,n){return!t||e!==n[t-1]}),["right",i].indexOf(e)>=0&&n.filter(function(e){return-1===f.indexOf(e[_.Re])}).forEach(function(e){u.push(c(null,e))}),o(u)})})},e.prototype.gt=function(e,t,n){if(void 0===e||void 0===n||null===e||null===n)return-1!==["=",">=","<="].indexOf(t)&&e===n?0:1;var r=function(e){return"LIKE"===t&&"string"==typeof e?e.toLowerCase():e},o=r(n),i=r(e);switch(t){case"=":return o===i?0:1;case">":return o>i?0:1;case"<":return o<i?0:1;case"<=":return o<=i?0:1;case">=":return o>=i?0:1;case"IN":return i.indexOf(o)<0?1:0;case"NOT IN":return i.indexOf(o)<0?0:1;case"REGEX":return o.search(i)<0?1:0;case"LIKE":return o.indexOf(i)<0?1:0;case"BETWEEN":return i[0]<=o&&i[1]>=o?0:1;case"HAVE":return(o||[]).indexOf(i)<0?1:0;case"NOT HAVE":return(o||[]).indexOf(i)<0?0:1;default:return 1}},e}();t.q=s},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n={END_WORD:"$",PERMS_MIN_LEN:2},r=function(){function e(t){this.vt=e.mt(t)}return e.prototype.addWord=function(t){var n=function(t,n,r,o){return e.xt(t,n,r,o)};return t.toLowerCase().split("").reduce(n,this.vt),this},e.prototype.removeWord=function(t){var r=e.wt(this.vt,t),o=r.prefixFound,i=r.prefixNode;return o&&delete i[n.END_WORD],this},e.prototype.kt=function(t){return e.wt(this.vt,t).prefixFound},e.prototype.getPrefix=function(t){if(t=t.toLowerCase(),!this.kt(t))return[];var n=e.wt(this.vt,t).prefixNode;return e.It(n,t)},e.xt=function(e,t,r,o){return e[t]=e[t]||{},e=e[t],r===o.length-1&&(e[n.END_WORD]=1),e},e.wt=function(e,t){return{prefixFound:t.toLowerCase().split("").every(function(t,n){return!!e[t]&&(e=e[t])}),prefixNode:e}},e.mt=function(t){return t.reduce(function(t,n){return n.toLowerCase().split("").reduce(e.xt,t),t},{})},e.It=function(t,r,o){void 0===o&&(o=[]);var i=r;for(var a in t)a===n.END_WORD&&(o.push(i),i=""),e.It(t[a],r+a,o);return o.sort()},e}();t.Trie=r},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=n(2),i=n(3),a=n(1),s=n(4),_=function(){function e(e,t){this.Ot=t,this.init(e,t)}return e.prototype.init=function(e,t){var n=this;n._={},n.ge={},n.St={},n.ke=0,n.we=0,n.Le=[0,0],n.me=[],n.Nt={},n.Ye=!0,n.Dt=1,n.Pt=!0,n.Lt=!1,n.Et={},n.Oe={},n.jt=0,n.N=e,t.S.length&&(n.Lt=void 0!==t.S[0].persistent&&t.S[0].persistent,n.Ye=void 0===t.S[0].history||t.S[0].history,n.Pt=void 0===t.S[0].memory||t.S[0].memory,t.S[0].size,n.jt={IDB:1,LS:2,LVL:4}[t.S[0].mode]||0,t.S[0].historyMode&&"revisions"===t.S[0].history&&(n.Dt=2),t.S[0].rebuildIndexes&&(n.Tt=!0),t.S[0].id&&(n.N.fe=String(t.S[0].id)));var s=!1,_=0,c=!0;Object.keys(t._).forEach(function(e){var n={key:"x",type:"x"},i=[];t._[e].forEach(function(e){e.props&&-1!==e.props.indexOf("pk")&&(n=r.t(e)),!e.props||-1===e.props.indexOf("idx")&&-1===e.props.indexOf("trie")||i.push(e)}),"x"!==n.key&&"x"!==n.type&&(t._["_"+e+"_hist__data"]=r.t(t._[e]).map(function(e){return{key:e.key,type:e.type}}),t._["_"+e+"_hist__data"].unshift({key:o._e(4),type:"int"}),t._["_"+e+"_hist__meta"]=[n,{key:"_pointer",type:"int",default:0},{key:"_historyDataRowIDs",type:"array"}]),i.length&&"x"!==n.key&&"x"!==n.type&&i.forEach(function(r){t._["_"+e+"_idx_"+r.key]=[{key:"id",type:r.type,props:["pk"]},{key:"rowPK",type:n.type}]})}),t._[o._e(1)]=[{key:"id",type:"int",props:["ai","pk"]},{key:"tableID",type:"int"},{key:"historyPoint",type:"int"},{key:"rowKeys",type:"array"},{key:"type",type:"string"}],t._[o._e(0)]=[{key:"key",type:"string",props:["pk"]},{key:"value",type:"blob"}];var u,f,l=Object.keys(t._);Object.keys(t._).forEach(function(e){n.At(e,t._[e])}),Object.keys(t.x||{}).forEach(function(e){i.x[e]=t.x[e]});var d=function(){n.Tt?a.k.all(Object.keys(t._).map(function(e){return new a.k(function(t,r){n.Mt(e,function(){t()})})})).then(function(){n.qt(t.D)}):n.qt(t.D)},p=function(){var e=Object.keys(t._),i=0;n.jt=f,u&&1===n.Dt&&(n.Se(o._e(0),"all",function(e){e.forEach(function(e){n.Pe("w",e.key,e.value),"historyPoint"===e.key&&(n.ke=e.value||0),"historyLength"===e.key&&(n.we=e.value||0)})}),n.Se(o._e(1),"all",function(e){e.forEach(function(e){n.Oe[e.historyPoint]||(n.Oe[e.historyPoint]=[]),n.Oe[e.historyPoint].push(e.id)})}));var a=function(){i<e.length?-1!==e[i].indexOf("_hist__data")?(r.NanoSQLInstance.W(e[i]),c?n.Ne(e[i],0,null,function(){i++,a()}):(i++,a())):(i++,a()):(n.Ye=u,d())};a()};if(f=n.jt,n.Lt)if(0!==n.jt)switch(n.jt){case 1:"undefined"==typeof indexedDB&&(n.jt=0);break;case 2:"undefined"==typeof localStorage&&(n.jt=0);break;case 4:"undefined"!=typeof window&&(n.jt=0)}else"undefined"!=typeof window&&("undefined"!=typeof localStorage&&(n.jt=2),"undefined"!=typeof indexedDB&&(n.jt=1)),"undefined"!=typeof global&&void 0!==global.Qt&&void 0!==global.Ct&&(n.jt=4);else n.jt=0;u=n.Ye,f=n.jt,n.jt=0;var h=function(e,t){var o=function(){if(_<l.length){var i=r.NanoSQLInstance.W(l[_]);e(l[_],i,n.ge[i]),_++,o()}else t()};o()},y=function(e){c=!1;var t=0,o=function(){if(!(t<l.length))return void(e.cleanup?e.cleanup(function(){p()}):p());var i=r.NanoSQLInstance.W(l[t]);if(!u&&(-1!==l[t].indexOf("_hist__data")||-1!==l[t].indexOf("_hist__meta")))return t++,void o();n.Pt?e.requestTable(l[t],function(e){n.N.N.loadJS(l[t],e).then(function(){-1!==l[t].indexOf("_hist__data")&&(n.ge[i].Rt[0]=null),t++,o()})}):n.Pt&&!e.forceIndex||e.requestIndex(l[t],function(e){n.N.le.ge[i].Ee=e,n.N.le.ge[i]._t=e.reduce(function(e,t){return Math.max(e,parseInt(t)||0)},0),n.N.le.ge[i]._t++,t++,o()})};o()};switch(f){case 0:p();break;case 1:var b=indexedDB.open(n.N.fe,1);b.onupgradeneeded=function(e){s=!0;var t=e.target.result,r=e.target.transaction;n.Ft=t,h(function(e,n,r){var o=r.Re?{keyPath:r.Re}:{};t.createObjectStore(e,o)},function(){r.oncomplete=function(){p()}})},b.onsuccess=function(e){if(n.Ft=e.target.result,!s){var t=function(e,t){var r=[],o=n.Ft.transaction(e,"readonly");o.objectStore(e).openCursor().onsuccess=function(e){var t=e.target.result;t&&(r.push(n.Pt?t.value:t.key),t.continue())},o.oncomplete=function(){t(r)}};y({requestIndex:function(e,n){t(e,n)},requestTable:function(e,n){t(e,n)}})}};break;case 2:localStorage.getItem("dbID")!==n.N.fe?(localStorage.setItem("dbID",n.N.fe),h(function(e,t,n){localStorage.setItem(e,JSON.stringify([]))},function(){p()})):y({forceIndex:!0,requestIndex:function(e,t){t(JSON.parse(localStorage.getItem(e)||"[]"))},requestTable:function(e,t){var n=[];JSON.parse(localStorage.getItem(e)||"[]").forEach(function(t){n.push(JSON.parse(localStorage.getItem(e+"-"+t)||""))}),t(n)}})}},e.prototype.Mt=function(e,t){var n=this,o=r.NanoSQLInstance.W(e),i=0,s=n.ge[o].He;this.Se(e,"all",function(r){var _=n.ge[o].Re,c=function(){if(i<r.length){var o=0,u=function(){if(o<s.length){var t=s[o],f="_"+e+"_idx_"+t,l=String(r[i][t]).toLowerCase();n.Se(f,l,function(e){var s=[r[i][_]];e.length&&e[0].rowPK&&(s=s.concat(e[0].rowPK).filter(function(e,t){return s.indexOf(e)===t})),n.Ne(f,l,{id:r[i][t],rowPK:s},function(){o++,a.setFast(u)})},!0)}else i++,a.setFast(c)};u()}else t()};c()})},e.prototype.qt=function(e){var t={},n=0,o=this;if(Object.keys(o.ge).forEach(function(e){var r=o.ge[e].be;0!==r.indexOf("_")&&o.ge[e].Bt.length&&(t[r]=o.ge[e].Bt,n++)}),0===n)e();else{var i=Object.keys(t),a=0,s=function(){if(a<i.length){var n=r.NanoSQLInstance.W(i[a]);o.Se(i[a],"all",function(e){e.forEach(function(e,r){t[i[a]].forEach(function(t){e[t]&&o.ge[n].Ue[t].addWord(e[t])})}),a++,s()})}else e()};s()}},e.prototype.xe=function(e){var t=this;return new a.k(function(n,r){t.jt,function(){t.Nt[e]?a.k.all(Object.keys(t.Nt[e]).map(function(e){return new a.k(function(n){t.Mt(e,n)})})).then(function(){n([{msg:Object.keys(t.Nt[e]).length+" transactions performed."}],t.N.N),delete t.Nt[e]}):n([{msg:"0 transactions performed."}],t.N.N)}()})},e.prototype.je=function(e,t){var n=this,i=Object.keys(n.ge).map(function(e){return n.ge[e].be}),s=function(){a.k.all(i.map(function(e){return new a.k(function(t,i){if(-1!==e.indexOf("_hist__meta")){var a=String(e).slice(1).replace("_hist__meta",""),s=r.NanoSQLInstance.W(a),_=n.ge[s].Re;n.Ne("_"+a+"_hist__data",0,null),n.ge["_"+a+"_hist__data"].Ee.push(0),n.Se(a,"all",function(r){r.forEach(function(t,r){var i={};i[o._e(2)]=0,i[o._e(3)]=[r+1],n.Ne(e,t[_],i),n.Ne("_"+a+"_hist__data",r+1,t)}),t()})}else t()})})).then(function(){t()})};a.k.all(i.map(function(t){return new a.k(function(r,i){var a=!1;"hist"!==e||t!==o._e(1)&&-1===t.indexOf("_hist__meta")&&-1===t.indexOf("_hist__data")||(a=!0),"all"===e&&"_utility"!==t&&(a=!0),a?n.Ge(t,"all",function(){-1!==t.indexOf("_hist__data")&&n.Ne(t,0,null),r()}):r()})})).then(function(){s()})},e.prototype.Ge=function(e,t,n,o){var i=this,a=r.NanoSQLInstance.W(e),_=[];"all"===t?(_=i.ge[a].Ee.slice().filter(function(e){return e}),i.ge[a].Ee=[],i.ge[a].ut=new s.Trie([])):(_.push(t),i.ge[a].ut.removeWord(String(t)),i.ge[a].Ee.splice(i.ge[a].Ee.indexOf(t),1)),i.Pt&&("all"===t?i.ge[a].Rt={}:delete i.ge[a].Rt[t]),r.NanoSQLInstance.chain(_.map(function(t){return function(n){switch(o&&(i.Nt[o]||(i.Nt[o]={}),i.Nt[o][e]||(i.Nt[o][e]=[]),i.Nt[o][e].push({type:"del",key:t,value:""})),i.jt){case 0:n();break;case 1:i.Ft.transaction(e,"readwrite").objectStore(e).delete(t),n();break;case 2:localStorage.setItem(e,JSON.stringify(i.ge[a].Ee)),localStorage.removeItem(e+"-"+String(t)),n();break;default:n()}}}))(function(){n&&n(!0)})},e.prototype.Ze=function(e,t,n){var o=this,i=o.ge[t],s={};if(0!==i.be.indexOf("_")){var _=[],c=function(t,n,r,a){o.Se(t,n,function(s){var c=[];s.length&&s[0].rowPK&&(c=c.concat(s[0].rowPK)),c.push(e[i.Re]),c=c.filter(function(e,t,n){return n.indexOf(e)===t}),c.length?o.Ne(t,n,{id:n,rowPK:c},a):(_.push(r),o.Ge(t,n,a))},!0)};i.Bt.forEach(function(n){var r=String(e[n]).toLocaleLowerCase();-1!==_.indexOf(n)?o.ge[t].Ue[n].removeWord(r):o.ge[t].Ue[n].addWord(r)}),i.He.length?a.k.all(i.He.map(function(t){return new a.k(function(a,_){var u="_"+i.be+"_idx_"+t,f=String(e[t]).toLowerCase(),l=String(s[t]).toLowerCase();f!==l&&s[t]?o.Se(u,l,function(e){var n=e[0]?r.t(e[0].rowPK||[]):[],s=n.indexOf(l[i.Re]);-1!==s?(n.splice(s,1),o.Ne(u,l,{id:l,rowPK:n},function(){c(u,f,t,a)})):c(u,f,t,a)}):void 0!==e[t]?c(u,f,t,a):n&&n()})})).then(n):n&&n()}else n&&n()},e.prototype.et=function(e,t,n,i){var a=this,s=a.ge[e],_="_"+s.be+"_hist__data",c=a.ge[r.NanoSQLInstance.W(_)];t=r.t(t);var u=c.Ee[c.Ee.length-1]+1;c.Ee.push(u),t[o._e(4)]=u,a.Ne(_,u,t,function(){i(u)},n)},e.prototype.at=function(e,t,n,i){var a=this;if(!a.Ye)return void i();var s=function(){a.Pe("w","historyLength",a.we),a.Pe("w","historyPoint",a.ke);var r=a.we-a.ke;a.Ne(o._e(1),null,{historyPoint:r,tableID:e,rowKeys:t,type:n},function(e){a.Oe[r]||(a.Oe[r]=[]),a.Oe[r].push(e),i()})};if(0===a.ke)a.we++,s();else if(a.ke>0){for(var _=[],c=0,u=a.we-a.ke+1;a.Oe[u];)_=_.concat(a.Oe[u].slice()),delete a.Oe[u],u++;a.Ie(o._e(1),_,function(e){r.NanoSQLInstance.chain(e.map(function(e){return function(t){var n=a.ge[e.tableID].be;r.NanoSQLInstance.chain(e.rowKeys.map(function(e){return function(t){a.Se("_"+n+"_hist__meta",e,function(i){i[0]=r.t(i[0]),i[0][o._e(2)]=0;var s=i[0][o._e(3)].shift();a.Ne("_"+n+"_hist__meta",e,i[0],function(){s?a.Ge("_"+n+"_hist__data",s,function(){c++,t()}):(c++,t())})})}}))(function(){a.Ge(o._e(1),e.id,t)})}}))(function(){a.we-=a.ke,a.we++,a.ke=0,s()})})}},e.prototype.ct=function(e,t){switch(e){case"int":return this.ge[t]._t++;case"uuid":return r.NanoSQLInstance.uuid();case"timeId":return r.NanoSQLInstance.timeid();case"timeIdms":return r.NanoSQLInstance.timeid(!0)}return""},e.prototype.Ne=function(e,t,n,i,a){var s=this;n=r.t(n);var _=r.NanoSQLInstance.W(e),c=s.ge[_].Re;if(-1!==e.indexOf("_hist__data")&&n?t=n[o._e(4)]:(void 0!==t&&null!==t||(s._[_].forEach(function(e){e.props&&-1!==e.props.indexOf("pk")&&(t=s.ct(e.type,_))}),t||(t=parseInt(s.ge[_].Ee[s.ge[_].Ee.length-1]||"0")+1)),c&&c.length&&n&&void 0===n[c]&&(n[c]=t)),t=void 0!==t&&null!==t?t:-1,s.ge[_].ut.getPrefix(String(t)).length||(s.ge[_].ut.addWord(String(t)),s.ge[_].Ee.push(t)),a&&(s.Nt[a]||(s.Nt[a]={}),s.Nt[a][e]||(s.Nt[a][e]=[]),s.Nt[a][e].push({type:-1!==e.indexOf("_hist__data")?"put":n?"put":"del",key:t,value:n?JSON.stringify(n):""})),s.Pt&&(s.ge[_].Rt[t]=s.N.ve(n,_),0===s.jt&&i))return i(t);switch(s.jt){case 1:var u=s.Ft.transaction(e,"readwrite"),f=u.objectStore(e);c.length&&n?f.put(n):-1!==e.indexOf("_hist__data")?f.put(n,t):(n&&f.put(n),n||f.delete(t)),u.oncomplete=function(){i&&i(t)};break;case 2:localStorage.setItem(e+"-"+String(t),n?JSON.stringify(n):""),localStorage.setItem(e,JSON.stringify(s.ge[_].Ee)),i&&i(t)}},e.prototype.Vt=function(e,t,n,r){var o=this,i=0===e.indexOf("_")&&-1!==e.indexOf("_idx_");if(!i||r)n(t);else{var a=i?e.slice(1,e.indexOf("_idx_")):"",s=t.reduce(function(e,t){return e.concat(t.rowPK)},[]),_=[],c=0,u=function(){c<s.length?o.Se(a,s[c],function(e){_=_.concat(e),c++,u()}):n(_)};u()}},e.prototype.Ie=function(e,t,n){var r=this,o=[],i=0,a=function(){i<t.length?r.Se(e,t[i],function(e){o=o.concat(e),i++,a()}):n(o)};a()},e.prototype.Je=function(e,t,n,o){var i=this,a=this,s=r.NanoSQLInstance.W(e);if(0===a.jt||2===a.jt){var _=a.ge[s].Ee.indexOf(n[0]),c=[];if(-1===_)return void o(c);var u=function(){var t=a.ge[s].Ee[_];if(!t)return void o(c);t<=n[1]?a.Se(e,t,function(e){c=c.concat(e),_++,u()}):o(c)};return void u()}var f=[];switch(a.jt){case 1:var l=a.Ft.transaction(e,"readonly"),d=l.objectStore(e),p=d.openCursor(IDBKeyRange.bound(n[0],n[1]));l.oncomplete=function(){i.Vt(e,f,o)},p.onsuccess=function(e){var t=e.target.result;t&&(f.push(t.value),t.continue())}}},e.prototype.Se=function(e,t,n,o){var i=this,a=this,s=r.NanoSQLInstance.W(e);if(a.Pt){var _=a.ge[s].Rt;if("all"===t||"function"==typeof t){var c=Object.keys(_).map(function(e){return _[e]});"all"===t?a.Vt(e,c.filter(function(e){return e}),n,o):a.Vt(e,c.filter(function(e){return t(e)}),n,o)}else a.Vt(e,[_[t]].filter(function(e){return e}),n,o)}else switch(a.jt){case 1:var u=a.Ft.transaction(e,"readonly"),f=u.objectStore(e);if("all"===t||"function"==typeof t){var l=f.openCursor(),d=[];u.oncomplete=function(){i.Vt(e,d,n,o)},l.onsuccess=function(e){var n=e.target.result;n&&("all"!==t?t(n.value)&&d.push(n.value):d.push(n.value),n.continue())}}else{var p=f.get(t);p.onsuccess=function(t){i.Vt(e,[p.result],n,o)}}break;case 2:if("all"===t||"function"==typeof t){var h=a.ge[s].Ee.map(function(t){var n=localStorage.getItem(e+"-"+t);return n&&n.length?JSON.parse(n):null});"all"!==t?this.Vt(e,h.filter(function(e){return t(e)}),n,o):this.Vt(e,h,n,o)}else{var y=localStorage.getItem(e+"-"+t);this.Vt(e,[y&&y.length?JSON.parse(y):null],n,o)}}},e.prototype.Pe=function(e,t,n){var r=this;return"r"===e?r.Et[t]?r.Et[t].value:null:(r.Ne(o._e(0),t,{key:t,value:n}),r.Pe[t]={key:t,value:n},n)},e.prototype.At=function(e,t){var n=this,o=r.NanoSQLInstance.W(e);n._[o]=t,n.N.ue[o]={},n.ge[o]={Re:"",st:"",De:[],tt:[],$e:[],He:[],Bt:[],Ue:{},be:e,_t:1,Ee:[],ut:new s.Trie([]),Rt:{}};for(var i=n._[o].length;i--;)!function(){var e=n._[o][i];if(n.ge[o].De.unshift(e.key),n.ge[o].$e[i]=e.default,e.props&&e.props.indexOf("pk")>=0&&(n.ge[o].Re=e.key,n.ge[o].st=e.type),e.props&&(e.props.indexOf("idx")>=0||e.props.indexOf("trie")>=0)&&n.ge[o].He.push(e.key),e.props&&e.props.indexOf("trie")>=0&&(n.ge[o].Bt.push(e.key),n.ge[o].Ue[e.key]=new s.Trie([])),e.props&&-1!==n.N.N.v.indexOf(e.type.replace("[]",""))){var t="";e.props.forEach(function(e){-1!==e.indexOf("ref=>")&&(t=e.replace("ref=>",""))}),n.ge[o].tt.push({rt:e.type.replace("[]",""),ot:e.key,nt:t,bt:-1===e.type.indexOf("[]")?"single":"array"})}}();return e},e}();t.de=_},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=n(1),i=function(){function e(e,t,n){this.Te=t,this.Kt=[],this.rt=e,this.Ht=n||""}return e.prototype.tID=function(e){return this.Jt=e||0,this},e.prototype.where=function(e){return e.length&&Array.isArray(e)||(this.Wt="Where condition requires an array!"),this.zt("where",e)},e.prototype.range=function(e,t){return this.zt("range",[e,t])},e.prototype.orm=function(e){return this.zt("orm",e)},e.prototype.orderBy=function(e){return this.zt("orderby",e)},e.prototype.groupBy=function(e){return this.zt("groupby",e)},e.prototype.having=function(e){return e.length&&Array.isArray(e)||(this.Wt="Having condition requires an array!"),this.zt("having",e)},e.prototype.join=function(e){return e.table&&e.type||(this.Wt="Join command requires table and type arguments!"),this.zt("join",e)},e.prototype.limit=function(e){return this.zt("limit",e)},e.prototype.trieSearch=function(e,t){return this.zt("trie",[e,t])},e.prototype.offset=function(e){return this.zt("offset",e)},e.prototype.zt=function(e,t){return this.Kt.push({type:e,args:t}),this},e.prototype.toCSV=function(e){var t=this;return new o.k(function(n,o){t.exec().then(function(o){o=r.t(o);var i=t.Q.args.length?t.Q.args.map(function(e){return t.Te._[t.rt].filter(function(t){return t.key===e})[0]}):t.Te._[t.rt];e&&o.unshift(i.map(function(e){return e.key})),n(o.map(function(t,n){return e&&0===n?t:i.map(function(e){if(void 0===t[e.key])return"";var n=e.type;switch(-1!==n.indexOf("[]")&&(n="any[]"),n){case"map":case"any[]":case"array":return'"'+JSON.stringify(t[e.key]).replace(/"/g,"'")+'"';case"string":case"safestr":return'"'+t[e.key].replace(/"/g,'"')+'"';default:return t[e.key]}}).join(",")}).join("\n"),t)})})},e.prototype.manualExec=function(e,t){var n=this;return n.Kt=t,n.rt=e,n.exec()},e.prototype.exec=function(){var e=this,t=e.rt;return e.Te.g[t]&&(e.Te.Ut=function(){switch(e.Q.type){case"select":return["*",e.Q.type];case"delete":case"upsert":case"drop":return["*",e.Q.type,"change"];default:return["*"]}}()),new o.k(function(n,r){if(e.Wt)throw r(e.Wt),Error;if(!e.Te.backend)throw r(),Error;var o=function(n,r,o,i,a,s){e.Te.g[t]&&e.Te.triggerEvent({name:e.Q.type,actionOrView:e.Ht,table:t,query:[e.Q].concat(e.Kt),time:(new Date).getTime(),result:n,changeType:o,changedRows:i,changedRowPKS:a},e.Te.Ut),r(n,e.Te)},i={table:t,transactionID:e.Jt,query:[e.Q].concat(e.Kt),viewOrAction:e.Ht,onSuccess:function(t,r,i,a){e.Jt?n(t,e.Te):o(t,n,r,i,a)},onFail:function(t){e.Jt?n(t,e.Te):(e.Te.Ut=["error"],r&&o(t,r,"error",[],[]))}};e.Te.V?e.Te.V(i,function(t){e.Te.backend.pe(t)}):e.Te.backend.pe(i)})},e}();t.q=i;var a=function(){function e(e,t,n,r,o){this.Te=e,this.Xt=t,this.Q=n,this.Gt=r||"",this.$t=o||[]}return e.prototype.where=function(e){return this.Yt=e,this},e.prototype.rebuild=function(e){var t=this,n=t.Te._[t.Xt].filter(function(e){return-1!==t.Te.v.indexOf(e.type.replace("[]",""))}).map(function(e){var n=e.type.replace("[]","");return{key:e.key,tablePK:t.Te._[n].reduce(function(e,t){return t.props&&-1!==t.props.indexOf("pk")?t.key:e},""),table:n,type:-1===e.type.indexOf("[]")?"single":"array"}}),o=t.Te._[t.Xt].reduce(function(e,t){return t.props&&-1!==t.props.indexOf("pk")?t.key:e},""),i=0,a=function(){t.Te.table(t.Xt).query("select").range(1,i).exec().then(function(s){s.length?r.NanoSQLInstance.chain(n.map(function(e){return function(n){var i;i=void 0===s[0][e.key]?"single"===e.type?"":[]:r.t(s[0][e.key]),"single"===e.type&&(i=[i]),i=i.filter(function(e,t,n){return n.indexOf(e)===t}),t.Te.table(e.table).query("select").where([e.tablePK,"IN",i]).exec().then(function(n){var r=n.length?n.map(function(t){return t[e.tablePK]}):[];return t.Te.table(t.Xt).updateORM("set",e.key,r).where([o,"=",s[0][o]]).exec()}).then(function(){n()})}}))(function(){i++,a()}):e(i)})};a()},e.prototype.tID=function(e){return this.Jt=e||0,this},e.prototype.exec=function(){var e=this;return new o.k(function(t,n){if("rebuild"===e.Q)return e.rebuild(t);var o=e.Te._[e.Xt].filter(function(e){return e.props&&-1!==e.props.indexOf("pk")})[0].key,i=e.Te._[e.Xt].filter(function(t){return t.key===e.Gt})[0],a=i.type.replace("[]",""),s=e.Te._[a].filter(function(e){return e.props&&-1!==e.props.indexOf("pk")})[0].key,_=-1!==i.type.indexOf("[]"),c=i.props&&i.props.filter(function(e){return-1!==e.indexOf("ref=>")})[0],u="single";if(c&&(c=c.replace("ref=>",""),u=-1===e.Te._[a].filter(function(e){return e.key===c})[0].type.indexOf("[]")?"single":"array"),!(o&&o.length&&s&&s.length))return void n("Relation models require a primary key!");var f=e.Te.table(e.Xt).query("select");e.Yt&&f.where(e.Yt),f.exec().then(function(n){r.NanoSQLInstance.chain(n.map(function(t){return function(n){var i=r.t(t),f=[];switch(void 0!==i[e.Gt]&&(f=r.t(i[e.Gt])),Array.isArray(f)||(f=[f]),e.Q){case"set":case"add":_?(void 0===i[e.Gt]&&(i[e.Gt]=[]),Array.isArray(i[e.Gt])||(i[e.Gt]=[]),"set"===e.Q?i[e.Gt]=e.$t:i[e.Gt]=i[e.Gt].concat(e.$t),i[e.Gt]=i[e.Gt].filter(function(e,t,n){return n.indexOf(e)===t})):i[e.Gt]=e.$t[0],f="set"===e.Q?f.filter(function(t){return-1===e.$t.indexOf(t)}):[];break;case"delete":_?e.$t.forEach(function(t){var n=i[e.Gt].indexOf(t);-1!==n&&i[e.Gt].splice(n,1)}):i[e.Gt]="";break;case"drop":i[e.Gt]=_?[]:void 0}var l=function(t,n){e.Te.table(a).query("upsert",t,!0).exec().then(n)},d=function(n){r.NanoSQLInstance.chain(f.map(function(n){return function(i){e.Te.table(a).query("select").where([s,"=",n]).exec().then(function(e){if(!e.length)return void i();var n=r.t(e[0]);if(Array.isArray(n[c])){var a=n[c].indexOf(t[o]);-1!==a&&n[c].splice(a,1)}else n[c]="";l(n,function(){i()})})}}))(function(){n()})};e.Te.table(e.Xt).query("upsert",i,!0).exec().then(function(){if(c)switch(e.Q){case"set":case"add":d(function(){r.NanoSQLInstance.chain(e.$t.map(function(n){return function(i){e.Te.table(a).query("select").where([s,"=",n]).exec().then(function(e){if(!e.length)return void i();var n=r.t(e[0]);void 0===n[c]&&(n[c]="array"===u?[]:""),"array"===u?(Array.isArray(n[c])||(n[c]=[]),n[c].push(t[o]),n[c]=n[c].filter(function(e,t,n){return n.indexOf(e)===t}),l(n,function(){i()})):(n[c]=t[o],l(n,function(){i()}))})}}))(n)});break;case"delete":case"drop":d(n)}else n()})}}))(t)})})},e}();t.C=a},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t,n,r,o){this.Zt=e,this.Qe={type:"orm",table:t,action:n,column:r,relationIDs:o}}return e.prototype.where=function(e){return this.Qe.where=e,this},e.prototype.exec=function(){this.Zt.push(this.Qe)},e}();t.B=n;var r=function(){function e(e,t,n,r){this.Q=e,this.en=t,this.Kt=[],this.rt=n,this.Zt=r}return e.prototype.where=function(e){return this.zt("where",e)},e.prototype.orm=function(e){return this.zt("orm",e)},e.prototype.zt=function(e,t){return this.Kt.push({type:e,args:t}),this},e.prototype.exec=function(){this.Zt.push({type:"std",action:this.Q,actionArgs:this.en,table:this.rt,query:this.Kt})},e}();t.F=r},function(e,t,n){e.exports=n(0)}])});
!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.e?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=5)}([function(e,t,n){var r=n(1),o=n(2);t.t=function(e){return JSON.parse(JSON.stringify(e))};var i=function(){function e(){var e=this;e.r={},e.a={},e._={},e.u=[],e.f=["change","delete","upsert","drop","select","error"],e.h={},e.y={},e.h["*"]={};for(var t=e.f.length;t--;)e.h["*"][e.f[t]]=[];e.b={},e.g={}}return e.prototype.table=function(e){return e&&(this.v=e),this},e.prototype.connect=function(e){var t=this,n=this;return n.backend?new o.k(function(e,t){throw t(),Error()}):(n.backend=e||new r.w,new o.k(function(e,r){n.backend.x({_:n._,r:n.r,a:n.a,b:n.b,I:n.u,S:t,O:function(t){e(t,n)},j:function(e){r&&r(e,n)}})}))},e.prototype.on=function(e,t){var n=this,r=n.v,o=0,i=e.split(" ");if(!n.h[r])for(n.h[r]={},n.h[r]["*"]=[];o--;)n.h[r][n.f[o]]=[];for(o=i.length;o--;)n.f.indexOf(i[o])!==-1&&n.h[r][i[o]].push(t);return n.T(),n},e.prototype.off=function(e){var t=this;for(var n in t.h)for(var r in t.h[n])t.h[n][r]=t.h[n][r].filter(function(t){return t!==e});return t.T(),t},e.prototype.T=function(){var e=this;this.y={},Object.keys(this._).concat(["*"]).forEach(function(t){e.y[t]=e.f.reduce(function(n,r){return n+(e.h[t]?e.h[t][r].length:0)},0)>0})},e.prototype.model=function(e){var t=this,n=t.v,r=t.f.length;if(!t.h[n])for(t.h[n]={},t.h[n]["*"]=[];r--;)t.h[n][t.f[r]]=[];return t._[n]=e,t.a[n]=[],t.r[n]=[],t},e.prototype.views=function(e){return this.a[this.v]=e,this},e.prototype.getView=function(e,t){return void 0===t&&(t={}),this.D("View",this.a[this.v],e,t)},e.prototype.cleanArgs=function(e,t){var n=this,r=(n.v,{}),o=e.length?e.length:-1;if(o>0)for(;o--;){var i=e[o].split(":");i.length>1?r[i[0]]=n.N(i[1],t[i[0]]||null):r[i[0]]=t[i[0]]||null}return r},e.prototype.N=function(e,n){var r=typeof n;return{string:"string"!==r?String(n||""):n,int:"number"!==r||n%1!=0?parseInt(n||0):n,float:"number"!==r?parseFloat(n||0):n,array:Array.isArray(n)?t.t(n||[]):[],map:"object"===r?t.t(n||{}):{},bool:n===!0}[e]||n},e.prototype.actions=function(e){return this.r[this.v]=e,this},e.prototype.doAction=function(e,t){return this.D("Action",this.r[this.v],e,t)},e.prototype.D=function(e,t,n,r){var i=this,a=this,s=t.reduce(function(e,t){return t.name===n?t:e},null);if(!s)return new o.k(function(e,t){return t("Action/View Not Found!")});a.A=n;var _=s.args?a.cleanArgs(s.args,r):{};return a.P?new o.k(function(t,n){a.P(i.v,e,a.A||"",_,function(e){!!s&&s.call(e,a).then(function(e){t(e,a)})},function(e){n(e)})}):s.call(_,a)},e.prototype.newFunction=function(e,t,n){return this.b[e]={type:t,call:n},this},e.prototype.query=function(e,t){var n=this,r=new a(n.v,n,n.A);n.A=void 0;var o=e.toLowerCase();if(["select","upsert","delete","drop","show tables","describe"].indexOf(o)===-1)throw Error;var i=t||("select"===o||"delete"===o?[]:{});if("upsert"===e){var s={};n._[n.v].forEach(function(e){i[e.key]&&(s[e.key]=n.N(e.type,i[e.key]))}),n.g[n.v]&&(s=n.g[n.v](s)),i=s}return r.L={type:o,args:i},r},e.prototype.triggerEvent=function(e,t){var n=this;setTimeout(function(){for(var r,o,i=t.length,a=0;i--;)for(r=t[i],o=n.h[e.table][r].concat(n.h[e.table]["*"]),a=o.length;a--;)e.name=r,o[a](e,n)},0)},e.prototype.default=function(e){var t={},n=this;return n._[n.v].forEach(function(r){t[r.key]=e&&e[r.key]?e[r.key]:r.default,t[r.key]||(t[r.key]=n.N(r.type,null))}),t},e.prototype.beginTransaction=function(){if(this.backend.C)return this.backend.C("start")},e.prototype.endTransaction=function(){if(this.backend.C)return this.backend.C("end")},e.prototype.queryFilter=function(e){return this.M=e,this},e.prototype.avFilter=function(e){return this.P=e,this},e.prototype.config=function(e){var t=this;return t.backend||t.u.push(e),t},e.prototype.extend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=this;if(n.backend)return n.backend.q?(e.unshift(n),n.backend.q.apply(n.backend,e)):void 0},e.prototype.loadJS=function(e,t){var n=this;return n.beginTransaction(),new o.k(function(r,o){var i=0,a=[],s=function(){i<t.length?t[i]?n.table(e).query("upsert",t[i]).exec().then(function(e){a.push(e),i++,s()}):(i++,s()):(n.endTransaction(),r(a,n))};s()})},e.prototype.rowFilter=function(e){return this.g[this.v]=e,this},e.prototype.loadCSV=function(e,t){var n=this,r=[];return n.beginTransaction(),new o.k(function(i,a){o.k.all(t.split("\n").map(function(t,i){return new o.k(function(o,a){if(0===i)r=t.split(","),o();else{var s={},_=t.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)||[];_=_.map(function(e){return e.replace(/^"(.+(?="$))"$/,"$1")});for(var c=r.length;c--;)0!==_[c].indexOf("{")&&0!==_[c].indexOf("[")||(_[c]=JSON.parse(_[c].replace(/'/g,""))),s[r[c]]=_[c];n.table(e).query("upsert",s).exec().then(function(){o()})}})})).then(function(){n.endTransaction(),i([],n)})})},e.uuid=function(){var e,t,n,r=function(){return"undefined"==typeof crypto?Math.round(Math.random()*Math.pow(2,16)):crypto.getRandomValues?(n=new Uint16Array(1),crypto.getRandomValues(n),n[0]):"undefined"!==global&&global.Q.randomBytes?global.Q.randomBytes(2).reduce(function(e,t){return t*e}):Math.round(Math.random()*Math.pow(2,16))},o="";return[o,o,o,o,o,o,o,o,o].reduce(function(n,i,a){for(e=r(),t=4===a?a:5===a?(e%16&3|8).toString(16):o,e=e.toString(16);e.length<4;)e="0"+e;return n+([3,4,5,6].indexOf(a)>=0?"-":o)+(t+e).slice(0,4)},o)},e.V=function(e){return Math.abs(e.split("").reduce(function(t,n,r){return(t<<5)+t+e.charCodeAt(r)},0))},e}();t.NanoSQLInstance=i;var a=function(){function e(e,t,n){this.F=t,this.R=[],this.B=e,this.J=n||""}return e.prototype.where=function(e){return e.length&&Array.isArray(e)||(this.H="Where condition requires an array!"),this.K("where",e)},e.prototype.orderBy=function(e){return this.K("orderby",e)},e.prototype.groupBy=function(e){return this.K("groupby",e)},e.prototype.having=function(e){return e.length&&Array.isArray(e)||(this.H="Having condition requires an array!"),this.K("having",e)},e.prototype.join=function(e){return e.table&&e.type||(this.H="Join command requires table and type arguments!"),this.K("join",e)},e.prototype.limit=function(e){return this.K("limit",e)},e.prototype.offset=function(e){return this.K("offset",e)},e.prototype.K=function(e,t){return this.R.push({type:e,args:t}),this},e.prototype.toCSV=function(e){var t=this;return new o.k(function(n,r){t.exec().then(function(r){var o=t.L.args.length?t.L.args.map(function(e){return t.F._[t.B].filter(function(t){return t.key===e})[0]}):t.F._[t.B];e&&r.unshift(o.map(function(e){return e.key})),n(r.map(function(t,n){return e&&0===n?t:o.filter(function(e){return!!t[e.key]}).map(function(e){switch(e.type){case"map":case"array":return'"'+JSON.stringify(t[e.key]).replace(/"/g,"'")+'"';default:return t[e.key]}}).join(",")}).join("\n"),t)})})},e.prototype.exec=function(){var e=this,t=e.B;return e.F.y[t]&&(e.F.U=function(){switch(e.L.type){case"select":return[e.L.type];case"delete":case"upsert":case"drop":return[e.L.type,"change"];default:return[]}}()),new o.k(function(n,r){if(e.H)throw r(e.H),Error;if(!e.F.backend)throw r(),Error;var o=function(n,r,o,i,a){e.F.y[t]&&e.F.triggerEvent({name:"error",actionOrView:e.J,table:t,query:[e.L].concat(e.R),time:(new Date).getTime(),result:n,changeType:o,changedRows:i},e.F.U),r(n,e.F)},i={table:t,query:[e.L].concat(e.R),viewOrAction:e.J,onSuccess:function(e,t,r){o(e,n,t,r,!1)},onFail:function(t){e.F.U=["error"],r&&o(t,r,"error",[],!0)}};e.F.M?e.F.M(i,function(t){e.F.backend.z(t)}):e.F.backend.z(i)})},e}();t.W=a;var s=new i;t.nSQL=function(e){return s.table(e)}},function(e,t,n){var r=n(0),o=n(2),i=n(4),a=n(3);t.X=function(e){return["_utility","_historyPoints","_pointer","_historyDataRowIDs"][e]};var s=function(){function e(){var e=this;e.$=[],e.G={}}return e.prototype.x=function(e){var t=this;t.Y=r.NanoSQLInstance.V(JSON.stringify(e._)).toString(),t.S=e.S,t.Z=new i.ee(t,e)},e.prototype.z=function(e){var t=this;new a.W(t).te(e)},e.prototype.ne=function(e,t,n,r){var o=this;o.G[e]={},t.length&&r&&o.S.triggerEvent({name:"change",actionOrView:"",table:o.Z.oe[e].re,query:[],time:(new Date).getTime(),result:[{msg:r+" was performed.",type:r}],changedRows:t,changeType:n},["change"])},e.prototype.ie=function(e,t){if(!e)return e;var n=this;return n.Z._[t].forEach(function(r){var o=e[r.key];["map","array"].indexOf(typeof o)>=0&&(e[r.key]=n.ie(o,t))}),Object.freeze(e)},e.prototype.C=function(e){return"start"===e&&(this.Z.ae=!0),"end"===e&&(this.Z.ae=!1),!!this.Z.ae},e.prototype.q=function(e,n){var i,a,s,_,c=this,u=function(e,n){var o={},a=c.Z.se-c.Z._e;c.Z.ce("_historyPoints",function(e){return e.historyPoint===a},function(a){s=0;var u=function(){if(s<a.length){i=0;var l=a[s].tableID,f=c.Z.oe[l],d=[],h=function(){i<a[s].rowKeys.length?(_=a[s].rowKeys[i],"int"===f.ue&&(_=parseInt(_)),c.Z.ce(f.re,_,function(n){e>0&&d.push(n[0]),c.Z.ce("_"+f.re+"_hist__meta",_,function(n){n=r.t(n),n[0][t.X(2)]+=e;var u=n[0][t.X(3)][n[0][t.X(2)]];c.Z.le("_"+f.re+"_hist__meta",_,n[0],function(){c.Z.ce("_"+f.re+"_hist__data",u,function(t){var n=t[0]?r.t(t[0]):null;c.Z.le(f.re,_,n,function(){e<0&&d.push(n),o[l]||(o[l]={type:a[s].type,rows:[]}),o[l].rows=o[l].rows.concat(d),i++,h()})})})})})):(s++,u())};h()}else n(o)};u()})};return new o.k(function(e,t){switch(n){case"<":c.Z.se&&c.Z._e!==c.Z.se?u(1,function(t){c.Z._e++,c.Z.fe("w","historyPoint",c.Z._e),Object.keys(t).forEach(function(e){var n=t[e].type;switch(n){case"inserted":n="deleted";break;case"deleted":n="inserted"}c.ne(parseInt(e),t[e].rows,n,"undo")}),e(!0)}):e(!1);break;case">":!c.Z.se||c.Z._e<1?e(!1):(c.Z._e--,c.Z.fe("w","historyPoint",c.Z._e),u(-1,function(t){Object.keys(t).forEach(function(e){c.ne(parseInt(e),t[e].rows,t[e].type,"redo")}),e(!0)}));break;case"?":a=[c.Z.se,c.Z.se-c.Z._e],c.Z.de.join("+")!==a.join("+")&&(c.Z.de=a),e(c.Z.de);break;case"flush_history":case"flush_db":c.Z.fe("w","historyPoint",0),c.Z.fe("w","historyLength",0),c.Z._e=0,c.Z.se=0,Object.keys(c.Z.oe).forEach(function(e){var t;0===c.Z.oe[parseInt(e)].re.indexOf("_")?t=[]:(t=c.Z.oe[parseInt(e)].he,t=Object.keys(t).map(function(e){return t[e]})),c.ne(parseInt(e),t,"remove","clear")}),"flush_db"===n?c.Z.pe("all",e):c.Z.pe("hist",e)}})},e}();t.w=s},function(e,t,n){"use strict";function r(e,t,n){setTimeout(function(){var r;try{r=t.apply(null,n)}catch(t){return d.ye(e,t)}return r===e?d.ye(e,new TypeError):d.be(e,r),null})}function o(e){var t=e&&e.then;return!e||"object"!=typeof e&&"function"!=typeof e||"function"!=typeof t?null:function(){t.apply(e,arguments)}}function i(e,t){function n(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];i||(i=!0,d.ye(e,t))}function r(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];i||(i=!0,d.be(e,t))}function o(){t(r,n)}var i=!1,s=a(o);"error"===s.ge&&n(s.ve)}function a(e,t){var n={ge:null,ve:null};try{n.ve=e(t),n.ge="success"}catch(e){n.ge="error",n.ve=e}return n}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){},_=["R"],c=["F"],u=["P"],l=function(){function e(e){this.me=u,this.ke=[],this.we=void 0,e!==s&&i(this,e)}return e.prototype.catch=function(e){return this.then(function(){},e)},e.prototype.then=function(t,n){if("function"!=typeof t&&this.me===c||"function"!=typeof n&&this.me===_)return this;var o=new e(s);if(this.me!==u){r(o,this.me===c?t:n,this.we)}else this.ke.push(new f(o,t,n));return o},e.resolve=function(t){return t instanceof this?t:d.be(new e(s),t)},e.reject=function(t){return d.ye(new e(s),t)},e.all=function(t){function n(e,t){function n(e){a[t]=e,++_!==o||i||(i=!0,d.be(u,a))}r.resolve(e).then(n,function(e){i||(i=!0,d.ye(u,e))})}var r=this,o=t.length,i=!1,a=new Array(o),_=0,c=-1,u=new e(s);if(!o)return this.resolve([]);for(;++c<o;)n(t[c],c);return u},e.race=function(t){function n(e){r.resolve(e).then(function(e){i||(i=!0,d.be(_,e))},function(e){i||(i=!0,d.ye(_,e))})}var r=this,o=t.length,i=!1,a=-1,_=new e(s);if(Array.isArray(t)!==!1)return this.reject(new TypeError);if(!o)return this.resolve([]);for(;++a<o;)n(t[a]);return _},e}();t.k=l;var f=function(){function e(e,t,n){this.xe=e,"function"==typeof t&&(this.Ie=t,this.Se=this.Oe),"function"==typeof n&&(this.je=n,this.Ee=this.Te)}return e.prototype.Se=function(e){d.be(this.xe,e)},e.prototype.Oe=function(e){r(this.xe,this.Ie,e)},e.prototype.Ee=function(e){d.ye(this.xe,e)},e.prototype.Te=function(e){r(this.xe,this.je,e)},e}();t.De=f;var d=function(){function e(){}return e.be=function(t,n){var r=a(o,n),s=r.ve,_=-1,u=t.ke.length;if("error"===r.ge)return e.ye(t,r.ve);if(s)i(t,s);else for(t.me=c,t.we=n;++_<u;)t.ke[_].Se(n);return t},e.ye=function(e,t){e.me=_,e.we=t;for(var n=-1,r=e.ke.length;++n<r;)e.ke[n].Ee(t);return e},e}()},function(e,t,n){var r=n(0),o=n(1),i=function(e,t,n,o,i){var a=n[0];0===o[0]&&(i[a]=e===-1?Number.MAX_VALUE:Number.MIN_VALUE);var s={};if(s=(e===-1?parseFloat(t[a])<parseFloat(i[a]):parseFloat(t[a])>parseFloat(i[a]))?t:i,o[0]===o[1]){var _=r.t(s);return _[e===-1?"MIN":"MAX"]=s[a],_}return s};t.b={SUM:{type:"aggregate",call:function(e,t,n,o){if(0===n[0]&&(o=0),o+=parseInt(e[t[0]]),n[0]===n[1]){var i=r.t(e);return i.SUM=o,i}return o}},MIN:{type:"aggregate",call:function(e,t,n,r){return i(-1,e,t,n,r)}},MAX:{type:"aggregate",call:function(e,t,n,r){return i(1,e,t,n,r)}},AVG:{type:"aggregate",call:function(e,t,n,o){if(0===n[0]&&(o=0),o+=parseInt(e[t[0]]),n[0]===n[1]){var i=r.t(e);return i.AVG=o/(n[1]+1)||o,i}return o}},COUNT:{type:"aggregate",call:function(e,t,n,o){if(0===n[0]&&(o=0),"*"===t[0]?o++:o+=e[t[0]]?1:0,n[0]===n[1]){var i=r.t(e);return i.COUNT=o,i}return o}}};var a=function(){function e(e){this.F=e}return e.prototype.te=function(e){var t=this;t.Ne=r.NanoSQLInstance.V(e.table),t.Ae=[],t.Pe=void 0;var n=[];if(e.query.forEach(function(o){["upsert","select","delete","drop"].indexOf(o.type)>=0?(t.Pe=o,"select"===o.type&&(t.Le=r.NanoSQLInstance.V(JSON.stringify(e.query)))):["show tables","describe"].indexOf(o.type)>=0?n.push(o):t.Ae.push(o)}),n.length)switch(n[0].type){case"show tables":e.onSuccess([{tables:Object.keys(t.F.Z.oe).map(function(e){return t.F.Z.oe[e].re})}],"info",[]);break;case"describe":var o,i=t.Ne,a={};Object.keys(t.F.Z.oe).forEach(function(e){parseInt(e)===t.Ne&&(o=r.t(t.F.Z._[e]),i=t.F.Z.oe[e].re)}),a[i]=o,e.onSuccess([a],"info",[])}else t.Ce(function(t,n,r){e.onSuccess(t,n,r)})},e.prototype.Me=function(e){return this.Ae.filter(function(t){return t.type===e}).pop()},e.prototype.Ce=function(e){var t=this;if(t.Pe){var n=function(n){if(t.Pe)switch(t.Pe.type){case"upsert":t.le(n,e);break;case"select":t.qe(n,e);break;case"drop":case"delete":t.Qe(n,e)}},r=t.F.Z.oe[t.Ne];if(t.Me("join")||"drop"===t.Pe.type)n([]);else if(t.Me("where")){var o=t.Me("where").args;if(o[1]=o[1].trim(),"string"==typeof o[0]&&o[0].trim()===r.Ve&&["=","IN","BETWEEN"].indexOf(o[1])!==-1)if("BETWEEN"===o[1])t.F.Z.Fe(r.re,o[0],o[2],function(e){n(e)});else{var i=[],a=[];"="===o[1]?i.push(o[2]):i=o[2];var s=0,_=function(){s<i.length?t.F.Z.ce(r.re,i[s],function(e){a=a.concat(e),s++,_()}):n(a)};_()}else t.F.Z.ce(r.re,function(e){return e&&t.Re(e,t.Me("where").args)},function(e){n(e)})}else"upsert"!==t.Pe.type?t.F.Z.ce(r.re,"all",function(e){n(e)}):n([])}},e.prototype.Be=function(e,t){var n=this,i=n.F.Z.oe[n.Ne];n.F.Z.ce(i.re,e,function(a){var s={},_=a[0]||{},c=n.Pe.args,u=function(){return n.Pe&&"delete"===n.Pe.type&&!c.length?"drop":n.Pe?n.Pe.type:""}(),l=!1;switch(u){case"upsert":s=_?r.t(_):{},Object.keys(c).forEach(function(e){s[e]=c[e]});var f=n.F.Z.oe[n.Ne];f.Je.forEach(function(e,t){var n=f.He[t];!s[e]&&n&&(s[e]=n)});break;case"delete":s=_?r.t(_):{},c&&c.length?c.forEach(function(e){s[e]=null}):(l=!0,s={})}var d=function(){0!==i.re.indexOf("_")&&n.F.Z.Ke&&i.Ve.length&&n.F.Z.ce("_"+i.re+"_hist__meta",e,function(t){t[0][o.X(3)].unshift(h),n.F.Z.le("_"+i.re+"_hist__meta",e,t[0])}),"upsert"===u?n.F.Z.le(i.re,e,s,function(){t()}):n.F.Z.Ue(i.re,e,function(){t()})},h=0;!l&&0!==i.re.indexOf("_")&&n.F.Z.Ke?n.F.Z.le("_"+i.re+"_hist__data",null,s,function(e){h=parseInt(e),d()}):d()})},e.prototype.ze=function(e,t,n){var i=this,a=this,s=0,_=0;if(e.length>0){var c=function(){if(a.F.Z.Ke)a.F.Z.ae||0!==a.F.Z._e||a.F.Z.se++,a.F.Z.fe("w","historyLength",a.F.Z.se),a.F.Z.fe("w","historyPoint",a.F.Z._e),a.F.Z.le("_historyPoints",null,{historyPoint:a.F.Z.se-a.F.Z._e,tableID:a.Ne,rowKeys:e.map(function(e){return parseInt(e)}),type:t},function(r){var o=a.F.Z.oe[i.Ne];a.F.ne(a.Ne,[],""),a.F.Z.ce(o.re,function(t){return t&&e.indexOf(t[o.Ve])!==-1},function(r){n([{msg:e.length+" row(s) "+t}],t,r)})});else{var r=a.F.Z.oe[a.Ne];a.F.ne(a.Ne,[],""),a.F.Z.ce(r.re,function(t){return t&&e.indexOf(t[r.Ve])!==-1},function(r){n([{msg:e.length+" row(s) "+t}],t,r)})}};a.F.Z.Ke&&a.F.Z._e>0&&a.F.Z.ae!==!0?a.F.Z.ce("_historyPoints",function(e){return e.historyPoint>a.F.Z.se-a.F.Z._e},function(e){_=0;var t=function(){if(!(_<e.length))return a.F.Z.se-=a.F.Z._e,a.F.Z._e=0,void c();var n=a.F.Z.oe[e[_].tableID].re;s=0;var i=function(){s<e[_].rowKeys.length?a.F.Z.ce("_"+n+"_hist__meta",e[_].rowKeys[s],function(t){t[0]=r.t(t[0]),t[0][o.X(2)]=0;var c=t[0][o.X(3)].shift();a.F.Z.le("_"+n+"_hist__meta",e[_].rowKeys[s],t[0],function(){c?a.F.Z.Ue("_"+n+"_hist__data",c,function(){s++,i()}):(s++,i())})}):(_++,t())};a.F.Z.Ue("_historyPoints",e[_].id,function(){i()})};t()}):c()}else n([{msg:"0 rows "+t}],t,[])},e.prototype.le=function(e,t){var n,i=this,a="",s=[],_=i.Pe.args||{},c=i.F.Z.oe[i.Ne],u=c.Ve;if(i.Me("where")){a="modified",s=e.map(function(e){return e[c.Ve]}),n=0;var l=function(){n<e.length?i.Be(e[n][u],function(){n++,l()}):i.ze(s,a,t)};l()}else{a="inserted",_[u]?"int"===c.ue&&(c.We=Math.max(_[u]+1,c.We)):"int"===c.ue?_[u]=c.We++:"uuid"===c.ue&&(_[u]=r.NanoSQLInstance.uuid());var f=_[u]?_[u]:c.Xe.length;if(s=[f],c.Xe.indexOf(f)===-1){var d=i.F.Z.oe[i.Ne].re;if(0!==d.indexOf("_")){var h="_"+d+"_hist__meta",p={};p[o.X(2)]=0,p[o.X(3)]=[0],i.F.Z.le(h,f,p)}c.Xe.push(f)}i.Be(f,function(){i.ze(s,a,t)})}},e.prototype.$e=function(){return this.Ge?this.Ge:this.Ne},e.prototype.qe=function(e,n){var o=this;if(o.F.G[o.Ne][o.Le])return void n(o.F.G[o.Ne][o.Le],"none",[]);var i,a,s=["join","groupby","having","orderby","offset","limit"],_={},c=function(e,t,n){return Object.keys(n).reduce(function(r,o){return r?r:e[o]===t[o]?0:(e[o]>t[o]?1:-1)*("desc"===n[o]?-1:1)},0)},u=function(e,n,a){if(i=o.Me(s[n]),2===n){var u=[];if(l.length){var f=Object.keys(t.b).map(function(e){return e+"("}),d=[];u=l.filter(function(e){return(f.reduce(function(t,n){return(e.indexOf(n)<0?0:1)+t},0)||0)>0||(d.push(e),!1)}).map(function(e){var n=e.match(/(.*)\((.*)\)/),r=n[1].trim(),o=(e.match(/\sAS\s(.*)/)||[]).pop()||r,i=n[2].split(",").map(function(e){return e.trim()});return"simple"===t.b[r].type&&o===r&&(o=i[0]),d.push(o),{name:r,args:i,as:o.trim(),type:t.b[r].type}});var h=[];if(u.length){var p,y=function(e){return u.sort(function(e,t){return e.type>t.type?1:-1}).reduce(function(n,r){var o=n.length-1;if("aggregate"===r.type){var i=e.slice();o=i.length-1,i=[i.reduce(function(e,n,i){return t.b[r.name].call(n,r.args,[i,o],e)},{})],p&&(i[0][p]=n[0][p]),n=i,p=r.name}else n=n.map(function(e,n){return t.b[r.name].call(e,r.args,[n,o])});return r.name!==r.as?d.push(r.name+" AS "+r.as):d.push(r.name),n},e.slice())},b=Object.keys(_);h=b.length?b.map(function(e){return p=null,y(_[e])}).reduce(function(e,t){return e=e.concat(t)},[]):y(e)}else h=e;var g=d.map(function(e){return e.match(/(.*)\sAS\s(.*)/)||e}).filter(function(e){return e})||[];g.length&&(h=h.map(function(e){e=r.t(e);var t={};return g.forEach(function(n){"string"==typeof n?t[n]=e[n]:t[n[2]]=e[n[1]]}),t})),e=h}}if(!i)return a(e);switch(n){case 0:var v=void 0;"cross"!==i.args.type&&(v={Ye:i.args.where[0].split(".").pop(),Ze:i.args.where[1],et:i.args.where[2].split(".").pop()});var m=o.Ne,k=r.NanoSQLInstance.V(i.args.table),w=o.Me("where");o.tt(i.args.type,m,k,v,function(e){a(w?e.filter(function(e){return o.Re(e,w.args)}):e)});break;case 1:var x=i.args,I={};x?(_=e.reduce(function(e,t){var n=Object.keys(x).reduce(function(e,n){return e+"."+String(t[n])},"").slice(1);return(e[n]=e[n]||[]).push(t),I[n]=Object.keys(x).reduce(function(e,n){return e[n]=t[n],e},{}),e},{}),a(Object.keys(_).sort(function(e,t){return c(I[e],I[t],x)}).reduce(function(e,t){return e.concat(_[t])},[]))):a(e);break;case 2:a(e.filter(function(e){return o.Re(e,o.Me("having").args)}));break;case 3:a(e.sort(function(e,t){return c(e,t,i.args)}));break;case 4:a(e.filter(function(e,t){return!i||t>=i.args}));break;case 5:a(e.filter(function(e,t){return!i||t<i.args}))}};a=-1;var l=o.Pe.args||[],f=function(e){a<s.length?(a++,u(e,a,function(e){f(e)})):(e=e.filter(function(e){return e}),o.Me("join")||(o.F.G[o.Ne][o.Le]=e),n(e,"none",[]))};f(e)},e.prototype.Qe=function(e,t){var n,r="deleted",o=this,i=o.Pe.args||[],a=o.F.Z.oe[o.Ne].Ve;n=0;var s=function(){n<e.length?o.Be(e[n][a],function(){n++,s()}):(i.length&&(r="modified"),o.ze(e.map(function(e){return e[a]}),r,t))};s()},e.prototype.Re=function(e,t){var n=this,r=["AND","OR"];if("string"!=typeof t[0]){var o;return t.reduce(function(t,i,a){if(r.indexOf(i)!==-1)return o=i,t;var s=0===n.nt(i[2],i[1],e[i[0]]);return 0===a?s:"AND"===o?t&&s:t||s},!0)}return 0===n.nt(t[2],t[1],e[t[0]])},e.prototype.tt=function(e,t,n,r,o){var i="outer",a=this,s=a.F.Z.oe[t],_=a.F.Z.oe[n],c=function(e,t){return[s,_].reduce(function(n,r,o){return r.Je.forEach(function(i){n[r.re+"."+i]=((0===o?e:t)||{})[i]}),n},{})},u=[],l=[];a.F.Z.ce(s.re,"all",function(t){a.F.Z.ce(_.re,"all",function(n){t.forEach(function(t){var o=n.filter(function(e){if(!r)return!0;var n=c(t,e),o=a.Re(n,[r.Ye,r.Ze,r.et]);return o&&l.push(e[_.Ve]),o});o.length?u=u.concat(o):["left",i].indexOf(e)>=0&&u.push(c(t,null))}),l=l.sort().filter(function(e,t,n){return!t||e!==n[t-1]}),["right",i].indexOf(e)>=0&&n.filter(function(e){return l.indexOf(e[_.Ve])===-1}).forEach(function(e){u.push(c(null,e))}),o(u)})})},e.prototype.nt=function(e,t,n){var r=function(e){return"LIKE"!==t?e:"string"==typeof e?String(e).toLowerCase():Array.isArray(e)?e.map(function(e){return r(e)}):e},o=r(n),i=r(e);switch(t){case"=":return o===i?0:1;case">":return o>i?0:1;case"<":return o<i?0:1;case"<=":return o<=i?0:1;case">=":return o>=i?0:1;case"IN":return i.indexOf(o)<0?1:0;case"NOT IN":return i.indexOf(o)<0?0:1;case"REGEX":case"LIKE":return o.search(i)<0?1:0;case"BETWEEN":return i[0]<=o&&i[1]>=o?0:1;case"HAVE":return(o||[]).indexOf(i)<0?1:0;default:return 0}},e}();t.W=a},function(e,t,n){var r=n(0),o=n(1),i=n(3),a=function(){function e(e,t){this.rt=t,this.init(e,t)}return e.prototype.init=function(e,t){var n=this;n._={},n.oe={},n.ot={},n._e=0,n.se=0,n.de=[0,0],n.ae=!1,n.Ke=!0,n.it=!0,n.at=!1,n.st={},n._t=0,n.S=e;t.I.length&&(n.at=void 0!==t.I[0].persistent&&t.I[0].persistent,n.Ke=void 0===t.I[0].history||t.I[0].history,n.it=void 0===t.I[0].memory||t.I[0].memory,t.I[0].size,n._t={IDB:1,LS:2,LVL:4}[t.I[0].mode]||0,t.I[0].id&&(n.S.Y=String(t.I[0].id)));var a=!1,s=0,_=!0;Object.keys(t._).forEach(function(e){var n;t._[e].forEach(function(e){e.props&&e.props.indexOf("pk")!==-1&&(n=r.t(e))}),n&&(t._["_"+e+"_hist__data"]=r.t(t._[e]).map(function(e){return delete e.props,e}),t._["_"+e+"_hist__meta"]=[n,{key:"_pointer",type:"int"},{key:"_historyDataRowIDs",type:"array"}])}),t._[o.X(0)]=[{key:"key",type:"string",props:["pk"]},{key:"value",type:"blob"}],t._[o.X(1)]=[{key:"id",type:"int",props:["ai","pk"]},{key:"tableID",type:"int"},{key:"historyPoint",type:"int"},{key:"rowKeys",type:"array"},{key:"type",type:"string"}];var c,u,l=Object.keys(t._);Object.keys(t._).forEach(function(e){n.ct(e,t._[e])}),Object.keys(t.b||[]).forEach(function(e){i.b[e]=t.b[e]});var f=function(){var e=Object.keys(t._),r=0;if(n._t=u,c&&n.ce(o.X(0),"all",function(e){e.forEach(function(e){n.fe("w",e.key,e.value),"historyPoint"===e.key&&(n._e=e.value||0),"historyLength"===e.key&&(n.se=e.value||0)})}),_){var i=function(){r<e.length?e[r].indexOf("_hist__data")!==-1?n.le(e[r],0,null,function(){r++,i()}):(r++,i()):(n.Ke=c,t.O())};i()}else n.Ke=c,t.O()};if(u=n._t,n.at)if(0!==n._t)switch(n._t){case 1:"undefined"==typeof indexedDB&&(n._t=0);break;case 2:"undefined"==typeof localStorage&&(n._t=0);break;case 4:"undefined"!=typeof window&&(n._t=0)}else"undefined"!=typeof window&&("undefined"!=typeof localStorage&&(n._t=2),"undefined"!=typeof indexedDB&&(n._t=1)),"undefined"!=typeof global&&void 0!==global.ut&&void 0!==global.lt&&(n._t=4);else n._t=0,f();c=n.Ke,u=n._t,n._t=0,n.Ke=!1;var d=function(e,t){var o=function(){if(s<l.length){var i=r.NanoSQLInstance.V(l[s]);e(l[s],i,n.oe[i]),s++,o()}else t()};o()},h=function(e){_=!1;var t=0,o=function(){if(t>=l.length)return void(e.cleanup?e.cleanup(function(){f()}):f());if(!c&&(l[t].indexOf("_hist__data")!==-1||l[t].indexOf("_hist__meta")!==-1))return t++,void o();if(t<l.length){var i=r.NanoSQLInstance.V(l[t]);n.it?e.requestTable(l[t],function(e){l[t].indexOf("_hist__data")!==-1?(n.oe[i].Xe.push("0"),n.oe[i].he[0]=null,n.oe[i].We++,n.S.S.loadJS(l[t],e).then(function(){t++,o()})):n.S.S.loadJS(l[t],e).then(function(){t++,o()})}):n.it&&!e.forceIndex||e.requestIndex(l[t],function(e){n.S.S.loadJS(l[t],e).then(function(){t++,o()})})}};o()};switch(u){case 0:f();break;case 1:var p=indexedDB.open(n.S.Y,1);p.onupgradeneeded=function(e){a=!0;var t=e.target.result,r=e.target.transaction;n.ft=t,d(function(e,n,r){var o=r.Ve?{keyPath:r.Ve}:{};t.createObjectStore(e,o)},function(){r.oncomplete=function(){f()}})},p.onsuccess=function(e){if(n.ft=e.target.result,!a){var t=function(e,t){var r=[],o=n.ft.transaction(e,"readonly");o.objectStore(e).openCursor().onsuccess=function(e){var t=e.target.result;t&&(r.push(n.it?t.value:t.key),t.continue())},o.oncomplete=function(){t(r)}};h({requestIndex:function(e,n){t(e,n)},requestTable:function(e,n){t(e,n)}})}};break;case 2:localStorage.getItem("dbID")!==n.S.Y?(localStorage.setItem("dbID",n.S.Y),d(function(e,t,n){localStorage.setItem(e,JSON.stringify([]))},function(){f()})):h({forceIndex:!0,requestIndex:function(e,t){t(JSON.parse(localStorage.getItem(e)||"[]"))},requestTable:function(e,t){var n=[];JSON.parse(localStorage.getItem(e)||"[]").forEach(function(t){n.push(JSON.parse(localStorage.getItem(e+"-"+t)||""))}),t(n)}})}},e.prototype.pe=function(e,t){var n=this,i=Object.keys(n.oe).map(function(e){return n.oe[e].re}),a=0,s=function(){var e=0,a=function(){if(e<i.length)if(i[e].indexOf("_hist__meta")!==-1){var s=String(i[e]).slice(1).replace("_hist__meta",""),_=r.NanoSQLInstance.V(s),c=n.oe[_].Ve;n.ce(s,"all",function(t){t.forEach(function(t,r){var a={};a[o.X(2)]=0,a[o.X(3)]=[r+1],n.le(i[e],t[c],a),n.le("_"+s+"_hist__data",r+1,t)}),e++,a()})}else e++,a();else t()};a()},_=function(){if(a<i.length){var r=!1;"hist"!==e||"_historyPoints"!==i[a]&&i[a].indexOf("_hist__meta")===-1&&i[a].indexOf("_hist__data")===-1||(r=!0),"all"===e&&"_utility"!==i[a]&&(r=!0),r?n.Ue(i[a],"all",function(){i[a].indexOf("_hist__data")!==-1&&n.le(i[a],0,null),a++,_()}):(a++,_())}else"hist"===e?s():t()};_()},e.prototype.Ue=function(e,t,n){var o=this,i=r.NanoSQLInstance.V(e),a=[];if("all"===t?(a=o.oe[i].Xe.slice(),o.oe[i].Xe=[]):(a.push(t),o.oe[i].Xe.splice(o.oe[i].Xe.indexOf(t),1)),o.it)if("all"===t)o.oe[i].he={};else if(delete o.oe[i].he[t],0===o._t&&n)return n(!0);if(o._t>0){var s=0,_=function(){if(s<a.length)switch(o._t){case 1:o.ft.transaction(e,"readwrite").objectStore(e).delete(parseInt(a[s])),s++,_();break;case 2:localStorage.setItem(e,JSON.stringify(o.oe[i].Xe)),localStorage.removeItem(e+"-"+String(a[s])),s++,_();break;default:s++,_()}else n&&n(!0)};_()}},e.prototype.le=function(e,t,n,o){var i=this,a=r.NanoSQLInstance.V(e);void 0!==t&&null!==t||(i._[a].forEach(function(e){e.props&&e.props.indexOf("pk")!==-1&&(t="uuid"===e.type?r.NanoSQLInstance.uuid():i.oe[a].We++)}),t||(t=parseInt(i.oe[a].Xe[i.oe[a].Xe.length-1]||"0")+1)),"int"===i.oe[a].ue&&(t=parseInt(t));var s=i.oe[a].Ve;if(s&&s.length&&n&&!n[s]&&(n[s]=t),i.oe[a]&&i.oe[a].Xe.indexOf(t)===-1&&i.oe[a].Xe.push(t),i.it&&i.oe[a]&&(i.oe[a].he[t]=i.S.ie(n,a),0===i._t&&o))return o(t);switch(i._t){case 1:var _=i.ft.transaction(e,"readwrite"),c=_.objectStore(e);s.length&&n?c.put(n):e.indexOf("_hist__data")!==-1?c.put(n,t):(n&&c.put(n),n||c.delete(t)),_.oncomplete=function(){o&&o(t)};break;case 2:localStorage.setItem(e+"-"+String(t),n?JSON.stringify(n):""),localStorage.setItem(e,JSON.stringify(i.oe[a].Xe)),o&&o(t)}},e.prototype.Fe=function(e,t,n,o){var i=this,a=r.NanoSQLInstance.V(e);if(i.it&&i.oe[a]||2===i._t)return void this.ce(e,function(e){return e[t]>=n[0]&&e[t]<=n[1]},o);var s=[];switch(i._t){case 1:var _=i.ft.transaction(e,"readonly"),c=_.objectStore(e),u=c.openCursor(IDBKeyRange.bound(n[0],n[1]));_.oncomplete=function(){o(s)},u.onsuccess=function(e){var t=e.target.result;t&&(s.push(t.value),t.continue())}}},e.prototype.ce=function(e,t,n){var o=this,i=r.NanoSQLInstance.V(e);if(o.it&&o.oe[i]){var a=o.oe[i].he;if("all"===t||"function"==typeof t){var s=Object.keys(a).map(function(e){return a[e]});n("all"===t?s.filter(function(e){return e}):s.filter(function(e){return t(e)}))}else n([a[t]].filter(function(e){return e}))}else switch(o._t){case 1:var _=o.ft.transaction(e,"readonly"),c=_.objectStore(e);if("all"===t||"function"==typeof t){var u=c.openCursor(),l=[];_.oncomplete=function(){n(l)},u.onsuccess=function(e){var n=e.target.result;n&&("all"!==t?t(n.value)&&l.push(n.value):l.push(n.value),n.continue())}}else{var f=c.get(t);f.onsuccess=function(e){n([f.result])}}break;case 2:if("all"===t||"function"==typeof t){var d=o.oe[i].Xe.map(function(t){var n=localStorage.getItem(e+"-"+t);return n&&n.length?JSON.parse(n):null});n("all"!==t?d.filter(function(e){return t(e)}):d)}else{var h=localStorage.getItem(e+"-"+t);n([h&&h.length?JSON.parse(h):null])}}},e.prototype.fe=function(e,t,n){var r=this;return"r"===e?r.st[t]?r.st[t].value:null:(r.le(o.X(0),t,{key:t,value:n}),r.fe[t]={key:t,value:n},n)},e.prototype.ct=function(e,t){var n=this,o=r.NanoSQLInstance.V(e);n._[o]=t,n.S.G[o]={},n.oe[o]={Ve:"",ue:"",Je:[],He:[],re:e,We:1,Xe:[],he:{}};for(var i=n._[o].length;i--;){var a=n._[o][i];n.oe[o].Je.unshift(a.key),n.oe[o].He[i]=a.default,a.props&&a.props.indexOf("pk")>=0&&(n.oe[o].Ve=a.key,n.oe[o].ue=a.type)}return e},e}();t.ee=a},function(e,t,n){e.exports=n(0)}])});
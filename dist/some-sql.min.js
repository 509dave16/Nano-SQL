!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){e.exports=n(1)},function(e,t,n){"use strict";function r(e){return f.init(e)}var i=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},o=n(2),s=n(3),c=n(4),u=function(){function e(){var e=this;e._actions=new o.tsMap,e._views=new o.tsMap,e._models=new o.tsMap,e._query=[],e._events=["change","delete","upsert","drop","select","error"],e._callbacks=new o.tsMap,e._callbacks.set("*",new o.tsMap),e._events.forEach(function(t){e._callbacks.get("*").set(t,[])})}return e.prototype.init=function(e){return e&&(this._selectedTable=e),this},e.prototype.connect=function(e){var t=this;return t._backend=e||new c.someSQL_MemDB,new a(t,function(e,n){t._backend.connect(t._models,t._actions,t._views,e,n)})},e.prototype.on=function(e,t){var n=this,r=this;return e.split(" ").forEach(function(e){if(n._events.indexOf(e)==-1)throw Error(e+"ins't a valid event!");r._callbacks.get(r._selectedTable).get(e).push(t)}),this},e.prototype.model=function(e){var t=this,n=t._selectedTable;return t._callbacks.set(n,new o.tsMap),t._callbacks.get(n).set("*",[]),t._events.forEach(function(e){t._callbacks.get(n).set(e,[])}),t._models.set(n,e),t._views.set(n,{}),t._actions.set(n,{}),this},e.prototype.views=function(e){return this._views.set(this._selectedTable,e),this},e.prototype.getView=function(e,t){var n=this,r=n._selectedTable,i=n._views.get(r)[e];return n._activeActionOrView=e,i[1].apply(n,[n._cleanArgs(i[0],t)])},e.prototype._cleanArgs=function(e,t){var n=this,r=(n._selectedTable,{});return e.forEach(function(e){var i=e.split(":");i.length>1?r[i[0]]=n._cast(i[1],t[i[0]]):r[i[0]]=t[i[0]]}),r},e.prototype._cast=function(e,t){switch(["string","int","float","array","map"].indexOf(e)){case 0:return String(t);case 1:return parseInt(t);case 2:return parseFloat(t);case 3:case 4:return JSON.parse(JSON.stringify(t));default:return""}},e.prototype.actions=function(e){return this._actions.set(this._selectedTable,e),this},e.prototype.doAction=function(e,t){var n=this,r=n._actions.get(n._selectedTable)[e];return n._activeActionOrView=e,r[1].apply(n,[n._cleanArgs(r[0],t)])},e.prototype.query=function(e,t){this._query=[];var n=e.toLowerCase();return["select","upsert","delete","drop"].indexOf(n)!=-1&&this._query.push(new o.tsMap([["type",n],["args",t]])),this},e.prototype.where=function(e){return this._addCmd("where",e)},e.prototype.andWhere=function(e){return this._addCmd("andWhere",e)},e.prototype.orWhere=function(e){return this._addCmd("orWhere",e)},e.prototype.orderBy=function(e){return this._addCmd("orderby",e)},e.prototype.limit=function(e){return this._addCmd("limit",e)},e.prototype.offset=function(e){return this._addCmd("offset",e)},e.prototype._addCmd=function(e,t){return this._query.push(new o.tsMap([["type",e],["args",t]])),this},e.prototype.exec=function(){var e=this,t=e._selectedTable;e._triggerEvents=e._query.map(function(e){switch(e.get("type")){case"select":return[e.get("type")];case"delete":case"upsert":case"drop":return[e.get("type"),"change"];default:return[]}}).reduce(function(e,t){return e.concat(t)});var n=function(n){e._triggerEvents.forEach(function(r){e._callbacks.get(t).get(r).concat(e._callbacks.get("*").get(r)).forEach(function(t){n.name=r,n.actionOrView=e._activeActionOrView,t.apply(e,[n])})}),e._activeActionOrView=void 0};return new a(e,function(r,i){e._backend.exec(t,e._query,e._activeActionOrView,function(i){n({table:t,query:e._query.map(function(e){return e.toJSON()}),time:(new Date).getTime(),result:i}),r(i)},function(r){e._triggerEvents=["error"],n({table:t,query:e._query.map(function(e){return e.toJSON()}),time:(new Date).getTime(),result:r}),i(r)})})},e.prototype.custom=function(e,t){var n=this;return new a(n,function(r,i){n._backend.custom?n._backend.custom.apply(n,[e,t,r,i]):r()})},e.prototype.loadJS=function(e){var t=this;return s.tsPromise.all(e.map(function(e){return t.init(t._selectedTable).query("upsert",e).exec()}))},e.prototype.loadCSV=function(e){var t=this,n=[];return new a(t,function(r,i){s.tsPromise.all(e.split("\n").map(function(e,r){return new a(t,function(i,o){if(0==r)n=e.split(","),i();else{var s={},c=e.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g).map(function(e){return e.replace(/^"(.+(?="$))"$/,"$1")});n.forEach(function(e,t){0!=c[t].indexOf("{")&&0!=c[t].indexOf("[")||(c[t]=JSON.parse(c[t].replace(/'/g,'"'))),s[e]=c[t]}),t.init(t._selectedTable).query("upsert",c).exec().then(function(){i()})}})})).then(function(){r()})})},e.prototype.toCSV=function(e){var t=this;return new a(t,function(n,r){t.exec().then(function(r){var i=t._query.filter(function(e){return"select"==e.get("type")}).map(function(e){return e.get("args")?e.get("args").map(function(e){return t._models.get(t._selectedTable).filter(function(t){return t.key==e})[0]}):t._models.get(t._selectedTable)})[0];e&&r.unshift(i.map(function(e){return e.key})),n(r.map(function(t,n){return e&&0==n?t:i.filter(function(e){return!!t[e.key]}).map(function(e){switch(e.type){case"map":return'"'+JSON.stringify(t[e.key]).replace(/"/g,"'")+'"';case"array":return'"'+JSON.stringify(t[e.key]).replace(/"/g,"'")+'"';default:return JSON.stringify(t[e.key])}}).join(",")}).join("\n"))})})},e.uuid=function(e){return e?e:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})}()},e.hash=function(e){for(var t=5381,n=0;n<e.length;n++){var r=e.charCodeAt(n);t=(t<<5)+t+r}return String(t)},e}();t.someSQL_Instance=u;var a=function(e){function t(t,n){var r=e.call(this,n)||this;return r.scope=t,r}return i(t,e),t.prototype.then=function(e,n){var r=this;return new t(r.scope,function(t,i){r.done(function(n){if("function"==typeof e)try{n=e.apply(r.scope,[n])}catch(e){return void i(e)}t(n)},function(e){if("function"==typeof n){try{e=n.apply(r.scope,[e])}catch(e){return void i(e)}t(e)}else i(e)})})},t}(s.tsPromise),f=new u;t.someSQL=r},function(e,t){"use strict";var n=function(){function e(e){var t=this;t._items=[],t._keys=[],t._values=[],t.length=0,e&&e.forEach(function(e,n){t.set(e[0],e[1])})}return e.prototype.fromJSON=function(e){for(var t in e)e.hasOwnProperty(t)&&this.set(t,e[t])},e.prototype.toJSON=function(){var e={},t=this;return t.keys().forEach(function(n){e[String(n)]=t.get(n)}),e},e.prototype.entries=function(){return[].slice.call(this._items)},e.prototype.keys=function(){return[].slice.call(this._keys)},e.prototype.values=function(){return[].slice.call(this._values)},e.prototype.has=function(e){return this._keys.indexOf(e)>-1},e.prototype.get=function(e){var t=this._keys.indexOf(e);return t>-1?this._values[t]:void 0},e.prototype.set=function(e,t){var n=this,r=this._keys.indexOf(e);r>-1?(n._items[r][1]=t,n._values[r]=t):(n._items.push([e,t]),n._keys.push(e),n._values.push(t)),n.length=n.size()},e.prototype.size=function(){return this._items.length},e.prototype.clear=function(){var e=this;e._keys.length=e._values.length=e._items.length=0,e.length=e.size()},e.prototype.delete=function(e){var t=this,n=t._keys.indexOf(e);return n>-1&&(t._keys.splice(n,1),t._values.splice(n,1),t._items.splice(n,1),t.length=t.size(),!0)},e.prototype.forEach=function(e){var t=this;t._keys.forEach(function(n){e(t.get(n),n)})},e.prototype.map=function(e){var t=this;return this._keys.map(function(n){return e(t.get(n),n)})},e.prototype.filter=function(e){var t=this;return t._keys.forEach(function(n){0==e(t.get(n),n)&&t.delete(n)}),this},e.prototype.clone=function(){return new e(JSON.parse(JSON.stringify(this._items)))},e}();t.tsMap=n},function(e,t){"use strict";var n=function(){function e(e){this._callbacks=[],this._failed=!1,this._resolved=!1,this._settled=!1,e(this._resolve.bind(this),this._reject.bind(this))}return e.resolve=function(t){return new e(function(e){e(t)})},e.reject=function(t){return new e(function(e,n){n(t)})},e.race=function(t){var n=!1;return new e(function(e,r){t.forEach(function(t){t.then(function(t){n||(e(t),n=!0)}).catch(function(e){r(e),n=!0})})})},e.chain=function(t){var n,r=0,i=[],o=function(e){r==t.length?n(i):e.then(function(e){i.push(e),r++,o(t[r])})};return new e(function(e){n=e,o(t[r])})},e.all=function(t){return new e(function(e,n){var r=t.length,i=[],o=!1;t.forEach(function(t,s){t.then(function(t){o||(r--,i[s]=t,0==r&&e(i))}).catch(function(e){n(e),o=!0})})})},e.prototype.done=function(e,t){this._settled?setTimeout(this._release.bind(this,e,t),0):this._callbacks.push({onSuccess:e,onFail:t})},e.prototype.then=function(t,n){var r=this;return new e(function(e,i){r.done(function(n){if("function"==typeof t)try{n=t(n)}catch(e){return void i(e)}e(n)},function(t){if("function"==typeof n){try{t=n(t)}catch(e){return void i(e)}e(t)}else i(t)})})},e.prototype.catch=function(e){return this.then(null,e)},e.prototype._release=function(e,t){this._failed?t(this._value):e(this._value)},e.prototype._resolve=function(t){this._resolved||(this._resolved=!0,t instanceof e?t.done(this._settle.bind(this),function(e){this._failed=!0,this._settle(e)}.bind(this)):this._settle(t))},e.prototype._reject=function(e){this._resolved||(this._resolved=!0,this._failed=!0,this._settle(e))},e.prototype._settle=function(e){this._settled=!0,this._value=e,setTimeout(this._callbacks.forEach.bind(this._callbacks,function(e){this._release(e.onSuccess,e.onFail)},this),0)},e}();t.tsPromise=n},function(e,t,n){"use strict";var r=n(1),i=n(3),o=n(2),s=function(){function e(){var e=this;e._tables=new o.tsMap,e._tIndex=new o.tsMap,e._models=new o.tsMap,e._tCacheI=new o.tsMap,e._immu=new o.tsMap,e._i=new o.tsMap}return e.prototype.connect=function(e,t,n,r){var i=this;e.forEach(function(e,t){i._newModel(t,e)}),r()},e.prototype._newModel=function(e,t){this._models.set(e,t),this._tables.set(e,[]),this._tIndex.set(e,[]),this._i.set(e,1)},e.prototype.exec=function(e,t,n,o,s){var c=this;c._sT=e,c._mod=[],c._act=null,c._cacheKey=r.someSQL_Instance.hash(JSON.stringify(t)),i.tsPromise.all(t.map(function(e){return new i.tsPromise(function(t,n){c._query(e,t)})})).then(function(){c._exec(o)})},e.prototype._query=function(e,t){["upsert","select","delete","drop"].indexOf(e.get("type"))!=-1&&(this._act=e),["where","orderby","limit","offset","andWhere","orWhere"].indexOf(e.get("type"))!=-1&&this._mod.push(e),t()},e.prototype._exec=function(e){var t=this,n=t._mod.filter(function(e){return["where","andWhere","orWhere"].indexOf(e.get("type"))!=-1}),i=t._act.get("args");switch(t._act.get("type")){case"upsert":var o=0,s=function(e){t._tCacheI.forEach(function(n,r){n&&n.indexOf(e)!=-1&&(t._tCacheI.delete(r),t._immu.delete(r))})};if(n.length){var c=t._where(t._tIndex.get(t._sT)),u=t._tables.get(t._sT);c.forEach(function(e,t){for(var n in i)u[e][n]=i[n];s(t),o++})}else{var a="";t._models.get(t._sT).forEach(function(e){"uuid"!=e.type||i[e.key]||(i[e.key]=r.someSQL_Instance.uuid()),e.props&&e.props.indexOf("pk")!=-1&&(a=e.key,e.props.indexOf("ai")==-1||i[e.key]||(i[e.key]=t._i.get(t._sT),t._i.set(t._sT,t._i.get(t._sT)+1)))});var f=i[a];t._tIndex.get(t._sT).indexOf(f)==-1?t._tIndex.get(t._sT).push(f):s(f),t._tables.get(t._sT)[f]=i,o++}e(o+" row(s) upserted");break;case"select":var p=t._tables.get(t._sT);t._tCacheI.set(t._cacheKey,[]),t._immu.set(t._cacheKey,JSON.parse(JSON.stringify(t._where(t._tIndex.get(t._sT)).sort(function(e,n){return t._mod.filter(function(e){return"orderby"==e.get("type")}).map(function(t){for(var r in t.get("args")){if(p[e][r]==p[n][r])return 0;var i=p[e][r]>p[n][r]?1:-1;return"asc"==t.get("args")[r]?i:-i}}).reduce(function(e,t){return e+t},0)||0}).filter(function(e,n){var r=0;return!t._mod.filter(function(e){return["limit","offset"].indexOf(e.get("type"))!=-1}).sort(function(e,t){return e.get("type")<t.get("type")?1:-1}).map(function(e,t){switch(e.get("type")){case"offset":return r=e.get("args"),n>=e.get("args")?0:1;case"limit":return n<r+e.get("args")?0:1}}).reduce(function(e,t){return e+t},0)}).map(function(e,n){if(i&&i.length){var r={};return t._models.get(t._sT).forEach(function(t){i.indexOf(t.key)!=-1&&(r[t.key]=p[e][t.key])}),r}return p[e]})))),e(t._immu.get(t._cacheKey));break;case"delete":if(n.length){var c=t._where(t._tIndex.get(t._sT)),l=t._tables.get(t._sT);c.forEach(function(e,n){delete l[e],t._tIndex.get(t._sT).splice(t._tIndex.get(t._sT).indexOf(e),1)}),e(c.length+" row(s) deleted")}else t._newModel(t._sT,t._models.get(t._sT)),e("Table dropped.");break;case"drop":t._newModel(t._sT,t._models.get(t._sT)),e("Table dropped.")}},e.prototype._where=function(e){var t=this,n=t._tables.get(t._sT);return e.filter(function(e,r){var i=[];return t._mod.filter(function(e){return"andWhere"==e.get("type")}).forEach(function(e){e.get("args").forEach(function(e){i.push({type:"where",args:e})})}),0==t._mod.filter(function(e){return"where"==e.get("type")}).concat(i).map(function(r){return t._models.get(t._sT).map(function(i){return i.key==r.get("args")[0]?t._compare(r.get("args")[2],r.get("args")[1],n[e][i.key]):0}).reduce(function(e,t){return e+t},0)}).reduce(function(e,t){return e+t},0)}).filter(function(e){var r=[];return t._mod.map(function(e){"orWhere"==e.type&&e.args.forEach(function(e){r.push(e)})}),0==r.length||t._models.get(t._sT).map(function(i){return r.filter(function(r){return 1!=t._compare(r[2],r[1],n[e][i.key])}).length}).filter(function(e){return e>0}).length>0})},e.prototype._compare=function(e,t,n){switch(t){case"=":return n==e?0:1;case">":return n>e?0:1;case"<":return n<e?0:1;case"<=":return n<=e?0:1;case">=":return n>=e?0:1;case"IN":return e.indexOf(n)==-1?1:0;case"NOT IN":return e.indexOf(n)==-1?0:1;case"LIKE":return n.search(e)==-1?1:0;default:return 0}},e}();t.someSQL_MemDB=s}])});
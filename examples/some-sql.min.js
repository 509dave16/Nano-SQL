!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.e?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=3)}([function(e,t,n){function r(e){return c.table(e)}var o=this&&this.t||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},i=n(1),s=n(2),a=function(){function e(){var e=this;e.r={},e.a={},e._={},e.u=[],e.f=[],e.h=["change","delete","upsert","drop","select","error"],e.b={},e.b["*"]={};for(var t=e.h.length;t--;)e.b["*"][e.h[t]]=[];e.y={},e.g=[]}return e.prototype.table=function(e){return e&&(this.v=e,this.activeTable=e),this},e.prototype.connect=function(e){var t=this,n=this;return n.backend=e||new s.w,new i.x(function(e,r){n.backend.k({_:n._,r:n.r,a:n.a,y:n.y,I:n.f,T:t,S:function(t){e(t,n)},j:function(e){r&&r(e,n)}})})},e.prototype.on=function(e,t){var n=this,r=n.v,o=0;if(!n.b[r])for(n.b[r]={},n.b[r]["*"]=[];o--;)n.b[r][n.h[o]]=[];var i=e.split(" ");for(o=i.length;o--;)n.h.indexOf(i[o])!==-1&&n.b[r][i[o]].push(t);return n},e.prototype.off=function(e){var t=this;for(var n in t.b)for(var r in t.b[n])t.b[n][r]=t.b[n][r].filter(function(t){return t!==e});return t},e.prototype.alwaysApplyFilter=function(e){return this.g.indexOf(e)===-1&&this.g.push(e),this},e.prototype.model=function(e){var t=this,n=t.v,r=t.h.length;if(!t.b[n])for(t.b[n]={},t.b[n]["*"]=[];r--;)t.b[n][t.h[r]]=[];return t._[n]=e,t.a[n]=[],t.r[n]=[],t},e.prototype.views=function(e){return this.a[this.v]=e,this},e.prototype.getView=function(e,t){void 0===t&&(t={});for(var n,r=this,o=r.v,i=r.a[o].length;i--;)r.a[o][i].name===e&&(n=r.a[o][i]);if(!n)throw Error;return r.O=e,n.call.apply(r,[r.R(n.args?n.args:[],t),r])},e.prototype.R=function(e,t){var n=this,r=(n.v,{}),o=e.length?e.length:-1;if(o>0)for(;o--;){var i=e[o].split(":");i.length>1?r[i[0]]=n.P(i[1],t[i[0]]||null):r[i[0]]=t[i[0]]||null}return r},e.prototype.P=function(e,t){var n={string:String(t),int:parseInt(t),float:parseFloat(t),array:o({},t),map:o({},t),bool:t===!0};return n[e]||t},e.prototype.actions=function(e){return this.r[this.v]=e,this},e.prototype.doAction=function(e,t){void 0===t&&(t={});for(var n,r=this,o=r.v,i=r.r[o].length;i--;)r.r[o][i].name===e&&(n=r.r[o][i]);if(!n)throw Error;return r.O=e,n.call.apply(r,[r.R(n.args?n.args:[],t),r])},e.prototype.addFilter=function(e,t){return this.y[e]=t,this},e.prototype.query=function(e,t){this.u=[];var n=e.toLowerCase();if(["select","upsert","delete","drop"].indexOf(n)===-1)throw Error;return this.u.push({type:n,args:t}),this},e.prototype.where=function(e){return this.D("where",e)},e.prototype.orderBy=function(e){return this.D("orderby",e)},e.prototype.join=function(e){return this.D("join",e)},e.prototype.limit=function(e){return this.D("limit",e)},e.prototype.offset=function(e){return this.D("offset",e)},e.prototype.filter=function(e,t){return this.D("filter-"+e,t)},e.prototype.D=function(e,t){return this.u.push({type:e,args:t}),this},e.prototype.triggerEvent=function(e,t){var n=this;setTimeout(function(){for(var r,o,i=t.length,s=0;i--;)for(r=t[i],o=n.b[n.v][r].concat(n.b[n.v]["*"]),s=o.length;s--;)e.name=r,e.actionOrView=n.O||"",o[s](e,n);n.O=void 0},0)},e.prototype.exec=function(){var e=this,t=e.v;return e.q=e.u.map(function(e){switch(e.type){case"select":return[e.type];case"delete":case"upsert":case"drop":return[e.type,"change"];default:return[]}}).reduce(function(e,t){return e.concat(t)}),new i.x(function(n,r){var o=function(n,r,o){e.g.length&&o!==!0&&(n=e.g.reduce(function(t,r,o){return e.y[e.g[o]].apply(e,[n])},n)),e.triggerEvent({name:"error",actionOrView:"",table:t,query:e.u,time:(new Date).getTime(),result:n},e.q),r(n,e)};e.backend.C({Q:t,u:e.u,F:e.O||"",S:function(e){o(e,n,!1)},j:function(t){e.q=["error"],r&&o(t,r,!0)}})})},e.prototype.config=function(e){var t=this;return t.backend||t.f.push(e),t},e.prototype.extend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=this;if(n.backend)return n.backend.A?(e.unshift(n),n.backend.A.apply(n.backend,e)):void 0},e.prototype.loadJS=function(e){var t=this;return new i.x(function(n,r){i.x.chain(e.map(function(e){return t.table(t.v).query("upsert",e).exec()})).then(function(e){n(e,t)})})},e.prototype.loadCSV=function(e){var t=this,n=[];return new i.x(function(r,o){i.x.all(e.split("\n").map(function(e,r){return new i.x(function(o,i){if(0===r)n=e.split(","),o();else{var s={},a=e.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)||[];a=a.map(function(e){return e.replace(/^"(.+(?="$))"$/,"$1")});for(var c=n.length;c--;)0!==a[c].indexOf("{")&&0!==a[c].indexOf("[")||(a[c]=JSON.parse(a[c].replace(/'/g,""))),s[n[c]]=a[c];t.table(t.v).query("upsert",s).exec().then(function(){o()})}})})).then(function(){r([],t)})})},e.uuid=function(){var e,t,n,r=function(){return window&&window.crypto.getRandomValues?(n=new Uint16Array(1),window.crypto.getRandomValues(n),n[0]):Math.round(Math.random()*Math.pow(2,16))},o="";return[o,o,o,o,o,o,o,o,o].reduce(function(n,i,s){for(e=r(),t=4===s?s:5===s?(e%16&3|8).toString(16):o,e=e.toString(16);e.length<4;)e="0"+e;return n+([3,4,5,6].indexOf(s)>=0?"-":o)+(t+e).slice(0,4)},o)},e.B=function(e){return Math.abs(e.split("").reduce(function(t,n,r){return(t<<5)+t+e.charCodeAt(r)},0))},e.prototype.toCSV=function(e){var t=this;return new i.x(function(n,r){t.exec().then(function(r){var o=t.u.filter(function(e){return"select"===e.type}).map(function(e){return e.args?e.args.map(function(e){return t._[t.v].filter(function(t){return t.key===e})[0]}):t._[t.v]})[0];e&&r.unshift(o.map(function(e){return e.key})),n(r.map(function(t,n){return e&&0===n?t:o.filter(function(e){return!!t[e.key]}).map(function(e){switch(e.type){case"map":case"array":return'"'+JSON.stringify(t[e.key]).replace(/"/g,"'")+'"';default:return JSON.stringify(t[e.key])}}).join(",")}).join("\n"),t)})})},e}();t.SomeSQLInstance=a;var c=new a;t.SomeSQL=r},function(e,t,n){"use strict";var r="function",o=function(){function e(e){var t=this;e&&e(function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];t.resolve.apply(t,e)},function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];t.reject.apply(t,e)})}return e.prototype.resolve=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.L(1,e)},e.prototype.reject=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.L(-1,e)},e.prototype.L=function(t,n){var o=this;if(!o.V&&n[0]!==o){if(1===t&&n[0]&&(typeof n[0]===r||"object"==typeof n[0])&&typeof n[0].then===r)return void n[0].then.call(n[0],function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];o.resolve.apply(o,e)},function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];o.reject.apply(o,e)});o.V=t,o.N=n,o.H&&o.H.forEach(function(n){1===t&&e.J(n,o.N),t===-1&&e.M(n,o.N)})}},e.prototype.then=function(t,n){var r=new e,o=this,i={promise:r,successFunc:t,failFunc:n};return o.V?1===o.V?e.J(i,o.N):e.M(i,o.N):o.H?o.H.push(i):o.H=[i],r},e.prototype.catch=function(e){return this.then(function(){},e)},e.all=function(t){var n=[];return new e(function(e,r){t&&t.length?t.forEach(function(r){r.then(function(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];n.push(r),n.length===t.length&&e(n)})}):e([])})},e.chain=function(t){var n=0,r=[];return new e(function(e){var o=function(i){n===t.length?e(r):i.then(function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];r.push(e),n++,o(t[n])})};o(t[n])})},e.race=function(t){return new e(function(e,n){t&&t.length?t.forEach(function(t){t.then(function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];e.apply(t,n)})}):e()})},e.J=function(t,n){e.L(1,t.successFunc,t,n)},e.M=function(t,n){t.failFunc&&e.L(-1,t.failFunc,t,n)},e.L=function(e,t,n,o){if(typeof t===r)try{n.promise.resolve(t.apply(n.promise,o))}catch(e){n.promise.reject(e)}else 1===e&&n.promise.resolve.apply(n.promise,o),e===-1&&n.promise.reject.apply(n.promise,o)},e}();t.x=o},function(e,t,n){var r=this&&this.t||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},o=n(0),i=n(1),s={sum:function(e){return[{sum:e.map(function(e){for(var t in e)return e[t]}).reduce(function(e,t){return e+t},0)}]},min:function(e){return[{min:e.map(function(e){for(var t in e)return e[t]}).sort(function(e,t){return e<t?-1:1})[0]}]},max:function(e){return[{max:e.map(function(e){for(var t in e)return e[t]}).sort(function(e,t){return e>t?-1:1})[0]}]},average:function(e){return[{average:s.sum(e)[0].sum/e.length}]},count:function(e){return[{count:e.length}]}},a=function(){function e(){var e=this;e._={},e.$={},e.z=[],e.G=[[]],e.K=0,e.U={},e.X=[0,0],e.W={},e.Y=[],e.Z={},e.ee=[]}return e.prototype.te=function(e){return this.Y[e][this.ne(e)]},e.prototype.ne=function(e){return this.U[e]},e.prototype.k=function(e){var t,n=this,r=0,i=[],a=!1;n.T=e.T,n.re=!!e.I.length&&(e.I[0].persistent||!1);for(var c in e._){var _=o.SomeSQLInstance.B(c);for(i.push(c),n._[_]=e._[c],n.Z[_]={},n.$[_]={oe:"",ie:c,se:1,ae:[],ce:{}},r=n._[_].length;r--;)t=n._[_][r],t.props&&t.props.indexOf("pk")!==-1&&(n.$[_].oe=t.key)}if(n._e=o.SomeSQLInstance.B(JSON.stringify(e._)),e.y)for(var u in e.y)s[u]=e.y[u];var l=0;if(n.re&&window&&window.indexedDB){var f=window.indexedDB.open(String(n._e),1);f.onupgradeneeded=function(t){a=!0;var r=t.target.result,s=function(){if(l<i.length){var t=o.SomeSQLInstance.B(i[l]),a=n.$[t].oe?{keyPath:n.$[t].oe}:{};r.createObjectStore(i[l],a),l++,s()}else e.S()};s()},f.onsuccess=function(t){if(n.ue=t.target.result,!a){n.isImporting=!0;var r=function(){if(l<i.length){var t=(o.SomeSQLInstance.B(i[l]),n.ue.transaction(i[l],"readonly")),s=t.objectStore(i[l]),a=s.openCursor(),c=[];t.oncomplete=function(){n.T.table(i[l]).loadJS(c).then(function(){l++,r()})},a.onsuccess=function(e){var t=e.target.result;t&&(c.push(t.value),t.continue())}}else n.isImporting=!1,e.S()};r()}}}else e.S()},e.prototype.C=function(e){var t=this;t.z.length?t.z.push(e):(t.v=o.SomeSQLInstance.B(e.Q),new c(t).le(e).then(function(e){t.z.length&&t.C(t.z.pop())}))},e.prototype.fe=function(e){for(var t=this,n=[t.v],r=t.ee.length;r--;)t.ee[r].indexOf(t.v)!==-1&&n.concat(t.ee[r]);t.de(n.sort()).forEach(function(n){t.Z[n]={},e&&t.T.triggerEvent({name:"change",actionOrView:"",table:t.$[n].ie,query:[],time:(new Date).getTime(),result:[]},["change"])})},e.prototype.de=function(e){return e.filter(function(e,t,n){return!t||e!==n[t-1]})},e.prototype.A=function(e,t){var n,r,o,s,a,c=this,_=c.ue.transaction(c.$[c.v].ie,"readwrite").objectStore(c.$[c.v].ie),u=function(e){for(n=c.G[c.K].length;n--;)o=c.G[c.K][n],s=c.te(o)||{},a=s[c.$[c.v].oe],c.U[o]+=e,s=c.te(o),c.ue&&(s?_.put(s):_.delete(a)),c.U[o]<0&&(c.U[o]=0)};return new i.x(function(e,n){if(!c.G.length&&["<",">"].indexOf(t)!==-1)return void e(!1);switch(t){case"<":c.K===c.G.length-1?e(!1):(u(1),c.K++,c.fe(!0),e(!0));break;case">":c.K<1?e(!1):(c.K--,u(-1),c.fe(!0),e(!0));break;case"?":r=[c.G.length-1,c.K],c.X.join("+")!==r.join("+")&&(c.X=r),e(c.X);break;case"clear_db":c.ue&&window.indexedDB.deleteDatabase(String(c._e))}})},e}();t.w=a;var c=function(){function e(e){this.pe=e}return e.prototype.le=function(e){var t=this;return new i.x(function(n,r){t.he=[],t.be=void 0,t.pe.v=o.SomeSQLInstance.B(e.Q),t.ye=o.SomeSQLInstance.B(JSON.stringify(e.u)),i.x.all(e.u.map(function(e){return new i.x(function(n,r){["upsert","select","delete","drop"].indexOf(e.type)!==-1?t.be=e:t.he.push(e),n()})})).then(function(){t.ge(function(r){e.S(r),n(t)})})})},e.prototype.ve=function(){var e=this,t=e.pe.Y.length;return e.pe.Y.push([null]),e.pe.$[e.pe.v].ae.push(t),e.pe.U[t]=0,t},e.prototype.ge=function(e){var t=this;if(t.be){var n,s,a,c,_,u,l,f,d,p,h,b,y,g,v,m=t.pe.$[t.pe.v].oe,w=t.be.args||[],x=0,k=[],I=[],T=t.pe.$[t.pe.v].ae.slice(),S=[],j=t.he.filter(function(e){return"where"===e.type}),O=function(e){return t.he.filter(function(t){return t.type===e}).pop()},R=function(n,r){n>0?(t.pe.K>0&&(t.pe.G=t.pe.G.filter(function(e,n){if(n<t.pe.K){for(a=e.length;a--;)t.pe.U[e[a]]=0,t.pe.Y[e[a]].shift();return!1}return!0}),t.pe.K=0),t.pe.isImporting?(t.pe.G[0]||(t.pe.G[0]=[]),t.pe.G[0]=t.pe.G[0].concat(I)):t.pe.G.unshift(I),t.pe.fe(!1),e([{msg:n+" row(s) "+r}])):e([{msg:"0 rows "+r}])},P=function(e,n){I.push(e);var o=r({},t.pe.te(e)||{});for(var i in w)o[i]=n(i,o[i]);if(t.pe.Y[e].unshift(Object.freeze(o)),t.pe.ue){var s=t.pe.$[t.pe.v].ie;t.pe.ue.transaction(s,"readwrite").objectStore(s).put(o)}};switch("drop"!==t.be.type&&(k=j.length&&!O("join")?t.me(T,j[0].args):T),t.be.type){case"upsert":if(n="updated",s=k.length,j.length&&w[m])throw new Error("Can't use a where statement if you have a non null primary key value!");if(j.length)for(x=s,n="modified";s--;)P(k[s],function(e,t){return e!==m?w[e]:t});else{if(c=0,w[m])t.pe.$[t.pe.v].ce[w[m]]?c=t.pe.$[t.pe.v].ce[w[m]]:(c=t.ve(),n="inserted",t.pe.$[t.pe.v].se=Math.max(w[m]+1,t.pe.$[t.pe.v].se),t.pe.$[t.pe.v].ce[w[m]]=c);else for(n="inserted",_=t.pe._[t.pe.v].length;_--;)if(u=t.pe._[t.pe.v][_],u.props&&u.props.indexOf("pk")!==-1){switch(u.type){case"int":w[m]=t.pe.$[t.pe.v].se++;break;case"uuid":w[m]=o.SomeSQLInstance.uuid()}c=t.ve(),t.pe.$[t.pe.v].ce[w[m]]=c}P(c,function(e,t){return w[e]||t}),x=1}R(x,n);break;case"select":if(t.pe.Z[t.pe.v][t.ye]){e(t.pe.Z[t.pe.v][t.ye]);break}l=["join","orderby","offset","limit"];var D=function(e,n){return new i.x(function(r,i){if(f=O(l[n]),!f)return r(e),!1;switch(n){case 0:t.pe.T.table(f.args.table).query("select").exec().then(function(n,i){if(f){d=f.args.where.map(function(e,t){return e.split(".").map(function(e,n){return 1!==t&&0===n?o.SomeSQLInstance.B(e):e})});var s=t.pe.$[d[2][0]];n=n.map(function(e){return s.ce[e[s.oe]]}).filter(function(e){return e}),e=t.we(f.args.type,e,n,d),j.length&&(e=t.me(e,j[0].args)),r(e)}});break;case 1:r(e.sort(function(e,n){if(f){p=[];for(var r in f.args)p.push(r);return p.reduce(function(r,o,i){if(f)return h=p[i],b=t.pe.te(e)||{},y=t.pe.te(n)||{},(b[h]>y[h]?1:-1)*("asc"===f.args[h]?1:-1)+r},0)}}));break;case 2:r(e.filter(function(e,t){return!f||t>=f.args}));break;case 3:r(e.filter(function(e,t){return!f||t<f.args}))}})};s=l.length;var q=function(n){s>-1?(s--,D(n,s).then(function(e){q(e)})):(n.forEach(function(e){if(w.length)if(a=w.length,g=t.pe.te(e))for(v={};a--&&v&&g;)v[w[a]]=g[w[a]];else v=null;else v=t.pe.te(e);v&&S.push(v)}),S=t.xe(S),t.pe.Z[t.pe.v][t.ye]=S,e(t.pe.Z[t.pe.v][t.ye]))};q(k);break;case"drop":case"delete":var C=[];C=k.length&&"delete"===t.be.type?k:T,n="deleted",s=C.length;for(var E=t.pe.$[t.pe.v].ie;s--;)if(w.length)P(C[s],function(e,t){return w.indexOf(e)!==-1?null:t}),n="modified";else{var Q=(t.pe.te(C[s])||{})[t.pe.$[t.pe.v].oe];t.pe.ue&&Q&&t.pe.ue.transaction(E,"readwrite").objectStore(E).delete(Q),t.pe.Y[C[s]].unshift(null),I.push(C[s])}R(C.length,n)}}},e.prototype.ke=function(e,t){var n,r=this;return e.filter(function(e){return n=r.pe.te(e),!!n&&0===r.Ie(t[2],t[1],n[t[0]])})},e.prototype.me=function(e,t){var n,r=this,o=["and","or"],i=function(e,t){return r.pe.de(e[0].concat(e[1]).sort().filter(function(e,n,r){return"and"!==t||n!==r.lastIndexOf(e)}))};return"string"==typeof t[0]?r.ke(e,t):t.map(function(t){return o.indexOf(t)!==-1?t:r.ke(e,t)}).reduce(function(e,t,r){return o.indexOf(t)===-1?0===r?t:i([e,t],n):(n=t,e)})},e.prototype.we=function(e,t,n,r){var o,i,s,a,c,_,u=this,l=[],f=[],d=[r[0][0],r[2][0]],p=[u.pe.$[r[0][0]].ie,u.pe.$[r[2][0]].ie],h=[u.pe._[r[0][0]],u.pe._[r[2][0]]],b={},y=[],g=[],v=t.length;for(v=u.pe.ee.length,a=0;v--&&!a;)u.pe.ee[v].indexOf(d[0])!==-1&&u.pe.ee[v].indexOf(d[1])!==-1&&(a=1);a||u.pe.ee.push(d);var m=function(e,t){return o=e.join("+"),i=!1,_=e.map(function(e){return u.pe.ne(e)}),u.pe.W[o]||(i=!0,u.pe.W[o]={Te:0,Se:_}),(i||_.join("+")!==u.pe.W[o].Se.join("+"))&&(b={},h.forEach(function(n,r){s=e[r]===-1||t[r]===!1,n.forEach(function(e){b[p[r]+"."+e.key]=s?null:t[r][e.key]})}),i&&(u.pe.W[o].Te=u.ve()),u.pe.Y[u.pe.W[o].Te].unshift(b)),u.pe.W[o].Te};for(v=t.length;v--;){for(a=n.length,l[0]=u.pe.te(t[v])||{},y=[];a--;)l[1]=u.pe.te(n[a])||{},u.Ie(l[0][r[0][1]],r[1][0],l[1][r[2][1]])&&"cross"!==e||(y.push([n[a],l[1]]),g.push(n[a]));if(c=y.length)for(;c--;)f.push(m([t[v],y[c][0]],[l[0],y[c][1]]));else"left"===e&&f.push(m([t[v],-1],[l[0],!1]))}if("right"===e)for(v=n.length;v--;)g.indexOf(n[v])===-1&&f.push(m([-1,n[v]],[!1,u.pe.te(n[v])||{}]));return f.reverse()},e.prototype.Ie=function(e,t,n){switch(t){case"=":return n===e?0:1;case">":return n>e?0:1;case"<":return n<e?0:1;case"<=":return n<=e?0:1;case">=":return n>=e?0:1;case"IN":return e.indexOf(n)===-1?1:0;case"NOT IN":return e.indexOf(n)===-1?0:1;case"REGEX":case"LIKE":return n.search(e)===-1?1:0;default:return 0}},e.prototype.xe=function(e){var t=this,n=t.he.filter(function(e){return 0===e.type.indexOf("filter-")});return n.length?n.reduce(function(e,r,o){return s[n[o].type.replace("filter-","")].apply(t,[e,n[o].args])},e):e},e}()},function(e,t,n){e.exports=n(0)}])});
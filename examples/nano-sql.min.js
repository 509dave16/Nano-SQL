!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=3)}([function(e,t,n){var r=n(2),o=n(1);t._assign=function(e){return JSON.parse(JSON.stringify(e))};var i=function(){function e(){var e=this;e._actions={},e._views={},e._models={},e._query=[],e._preConnectExtend=[],e._events=["change","delete","upsert","drop","select","error"],e._callbacks={},e._hasEvents={},e._callbacks["*"]={};for(var t=e._events.length;t--;)e._callbacks["*"][e._events[t]]=[];e._functions={},e._rowFilters={}}return e.prototype.table=function(e){return e&&(this._selectedTable=e,this.activeTable=e),this},e.prototype.connect=function(e){var t=this,n=this;return n.backend?new o.Promise(function(e,t){throw t(),Error()}):(n.backend=e||new r._NanoSQLImmuDB,new o.Promise(function(e,r){n.backend._connect({_models:n._models,_actions:n._actions,_views:n._views,_functions:n._functions,_config:n._preConnectExtend,_parent:t,_onSuccess:function(t){e(t,n)},_onFail:function(e){r&&r(e,n)}})}))},e.prototype.on=function(e,t){var n=this,r=n._selectedTable,o=0,i=e.split(" ");if(!n._callbacks[r])for(n._callbacks[r]={},n._callbacks[r]["*"]=[];o--;)n._callbacks[r][n._events[o]]=[];for(o=i.length;o--;)n._events.indexOf(i[o])!==-1&&n._callbacks[r][i[o]].push(t);return n._refreshEventChecker(),n},e.prototype.off=function(e){var t=this;for(var n in t._callbacks)for(var r in t._callbacks[n])t._callbacks[n][r]=t._callbacks[n][r].filter(function(t){return t!==e});return t._refreshEventChecker(),t},e.prototype._refreshEventChecker=function(){var e=this;this._hasEvents={},Object.keys(this._models).concat(["*"]).forEach(function(t){e._hasEvents[t]=e._events.reduce(function(n,r){return n+(e._callbacks[t]?e._callbacks[t][r].length:0)},0)>0})},e.prototype.model=function(e){var t=this,n=t._selectedTable,r=t._events.length;if(!t._callbacks[n])for(t._callbacks[n]={},t._callbacks[n]["*"]=[];r--;)t._callbacks[n][t._events[r]]=[];return t._models[n]=e,t._views[n]=[],t._actions[n]=[],t},e.prototype.views=function(e){return this._views[this._selectedTable]=e,this},e.prototype.getView=function(e,t){void 0===t&&(t={});for(var n,r=this,o=r._selectedTable,i=r._views[o].length;i--;)r._views[o][i].name===e&&(n=r._views[o][i]);if(!n)throw Error;return r._activeActionOrView=e,n.call.apply(r,[r._cleanArgs(n.args?n.args:[],t),r])},e.prototype._cleanArgs=function(e,t){var n=this,r=(n._selectedTable,{}),o=e.length?e.length:-1;if(o>0)for(;o--;){var i=e[o].split(":");i.length>1?r[i[0]]=n._cast(i[1],t[i[0]]||null):r[i[0]]=t[i[0]]||null}return r},e.prototype._cast=function(e,n){var r=typeof n;return{string:"string"!==r?String(n||""):n,int:"number"!==r||n%1!=0?parseInt(n||0):n,float:"number"!==r?parseFloat(n||0):n,array:Array.isArray(n)?t._assign(n||[]):[],map:"object"===r?t._assign(n||{}):{},bool:n===!0}[e]||n},e.prototype.actions=function(e){return this._actions[this._selectedTable]=e,this},e.prototype.doAction=function(e,t){void 0===t&&(t={});for(var n,r=this,o=r._selectedTable,i=r._actions[o].length;i--;)r._actions[o][i].name===e&&(n=r._actions[o][i]);if(!n)throw Error;return r._activeActionOrView=e,n.call.apply(r,[r._cleanArgs(n.args?n.args:[],t),r])},e.prototype.newFunction=function(e,t,n){return this._functions[e]={type:t,call:n},this},e.prototype.query=function(e,t){var n=this;this._query=[];var r=e.toLowerCase();if(["select","upsert","delete","drop","show tables","describe"].indexOf(r)===-1)throw Error;var o=t||("select"===r||"delete"===r?[]:{});if("upsert"===e){var i={};this._models[this._selectedTable].forEach(function(e){o[e.key]&&(i[e.key]=n._cast(e.type,o[e.key]))}),this._rowFilters[this._selectedTable]&&(i=this._rowFilters[this._selectedTable](i)),o=i}return this._query.push({type:r,args:o}),this},e.prototype.where=function(e){return this._addCmd("where",e)},e.prototype.orderBy=function(e){return this._addCmd("orderby",e)},e.prototype.groupBy=function(e){return this._addCmd("groupby",e)},e.prototype.having=function(e){return this._addCmd("having",e)},e.prototype.join=function(e){return this._addCmd("join",e)},e.prototype.limit=function(e){return this._addCmd("limit",e)},e.prototype.offset=function(e){return this._addCmd("offset",e)},e.prototype._addCmd=function(e,t){return this._query.push({type:e,args:t}),this},e.prototype.triggerEvent=function(e,t){var n=this;setTimeout(function(){for(var r,o,i=t.length,a=0;i--;)for(r=t[i],o=n._callbacks[n._selectedTable][r].concat(n._callbacks[n._selectedTable]["*"]),a=o.length;a--;)e.name=r,e.actionOrView=n._activeActionOrView||"",o[a](e,n);n._activeActionOrView=void 0},0)},e.prototype.default=function(e){var t={},n=this;return n._models[n._selectedTable].forEach(function(r){t[r.key]=e&&e[r.key]?e[r.key]:r.default,t[r.key]||(t[r.key]=n._cast(r.type,null))}),t},e.prototype.beginTransaction=function(){if(this.backend._transaction)return this.backend._transaction("start")},e.prototype.endTransaction=function(){if(this.backend._transaction)return this.backend._transaction("end")},e.prototype.exec=function(){var e=this,t=e._selectedTable;return e._hasEvents[t]&&(e._triggerEvents=e._query.map(function(e){switch(e.type){case"select":return[e.type];case"delete":case"upsert":case"drop":return[e.type,"change"];default:return[]}}).reduce(function(e,t){return e.concat(t)})),new o.Promise(function(n,r){if(!e.backend)throw r(),Error;var o=function(n,r,o,i,a){e._hasEvents[t]&&e.triggerEvent({name:"error",actionOrView:"",table:t,query:e._query,time:(new Date).getTime(),result:n,changeType:o,changedRows:i},e._triggerEvents),r(n,e)};e.backend._exec({_table:t,_query:e._query,_viewOrAction:e._activeActionOrView||"",_onSuccess:function(e,t,r){o(e,n,t,r,!1)},_onFail:function(t){e._triggerEvents=["error"],r&&o(t,r,"error",[],!0)}})})},e.prototype.config=function(e){var t=this;return t.backend||t._preConnectExtend.push(e),t},e.prototype.extend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=this;if(n.backend)return n.backend._extend?(e.unshift(n),n.backend._extend.apply(n.backend,e)):void 0},e.prototype.loadJS=function(e){var t=this;return t.beginTransaction(),new o.Promise(function(n,r){var o=0,i=[],a=function(){o<e.length?e[o]?t.table(t._selectedTable).query("upsert",e[o]).exec().then(function(e){i.push(e),o++,a()}):(o++,a()):(t.endTransaction(),n(i,t))};a()})},e.prototype.rowFilter=function(e){return this._rowFilters[this._selectedTable]=e,this},e.prototype.loadCSV=function(e){var t=this,n=[];return t.beginTransaction(),new o.Promise(function(r,i){o.Promise.all(e.split("\n").map(function(e,r){return new o.Promise(function(o,i){if(0===r)n=e.split(","),o();else{var a={},s=e.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)||[];s=s.map(function(e){return e.replace(/^"(.+(?="$))"$/,"$1")});for(var _=n.length;_--;)0!==s[_].indexOf("{")&&0!==s[_].indexOf("[")||(s[_]=JSON.parse(s[_].replace(/'/g,""))),a[n[_]]=s[_];t.table(t._selectedTable).query("upsert",a).exec().then(function(){o()})}})})).then(function(){t.endTransaction(),r([],t)})})},e.uuid=function(){var e,t,n,r=function(){return"undefined"==typeof crypto?Math.round(Math.random()*Math.pow(2,16)):crypto.getRandomValues?(n=new Uint16Array(1),crypto.getRandomValues(n),n[0]):crypto.randomBytes?crypto.randomBytes(2).reduce(function(e,t){return t*e}):Math.round(Math.random()*Math.pow(2,16))},o="";return[o,o,o,o,o,o,o,o,o].reduce(function(n,i,a){for(e=r(),t=4===a?a:5===a?(e%16&3|8).toString(16):o,e=e.toString(16);e.length<4;)e="0"+e;return n+([3,4,5,6].indexOf(a)>=0?"-":o)+(t+e).slice(0,4)},o)},e._hash=function(e){return Math.abs(e.split("").reduce(function(t,n,r){return(t<<5)+t+e.charCodeAt(r)},0))},e.prototype.toCSV=function(e){var t=this;return new o.Promise(function(n,r){t.exec().then(function(r){var o=t._query.filter(function(e){return"select"===e.type}).map(function(e){return e.args.length?e.args.map(function(e){return t._models[t._selectedTable].filter(function(t){return t.key===e})[0]}):t._models[t._selectedTable]})[0];e&&r.unshift(o.map(function(e){return e.key})),n(r.map(function(t,n){return e&&0===n?t:o.filter(function(e){return!!t[e.key]}).map(function(e){switch(e.type){case"map":case"array":return'"'+JSON.stringify(t[e.key]).replace(/"/g,"'")+'"';default:return t[e.key]}}).join(",")}).join("\n"),t)})})},e}();t.NanoSQLInstance=i;var a=new i;t.nSQL=function(e){return a.table(e)}},function(e,t,n){"use strict";function r(e,t,n){setTimeout(function(){var r;try{r=t.apply(null,n)}catch(t){return d._reject(e,t)}return r===e?d._reject(e,new TypeError):d._resolve(e,r),null})}function o(e){var t=e&&e.then;return!e||"object"!=typeof e&&"function"!=typeof e||"function"!=typeof t?null:function(){t.apply(e,arguments)}}function i(e,t){function n(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];i||(i=!0,d._reject(e,t))}function r(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];i||(i=!0,d._resolve(e,t))}function o(){t(r,n)}var i=!1,s=a(o);"error"===s._status&&n(s._value)}function a(e,t){var n={_status:null,_value:null};try{n._value=e(t),n._status="success"}catch(e){n._status="error",n._value=e}return n}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){},_=["R"],c=["F"],u=["P"],l=function(){function e(e){this._state=u,this._queue=[],this._outcome=void 0,e!==s&&i(this,e)}return e.prototype.catch=function(e){return this.then(function(){},e)},e.prototype.then=function(t,n){if("function"!=typeof t&&this._state===c||"function"!=typeof n&&this._state===_)return this;var o=new e(s);if(this._state!==u){r(o,this._state===c?t:n,this._outcome)}else this._queue.push(new f(o,t,n));return o},e.resolve=function(t){return t instanceof this?t:d._resolve(new e(s),t)},e.reject=function(t){return d._reject(new e(s),t)},e.all=function(t){function n(e,t){function n(e){a[t]=e,++_!==o||i||(i=!0,d._resolve(u,a))}r.resolve(e).then(n,function(e){i||(i=!0,d._reject(u,e))})}var r=this,o=t.length,i=!1,a=new Array(o),_=0,c=-1,u=new e(s);if(!o)return this.resolve([]);for(;++c<o;)n(t[c],c);return u},e.race=function(t){function n(e){r.resolve(e).then(function(e){i||(i=!0,d._resolve(_,e))},function(e){i||(i=!0,d._reject(_,e))})}var r=this,o=t.length,i=!1,a=-1,_=new e(s);if(Array.isArray(t)!==!1)return this.reject(new TypeError);if(!o)return this.resolve([]);for(;++a<o;)n(t[a]);return _},e}();t.Promise=l;var f=function(){function e(e,t,n){this._promise=e,"function"==typeof t&&(this._onFulfilled=t,this._callFulfilled=this._otherCallFulfilled),"function"==typeof n&&(this._onRejected=n,this._callRejected=this._otherCallRejected)}return e.prototype._callFulfilled=function(e){d._resolve(this._promise,e)},e.prototype._otherCallFulfilled=function(e){r(this._promise,this._onFulfilled,e)},e.prototype._callRejected=function(e){d._reject(this._promise,e)},e.prototype._otherCallRejected=function(e){r(this._promise,this._onRejected,e)},e}();t._QueueItem=f;var d=function(){function e(){}return e._resolve=function(t,n){var r=a(o,n),s=r._value,_=-1,u=t._queue.length;if("error"===r._status)return e._reject(t,r._value);if(s)i(t,s);else for(t._state=c,t._outcome=n;++_<u;)t._queue[_]._callFulfilled(n);return t},e._reject=function(e,t){e._state=_,e._outcome=t;for(var n=-1,r=e._queue.length;++n<r;)e._queue[n]._callRejected(t);return e},e}()},function(e,t,n){var r=n(0),o=n(1),i=function(e,t,n,o,i){var a=n[0];0===o[0]&&(i[a]=e===-1?Number.MAX_VALUE:Number.MIN_VALUE);var s={};if(s=(e===-1?parseFloat(t[a])<parseFloat(i[a]):parseFloat(t[a])>parseFloat(i[a]))?t:i,o[0]===o[1]){var _=r._assign(s);return _[e===-1?"MIN":"MAX"]=s[a],_}return s},a={SUM:{type:"aggregate",call:function(e,t,n,o){if(0===n[0]&&(o=0),o+=parseInt(e[t[0]]),n[0]===n[1]){var i=r._assign(e);return i.SUM=o,i}return o}},MIN:{type:"aggregate",call:function(e,t,n,r){return i(-1,e,t,n,r)}},MAX:{type:"aggregate",call:function(e,t,n,r){return i(1,e,t,n,r)}},AVG:{type:"aggregate",call:function(e,t,n,o){if(0===n[0]&&(o=0),o+=parseInt(e[t[0]]),n[0]===n[1]){var i=r._assign(e);return i.AVG=o/(n[1]+1)||o,i}return o}},COUNT:{type:"aggregate",call:function(e,t,n,o){if(0===n[0]&&(o=0),"*"===t[0]?o++:o+=e[t[0]]?1:0,n[0]===n[1]){var i=r._assign(e);return i.COUNT=o,i}return o}}},s=function(){function e(){var e=this;e._pendingQuerys=[],e._queryCache={}}return e.prototype._connect=function(e){var t=this;t._databaseID=r.NanoSQLInstance._hash(JSON.stringify(e._models)),t._parent=e._parent,t._store=new _(t,e)},e.prototype._exec=function(e){var t=this;t._pendingQuerys.length?t._pendingQuerys.push(e):(t._selectedTable=r.NanoSQLInstance._hash(e._table),new c(t)._doQuery(e,function(e){t._pendingQuerys.length&&t._exec(t._pendingQuerys.pop())}))},e.prototype._invalidateCache=function(e,t,n,r){var o=this;o._queryCache[o._selectedTable]={},t.length&&r&&o._parent.triggerEvent({name:"change",actionOrView:"",table:o._store._tables[e]._name,query:[],time:(new Date).getTime(),result:[{msg:r+" was performed.",type:r}],changedRows:t,changeType:n},["change"])},e.prototype._deepFreeze=function(e){if(!e)return e;var t=this;return t._store._models[t._selectedTable].forEach(function(n){var r=e[n.key];["map","array"].indexOf(typeof r)>=0&&(e[n.key]=t._deepFreeze(r))}),Object.freeze(e)},e.prototype._transaction=function(e){return"start"===e&&(this._store._doingTransaction=!0),"end"===e&&(this._store._doingTransaction=!1),!!this._store._doingTransaction},e.prototype._extend=function(e,t){var n,i,a,s,_=this,c=function(e,t){var o={},i=_._store._historyLength-_._store._historyPoint;_._store._read("_historyPoints",function(e){return e.historyPoint===i},function(i){a=0;var c=function(){if(a<i.length){n=0;var u=i[a].tableID,l=_._store._tables[u],f=[],d=function(){n<i[a].rowKeys.length?(s=i[a].rowKeys[n],"int"===l._pkType&&(s=parseInt(s)),_._store._read(l._name,s,function(t){e>0&&f.push(t[0]),_._store._read("_"+l._name+"_hist__meta",s,function(t){t=r._assign(t),t[0]._pointer+=e;var c=t[0]._historyDataRowIDs[t[0]._pointer];_._store._upsert("_"+l._name+"_hist__meta",s,t[0],function(){_._store._read("_"+l._name+"_hist__data",c,function(t){var c=t[0]?r._assign(t[0]):null;_._store._upsert(l._name,s,c,function(){e<0&&f.push(c),o[u]||(o[u]={type:i[a].type,rows:[]}),o[u].rows=o[u].rows.concat(f),n++,d()})})})})})):(a++,c())};d()}else t(o)};c()})};return new o.Promise(function(e,n){switch(t){case"<":_._store._historyLength&&_._store._historyPoint!==_._store._historyLength?c(1,function(t){_._store._historyPoint++,_._store._utility("w","historyPoint",_._store._historyPoint),Object.keys(t).forEach(function(e){var n=t[e].type;switch(n){case"inserted":n="deleted";break;case"deleted":n="inserted"}_._invalidateCache(parseInt(e),t[e].rows,n,"undo")}),e(!0)}):e(!1);break;case">":!_._store._historyLength||_._store._historyPoint<1?e(!1):(_._store._historyPoint--,_._store._utility("w","historyPoint",_._store._historyPoint),c(-1,function(t){Object.keys(t).forEach(function(e){_._invalidateCache(parseInt(e),t[e].rows,t[e].type,"redo")}),e(!0)}));break;case"?":i=[_._store._historyLength,_._store._historyLength-_._store._historyPoint],_._store._historyArray.join("+")!==i.join("+")&&(_._store._historyArray=i),e(_._store._historyArray);break;case"flush_db":Object.keys(_._store._tables).forEach(function(e){var t=_._store._tables[parseInt(e)]._rows;_._invalidateCache(parseInt(e),Object.keys(t).map(function(e){return t[e]}),"remove","clear")}),_._store._clearAll(e);break;case"flush_history":_._store._clearHistory(e)}})},e}();t._NanoSQLImmuDB=s;var _=function(){function e(e,t){this._savedArgs=t,this.init(e,t)}return e.prototype.init=function(e,t){var n=this;n._models={},n._tables={},n._levelDBs={},n._historyPoint=0,n._historyLength=0,n._historyArray=[0,0],n._doingTransaction=!1,n._doHistory=!0,n._storeMemory=!0,n._persistent=!1,n._utilityTable={},n._mode=0,n._parent=e;t._config.length&&(n._persistent=void 0!==t._config[0].persistent&&t._config[0].persistent,n._doHistory=void 0===t._config[0].history||t._config[0].history,n._storeMemory=void 0===t._config[0].memory||t._config[0].memory,t._config[0].size||5,n._mode={IDB:1,LS:2,LVL:4}[t._config[0].mode]||0);var o=!1,i=0,s=!0;Object.keys(t._models).forEach(function(e){t._models["_"+e+"_hist__data"]=r._assign(t._models[e]),t._models["_"+e+"_hist__data"]=t._models["_"+e+"_hist__data"].map(function(e){return delete e.props,e}),t._models["_"+e+"_hist__meta"]=[{key:"id",type:"int",props:["ai","pk"]},{key:"_pointer",type:"int"},{key:"_historyDataRowIDs",type:"array"}]}),t._models._utility=[{key:"key",type:"string",props:["pk"]},{key:"value",type:"blob"}],t._models._historyPoints=[{key:"id",type:"int",props:["ai","pk"]},{key:"tableID",type:"int"},{key:"historyPoint",type:"int"},{key:"rowKeys",type:"array"},{key:"type",type:"string"}];var _,c,u=Object.keys(t._models),l=n._parent._selectedTable;Object.keys(t._models).forEach(function(e){n._newTable(e,t._models[e])}),Object.keys(t._functions||[]).forEach(function(e){a[e]=t._functions[e]});var f=function(){var e=Object.keys(t._models),o=0;if(n._mode=c,_&&n._read("_utility","all",function(e){e.forEach(function(e){n._utility("w",e.key,e.value),"historyPoint"===e.key&&(n._historyPoint=e.value||0),"historyLength"===e.key&&(n._historyLength=e.value||0)})}),s){var i=function(){o<e.length?e[o].indexOf("_hist__data")!==-1?(n._parent._selectedTable=r.NanoSQLInstance._hash(e[o]),n._upsert(e[o],0,null,function(){o++,i()})):(o++,i()):(n._doHistory=_,n._parent._selectedTable=l,t._onSuccess())};i()}else n._doHistory=_,n._parent._selectedTable=l,t._onSuccess()};if(c=n._mode,n._persistent)if(0!==n._mode)switch(n._mode){case 1:"undefined"==typeof indexedDB&&(n._mode=0);break;case 2:"undefined"==typeof localStorage&&(n._mode=0);break;case 3:n._mode=0;break;case 4:"undefined"!=typeof window&&(n._mode=0)}else"undefined"!=typeof window?("undefined"!=typeof localStorage&&(n._mode=2),"undefined"!=typeof indexedDB&&(n._mode=1)):n._mode=4;else n._mode=0,f();switch(_=n._doHistory,c=n._mode,n._mode=0,n._doHistory=!1,c){case 1:var d=indexedDB.open(String(n._parent._databaseID),1);d.onupgradeneeded=function(e){o=!0;var t=e.target.result,a=e.target.transaction;n._indexedDB=t;var s=function(){if(i<u.length){var e=r.NanoSQLInstance._hash(u[i]),o=n._tables[e]._pk?{keyPath:n._tables[e]._pk}:{};t.createObjectStore(n._tables[e]._name,o),i++,s()}else a.oncomplete=function(){f()}};s()},d.onsuccess=function(e){if(n._indexedDB=e.target.result,!o){s=!1;var t=function(){if(i>=u.length)return void f();if(!_&&(u[i].indexOf("_hist__data")!==-1||u[i].indexOf("_hist__meta")!==-1))return i++,void t();if(i<u.length){var e=r.NanoSQLInstance._hash(u[i]),o=n._indexedDB.transaction(u[i],"readonly"),a=o.objectStore(u[i]),s=a.openCursor(),c=[];o.oncomplete=function(){n._storeMemory?u[i].indexOf("_hist__data")!==-1?(n._tables[e]._index.push("0"),n._tables[e]._rows[0]=null,n._tables[e]._incriment++,n._parent._parent.table(u[i]).loadJS(c).then(function(){i++,t()})):n._parent._parent.table(u[i]).loadJS(c).then(function(){i++,t()}):(n._tables[e]._index=c,n._tables[e]._incriment=c.reduce(function(e,t){return Math.max(parseInt(t),e)},0)+1,i++,t())},s.onsuccess=function(e){var t=e.target.result;t&&(c.push(n._storeMemory?t.value:t.key),t.continue())}}};t()}};break;case 2:if(localStorage.getItem("dbID")!==String(n._parent._databaseID))localStorage.clear(),localStorage.setItem("dbID",String(n._parent._databaseID)),u.forEach(function(e){r.NanoSQLInstance._hash(e);localStorage.setItem(e,JSON.stringify([]))}),f();else if(s=!1,u.forEach(function(e){var t=r.NanoSQLInstance._hash(e),o=JSON.parse(localStorage.getItem(e)||"[]");n._tables[t]._index=o,n._storeMemory||(n._tables[t]._incriment=o.reduce(function(e,t){return Math.max(parseInt(t),e)},0)+1)}),n._storeMemory){var p=0,h=function(){if(p<u.length){var e=[];if(!_&&(u[p].indexOf("_hist__data")!==-1||u[i].indexOf("_hist__meta")!==-1))return p++,void h();JSON.parse(localStorage.getItem(u[p])||"[]").forEach(function(t){e.push(JSON.parse(localStorage.getItem(u[p]+"-"+t)||""))}),n._parent._parent.table(u[p]).loadJS(e).then(function(){p++,h()})}else f()};h()}else f()}},e.prototype._clearHistory=function(e){var t=this,n=Object.keys(t._tables),r=0;!function(){r<n.length?(n[r].indexOf("_hist__meta"),n[r].indexOf("_hist__data"),n[r]):e()}()},e.prototype._delete=function(e,t,n){var o=this,i=r.NanoSQLInstance._hash(e);if(o._tables[i]._index.splice(o._tables[i]._index.indexOf(String(t)),1),o._storeMemory&&(delete o._tables[i]._rows[t],0===o._mode&&n))return n(!0);switch(o._mode){case 1:o._indexedDB.transaction(e,"readwrite").objectStore(e).delete(t),n&&n(!0);break;case 2:localStorage.removeItem(e+"-"+String(t)),localStorage.setItem(e,JSON.stringify(o._tables[i]._index)),n&&n(!0)}},e.prototype._upsert=function(e,t,n,o){var i=this,a=r.NanoSQLInstance._hash(e);void 0!==t&&null!==t||(i._models[a].forEach(function(e){e.props&&e.props.indexOf("pk")!==-1&&(t="uuid"===e.type?r.NanoSQLInstance.uuid():i._tables[a]._incriment++)}),t||(t=parseInt(i._tables[a]._index[i._tables[a]._index.length-1]||"0")+1)),"int"===i._tables[a]._pkType&&(t=parseInt(t));var s=i._tables[a]._pk;if(s&&s.length&&n&&!n[s]&&(n[s]=t),i._tables[a]&&i._tables[a]._index.indexOf(String(t))===-1&&i._tables[a]._index.push(String(t)),i._storeMemory&&i._tables[a]&&(i._tables[a]._rows[t]=i._parent._deepFreeze(n),0===i._mode&&o))return o(t);switch(i._mode){case 1:var _=i._indexedDB.transaction(e,"readwrite"),c=_.objectStore(e);s.length&&n?c.put(n):e.indexOf("_hist__data")!==-1?c.put(n,t):(n&&c.put(n),n||c.delete(t)),_.oncomplete=function(){o&&o(t)};break;case 2:localStorage.setItem(e+"-"+String(t),n?JSON.stringify(n):""),localStorage.setItem(e,JSON.stringify(i._tables[a]._index)),o&&o(t)}},e.prototype._read=function(e,t,n){var o=this,i=r.NanoSQLInstance._hash(e);if(o._storeMemory&&o._tables[i]){var a=o._tables[i]._rows;if("all"===t||"function"==typeof t){var s=Object.keys(a).map(function(e){return a[e]});n("all"===t?s.filter(function(e){return e}):s.filter(function(e){return t(e)}))}else n([a[t]].filter(function(e){return e}))}else switch(o._mode){case 1:var _=o._indexedDB.transaction(e,"readonly"),c=_.objectStore(e);if("all"===t||"function"==typeof t){var u=c.openCursor(),l=[];_.oncomplete=function(){n(l)},u.onsuccess=function(e){var n=e.target.result;n&&("all"!==t?t(n.value)&&l.push(n.value):l.push(n.value),n.continue())}}else{var f=c.get(t);f.onsuccess=function(e){n([f.result])}}break;case 2:if("all"===t||"function"==typeof t){var d=o._tables[i]._index.map(function(t){var n=localStorage.getItem(e+"-"+t);return n&&n.length?JSON.parse(n):null});n("all"!==t?d.filter(function(e){return t(e)}):d)}else{var p=localStorage.getItem(e+"-"+t);n([p&&p.length?JSON.parse(p):null])}}},e.prototype._clearAll=function(e){var t=this;switch(t._savedArgs._onSuccess=e,t._savedArgs._onFail=function(){},t._mode){case 0:t.init(t._parent,t._savedArgs);break;case 1:indexedDB.deleteDatabase(String(t._parent._databaseID)).onsuccess=function(){t.init(t._parent,t._savedArgs)};break;case 2:localStorage.clear(),t.init(t._parent,t._savedArgs)}e&&e(!0)},e.prototype._utility=function(e,t,n){return"r"===e?this._utilityTable[t]?this._utilityTable[t].value:null:(this._upsert("_utility",t,{key:t,value:n}),this._utility[t]={key:t,value:n},n)},e.prototype._getTable=function(){return this._tables[this._parent._selectedTable]},e.prototype._newTable=function(e,t){var n=this,o=r.NanoSQLInstance._hash(e);n._models[o]=t,n._parent._queryCache[o]={},n._tables[o]={_pk:"",_pkType:"",_keys:[],_defaults:[],_name:e,_incriment:1,_index:[],_rows:{}};for(var i=n._models[o].length;i--;){var a=n._models[o][i];n._tables[o]._keys.unshift(a.key),n._tables[o]._defaults[i]=a.default,a.props&&a.props.indexOf("pk")>=0&&(n._tables[o]._pk=a.key,n._tables[o]._pkType=a.type)}return e},e.prototype._safari=function(){return"undefined"!=typeof navigator&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent)},e.prototype._iOS=function(){var e=["iPad","iPhone","iPod"];if("undefined"!=typeof navigator&&navigator.platform)for(;e.length;)if(navigator.platform.indexOf(e.pop())!==-1)return!0;return!1},e}();t._NanoSQL_Storage=_;var c=function(){function e(e){this._db=e}return e.prototype._doQuery=function(e,t){var n=this,o=this;o._mod=[],o._act=void 0;var i=[];if(e._query.forEach(function(t){["upsert","select","delete","drop"].indexOf(t.type)>=0?(o._act=t,"select"===t.type&&(o._queryHash=r.NanoSQLInstance._hash(JSON.stringify(e._query)))):["show tables","describe"].indexOf(t.type)>=0?i.push(t):o._mod.push(t)}),i.length)switch(i[0].type){case"show tables":t(),e._onSuccess([{tables:Object.keys(this._db._store._tables).map(function(e){return n._db._store._tables[e]._name})}],"info",[]);break;case"describe":var a,s=this._db._selectedTable,_={};Object.keys(this._db._store._tables).forEach(function(e){parseInt(e)===n._db._selectedTable&&(a=r._assign(n._db._store._models[e]),s=n._db._store._tables[e]._name)}),_[s]=a,t(),e._onSuccess([_],"info",[])}else o._execQuery(function(n,r,i){e._onSuccess(n,r,i),t(o)})},e.prototype._getMod=function(e){return this._mod.filter(function(t){return t.type===e}).pop()},e.prototype._execQuery=function(e){var t=this,n=this;if(n._act){var r=function(r){if(n._act)switch(n._act.type){case"upsert":t._upsert(r,e);break;case"select":t._select(r,e);break;case"drop":case"delete":t._remove(r,e)}},o=this._db._store._tables[n._db._selectedTable]._name;n._getMod("join")||"drop"===n._act.type?r([]):n._getMod("where")?n._db._store._read(o,function(e){return e&&n._where(e,n._getMod("where").args)},function(e){r(e)}):n._act&&"upsert"!==n._act.type?n._db._store._read(o,"all",function(e){r(e)}):r([])}},e.prototype._updateRow=function(e,t){var n=this,o=n._db._store._getTable()._name;n._db._store._read(o,e,function(i){var a={},s=i[0]||{},_=n._act.args,c=function(){return n._act&&"delete"===n._act.type&&!_.length?"drop":n._act?n._act.type:""}(),u=!1;switch(c){case"upsert":a=s?r._assign(s):{},Object.keys(_).forEach(function(e){a[e]=_[e]}),n._db._store._getTable()._keys.forEach(function(e,t){var r=n._db._store._getTable()._defaults[t];!a[e]&&r&&(a[e]=r)});break;case"delete":a=s?r._assign(s):{},_&&_.length?_.forEach(function(e){a[e]=null}):(u=!0,a={})}var l=function(){0!==o.indexOf("_")&&n._db._store._doHistory&&n._db._store._read("_"+o+"_hist__meta",parseInt(e),function(t){t[0]._historyDataRowIDs.unshift(f),n._db._store._upsert("_"+o+"_hist__meta",parseInt(e),t[0])}),"upsert"===c?n._db._store._upsert(o,e,a,function(){t()}):n._db._store._delete(o,e,function(){t()})},f=0;!u&&0!==o.indexOf("_")&&n._db._store._doHistory?n._db._store._upsert("_"+o+"_hist__data",null,a,function(e){f=parseInt(e),l()}):l()})},e.prototype._tableChanged=function(e,t,n){var o=this,i=this,a=0,s=0;if(e.length>0){var _=function(){if(i._db._store._doHistory)i._db._store._doingTransaction||0!==i._db._store._historyPoint||i._db._store._historyLength++,i._db._store._utility("w","historyLength",i._db._store._historyLength),i._db._store._utility("w","historyPoint",i._db._store._historyPoint),i._db._store._upsert("_historyPoints",null,{historyPoint:i._db._store._historyLength-i._db._store._historyPoint,tableID:i._db._selectedTable,rowKeys:e.map(function(e){return parseInt(e)}),type:t},function(r){var a=i._db._store._tables[o._db._selectedTable];i._db._invalidateCache(i._db._selectedTable,[],""),i._db._store._read(a._name,function(t){return t&&e.indexOf(t[a._pk])!==-1},function(r){n([{msg:e.length+" row(s) "+t}],t,r)})});else{var r=i._db._store._tables[o._db._selectedTable];i._db._invalidateCache(i._db._selectedTable,[],""),i._db._store._read(r._name,function(t){return t&&e.indexOf(t[r._pk])!==-1},function(r){n([{msg:e.length+" row(s) "+t}],t,r)})}};i._db._store._doHistory&&i._db._store._historyPoint>0&&i._db._store._doingTransaction!==!0?i._db._store._read("_historyPoints",function(e){return e.historyPoint>i._db._store._historyLength-i._db._store._historyPoint},function(e){s=0;var t=function(){if(!(s<e.length))return i._db._store._historyLength-=i._db._store._historyPoint,i._db._store._historyPoint=0,void _();var n=i._db._store._tables[e[s].tableID]._name;a=0;var o=function(){a<e[s].rowKeys.length?i._db._store._read("_"+n+"_hist__meta",e[s].rowKeys[a],function(t){t[0]=r._assign(t[0]),t[0]._pointer=0;var _=t[0]._historyDataRowIDs.shift();i._db._store._upsert("_"+n+"_hist__meta",e[s].rowKeys[a],t[0],function(){_?i._db._store._delete("_"+n+"_hist__data",_,function(){a++,o()}):(a++,o())})}):(s++,t())};i._db._store._delete("_historyPoints",e[s].id,function(){o()})};t()}):_()}else n([{msg:"0 rows "+t}],t,[])},e.prototype._upsert=function(e,t){var n,o=this,i="",a=[],s=o._act.args||{},_=o._db._store._getTable(),c=_._pk;if(o._getMod("where")){i="modified",a=e.map(function(e){return e[_._pk]}),n=0;var u=function(){n<e.length?o._updateRow(e[n][c],function(){n++,u()}):o._tableChanged(a,i,t)};u()}else{i="inserted",s[c]?"int"===_._pkType&&(_._incriment=Math.max(s[c]+1,_._incriment)):"int"===_._pkType?s[c]=_._incriment++:"uint"===_._pkType&&(s[c]=r.NanoSQLInstance.uuid());var l=s[c]?String(s[c]):String(_._index.length);if(a=[l],_._index.indexOf(l)===-1){var f=this._db._store._tables[o._db._selectedTable]._name;if(0!==f.indexOf("_")){var d="_"+f+"_hist__meta";o._db._store._upsert(d,l,{_pointer:0,_historyDataRowIDs:[0]})}_._index.push(l)}o._updateRow(l,function(){o._tableChanged(a,i,t)})}},e.prototype._getTableID=function(){return this._joinTable?this._joinTable:this._db._selectedTable},e.prototype._select=function(e,t){var n=this;if(n._db._queryCache[n._db._selectedTable][n._queryHash])return void t(n._db._queryCache[n._db._selectedTable][n._queryHash],"none",[]);var o,i,s=["join","groupby","having","orderby","offset","limit"],_={},c=function(e,t,n){return Object.keys(n).reduce(function(r,o){return r?r:e[o]===t[o]?0:(e[o]>t[o]?1:-1)*("desc"===n[o]?-1:1)},0)},u=function(e,t,i){if(o=n._getMod(s[t]),2===t){var u=[];if(l.length){var f=Object.keys(a).map(function(e){return e+"("}),d=[];u=l.filter(function(e){return(f.reduce(function(t,n){return(e.indexOf(n)<0?0:1)+t},0)||0)>0||(d.push(e),!1)}).map(function(e){var t=e.match(/(.*)\((.*)\)/),n=t[1].trim(),r=(e.match(/\sAS\s(.*)/)||[]).pop()||n,o=t[2].split(",").map(function(e){return e.trim()});return"simple"===a[n].type&&r===n&&(r=o[0]),d.push(r),{name:n,args:o,as:r.trim(),type:a[n].type}});var p=[];if(u.length){var h,y=function(e){return u.sort(function(e,t){return e.type>t.type?1:-1}).reduce(function(t,n){var r=t.length-1;if("aggregate"===n.type){var o=e.slice();r=o.length-1,o=[o.reduce(function(e,t,o){return a[n.name].call(t,n.args,[o,r],e)},{})],h&&(o[0][h]=t[0][h]),t=o,h=n.name}else t=t.map(function(e,t){return a[n.name].call(e,n.args,[t,r])});return n.name!==n.as?d.push(n.name+" AS "+n.as):d.push(n.name),t},e.slice())},b=Object.keys(_);p=b.length?b.map(function(e){return y(_[e])}).reduce(function(e,t){return e=e.concat(t)},[]):y(e)}else p=e;var g=d.map(function(e){return e.match(/(.*)\sAS\s(.*)/)||e}).filter(function(e){return e})||[];g.length&&(p=p.map(function(e){e=r._assign(e);var t={};return g.forEach(function(n){"string"==typeof n?t[n]=e[n]:t[n[2]]=e[n[1]]}),t})),e=p}}if(!o)return i(e);switch(t){case 0:var v=void 0;"cross"!==o.args.type&&(v={_left:o.args.where[0].split(".").pop(),_check:o.args.where[1],_right:o.args.where[2].split(".").pop()});var m=n._db._selectedTable,k=r.NanoSQLInstance._hash(o.args.table),w=n._getMod("where");n._join(o.args.type,m,k,v,function(e){i(w?e.filter(function(e){return n._where(e,w.args)}):e)});break;case 1:var S=o.args,O={};S?(_=e.reduce(function(e,t){var n=Object.keys(S).reduce(function(e,n){return e+"."+String(t[n])},"").slice(1);return(e[n]=e[n]||[]).push(t),O[n]=Object.keys(S).reduce(function(e,n){return e[n]=t[n],e},{}),e},{}),i(Object.keys(_).sort(function(e,t){return c(O[e],O[t],S)}).reduce(function(e,t){return e.concat(_[t])},[]))):i(e);break;case 2:i(e.filter(function(e){return n._where(e,n._getMod("having").args)}));break;case 3:i(e.sort(function(e,t){return c(e,t,o.args)}));break;case 4:i(e.filter(function(e,t){return!o||t>=o.args}));break;case 5:i(e.filter(function(e,t){return!o||t<o.args}))}};i=-1;var l=n._act.args||[],f=function(e){i<s.length?(i++,u(e,i,function(e){f(e)})):(e=e.filter(function(e){return e}),n._getMod("join")||(n._db._queryCache[n._db._selectedTable][n._queryHash]=e),t(e,"none",[]))};f(e)},e.prototype._remove=function(e,t){var n,r="deleted",o=this,i=o._act.args||[],a=this._db._store._getTable()._pk;n=0;var s=function(){n<e.length?o._updateRow(e[n][a],function(){n++,s()}):(i.length&&(r="modified"),o._tableChanged(e.map(function(e){return e[a]}),r,t))};s()},e.prototype._where=function(e,t){var n=this,r=["AND","OR"];if("string"!=typeof t[0]){var o;return t.reduce(function(t,i,a){if(r.indexOf(i)!==-1)return o=i,t;var s=0===n._compare(i[2],i[1],e[i[0]]);return 0===a?s:"AND"===o?t&&s:t||s},!0)}return 0===n._compare(t[2],t[1],e[t[0]])},e.prototype._join=function(e,t,n,r,o){var i="outer",a=this,s=a._db._store._tables[t],_=a._db._store._tables[n],c=function(e,t){return[s,_].reduce(function(n,r,o){return r._keys.forEach(function(i){n[r._name+"."+i]=((0===o?e:t)||{})[i]}),n},{})},u=[],l=[];a._db._store._read(s._name,"all",function(t){a._db._store._read(_._name,"all",function(n){t.forEach(function(t){var o=n.filter(function(e){if(!r)return!0;var n=c(t,e),o=a._where(n,[r._left,r._check,r._right]);return o&&l.push(e[_._pk]),o});o.length?u=u.concat(o):["left",i].indexOf(e)>=0&&u.push(c(t,null))}),l=l.sort().filter(function(e,t,n){return!t||e!==n[t-1]}),["right",i].indexOf(e)>=0&&n.filter(function(e){return l.indexOf(e[_._pk])===-1}).forEach(function(e){u.push(c(null,e))}),o(u)})})},e.prototype._compare=function(e,t,n){switch(t){case"=":return n===e?0:1;case">":return n>e?0:1;case"<":return n<e?0:1;case"<=":return n<=e?0:1;case">=":return n>=e?0:1;case"IN":return e.indexOf(n)<0?1:0;case"NOT IN":return e.indexOf(n)<0?0:1;case"REGEX":case"LIKE":return n.search(e)<0?1:0;case"BETWEEN":return e[0]<n&&e[1]>n?0:1;default:return 0}},e}()},function(e,t,n){e.exports=n(0)}])});
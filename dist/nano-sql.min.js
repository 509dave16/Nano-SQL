!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var n=e();for(var r in n)("object"==typeof exports?exports:t)[r]=n[r]}}(window,function(){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:r})},n.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},n.n=function(t){var e=t&&t.t?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=30)}([function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0});var r=n(1),i=n(7),o=n(6);e.e="undefined"!=typeof window&&window.e?window.e:"undefined"!=typeof global&&global.e?global.e:r.e,e.stopWords=["a","about","after","all","also","am","an","and","andor","another","any","are","as","at","be","because","been","before","being","between","both","but","by","came","can","come","could","did","do","each","for","from","get","got","had","has","have","he","her","here","him","himself","his","how","i","if","in","into","is","it","like","make","many","me","might","more","most","much","must","my","never","now","of","on","only","or","other","our","out","over","said","same","see","should","since","some","still","such","take","than","that","the","their","them","then","there","these","they","this","those","through","to","too","under","up","very","was","way","we","well","were","what","where","which","while","who","with","would","you","your"],e.u=function(t){return t?JSON.parse(JSON.stringify(t)):null},e.fastCHAIN=function(t,n){return new e.e(function(e,i){if(t&&t.length){var o=[],s=function(){o.length<t.length?n(t[o.length],o.length,function(t){o.push(t),o.length%100==0?r.setFast(s):s()}):e(o)};s()}else e([])})},e.fastRACE=function(t,n){return new e.e(function(e,r){if(t&&t.length){var i=!1,o=0,s=function(){o<t.length&&(n(t[o],o,function(t){i||(i=!0,e([t]))}),o++,s())};s()}else e([])})},e.fastALL=function(t,n){return e.e.all((t||[]).map(function(t,r){return new e.e(function(e,i){n(t,r,function(t){e(t)})})}))};var s="undefined"==typeof window?"":navigator.userAgent||"";e.isSafari=0!==s.length&&(/^((?!chrome|android).)*safari/i.test(s)||/iPad|iPhone|iPod/.test(s)&&!window.MSStream),e.isMSBrowser=0!==s.length&&(s.indexOf("MSIE ")>0||s.indexOf("Trident/")>0||s.indexOf("Edge/")>0),e.isAndroid=/Android/.test(s),e.random16Bits=function(){if("undefined"==typeof crypto)return Math.round(Math.random()*Math.pow(2,16));if(crypto.getRandomValues){var t=new Uint16Array(1);return crypto.getRandomValues(t),t[0]}return"undefined"!=typeof global&&global.f.randomBytes?global.f.randomBytes(2).reduce(function(t,e){return e*t}):Math.round(Math.random()*Math.pow(2,16))},e.tokenizer=function(t,n,r,s,a){var u=function(t){return!t||1===String(t).length||-1!==e.stopWords.indexOf(t)},c=(s||"").toLowerCase().replace(/(\d+)\/(\d+)|(?:\d+(?:,\d+)*|\d+)(?:\.\d+)?/gim,function(t,e,n){return e||n?(parseInt(e)/parseInt(n)).toFixed(a||4):parseFloat(t.replace(/\,/gim,"")).toFixed(a||4)}).replace(/\-|\_|\[|\]|\(|\)|\{|\}|\r?\n|\r|\t/gim," ").replace(/[^\w\s]|(\d\.)/gim,"$1").replace(/\s+/g," ").split(" ");switch(r[1]){case"english":return c.map(function(t,e){return{i:e,o:t,w:isNaN(t)?u(t)?"":i(o(t)):t}});case"english-stem":return c.map(function(t,e){return{i:e,o:t,w:isNaN(t)?u(t)?"":o(t):t}});case"english-meta":return c.map(function(t,e){return{i:e,o:t,w:isNaN(t)?u(t)?"":i(t):t}})}return c.map(function(t,e){return{o:t,w:t,i:e}})},e.timeid=function(t){for(var n=Math.round((new Date).getTime()/(t?1:1e3)).toString();n.length<(t?13:10);)n="0"+n;return n+"-"+(e.random16Bits()+e.random16Bits()).toString(16)},e.intersect=function(t,e){return!(!t||!e)&&!(!t.length||!e.length)&&(t||[]).filter(function(t){return-1!==(e||[]).indexOf(t)}).length>0},e.uuid=function(){var t,n,r="";return[r,r,r,r,r,r,r,r].reduce(function(i,o,s){for(t=e.random16Bits(),n=3===s?4:4===s?(t%16&3|8).toString(16):r,t=t.toString(16);t.length<4;)t="0"+t;return i+([2,3,4,5].indexOf(s)>-1?"-":r)+(n+t).slice(0,4)},r)},e.hash=function(t){for(var e=5381,n=t.length;n;)e=33*e^t.charCodeAt(--n);return(e>>>0).toString(16)};var a={int:function(t){return t},uuid:e.uuid,timeId:function(){return e.timeid()},timeIdms:function(){return e.timeid(!0)}};e.generateID=function(t,e){return a[t]?a[t](e||1):""},e.cleanArgs=function(t,n){for(var r={},i=t.length;i--;){var o=t[i].split(":");o.length>1?r[o[0]]=e.cast(o[1],n[o[0]]||void 0):r[o[0]]=n[o[0]]||void 0}return r},e.isObject=function(t){return"[object Object]"===Object.prototype.toString.call(t)},e.cast=function(t,n){if("any"===t||"blob"===t)return n;var r=typeof n;if("undefined"===r||null===n)return n;var i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},o=function(t,n){switch(t){case"safestr":return o("string",n).replace(/[&<>"'`=\/]/gim,function(t){return i[t]});case"int":return"number"!==r||n%1!=0?parseInt(n||0):n;case"number":case"float":return"number"!==r?parseFloat(n||0):n;case"any[]":case"array":return Array.isArray(n)?n:[];case"uuid":case"timeId":case"timeIdms":case"string":return"string"!==r?String(n):n;case"object":case"obj":case"map":return e.isObject(n)?n:{};case"boolean":case"bool":return!0===n}return n},s=o(String(t||"").toLowerCase(),n);if(-1!==t.indexOf("[]")){var a=t.slice(0,t.lastIndexOf("[]"));return(n||[]).map(function(t){return e.cast(a,t)})}return void 0!==s?["int","float","number"].indexOf(t)>-1&&isNaN(s)?0:s:void 0},e.binarySearch=function(t,n,r,i){var o=r||0,s=i||t.length;if(t[o]>n)return o;if(t[s]<n)return s+1;var a=Math.floor((o+s)/2);return n===t[a]?a:s-1===o?s:n>t[a]?e.binarySearch(t,n,a,s):n<t[a]?e.binarySearch(t,n,o,a):s},e.removeDuplicates=function(t){if(!t.length)return[];for(var e=[t[0]],n=1;n<t.length;n++)t[n]!==t[n-1]&&e.push(t[n]);return e},e.deepFreeze=function(t){return Object.getOwnPropertyNames(t||{}).forEach(function(n){var r=t[n];"object"==typeof r&&null!==r&&(t[n]=e.deepFreeze(r))}),Object.freeze(t)},e.crowDistance=function(t,e,n,r,i){void 0===i&&(i=6371);var o=function(t){return t*(Math.PI/180)},s=o(n-t),a=o(r-e),u=Math.sin(s/2)*Math.sin(s/2)+Math.cos(o(t))*Math.cos(o(n))*Math.sin(a/2)*Math.sin(a/2);return i*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))};var u={};e.objQuery=function(t,e,n){var r=function(t,e,n){return t[e]&&n?r(t,e+1,n[t[e]]):n},i=t+(n?"1":"0");if(u[i])return r(u[i],0,e);var o=[];if(o=t.indexOf("[")>-1?[].concat.apply([],t.split(".").map(function(t){return t.match(/([^\[]+)|\[([^\]]+)\]\[/gim)||t})).map(function(t){return t.replace(/\[|\]/gim,"")}):t.split("."),n){var s=o.shift()+"."+o.shift();o.unshift(s)}return u[i]=o,r(u[i],0,e)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=0,i={},o=Array.prototype.slice,s="undefined"!=typeof window&&window.setImmediate?window.setImmediate:!("undefined"==typeof global||!global.setImmediate)&&global.setImmediate,a="undefined"!=typeof window&&window.postMessage&&window.addEventListener,u=function(t){return t[0].apply(null,o.call(t,1))};a&&window.addEventListener("message",function(t){var e,n=t.data;"string"==typeof n&&0===n.indexOf("setMsg")&&(e=i[n])&&(delete i[n],u(e))});e.setFast=s?function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];s(function(){u(t)})}:a?function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=r++,o="setMsg"+n;return i[o]=t,window.postMessage(o,"*"),n}:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];setTimeout(function(){u(t)},0)};var c=function(){},f=["R"],h=["F"],l=["P"],p=function(){function t(t){this.a=l,this.h=[],this.v=void 0,t!==c&&g(this,t)}return t.doPolyFill=function(){"undefined"!=typeof global&&(global.e||(global.e=this)),"undefined"!=typeof window&&(window.e||(window.e=this))},t.prototype.catch=function(t){return this.then(function(){},t)},t.prototype.then=function(e,n){if("function"!=typeof e&&this.a===h||"function"!=typeof n&&this.a===f)return this;var r=new t(c);return this.a!==l?y(r,this.a===h?e:n,this.v):this.h.push(new d(r,e,n)),r},t.resolve=function(e){return e instanceof this?e:b.b(new t(c),e)},t.reject=function(e){return b._(new t(c),e)},t.all=function(e){return new t(function(t,n){var r=[];if(e.length)for(var i=function(n,i,o){void 0!==o?r.push(o):r.push(i),r.length==e.length&&t(r)},o=function(t){e[t].then(function(t){i(0,t,void 0)}).catch(function(t){i(0,void 0,t)})},s=0;s<e.length;s++)o(s);else t([])})},t.race=function(e){var n,r=e.length,i=!1,o=-1,s=new t(c);if(!1!==Array.isArray(e))return this.reject(new TypeError);if(!r)return this.resolve([]);for(;++o<r;)n=e[o],this.resolve(n).then(function(t){i||(i=!0,b.b(s,t))},function(t){i||(i=!0,b._(s,t))});return s},t}();e.e=p;var d=function(){function t(t,e,n){this.y=t,"function"==typeof e&&(this.g=e,this.O=this.S),"function"==typeof n&&(this.j=n,this.k=this.N)}return t.prototype.O=function(t){b.b(this.y,t)},t.prototype.S=function(t){y(this.y,this.g,t)},t.prototype.k=function(t){b._(this.y,t)},t.prototype.N=function(t){y(this.y,this.j,t)},t}();function y(t,n,r){e.setFast(function(){var e;try{e=n.apply(null,r)}catch(e){return b._(t,e)}return e===t?b._(t,new TypeError):b.b(t,e),null})}e.A=d;var b=function(){function t(){}return t.b=function(e,n){var r=m(v,n),i=r.I,o=-1,s=e.h.length;if("error"===r.T)return t._(e,r.I);if(i)g(e,i);else for(e.a=h,e.v=n;++o<s;)e.h[o].O(n);return e},t._=function(t,e){t.a=f,t.v=e;for(var n=-1,r=t.h.length;++n<r;)t.h[n].k(e);return t},t}();function v(t){var e=t&&t.then;return!t||"object"!=typeof t&&"function"!=typeof t||"function"!=typeof e?null:function(){e.apply(t,arguments)}}function g(t,e){var n=!1;function r(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];n||(n=!0,b._(t,e))}function i(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];n||(n=!0,b.b(t,e))}var o=m(function(){e(i,r)});"error"===o.T&&r(o.I)}function m(t,e){var n={T:null,I:null};try{n.I=t(e),n.T="success"}catch(t){n.T="error",n.I=t}return n}},function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),i=function(){function t(){this.M=[],this.x={},this.ai=1,this.sortIndex=!0,this.doAI=!1}return t.prototype.clone=function(e){this.L&&!e&&this.L(this.R,"drop",null);var n=new t;return n.doAI=this.doAI,n.ai=this.ai,n.sortIndex=this.sortIndex,n.L=this.L,n.R=this.R,n.pkType=this.pkType,e&&this.set([]),n},t.prototype.onChange=function(t,e){this.R=t,this.L=e},t.prototype.set=function(t){var e=this;this.M=t||[],this.x={},this.M.forEach(function(t,n){e.x[String(t)]=!0}),this.doAI&&this.M.length&&(this.ai=this.M[this.M.length-1]+1)},t.prototype.getLocation=function(t,e){var n=this.indexOf(t);return-1!==n?n:this.sortIndex?r.binarySearch(this.M,t,e):r.binarySearch(this.M.sort(function(t,e){return t>e?1:-1}),t,e)},t.prototype.add=function(t,e){if(!this.x[String(t)])if(this.L&&!e&&this.L(this.R,"add",t),this.x[String(t)]=!0,e&&-1!==["number","int","float"].indexOf(this.pkType)&&(t=parseFloat(t)),this.doAI)this.ai++,this.M.push(t);else if(this.sortIndex){var n=r.binarySearch(this.M,t);this.M.splice(n,0,t)}else this.M.push(t)},t.prototype.keys=function(){return this.M},t.prototype.exists=function(t){return!!this.x[String(t)]},t.prototype.indexOf=function(t){return this.x[String(t)]?this.sortIndex?r.binarySearch(this.M,t):this.M.indexOf(t):-1},t.prototype.remove=function(t,e){if(this.L&&!e&&this.L(this.R,"rm",t),e&&-1!==["number","int","float"].indexOf(this.pkType)&&(t=parseFloat(t)),this.x[String(t)]){var n=this.indexOf(t);this.x[String(t)]=!1,this.M.splice(n,1)}},t}();e.DatabaseIndex=i,e.syncPeerIndex=function(t,e){t.peerMode&&(Object.keys(e).forEach(function(n){e[n].onChange(n,function(e,n,i){t.peers.filter(function(e){return e!==t.pid}).forEach(function(t){localStorage.setItem(t+"::"+r.random16Bits().toString(16),n+","+e+","+(i||""))})})}),window.addEventListener("storage",function(n){if(n.key&&-1!==n.key.indexOf(t.pid+"::")){var r=(n.newValue||"").split(",");switch(localStorage.removeItem(n.key),r[0]){case"rm":e[r[1]].remove(r[2],!0);break;case"add":e[r[1]].add(r[2],!0);break;case"drop":e[r[1]].clone(!0)}}}))}},function(t,e,n){var r=this&&this.C||Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t};Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),o=n(0),s=n(2),a=function(){function t(t){this.D={},this.J={},this.P=1e3*(t||0)*1e3}return t.prototype.setID=function(t){this.H=t},t.prototype.connect=function(t){var e=this;this.F=window.openDatabase(this.H,"1.0",this.H,this.P||o.isAndroid?5e6:1),o.fastALL(Object.keys(this.D),function(t,n,r){e.Q(!0,"CREATE TABLE IF NOT EXISTS "+t+" (id BLOB PRIMARY KEY UNIQUE, data TEXT)",[],function(){e.Q(!1,"SELECT id FROM "+t,[],function(n){for(var i=[],o=0;o<n.rows.length;o++)i.push(n.rows.item(o).id);e.J[t].sortIndex&&(i=i.sort(function(t,e){return t>e?1:-1})),e.J[t].set(i),r()})})}).then(t)},t.prototype.$=function(t){if(-1===Object.keys(this.J).indexOf(t))throw Error("No table "+t+" found!");return t},t.prototype.makeTable=function(t,e){var n=this;this.J[t]=new s.DatabaseIndex,e.forEach(function(e){e.props&&o.intersect(["pk","pk()"],e.props)&&(n.J[t].pkType=e.type,n.D[t]=e.key,e.props&&o.intersect(["ai","ai()"],e.props)&&("int"===e.type||"number"===e.type)&&(n.J[t].doAI=!0),(e.props&&o.intersect(["ns","ns()"],e.props)||-1!==["uuid","timeId","timeIdms"].indexOf(n.J[t].pkType))&&(n.J[t].sortIndex=!1))})},t.prototype.Q=function(t,e,n,r){var i=function(t){t.executeSql(e,n,function(t,e){r(e)},function(t,r){return console.error(e,n,r),!1})};t?this.F.transaction(i):this.F.readTransaction(i)},t.prototype.write=function(t,e,n,i){if(!(e=e||o.generateID(this.J[t].pkType,this.J[t].ai)))throw new Error("nSQL: Can't add a row without a primary key!");var s,a,u=!1;if(this.J[t].exists(e)||(u=!0,this.J[t].add(e)),u){var c=r({},n,((s={})[this.D[t]]=e,s));this.Q(!0,"INSERT into "+this.$(t)+" (id, data) VALUES (?, ?)",[e,JSON.stringify(c)],function(t){i(c)})}else{var f=r({},n,((a={})[this.D[t]]=e,a));this.Q(!0,"UPDATE "+this.$(t)+" SET data = ? WHERE id = ?",[JSON.stringify(f),e],function(){i(f)})}},t.prototype.delete=function(t,e,n){-1!==this.J[t].indexOf(e)&&this.J[t].remove(e),this.Q(!0,"DELETE FROM "+this.$(t)+" WHERE id = ?",[e],function(){n()})},t.prototype.read=function(t,e,n){this.Q(!1,"SELECT data FROM "+this.$(t)+" WHERE id = ?",[e],function(t){t.rows.length?n(JSON.parse(t.rows.item(0).data)):n(void 0)})},t.prototype.batchRead=function(t,e,n){this.Q(!1,"SELECT data from "+this.$(t)+" WHERE id IN ("+e.map(function(t){return"?"}).join(", ")+") ORDER BY id",e,function(t){for(var e=t.rows.length,r=[];e--;)r.unshift(JSON.parse(t.rows.item(e).data));n(r)})},t.prototype.rangeRead=function(t,e,n,r,o,s){var a=this,u=this.J[t].keys(),c=-1===[typeof r,typeof o].indexOf("undefined"),f=c?[r,o]:[];if(u.length){s&&c&&(f=f.map(function(e){return a.J[t].getLocation(e)})),s&&c||!1!==this.J[t].sortIndex||(u=u.sort());var h=f[0]||0,l=[],p=f[0],d="SELECT data from "+this.$(t);if(f.length){for(u[p];p<=f[1];)l.push(u[p]),p++;d+=" WHERE id IN ("+l.map(function(t){return"?"}).join(", ")+")"}d+=" ORDER BY id",this.Q(!1,d,l,function(t){var r=0,o=function(){t.rows.length>r?e(JSON.parse(t.rows.item(r).data),h,function(){h++,++r%500==0?i.setFast(o):o()}):n()};o()})}else n()},t.prototype.drop=function(t,e){this.J[t]=this.J[t].clone(),this.Q(!0,"DELETE FROM "+this.$(t),[],function(t){e()})},t.prototype.getIndex=function(t,e,n){n(e?this.J[t].keys().length:this.J[t].keys())},t.prototype.destroy=function(t){var e=this;o.fastALL(Object.keys(this.J),function(t,n,r){e.drop(t,r)}).then(t)},t.prototype.setNSQL=function(t){s.syncPeerIndex(t,this.J)},t}();e.W=a},function(t,e,n){var r=this&&this.C||Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t};Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),o=n(0),s=n(2),a=function(){function t(){this.D={},this.J={},this.z={}}return t.prototype.onError=function(t){throw console.error(t),new Error("nSQL: IndexedDB Error!")},t.prototype.connect=function(t){var e=this;this.B=o.hash(JSON.stringify(this.z));var n=parseInt(localStorage.getItem(this.H+"-idb-version")||"")||1;(localStorage.getItem(this.H+"-idb-hash")||this.B)!==this.B&&n++,localStorage.setItem(this.H+"-idb-version",String(n)),localStorage.setItem(this.H+"-idb-hash",this.B);var r=indexedDB.open(this.H,n),i={};r.onerror=this.onError,r.onupgradeneeded=function(t){e.F=t.target.result,Object.keys(e.J).forEach(function(t){e.F.objectStoreNames.contains(t)||e.F.createObjectStore(t,{keyPath:e.D[t]}),i[t]=[]})},r.onsuccess=function(n){e.F=n.target.result,o.fastALL(Object.keys(e.J),function(t,n,r){var i,o,s;i=t,o=function(n){e.J[t].set(n),r()},s=[],e.store(i,"readonly",function(t,n){var r=n.openCursor();r.onsuccess=function(t){var e=t.target.result;e&&(s.push(e.key),e.continue())},r.onerror=e.onError,t.oncomplete=function(){o(s)}})}).then(function(){t()})}},t.prototype.store=function(t,e,n){var r=this.F.transaction(t,e);r.onabort=this.onError,r.onerror=this.onError,n(r,r.objectStore(t))},t.prototype.setID=function(t){this.H=t},t.prototype.makeTable=function(t,e){var n=this;this.J[t]=new s.DatabaseIndex,this.z[t]=e,e.forEach(function(e){e.props&&o.intersect(["pk","pk()"],e.props)&&(n.J[t].pkType=e.type,n.D[t]=e.key,e.props&&o.intersect(["ai","ai()"],e.props)&&("int"===e.type||"number"===e.type)&&(n.J[t].doAI=!0),(e.props&&o.intersect(["ns","ns()"],e.props)||-1!==["uuid","timeId","timeIdms"].indexOf(n.J[t].pkType))&&(n.J[t].sortIndex=!1))})},t.prototype.write=function(t,e,n,i){var s=this;if(!(e=e||o.generateID(this.J[t].pkType,this.J[t].ai)))throw new Error("nSQL: Can't add a row without a primary key!");-1===this.J[t].indexOf(e)&&this.J[t].add(e);var a,u=r({},n,((a={})[this.D[t]]=e,a));this.store(t,"readwrite",function(t,e){var n=e.put(u);n.onerror=s.onError,n.onsuccess=function(t){i(u)}})},t.prototype.delete=function(t,e,n){var r=this;-1!==this.J[t].indexOf(e)&&this.J[t].remove(e),this.store(t,"readwrite",function(t,i){var o="_clear_"===e?i.clear():i.delete(e);o.onerror=r.onError,o.onsuccess=function(t){n()}})},t.prototype.read=function(t,e,n){var r=this;-1!==this.J[t].indexOf(e)?this.store(t,"readonly",function(t,i){var o=i.get(e);o.onerror=r.onError,o.onsuccess=function(){n(o.result)}}):n(null)},t.prototype.rangeRead=function(t,e,n,r,o,s){var a=this,u=this.J[t].keys(),c=-1===[typeof r,typeof o].indexOf("undefined"),f=c?[r,o]:[0,u.length-1];if(u.length){s&&c||!1!==this.J[t].sortIndex||(u=u.sort());var h=s&&c?r:u[f[0]],l=s&&c?o:u[f[1]];this.store(t,"readonly",function(t,r){var o=[],s=c?r.openCursor(IDBKeyRange.bound(h,l)):r.openCursor();t.oncomplete=function(t){var r=0,s=function(){o[r]?e(o[r],r,function(){++r%500==0?i.setFast(s):s()}):n()};s()},s.onsuccess=function(t){var e=t.target.result;e&&(o.push(e.value),e.continue())},s.onerror=a.onError})}else n()},t.prototype.drop=function(t,e){this.J[t]=this.J[t].clone(),this.delete(t,"_clear_",function(){e()})},t.prototype.getIndex=function(t,e,n){n(e?this.J[t].keys().length:this.J[t].keys())},t.prototype.destroy=function(t){var e=this;localStorage.removeItem(this.H+"-idb-version"),localStorage.removeItem(this.H+"-idb-hash"),o.fastALL(Object.keys(this.J),function(t,n,r){e.drop(t,r)}).then(t)},t.prototype.setNSQL=function(t){s.syncPeerIndex(t,this.J)},t}();e.K=a},function(t,e,n){var r=this&&this.C||Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t};Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),o=n(0),s=n(2),a=function(){function t(t){this.D={},this.U={},this.J={},this.V=t||!1}return t.prototype.connect=function(t){t()},t.prototype.setID=function(t){this.H=t},t.prototype.makeTable=function(t,e){var n=this;this.U[t]={},this.J[t]=new s.DatabaseIndex,e.forEach(function(e){if(e.props&&o.intersect(["pk","pk()"],e.props)&&(n.J[t].pkType=e.type,n.D[t]=e.key,e.props&&o.intersect(["ai","ai()"],e.props)&&("int"===e.type||"number"===e.type)&&(n.J[t].doAI=!0),(e.props&&o.intersect(["ns","ns()"],e.props)||-1!==["uuid","timeId","timeIdms"].indexOf(n.J[t].pkType))&&(n.J[t].sortIndex=!1),n.V)){var r=localStorage.getItem(n.H+"*"+t+"_idx");r&&n.J[t].set(JSON.parse(r))}})},t.prototype.write=function(t,e,n,i){if(!(e=e||o.generateID(this.J[t].pkType,this.J[t].ai)))throw new Error("nSQL: Can't add a row without a primary key!");if(-1===this.J[t].indexOf(e)&&(this.J[t].add(e),this.V&&localStorage.setItem(this.H+"*"+t+"_idx",JSON.stringify(this.J[t].keys()))),this.V){var s=r({},n,((a={})[this.D[t]]=e,a));localStorage.setItem(this.H+"*"+t+"__"+e,JSON.stringify(s)),i(s)}else s=r({},n,((u={})[this.D[t]]=e,u)),this.U[t][e]=o.deepFreeze(s),i(s);var a,u},t.prototype.delete=function(t,e,n){-1!==this.J[t].indexOf(e)&&(this.J[t].remove(e),this.V&&localStorage.setItem(this.H+"*"+t+"_idx",JSON.stringify(this.J[t].keys()))),this.V?localStorage.removeItem(this.H+"*"+t+"__"+e):delete this.U[t][e],n()},t.prototype.read=function(t,e,n){if(this.V){var r=localStorage.getItem(this.H+"*"+t+"__"+e);n(r?JSON.parse(r):void 0)}else n(this.U[t][e])},t.prototype.rangeRead=function(t,e,n,r,o,s){var a=this,u=this.J[t].keys(),c=-1===[typeof r,typeof o].indexOf("undefined"),f=c?[r,o]:[0,u.length-1];if(u.length){s&&c||!1!==this.J[t].sortIndex||(u=u.sort()),s&&c&&(f=f.map(function(e){var n=a.J[t].indexOf(e);return-1!==n?n:a.J[t].getLocation(e)}));var h=f[0],l=0,p=function(){h++,++l%500==0?i.setFast(d):d()},d=function(){if(h<=f[1])if(a.V){var r=localStorage.getItem(a.H+"*"+t+"__"+u[h]);e(r?JSON.parse(r):void 0,h,p)}else e(a.U[t][u[h]],h,p);else n()};d()}else n()},t.prototype.drop=function(t,e){var n=this;this.V?(localStorage.setItem(this.H+"*"+t+"_idx",JSON.stringify([])),this.J[t].keys().forEach(function(e){localStorage.removeItem(n.H+"*"+t+"__"+e)})):this.U[t]={},this.J[t]=this.J[t].clone(),e()},t.prototype.getIndex=function(t,e,n){n(e?this.J[t].keys().length:this.J[t].keys())},t.prototype.destroy=function(t){var e=this;o.fastALL(Object.keys(this.J),function(t,n,r){e.drop(t,r)}).then(t)},t.prototype.setNSQL=function(t){s.syncPeerIndex(t,this.J)},t}();e.G=a},function(t,e,n){"use strict";t.exports=function(t){var e,n;return(t=String(t).toLowerCase()).length<3?t:(t.charCodeAt(0)===r&&(e=!0,t="Y"+t.substr(1)),m.test(t)?t=t.substr(0,t.length-2):g.test(t)&&(t=t.substr(0,t.length-1)),(n=v.exec(t))?s.test(n[1])&&(t=t.substr(0,t.length-1)):(n=y.exec(t))&&c.test(n[1])&&(t=n[1],b.test(t)?t+="e":w.test(t)?t=t.substr(0,t.length-1):f.test(t)&&(t+="e")),(n=p.exec(t))&&c.test(n[1])&&(t=n[1]+"i"),(n=x.exec(t))&&s.test(n[1])&&(t=n[1]+i[n[2]]),(n=O.exec(t))&&s.test(n[1])&&(t=n[1]+o[n[2]]),(n=E.exec(t))?u.test(n[1])&&(t=n[1]):(n=d.exec(t))&&u.test(n[1])&&(t=n[1]),(n=l.exec(t))&&(u.test(n[1])||a.test(n[1])&&!f.test(n[1]))&&(t=n[1]),h.test(t)&&u.test(t)&&(t=t.substr(0,t.length-1)),e&&(t="y"+t.substr(1)),t)};var r="y".charCodeAt(0),i={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},o={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},s=new RegExp("^([^aeiou][^aeiouy]*)?([aeiouy][aeiou]*)([^aeiou][^aeiouy]*)"),a=new RegExp("^([^aeiou][^aeiouy]*)?([aeiouy][aeiou]*)([^aeiou][^aeiouy]*)([aeiouy][aeiou]*)?$"),u=new RegExp("^([^aeiou][^aeiouy]*)?(([aeiouy][aeiou]*)([^aeiou][^aeiouy]*)){2,}"),c=new RegExp("^([^aeiou][^aeiouy]*)?[aeiouy]"),f=new RegExp("^([^aeiou][^aeiouy]*)[aeiouy][^aeiouwxy]$"),h=/ll$/,l=/^(.+?)e$/,p=/^(.+?)y$/,d=/^(.+?(s|t))(ion)$/,y=/^(.+?)(ed|ing)$/,b=/(at|bl|iz)$/,v=/^(.+?)eed$/,g=/^.+?[^s]s$/,m=/^.+?(ss|i)es$/,w=/([^aeiouylsz])\1$/,x=new RegExp("^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$"),O=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,E=new RegExp("^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$")},function(t,e,n){"use strict";t.exports=function(t){var e,n,f,h,l="",p=0;function d(t){l+=t}function y(e){return t.charAt(p+e).toUpperCase()}function b(t){return function(){return y(t)}}if(!(t=String(t||"")))return"";for(n=b(1),f=b(0),h=b(-1);!c(f());){if(!f())return"";p++}switch(f()){case"A":"E"===n()?(d("E"),p+=2):(d("A"),p++);break;case"G":case"K":case"P":"N"===n()&&(d("N"),p+=2);break;case"W":"R"===n()?(d(n()),p+=2):"H"===n()?(d(f()),p+=2):a(n())&&(d("W"),p+=2);break;case"X":d("S"),p++;break;case"E":case"I":case"O":case"U":d(f()),p++}for(;f();)if(e=1,!c(f())||f()===h()&&"C"!==f())p+=e;else{switch(f()){case"B":"M"!==h()&&d("B");break;case"C":s(n())?"I"===n()&&"A"===y(2)?d(r):"S"!==h()&&d("S"):"H"===n()?(d(r),e++):d("K");break;case"D":"G"===n()&&s(y(2))?(d("J"),e++):d("T");break;case"G":"H"===n()?o(y(-3))||"H"===y(-4)||(d("F"),e++):"N"===n()?!c(y(2))||"E"===y(2)&&"D"===y(3)||d("K"):s(n())&&"G"!==h()?d("J"):d("K");break;case"H":a(n())&&!u(h())&&d("H");break;case"K":"C"!==h()&&d("K");break;case"P":"H"===n()?d("F"):d("P");break;case"Q":d("K");break;case"S":"I"!==n()||"O"!==y(2)&&"A"!==y(2)?"H"===n()?(d(r),e++):d("S"):d(r);break;case"T":"I"!==n()||"O"!==y(2)&&"A"!==y(2)?"H"===n()?(d(i),e++):"C"===n()&&"H"===y(2)||d("T"):d(r);break;case"V":d("F");break;case"W":a(n())&&d("W");break;case"X":d("KS");break;case"Y":a(n())&&d("Y");break;case"Z":d("S");break;case"F":case"J":case"L":case"M":case"N":case"R":d(f())}p+=e}return l};var r="X",i="0";function o(t){return"B"===(t=f(t))||"D"===t||"H"===t}function s(t){return"E"===(t=f(t))||"I"===t||"Y"===t}function a(t){return"A"===(t=f(t))||"E"===t||"I"===t||"O"===t||"U"===t}function u(t){return"C"===(t=f(t))||"G"===t||"P"===t||"S"===t||"T"===t}function c(t){var e=function(t){return f(t).charCodeAt(0)}(t);return e>=65&&e<=90}function f(t){return String(t).charAt(0).toUpperCase()}},function(t,e,n){var r=this&&this.C||Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t};Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),o=n(29),s=n(28),a=n(27),u=n(0),c=n(26),f=n(18),h=n(9),l=n(17),p=1.68,d=["_util"],y=function(){function t(){this.version=p,this.X=[];var t=this;t.isConnected=!1,t.focused=!0,t.Y={},t.Z={},t.dataModels={},t.tt=["*","change","delete","upsert","drop","select","error","peer-change"],t.nt={},t.tableNames=[],t.plugins=[],t.hasPK={},t.skipPurge={},t.toRowFns={},t.tablePKs={},t.toColFns={},t.toColRules={},t.rowFilters={},t.peers=[],t.peerEvents=[],t.pid=u.uuid(),t.it=[],t.rt=0,t.hasAnyEvents=!1;for(var e=0;e<1e3;e++)t.it.push(u.random16Bits());t.et={},t.et["*"]=new a.ReallySmallEvents,t.iB=new c.NanoSQLDefaultBackend;var n={models:{},actions:{},views:{},config:{},parent:this};t.iB.willConnect&&t.iB.willConnect(n,function(){t.iB.didConnect&&t.iB.didConnect(n,function(){})})}return t.prototype.rowFilter=function(t){return this.rowFilters[this.sTable]=t,this},t.prototype.toColumn=function(t){return this.toColFns[this.sTable]||(this.toColFns[this.sTable]={}),this.toColFns[this.sTable]=t,this},t.prototype.toRow=function(t){return this.toRowFns[this.sTable]||(this.toRowFns[this.sTable]={}),this.toRowFns[this.sTable]=t,this},t.prototype.fastRand=function(){return this.rt++,this.rt>=this.it.length&&(this.rt=0),this.it[this.rt]},t.prototype.table=function(t){return t&&(this.sTable=t),this},t.prototype.getPeers=function(){return JSON.parse(localStorage.getItem("nsql-peers-"+this.id)||"[]")},t.prototype.connect=function(){var t=this,n=this;return new u.e(function(o,s){var a={models:n.dataModels,actions:n.Y,views:n.Z,config:n.ot,parent:t};a.models[d[0]]=[{key:"key",type:"string",props:["pk()","ai()"]},{key:"value",type:"any"}],n.ot&&n.ot.history&&t.use(new f.ut(n.ot.historyMode)),n.ot&&!1===n.ot.mode||t.use(new c.NanoSQLDefaultBackend),"undefined"!=typeof window&&t.ot&&t.ot.peer&&(t.peerMode=!0),u.fastCHAIN(n.plugins,function(t,e,n){t.willConnect?t.willConnect(a,function(t){a=t,n()}):n()}).then(function(){n.dataModels=a.models,n.Y=a.actions,n.Z=a.views,n.ot=a.config,Object.keys(n.dataModels).forEach(function(t){var e=!1;n.dataModels[t]=n.dataModels[t].filter(function(t){return"*"!==t.key||"*"!==t.type||(e=!0,!1)}),n.skipPurge[t]=e}),n.plugins.forEach(function(t){t.didExec&&(n.pluginHasDidExec=!0)}),n.tableNames=Object.keys(n.dataModels);var s=function(){u.fastALL(n.plugins,function(e,n,r){e.getId&&!t.id&&(t.id=e.getId()),e.didConnect?e.didConnect(a,function(){r()}):r()}).then(function(){if(t.peerMode){var s=0;t.id||(t.id=t.pid),t.peers=t.getPeers(),t.peers.unshift(t.pid),localStorage.setItem("nsql-peers-"+t.id,JSON.stringify(t.peers)),window.addEventListener("storage",function(e){if(e.key==="nsql-peers-"+t.id&&(t.peers=t.getPeers()),e.key&&0===e.key.indexOf(t.pid+".")){localStorage.removeItem(e.key);var n=JSON.parse(e.newValue||"{}");t.peerEvents.push(n.query.queryID||""),t.triggerEvent(r({},n,{types:["peer-change"]})),i.setFast(function(){t.triggerEvent(n)})}if(++s>50&&t.peers[0]===t.pid){s=0;for(var o=localStorage.length,a={};o--;){var u=localStorage.key(o),c=u?u.match(/\w{8}-\w{4}-\w{4}-\w{4}-\w{8}/gim):null;if(u&&c){var f=(c||[""])[0];a[f]||(a[f]=[]),a[f].push(u)}}Object.keys(a).forEach(function(e){a[e].length>10&&(t.peers=t.peers.filter(function(t){return t!==e}),a[e].forEach(function(t){localStorage.removeItem(t)}),localStorage.setItem("nsql-peers-"+t.id,JSON.stringify(t.peers)))})}}),window.onblur=function(){t.focused=!1},window.onfocus=function(){t.peers=t.peers.filter(function(e){return e!==t.pid}),t.peers.unshift(t.pid),localStorage.setItem("nsql-peers-"+t.id,JSON.stringify(t.peers)),t.focused=!0},e.nSQL("*").on("change",function(e){var n=t.peerEvents.indexOf(e.query.queryID||"");-1===n?t.peers.filter(function(e){return e!==t.pid}).forEach(function(t){localStorage.setItem(t+"."+e.query.queryID,JSON.stringify(e))}):t.peerEvents.splice(n,1)}),window.addEventListener("beforeunload",function(){return t.peers=t.peers.filter(function(e){return e!==t.pid}),localStorage.setItem("nsql-peers-"+t.id,JSON.stringify(t.peers)),!1})}n.isConnected=!0,n.X.length&&(n.X.forEach(function(t){return t()}),n.X=[]),o(n.tableNames)})},c=function(t){n.query("upsert",{key:"version",value:n.version}).manualExec({table:"_util"}).then(function(){t?n.extend("beforeConn","rebuild_idx").then(function(){s()}):s()})};n.query("select").where(["key","=","version"]).manualExec({table:"_util"}).then(function(t){t.length?t[0].value<=1.21?c(!0):t[0].value<p?c(!1):s():c(!0)})})})},t.prototype.getActions=function(t){return this.Y[t].map(function(t){return{name:t.name,args:t.args}})},t.prototype.getViews=function(t){return this.Z[t].map(function(t){return{name:t.name,args:t.args}})},t.prototype.getConfig=function(){return this.ot||{}},t.prototype.avFilter=function(t){return this.st=t,this},t.prototype.use=function(t){return this.plugins.push(t),this},t.prototype.on=function(t,e){var n=this,r=n.sTable,i=n.tt.length,o=t.split(" ");if(Array.isArray(r))return this;for(n.et[r]||(n.et[r]=new a.ReallySmallEvents),i=o.length;i--;)-1!==n.tt.indexOf(o[i])&&n.et[r].on(o[i],e);return n.ct()},t.prototype.off=function(t,e){var n=this,r=t.split(" "),i=r.length,o=n.sTable;if(Array.isArray(o))return this;for(;i--;)-1!==n.tt.indexOf(r[i])&&n.et[o].off(r[i],e);return n.ct()},t.prototype.ct=function(){var t=this;return this.nt={},Object.keys(this.et).concat(["*"]).forEach(function(e){t.nt[e]=t.tt.reduce(function(n,r){return n+(t.et[e]&&t.et[e].eventListeners[r]?t.et[e].eventListeners[r].length:0)},0)>0}),this.hasAnyEvents=!1,Object.keys(this.nt).forEach(function(e){t.hasAnyEvents=t.hasAnyEvents||t.nt[e]}),this},t.prototype.model=function(t,e,n){var r=this,i=this,o=i.sTable;if(Array.isArray(o))return this;i.et[o]||(i.et[o]=new a.ReallySmallEvents);var s=!1;if(!n){if(-1!==["string","safestr","timeId","timeIdms","uuid","int","float","number","array","map","bool","blob","any"].indexOf(o.replace(/\W/gim,""))||0===o.indexOf("_")||null!==o.match(/[\(\)\]\[\.]/g))throw Error("Invalid Table Name! https://docs.nanosql.io/setup/data-models");(t||[]).forEach(function(t){if(null!==t.key.match(/[\(\)\]\[\.]/g)||0===t.key.indexOf("_"))throw Error("Invalid Data Model! https://docs.nanosql.io/setup/data-models")})}return i.toColRules[o]={},(t||[]).forEach(function(t){t.props&&t.props.forEach(function(e){if(-1!==e.indexOf("from=>")&&-1!==e.indexOf("(")){var n=e.replace("from=>","").split("(").shift(),r=e.replace("from=>","").split("(").pop().replace(")","").split(",").map(function(t){return t.trim()});i.toColRules[o][t.key]=[n].concat(r)}0===e.indexOf("toColumn.")&&(n=e.replace(/toColumn\.(.*)\(.*\)/gim,"$1"),r=e.replace(/toColumn\..*\((.*)\)/gim,"$1").split(",").map(function(t){return t.trim()}),i.toColRules[o][t.key]=[n].concat(r))}),t.props&&u.intersect(["pk","pk()"],t.props)&&(r.tablePKs[o]=t.key,s=!0)}),this.hasPK[o]=s,s||(this.tablePKs[o]="_id_",t.unshift({key:"_id_",type:"uuid",props:["pk()"]})),i.dataModels[o]=t,i.Z[o]=[],i.Y[o]=[],i},t.prototype.views=function(t){return Array.isArray(this.sTable)?this:(this.Z[this.sTable]=t,this)},t.prototype.getView=function(t,e){return void 0===e&&(e={}),Array.isArray(this.sTable)?new u.e(function(t,e){return e()}):this.ft("View",this.Z[this.sTable],t,e)},t.prototype.actions=function(t){return Array.isArray(this.sTable)?this:(this.Y[this.sTable]=t,this)},t.prototype.doAction=function(t,e){return Array.isArray(this.sTable)?new u.e(function(t,e){return e()}):this.ft("Action",this.Y[this.sTable],t,e)},t.prototype.queryFilter=function(t){return this.queryMod=t,this},t.prototype.ft=function(t,e,n,r){var i=this,o=this,s=e.reduce(function(t,e){return e.name===n?e:t},null);return s?(o.at=n,o.st?new u.e(function(e,n){o.st(i.sTable,t,o.at||"",r,function(t){s.call(s.args?u.cleanArgs(s.args,t):{},o).then(e).catch(n)},function(t){n(t)})}):s.call(s.args?u.cleanArgs(s.args,r):{},o)):new u.e(function(t,e){return e("Action/View Not Found!")})},t.prototype.query=function(t,e){var n=this.at;return this.at=void 0,new o.ht(this,this.sTable,t,e,n)},t.prototype.onConnected=function(t){this.isConnected?t():this.X.push(t)},t.prototype.triggerEvent=function(t){var e=this;if(e.nt["*"]||e.nt[t.table]){if("*"===t.table)return this;i.setFast(function(){t.types.forEach(function(n){e.et["*"].trigger(n,t,e),e.et["*"].trigger("*",t,e),t.table&&e.et[t.table]&&e.et[t.table].trigger(n,t,e)})})}return e},t.prototype.default=function(t){var e={},n=this;return Array.isArray(n.sTable)?{}:(n.dataModels[n.sTable].forEach(function(n){e[n.key]=t&&t[n.key]?t[n.key]:n.default,void 0===e[n.key]&&(e[n.key]=u.cast(n.type,null))}),e)},t.prototype.rawDump=function(t){var e=this;return new u.e(function(n,i){var o={};u.fastCHAIN(e.plugins,function(e,n,i){e.dumpTables?e.dumpTables(t).then(function(t){o=r({},o,t),i(o)}):i()}).then(function(){n(o)})})},t.prototype.rawImport=function(t,e){var n=this;return new u.e(function(r,i){u.fastCHAIN(n.plugins,function(n,r,i){n.importTables?n.importTables(t,e||function(t){}).then(i):i()}).then(function(){r()})})},t.prototype.disconnect=function(){return u.fastCHAIN(this.plugins,function(t,e,n){t.willDisconnect?t.willDisconnect(n):n()})},t.prototype.doTransaction=function(t){var e=this,n=this,i=[],o=u.random16Bits().toString(16);return new u.e(function(a,c){if(n.plugins.length){var f=function(){u.fastCHAIN(n.plugins,function(t,e,n){t.transactionBegin?t.transactionBegin(o,n):n()}).then(function(){Array.isArray(n.sTable)||t(function(t){var e=t||n.sTable;return{query:function(t,n){return new s.lt(t,n,e,i,o)}}},function(){var t=[];u.fastCHAIN(i,function(e,i,s){t.push(e.table),n.query(e.action,e.actionArgs).manualExec(r({},e,{table:e.table,transaction:!0,queryID:o})).then(s)}).then(function(r){u.fastCHAIN(e.plugins,function(t,e,n){t.transactionEnd?t.transactionEnd(o,n):n()}).then(function(){t.filter(function(t,e,n){return n.indexOf(t)===e}).forEach(function(t){0!==t.indexOf("_")&&n.triggerEvent({query:i[0],table:t,time:(new Date).getTime(),result:r,types:["transaction"],actionOrView:"",notes:[],transactionID:o,affectedRowPKS:[],affectedRows:[]})}),a(r)})})})})};e.isConnected?f():e.onConnected(f)}else c("nSQL: Nothing to do, no plugins!")})},t.prototype.config=function(t){return this.ot=t,this},t.prototype.observable=function(t,e){return new l.Observer(this,t,e||[])},t.prototype.extend=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r=this;return new u.e(function(n,i){var o=function(){if(r.plugins.length){var t=e,o=[];u.fastCHAIN(r.plugins,function(e,n,r){e.extend?e.extend(function(e,n){t=e,o=n,r()},t,o):r()}).then(function(){n(o)})}else i("No plugins!")};if("beforeConn"===e[0])return e.shift(),void o();t.isConnected?o():t.onConnected(o)})},t.prototype.loadJS=function(t,e,n,r){var i=this;return n?this.doTransaction(function(n,r){e.forEach(function(e){n(t).query("upsert",e).exec()}),r()}):new u.e(function(n,o){u.fastCHAIN(e,function(n,o,s){r&&r(Math.round((o+1)/e.length*1e4)/100),i.query("upsert",n).manualExec({table:t}).then(s)}).then(function(t){n(t.map(function(t){return t.shift()}))})})},t.prototype.JSONtoCSV=function(t,e,n){var r=[];if(!t.length)return"";var i=[];return n?i=n:t.forEach(function(t){i=u.removeDuplicates(Object.keys(t).concat(i))}),e&&r.push(i.join(",")),t.forEach(function(t){r.push(i.map(function(e){return null===t[e]||void 0===t[e]?"":"string"==typeof t[e]?'"'+t[e].replace(/\"/g,'""')+'"':"boolean"==typeof t[e]?!0===t[e]?"true":"false":"object"==typeof t[e]?'"'+JSON.stringify(t[e]).replace(/\"/g,"'")+'"':t[e]}).join(","))}),r.join("\r\n")},t.prototype.CSVtoJSON=function(t,e){var n=[];return t.split(/\r?\n|\r|\t/gm).map(function(t,r){if(0!==r){var i={},o=t.match(/(,)|(["|\[|\{].*?["|\]|\}]|[^",\s]+)(?=\s*,|\s*$)/g)||[],s=!1;","===o[0]&&o.unshift("");for(var a=function(){var t=!1;if(o.forEach(function(e,n){t||","===e&&(void 0!==o[n+1]&&","!==o[n+1]||(t=!0,o.splice(n+1,0,"")))}),t)return"break";s=!0};!s&&"break"!==a(););o=o.filter(function(t,e){return e%2==0});for(var u=n.length;u--;)o[u]&&("true"===o[u]||"false"===o[u]?i[n[u]]="true"===o[u]:1===o[u].indexOf("{")||1===o[u].indexOf("[")?i[n[u]]=JSON.parse(o[u].slice(1,o[u].length-1).replace(/'/gm,'"')):0===o[u].indexOf('"')?i[n[u]]=o[u].slice(1,o[u].length-1).replace(/\"\"/gim,'"'):i[n[u]]=o[u]);return e?e(i):i}n=t.split(",")}).filter(function(t){return t})},t.prototype.loadCSV=function(t,e,n,r,i){var o=this,s=this.CSVtoJSON(e,r);return n?this.doTransaction(function(e,n){s.forEach(function(n){e(t).query("upsert",n).exec()}),n()}):new u.e(function(e,n){u.fastCHAIN(s,function(e,n,r){i&&i(Math.round((n+1)/s.length*1e4)/100),o.query("upsert",e).manualExec({table:t}).then(r)}).then(function(t){e(t.map(function(t){return t.shift()}))})})},t.earthRadius=6371,t}();e.NanoSQLInstance=y;var b={};y.whereFunctions={levenshtein:function(t,e,n,r){var i=u.objQuery(r,t,e)||"",o=i+"::"+n;return b[o]||(b[o]=h(i,n)),b[o]},arrayObjSrch:function(t,e,n,r,i){var o=u.objQuery(n,t,e);if(Array.isArray(o)&&o.length){var s,a=r.split("=");if(o.forEach(function(t){var e=u.objQuery(a[0],t);e=isNaN(e)?e:parseFloat(e),a[1]=isNaN(a[1])?a[1]:parseFloat(a[1]),e===a[1]&&(s=t)}),void 0!==s)return u.objQuery(i,s)}},crow:function(t,e,n,r,i,o){var s=i||"lat",a=o||"lon",c=u.objQuery(s,t,e),f=u.objQuery(a,t,e);return u.crowDistance(c,f,n,r,y.earthRadius)},sum:function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return n.reduce(function(n,r){var i=u.objQuery(r,t,e)||0;return Array.isArray(i)?n+i.reduce(function(t,e){return t+parseFloat(e||0)},0):n+parseFloat(i)},0)},avg:function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i=0;return n.reduce(function(n,r){var o=u.objQuery(r,t,e)||0;return Array.isArray(o)?(i+=o.length,n+o.reduce(function(t,e){return t+parseFloat(e||0)},0)):(i++,n+parseFloat(o))},0)/i}},y.functions={COUNT:{type:"A",call:function(t,e,n,r){e(r&&"*"!==r?t.filter(function(t){return u.objQuery(r,t,n)}).length:t.length)}},MAX:{type:"A",call:function(t,e,n,r){if(t.length){var i=u.objQuery(r,t[0])||0;t.forEach(function(t){u.objQuery(r,t,n),u.objQuery(r,t)>i&&(i=u.objQuery(r,t,n))}),e(i)}else e(0)}},MIN:{type:"A",call:function(t,e,n,r){if(t.length){var i=u.objQuery(r,t[0],n)||0;t.forEach(function(t){var e=u.objQuery(r,t,n);e<i&&(i=e)}),e(i)}else e(0)}},AVG:{type:"A",call:function(t,e,n,r){e(t.reduce(function(t,e){return t+(u.objQuery(r,e,n)||0)},0)/t.length)}},SUM:{type:"A",call:function(t,e,n,r){e(t.reduce(function(t,e){return t+(u.objQuery(r,e,n)||0)},0))}},LOWER:{type:"S",call:function(t,e,n,r){e(t.map(function(t){return String(u.objQuery(r,t,n)).toLowerCase()}))}},UPPER:{type:"S",call:function(t,e,n,r){e(t.map(function(t){return String(u.objQuery(r,t,n)).toUpperCase()}))}},CAST:{type:"S",call:function(t,e,n,r,i){e(t.map(function(t){return u.cast(i,u.objQuery(r,t,n))}))}},ABS:{type:"S",call:function(t,e,n,r){e(t.map(function(t){return Math.abs(u.objQuery(r,t,n))}))}},CEIL:{type:"S",call:function(t,e,n,r){e(t.map(function(t){return Math.ceil(u.objQuery(r,t,n))}))}},POW:{type:"S",call:function(t,e,n,r,i){e(t.map(function(t){return Math.pow(u.objQuery(r,t,n),parseInt(i))}))}},ROUND:{type:"S",call:function(t,e,n,r){e(t.map(function(t){return Math.round(u.objQuery(r,t,n))}))}},SQRT:{type:"S",call:function(t,e,n,r){e(t.map(function(t){return Math.sqrt(u.objQuery(r,t,n))}))}}};var v=new y;e.nSQL=function(t){return v.table(t)},"undefined"!=typeof window&&(window["nano-sql"]={nSQL:e.nSQL,NanoSQLInstance:y})},function(t,e,n){"use strict";t.exports=function(t,e,n){var o,s,a,u,c,f,h,l;if(t===e)return 0;if(o=t.length,s=e.length,0===o)return s;if(0===s)return o;for(n&&(t=t.toLowerCase(),e=e.toLowerCase()),h=0;h<o;)i[h]=t.charCodeAt(h),r[h]=++h;for(l=0;l<s;)for(a=e.charCodeAt(l),u=c=l++,h=-1;++h<o;)f=a===i[h]?c:c+1,c=r[h],r[h]=u=c>u?f>u?u+1:f:f>c?c+1:f;return u};var r=[],i=[]},,,,,,,,function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),i=n(1),o=function(){function t(t,e,n){this.vt=t,this.dt=e,this.bt=n,this._t=[],this.wt=0,this.ot=[]}return t.prototype.debounce=function(t){return this.ot[this._t.length]=t,this._t.push("dbnc"),this},t.prototype.distinct=function(t,e){return this.ot[this._t.length]=[t||function(t){return t},e||function(t,e){return t===e}],this._t.push("dsct"),this},t.prototype.filter=function(t){return this.ot[this._t.length]=t,this._t.push("fltr"),this},t.prototype.map=function(t){return this.ot[this._t.length]=t,this._t.push("mp"),this},t.prototype.first=function(t){return this.ot[this._t.length]=t||function(t,e){return!0},this._t.push("fst"),this},t.prototype.skip=function(t){return this.ot[this._t.length]=t,this._t.push("skp"),this},t.prototype.take=function(t){return this.ot[this._t.length]=t,this._t.push("tk"),this},t.prototype.subscribe=function(t){var e,n=this,r={},i={},o={},a={};return new s(this.vt,this.dt,{next:function(s,u){if(n.wt++,!e){var c=0,f=function(){if(c===n._t.length)"function"==typeof t?t(s,u):t.next&&t.next(s,u),e&&t.complete&&t.complete(s,u);else{var h=function(t){if(0===n.wt)return 0;for(var e=t,r=n.wt,i=!1;e--&&!i;)void 0!==a[e]&&(i=!0,r=a[e]);return r};switch(n._t[c]){case"dbnc":if(i[c]){clearTimeout(o[c]);var l=n.ot[c];return void(o[c]=setTimeout(function(){Date.now()-i[c]>=l&&(i[c]=Date.now(),void 0===a[c]&&(a[c]=0),a[c]++,c++,f())},l-(Date.now()-i[c])))}i[c]=Date.now();break;case"dsct":var p=n.ot[c][0](s,u);if(!1!==n.ot[c][1](r[c],p))return;r[c]=p,void 0===a[c]&&(a[c]=0),a[c]++;break;case"fltr":if(!1===n.ot[c](s,h(c),u))return;void 0===a[c]&&(a[c]=0),a[c]++;break;case"fst":if(!0!==n.ot[c](s,h(c),u))return;void 0===a[c]&&(a[c]=0),a[c]++,e=!0;break;case"mp":s=n.ot[c](s,h(c),u);break;case"skp":if(h(c)<=n.ot[c])return;break;case"tk":h(c)>=n.ot[c]&&(e=!0)}c++,f()}};f()}},error:function(e){t.error&&t.error(e)}},this.bt)},t}();e.Observer=o;var s=function(){function t(t,e,n,i){var o=this;this.vt=t,this.pt=e,this.yt=n,this.bt=i,this.mt=!1,this.exec=this.exec.bind(this),this.unsubscribe=this.unsubscribe.bind(this);var s=this.pt();s&&(this.bt=r.removeDuplicates(this.bt.concat([s.table])),this.exec()),this.bt.forEach(function(t){o.vt.table(t).on("change",o.exec)})}return t.prototype.exec=function(t){var e=this;i.setFast(function(){var n=e.pt(t);n&&e.vt.query("select").manualExec(n).then(function(n){e.yt.next(n,t)}).catch(function(t){e.yt.error(t)})})},t.prototype.unsubscribe=function(){var t=this;this.bt.forEach(function(e){t.vt.table(e).off("change",t.exec)}),this.mt=!0},t.prototype.closed=function(){return this.mt},t}();e.ObserverSubscriber=s},function(t,e,n){var r=this&&this.C||Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t};Object.defineProperty(e,"__esModule",{value:!0});var i=n(0),o=["_hist","_hist_ptr","_id"],s=function(){function t(t){this.historyModeArgs=t,this.gt={},this.Ot={},this.St={}}return t.prototype.willConnect=function(t,e){var n=this;this.parent=t.parent;var s={};Object.keys(t.models).forEach(function(e){if(0!==e.indexOf("_")){var r=i.u(t.models[e]).map(function(t){return t.props&&i.intersect(["pk","pk()"],t.props)&&(n.gt[e]=t.key,n.Ot[e]=t.type,n.St[e]={}),delete t.props,delete t.default,t});r.unshift({key:"_id",type:"timeIdms",props:["pk()"]}),s["_"+e+"__hist_rows"]=r,s["_"+e+"__hist_idx"]=[{key:"id",type:n.Ot[e],props:["pk()"]},{key:"histRows",type:"timeIdms[]"},{key:"histPtr",type:"number"}]}});var a="string"!=typeof this.historyModeArgs,u=[{key:"id",type:"timeIdms",props:["pk()"]},{key:"table",type:"string"},{key:"keys",type:"any[]"}],c=[{key:"id",type:"timeIdms",props:["pk()"]},{key:"ptr",type:"int"}];"database"!==this.historyModeArgs&&this.historyModeArgs?("database"!==this.historyModeArgs||a)&&(this.historyModes={},a?this.historyModes=i.u(this.historyModeArgs):Object.keys(this.gt).forEach(function(t){n.historyModes[t]=n.historyModeArgs}),Object.keys(this.historyModes).forEach(function(t){"table"===n.historyModes[t]&&(s["_"+t+"__hist"]=u,s["_"+t+"__hist_ptr"]=c)})):(s[o[0]]=u,s[o[1]]=c),t.models=r({},t.models,s),e(t)},t.prototype.jt=function(t){return t?this.historyModes?"table"===this.historyModes[t]?"_"+t+"__hist":null:"_hist":"__null"},t.prototype.kt=function(t,e){var n=this,r=this.jt(t);r?this.parent.query("select").manualExec({table:r+"_ptr"}).then(function(o){o.length?e():n.parent.query("upsert",{id:i.timeid(!0),table:t,ptr:0}).manualExec({table:r+"_ptr"}).then(e)}):e()},t.prototype.didConnect=function(t,e){var n=this,r=function(){i.fastALL(Object.keys(n.St),function(t,e,r){n.parent.extend("beforeConn","idx","_"+t+"__hist_idx").then(function(e){e.forEach(function(e){n.St[t][e]=!0}),n.historyModes?n.kt(t,r):r()})}).then(e)};this.historyModes?r():this.parent.query("select").manualExec({table:"_hist_ptr"}).then(function(t){t.length?r():n.parent.query("upsert",{id:i.timeid(!0),table:"",ptr:0}).manualExec({table:"_hist_ptr"}).then(r)})},t.prototype.Et=function(t,e,n,r){var o=this,s="_"+t+"__hist_rows",a="_"+t+"__hist_idx";i.fastALL(e,function(e,n,u){o.parent.query("select").where(["id","=",e]).manualExec({table:a}).then(function(n){if(n.length){var c=Object.isFrozen(n[0])?i.u(n[0]):n[0],f=[];if(r)f=f.concat(c.histRows.filter(function(t){return-1!==t})),c.histPtr=0,c.histRows=[];else{for(;c.histPtr--;)f.push(c.histRows.shift());c.histPtr=0}f.length?o.parent.query("upsert",c).comment("History Purge").where(["id","=",e]).manualExec({table:a}).then(function(){o.parent.query("delete").comment("History Purge").where(["_id","IN",f]).manualExec({table:s}).then(function(){r?o.parent.query("select").where([o.gt[t],"=",e]).manualExec({table:t}).then(function(n){o.Nt(t,["change"],e,n[0],!1,u)}):u()})}):u()}else u()})}).then(n)},t.prototype.At=function(t,e,n){var r=this;this.parent.query("select").manualExec({table:t+"_ptr"}).then(function(o){var s=Object.isFrozen(o[0])?i.u(o[0]):o[0];if(n||s.ptr>0){var a=r.parent.query("select");n||a.range(-1*s.ptr,0),a.manualExec({table:t}).then(function(o){if(o.length){var a={};o.forEach(function(t){a[t.table]||(a[t.table]=[]),a[t.table]=a[t.table].concat(t.keys)}),i.fastALL(Object.keys(a),function(t,e,i){r.Et(t,a[t],i,n)}).then(function(){r.parent.query("delete").comment("History Purge").where(["id","IN",o.map(function(t){return t.id})]).manualExec({table:t}).then(function(){s.ptr=0,r.parent.query("upsert",s).comment("History Purge").where(["id","=",s.id]).manualExec({table:t+"_ptr"}).then(e)})})}else e()})}else e()})},t.prototype.It=function(t,e,n){if(this.historyModes){var r=this.jt(t);r?this.At(r,n):this.Et(t,e,n)}else this.At("_hist",n)},t.prototype.Tt=function(t,e,n){if(this.historyModes){var r=this.jt(t);r?this.At(r,n,!0):this.Et(t,[e],n,!0)}else this.At("_hist",n,!0)},t.prototype.didExec=function(t,e){var n=this;t.table&&0!==t.table.indexOf("_")&&t.types.indexOf("change")>-1&&-1===t.query.comments.indexOf("History Write")?this.It(t.table,t.affectedRowPKS,function(){i.fastALL(t.affectedRows,function(e,r,i){var o=e[n.gt[t.table]];n.St[t.table][o]?n.Nt(t.table,t.types,o,e,!1,function(t){i(o)}):(n.St[t.table][o]=!0,n.Nt(t.table,t.types,o,e,!0,function(e){n.parent.query("upsert",{id:o,histRows:[e,-1],histPtr:0}).manualExec({table:"_"+t.table+"__hist_idx"}).then(function(){i(o)})}))}).then(function(r){n.Mt(t,r,e)})}):e(t)},t.prototype.Mt=function(t,e,n){var r=this.jt(t.table);r?this.parent.query("upsert",{id:i.timeid(!0),table:t.table,keys:e}).manualExec({table:r}).then(function(){n(t)}):n(t)},t.prototype.Nt=function(t,e,n,s,a,u){var c,f=this,h="_"+t+"__hist_idx",l=i.timeid(!0),p=function(t){f.parent.query("select").where(["id","=",n]).manualExec({table:h}).then(function(e){var r=Object.isFrozen(e[0])||Object.isFrozen(e[0].histRows)?i.u(e[0]):e[0];r.histRows.unshift(t),f.parent.query("upsert",r).where(["id","=",n]).manualExec({table:h}).then(function(){u(t)})})};e.indexOf("delete")>-1||e.indexOf("drop")>-1?p(-1):this.parent.query("upsert",r((c={},c[o[2]]=l,c),s)).manualExec({table:"_"+t+"__hist_rows"}).then(function(){a?u(l):p(l)})},t.prototype.extend=function(t,e,n){if("hist"===e[0]){var r=e[1],i=e[2],o=e[3];switch(r){case"<":case">":this.xt(r,i,o,function(n){t(e,[n])});break;case"?":this.Lt(i,o,function(n){t(e,n)});break;case"rev":this.Rt(i,o,function(n){t(e,n)});break;case"clear":this.Tt(i,o,function(){t(e,n)})}}else t(e,n)},t.prototype.Rt=function(t,e,n){var r=this,s="_"+t+"__hist_idx";this.parent.query("select").where(["id","=",e]).manualExec({table:s}).then(function(e){var s=e[0].histRows.filter(function(t){return-1!==t});r.parent.query("select").where(["_id","IN",s]).manualExec({table:"_"+t+"__hist_rows"}).then(function(t){var r={};t.forEach(function(t){r[t[o[2]]]=Object.isFrozen(t)?i.u(t):t,delete r[t[o[2]]][o[2]]}),n([{pointer:e[0].histRows.length-e[0].histPtr-1,revisions:e[0].histRows.reverse().map(function(t){return-1===t?null:r[t]})}])})})},t.prototype.Ct=function(t,e){var n=this;this.parent.extend("idx.length",t).then(function(r){n.parent.query("select").manualExec({table:t+"_ptr"}).then(function(t){t.length?e([r,r-t[0].ptr]):e([0,0])})})},t.prototype.Lt=function(t,e,n){if(this.historyModes){var r=this.jt(t);if(r){if(!t)throw Error("nSQL: Need a table to query this history!");this.Ct(r,n)}else{if(!e)throw Error("nSQL: Need a row primary key to query this history!");var i="_"+t+"__hist_idx";this.parent.query("select").where(["id","=",e]).manualExec({table:i}).then(function(t){var e=t[0];n([e.histRows.length,e.histRows.length-e.histPtr-1])})}}else this.Ct("_hist",function(t){n(t)})},t.prototype.Dt=function(t,e,n){var r=this;this.parent.query("select").manualExec({table:e+"_ptr"}).then(function(o){var s=i.u(o[0]);s.ptr+="<"===t?1:-1,s.ptr<0&&(s.ptr=0),r.parent.extend("idx.length",e).then(function(a){s.ptr>a&&(s.ptr=a),o[0].ptr!==s.ptr?r.parent.query("select").range(-1,"<"===t?o[0].ptr:s.ptr).manualExec({table:e}).then(function(o){r.parent.query("upsert",s).manualExec({table:e+"_ptr"}).then(function(){i.fastALL(o[0].keys,function(e,n,i){r.Jt(t,o[0].table,e,i)}).then(function(t){n(t.indexOf(!0)>-1)})})}):n(!1)})})},t.prototype.Jt=function(t,e,n,r){var o=this,s=function(t){o.parent.query("upsert",t).where([o.gt[e],"=",n]).manualExec({table:"_"+e+"__hist_idx"}).then(function(){r(!0)})};this.parent.query("select").where([this.gt[e],"=",n]).manualExec({table:"_"+e+"__hist_idx"}).then(function(a){var u=i.u(a[0]);if(u.histPtr+="<"===t?1:-1,u.histPtr<0&&(u.histPtr=0),u.histPtr>u.histRows.length-1&&(u.histPtr=u.histRows.length-1),u.histPtr!==a[0].histPtr){var c=u.histRows[u.histPtr];-1===c?o.parent.query("delete").comment("History Write").where([o.gt[e],"=",n]).manualExec({table:e}).then(function(){s(u)}):o.parent.query("select").where(["_id","=",c]).manualExec({table:"_"+e+"__hist_rows"}).then(function(t){o.parent.query("upsert",t[0]).comment("History Write").manualExec({table:e}).then(function(){s(u)})})}else r(!1)})},t.prototype.xt=function(t,e,n,r){if(this.historyModes){var i=this.jt(e);if(i){if(!e)throw Error("nSQL: Need a table to change this history!");this.Dt(t,i,r)}else{if(!n)throw Error("nSQL: Need a row primary key to change this history!");this.Jt(t,e,n,r)}}else this.Dt(t,"_hist",r)},t}();e.ut=s},function(t,e){function n(){this.tt=this.tt||{},this.Pt=this.Pt||void 0}function r(t){return"function"==typeof t}function i(t){return"object"==typeof t&&null!==t}function o(t){return void 0===t}t.exports=n,n.EventEmitter=n,n.prototype.tt=void 0,n.prototype.Pt=void 0,n.defaultMaxListeners=10,n.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw TypeError("n must be a positive number");return this.Pt=t,this},n.prototype.emit=function(t){var e,n,s,a,u,c;if(this.tt||(this.tt={}),"error"===t&&(!this.tt.error||i(this.tt.error)&&!this.tt.error.length)){if((e=arguments[1])instanceof Error)throw e;var f=new Error('Uncaught, unspecified "error" event. ('+e+")");throw f.context=e,f}if(o(n=this.tt[t]))return!1;if(r(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:a=Array.prototype.slice.call(arguments,1),n.apply(this,a)}else if(i(n))for(a=Array.prototype.slice.call(arguments,1),s=(c=n.slice()).length,u=0;u<s;u++)c[u].apply(this,a);return!0},n.prototype.addListener=function(t,e){var s;if(!r(e))throw TypeError("listener must be a function");return this.tt||(this.tt={}),this.tt.newListener&&this.emit("newListener",t,r(e.listener)?e.listener:e),this.tt[t]?i(this.tt[t])?this.tt[t].push(e):this.tt[t]=[this.tt[t],e]:this.tt[t]=e,i(this.tt[t])&&!this.tt[t].warned&&(s=o(this.Pt)?n.defaultMaxListeners:this.Pt)&&s>0&&this.tt[t].length>s&&(this.tt[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this.tt[t].length),"function"==typeof console.trace&&console.trace()),this},n.prototype.on=n.prototype.addListener,n.prototype.once=function(t,e){if(!r(e))throw TypeError("listener must be a function");var n=!1;function i(){this.removeListener(t,i),n||(n=!0,e.apply(this,arguments))}return i.listener=e,this.on(t,i),this},n.prototype.removeListener=function(t,e){var n,o,s,a;if(!r(e))throw TypeError("listener must be a function");if(!this.tt||!this.tt[t])return this;if(s=(n=this.tt[t]).length,o=-1,n===e||r(n.listener)&&n.listener===e)delete this.tt[t],this.tt.removeListener&&this.emit("removeListener",t,e);else if(i(n)){for(a=s;a-- >0;)if(n[a]===e||n[a].listener&&n[a].listener===e){o=a;break}if(o<0)return this;1===n.length?(n.length=0,delete this.tt[t]):n.splice(o,1),this.tt.removeListener&&this.emit("removeListener",t,e)}return this},n.prototype.removeAllListeners=function(t){var e,n;if(!this.tt)return this;if(!this.tt.removeListener)return 0===arguments.length?this.tt={}:this.tt[t]&&delete this.tt[t],this;if(0===arguments.length){for(e in this.tt)"removeListener"!==e&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this.tt={},this}if(r(n=this.tt[t]))this.removeListener(t,n);else if(n)for(;n.length;)this.removeListener(t,n[n.length-1]);return delete this.tt[t],this},n.prototype.listeners=function(t){return this.tt&&this.tt[t]?r(this.tt[t])?[this.tt[t]]:this.tt[t].slice():[]},n.prototype.listenerCount=function(t){if(this.tt){var e=this.tt[t];if(r(e))return 1;if(e)return e.length}return 0},n.listenerCount=function(t,e){return t.listenerCount(e)}},function(t,e){"function"==typeof Object.create?t.exports=function(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function(t,e){t.super_=e;var n=function(){};n.prototype=e.prototype,t.prototype=new n,t.prototype.constructor=t}},function(t,e,n){var r=n(20),i=n(19).EventEmitter;function o(t){if(!(this instanceof o))return new o(t);i.call(this),t=t||{},this.concurrency=t.concurrency||1/0,this.timeout=t.timeout||0,this.autostart=t.autostart||!1,this.results=t.results||null,this.pending=0,this.session=0,this.running=!1,this.jobs=[],this.timers={}}function s(t){this.session++,this.running=!1,this.emit("end",t)}t.exports=o,r(o,i),["pop","shift","indexOf","lastIndexOf"].forEach(function(t){o.prototype[t]=function(){return Array.prototype[t].apply(this.jobs,arguments)}}),o.prototype.slice=function(t,e){return this.jobs=this.jobs.slice(t,e),this},o.prototype.reverse=function(){return this.jobs.reverse(),this},["push","unshift","splice"].forEach(function(t){o.prototype[t]=function(){var e=Array.prototype[t].apply(this.jobs,arguments);return this.autostart&&this.start(),e}}),Object.defineProperty(o.prototype,"length",{get:function(){return this.pending+this.jobs.length}}),o.prototype.start=function(t){if(t&&function(t){var e=this;function n(t){e.end(t)}this.on("error",n),this.on("end",function r(i){e.removeListener("error",n),e.removeListener("end",r),t(i,this.results)})}.call(this,t),this.running=!0,!(this.pending>=this.concurrency))if(0!==this.jobs.length){var e=this,n=this.jobs.shift(),r=!0,i=this.session,o=null,a=!1,u=null;this.timeout&&(o=setTimeout(function(){a=!0,e.listeners("timeout").length>0?e.emit("timeout",f,n):f()},this.timeout),this.timers[o]=o),this.results&&(u=this.results.length,this.results[u]=null),this.pending++;var c=n(f);c&&c.then&&"function"==typeof c.then&&c.then(function(t){f(null,t)}).catch(function(t){f(t||!0)}),this.running&&this.jobs.length>0&&this.start()}else 0===this.pending&&s.call(this);function f(t,c){r&&e.session===i&&(r=!1,e.pending--,null!==o&&(delete e.timers[o],clearTimeout(o)),t?e.emit("error",t,n):!1===a&&(null!==u&&(e.results[u]=Array.prototype.slice.call(arguments,1)),e.emit("success",c,n)),e.session===i&&(0===e.pending&&0===e.jobs.length?s.call(e):e.running&&e.start()))}},o.prototype.stop=function(){this.running=!1},o.prototype.end=function(t){(function(){for(var t in this.timers){var e=this.timers[t];delete this.timers[t],clearTimeout(e)}}).call(this),this.jobs.length=0,this.pending=0,s.call(this,t)}},function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(e){this.Ht=t.Ft(e)}return t.prototype.getIndex=function(){return this.Ht},t.prototype.setIndex=function(t){this.Ht=t},t.prototype.addWord=function(e){return e.toLowerCase().split("").reduce(function(e,n,r,i){return t.Qt(e,n,r,i)},this.Ht),this},t.prototype.removeWord=function(e){var n=t.$t(this.Ht,e),r=n.prefixFound,i=n.prefixNode;return r&&delete i.$,this},t.prototype.getWords=function(){return t.Wt(this.Ht,"")},t.prototype.getPrefix=function(e){if(e=e.toLowerCase(),!this.qt(e))return[];var n=t.$t(this.Ht,e).prefixNode;return t.Wt(n,e)},t.prototype.qt=function(e){return t.$t(this.Ht,e).prefixFound},t.Qt=function(t,e,n,r){return t[e]=t[e]||{},t=t[e],n===r.length-1&&(t.$=1),t},t.$t=function(t,e){return{prefixFound:e.toLowerCase().split("").every(function(e,n){return!!t[e]&&(t=t[e])}),prefixNode:t}},t.Ft=function(e){return(e||[]).reduce(function(e,n){return n.toLowerCase().split("").reduce(t.Qt,e),e},{})},t.Wt=function(e,n,r){void 0===r&&(r=[]);var i=n;for(var o in e)"$"===o&&(r.push(i),i=""),t.Wt(e[o],n+o,r);return r.sort()},t}();e.Trie=n},function(t,e,n){var r=this&&this.C||Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t};Object.defineProperty(e,"__esModule",{value:!0});var i=n(22),o=n(0),s=n(5),a=n(4),u=n(3),c=n(1),f=n(21),h=function(t){return{qs:{},add:function(e,n){t.queue.qs[e]||(t.queue.qs[e]=f({autostart:!0,concurrency:1})),t.queue.qs[e].push(function(t){c.setFast(function(){return n(t)})})}}},l=function(){function t(t,e){var n=this;if(this.zt=[],this.Bt={},this.Kt={},this.Ut=t,this.Vt=e.persistent?"PERM":e.mode||"TEMP",this.H=e.id,this.P=e.size||5,this.queue=h(this),this.adapters=[],this.models={},this.tableInfo={},this.Gt={},this.zt=[],this.Xt=void 0===e.cache||e.cache,this.Yt={},this.Xt&&e.peer&&"undefined"!=typeof window){var r=t.sTable;t.table("*").on("peer-change",function(t){n.Yt[t.table]={}}),t.table(r)}if(this.adapters[0]={adapter:null,waitForWrites:!0},"string"==typeof this.Vt)switch("PERM"===this.Vt&&(this.Vt=this.Zt()||this.Vt),this.Vt){case"IDB":case"IDB_WW":this.adapters[0].adapter=new a.K;break;case"WSQL":this.adapters[0].adapter=new u.W(this.P);break;case"LS":this.adapters[0].adapter=new s.G(!0);break;case"TEMP":this.adapters[0].adapter=new s.G(!1)}else this.adapters[0].adapter=this.Vt}return t.prototype.tn=function(){var t=this;if(this.Xt&&!this.nn&&Object.keys(this.Kt).length){this.nn=!0;var e=o.u(this.Kt);this.Kt={},o.fastALL(Object.keys(e),function(n,r,i){var s=e[n];o.fastALL(s,function(e,r,i){t.adapterWrite(n,e,o.u(t.Bt[n].rows[e]),i)}).then(i)}).then(function(){setTimeout(function(){t.nn=!1,t.tn()},100)})}},t.prototype.init=function(t,e){var n=this;this.H||(this.H=o.hash(JSON.stringify(t)).toString()),this.models=this.in(t),this.zt=Object.keys(this.models),this.adapters.forEach(function(t){t.adapter.setID(n.H)}),this.zt.forEach(function(e){n.rn(e,t[e])}),this.en={},this.un={},this.sn={},this.cn={},this.zt.forEach(function(t){n.tableInfo[t].an=Object.keys(n.tableInfo).reduce(function(e,r){return r===t?e:(-1!==Object.keys(n.tableInfo[r].Z).indexOf(t)&&e.push({table:r,column:n.tableInfo[r].Z[t].pkColumn}),e)},[]);var e=n.models[t].length;n.en[t]={},n.sn[t]=[],n.un[t]=[],n.cn[t]={};for(var r=function(){var r=n.models[t][e];if(-1!==n.zt.indexOf(r.type.replace("[]",""))){var i="";n.cn[t][r.key]={hn:r.type.replace("[]",""),ln:-1===r.type.indexOf("[]")?"single":"array"},r.props&&(r.props.forEach(function(t){-1!==t.indexOf("ref=>")&&(i=t.replace("ref=>","")),0===t.indexOf("orm(")&&(i=t.replace(/orm\((.*)\)/gim,"$1"))}),i&&(n.vn=!0,n.sn[t].push(r.key),n.en[t][r.key]={hn:r.type.replace("[]",""),dn:i.replace("[]",""),bn:-1===i.indexOf("[]")?"single":"array",ln:-1===r.type.indexOf("[]")?"single":"array"}))}};e--;)r()}),Object.keys(this.en).forEach(function(t){Object.keys(n.en[t]).forEach(function(e){var r=n.en[t][e];n.un[r.hn].push({_n:r.dn,ln:r.bn,wn:t,pn:e,yn:r.ln})})}),o.fastALL(this.adapters,function(t,e,r){t.adapter.connect(function(){t.adapter.setNSQL&&t.adapter.setNSQL(n.Ut),r()})}).then(function(){o.fastALL(Object.keys(n.Gt),function(t,e,r){var i=n.Gt[t];Object.keys(i).length?o.fastALL(Object.keys(i),function(e,r,i){var o="_"+t+"_idx_"+e;n.adapters[0].adapter.getIndex(o,!1,function(r){r.forEach(function(r){n.Gt[t][e].addWord(String(r))}),i()})}).then(r):r()}).then(function(){n.Xt?o.fastALL(Object.keys(n.tableInfo),function(t,e,r){o.fastALL(n.tableInfo[t].Bt,function(e,r,i){var o="_"+t+"_idx_"+e;n.adapters[0].adapter.getIndex(o,!1,function(t){n.Bt[o].idx=t,n.adapters[0].adapter.rangeRead(o,function(t,e,r){n.Bt[o].rows[t.id]=t,r()},i)})}).then(r)}).then(function(){e(n.models)}):e(n.models)})})},t.prototype.rebuildIndexes=function(t,e){var n=this,r=(new Date).getTime();o.fastALL(Object.keys(this.tableInfo),function(e,r,i){if("_ALL_"!==t&&t!==e||0===e.indexOf("_"))i();else{var s=n.tableInfo[e].Bt;o.fastALL(s,function(t,r,i){var o="_"+e+"_idx_"+t;n.Bt[o].idx=[],n.Bt[o].rows={},n.Kt[o]=[],n.mn(o,i)}).then(function(){var t=n.tableInfo[e].gn,r={};s.forEach(function(t){r[t]={}}),n.On(e,function(e,n,i){e[t]?(s.forEach(function(n){e[n]&&(r[n][e[n]]||(r[n][e[n]]=[]),r[n][e[n]].push(e[t]))}),i(!1)):i(!1)},function(){o.fastALL(s,function(t,i,s){var a="_"+e+"_idx_"+t;n.Xt?(Object.keys(r[t]).forEach(function(e,i){n.Kt[a].push(e),n.Bt[a].idx.push(e),n.Bt[a].rows[e]={id:e,rows:r[t][e]}}),s()):o.fastALL(Object.keys(r[t]),function(e,i,o){n.adapterWrite(a,e,{id:e,rows:r[t][e].sort()},o)}).then(s)}).then(function(){i()})})})}}).then(function(){n.Xt&&n.tn(),e((new Date).getTime()-r)})},t.prototype.Sn=function(t){return o.isObject(t)||Array.isArray(t)?JSON.stringify(t).substr(0,12):"number"==typeof t?t:String(t).substr(0,32)},t.prototype.Zt=function(){return"undefined"==typeof window?"LVL":o.isSafari?"WSQL":"undefined"!=typeof indexedDB?"IDB":"undefined"!=typeof window&&void 0!==window.openDatabase?"WSQL":"LS"},t.prototype.jn=function(t,e,n,r,i){var o=this,s=function(t,e,n){o.Xt?n(e.map(function(e){return o.Bt[t].rows[e]}).filter(function(t){return t})):1===e.length?o.adapters[0].adapter.read(t,e[0],function(t){n([t])}):o.On(t,e,function(t){n(t)})};switch(e){case"=":s("_"+t+"_idx_"+n,[this.Sn(r)],function(e){void 0!==e[0]&&null!==e[0]?o.On(t,e[0].rows||[],function(t){i(t)}):i([])});break;default:!function(t,e){o.Xt?e(o.Bt[t].idx):o.adapters[0].adapter.getIndex(t,!1,e)}("_"+t+"_idx_"+n,function(a){var u=o.Sn(r),c=a.filter(function(t){switch(e){case">":return t>u;case">=":return t>=u;case"<":return t<u;case"<=":return t<=u}return!1});c.length?s("_"+t+"_idx_"+n,c,function(e){var n=[].concat.apply([],e.map(function(t){return t.rows}));n.length?o.On(t,n,function(t){i(t)}):i([])}):i([])})}},t.prototype.kn=function(t,e,n,r,i){var o=[];this.adapters[0].adapter.rangeRead(t,function(t,e,n){o.push(t),n()},function(){i(o)},e,n,r)},t.prototype.On=function(t,e,n){var r=this;if(Array.isArray(e)){var i=this.adapters[0].adapter.batchRead;i?i.apply(this.adapters[0].adapter,[t,e,n]):o.fastALL(e,function(e,n,i){r.adapters[0].adapter.read(t,e,i)}).then(function(t){n(t.filter(function(t){return t}))})}else{var s=[];"function"!=typeof e||this.adapters[0].adapter.rangeRead(t,function(t,n,r){e(t,n,function(e){e&&s.push(t),r()})},function(){n(s)})}},t.prototype.En=function(t,e,n,r){var i=this,s=this.Gt[t][e].getPrefix(n);o.fastALL(s,function(n,r,o){i.jn(t,"=",e,n,o)}).then(function(t){r([].concat.apply([],t))})},t.prototype.Nn=function(t,e,n,r,i){var s=this;this.Xt?(r.forEach(function(r){var i="_"+t+"_idx_"+r,o=s.Sn(n[r]);s.Kt[i]||(s.Kt[i]=[]),-1===s.Kt[i].indexOf(o)&&s.Kt[i].push(o);var a=s.Bt[i].rows[o];if(a){var u=a.rows.indexOf(e);if(-1!==u){var c=a||{id:o,rows:[]};c.rows.splice(u,1),s.Bt[i].rows[o]=c}}}),this.tn(),i()):o.fastALL(r,function(r,i,a){var u=s.Sn(n[r]),c="_"+t+"_idx_"+r;s.adapters[0].adapter.read(c,u,function(t){if(t){var n=t.rows.indexOf(e);if(-1!==n){var r=t?Object.isFrozen(t)?o.u(t):t:{id:u,rows:[]};r.rows.splice(n,1),s.adapterWrite(c,r.id,r,a)}else a()}else a()})}).then(i)},t.prototype.An=function(t,e,n,r,i){var s=this;this.Xt?(r.forEach(function(r,i){var a=s.Sn(n[r]);if(void 0!==a&&("string"!=typeof a||a.length)){s.Gt[t][r]&&s.Gt[t][r].addWord(String(n[r]));var u="_"+t+"_idx_"+r;s.Kt[u]||(s.Kt[u]=[]),-1===s.Kt[u].indexOf(a)&&s.Kt[u].push(a);var c=s.Bt[u].rows[a];if(!c)if(c={id:a,rows:[]},s.Bt[u].sortIdx){var f=o.binarySearch(s.Bt[u].idx,a);s.Bt[u].idx.splice(f,0,a)}else s.Bt[u].idx.push(a);c.rows.push(e),s.Bt[u].rows[a]=c}}),this.tn(),i&&i()):o.fastALL(r,function(r,i,a){var u=s.Sn(n[r]);if(void 0!==u)if("string"!=typeof u||u.length){s.Gt[t][r]&&s.Gt[t][r].addWord(String(n[r]));var c="_"+t+"_idx_"+r;s.adapters[0].adapter.read(c,u,function(t){var n=t?Object.isFrozen(t)?o.u(t):t:{id:u,rows:[]};n.rows.push(e),s.adapterWrite(c,u,n,a)})}else a();else a()}).then(function(){i&&i()})},t.prototype.In=function(t,e,n,i,s){var a,u=this;if(n){var c=r({},n,i,((a={})[this.tableInfo[t].gn]=e,a)),f=this.tableInfo[t].Bt.filter(function(t){return-1===Object.keys(c).filter(function(t){return c[t]===n[t]}).indexOf(t)});this.tableInfo[t].Bt.length?o.fastALL([0,1,2],function(r,i,o){switch(r){case 0:u.Nn(t,e,n,f,o);break;case 1:u.An(t,e,c,f,o);break;case 2:u.adapterWrite(t,e,c,o)}}).then(function(t){s(t[2])}):this.adapterWrite(t,e,c,function(t){s(t)})}else this.adapterWrite(t,e,i,function(e){u.tableInfo[t].Bt.length?u.An(t,e[u.tableInfo[t].gn],i,u.tableInfo[t].Bt,function(){s(e)}):s(e)})},t.prototype.Tn=function(t,e,n){var r=this;if(!e)throw new Error("nSQL: Can't delete without a primary key!");this.adapters[0].adapter.read(t,e,function(i){o.fastALL([0,1],function(n,o,s){switch(n){case 0:r.Nn(t,e,i,r.tableInfo[t].Bt,s);break;case 1:r.adapterDelete(t,e,s)}}).then(function(){n(i)})})},t.prototype.mn=function(t,e){var n=this,r=Object.keys(this.tableInfo[t].Mn).map(function(e){return"_"+t+"_search_tokens_"+e});r=(r=r.concat(Object.keys(this.tableInfo[t].Mn).map(function(e){return"_"+t+"_search_"+e}))).concat(Object.keys(this.tableInfo[t].Mn).map(function(e){return"_"+t+"_search_fuzzy_"+e}));var s=this.tableInfo[t].Bt.map(function(e){return"_"+t+"_idx_"+e});r=r.concat(s),this.Xt&&s.forEach(function(t){n.Bt[t].idx=[],n.Bt[t].rows={}}),o.fastALL(r,function(t,e,r){n.adapterDrop(t,r)}).then(function(){n.Gt[t]={},n.tableInfo[t].xn.forEach(function(e){n.Gt[t][e]=new i.Trie([])}),n.adapterDrop(t,e)})},t.prototype.in=function(t){return Object.keys(t).forEach(function(e){var n=!1,r=!1,i="";if(t[e].forEach(function(s){if(s.props&&s.props.length){if(o.intersect(["pk","pk()"],s.props)&&(i=s.key),o.intersect(["trie","idx","idx()","trie()"],s.props)){n=!0;var a=-1!==["number","float","int"].indexOf(s.type);t["_"+e+"_idx_"+s.key]=[{key:"id",type:a?s.type:"string",props:["pk()"]},{key:"rows",type:"any[]"}]}s.props.forEach(function(n){-1!==n.indexOf("search(")&&(r=!0,t["_"+e+"_search_"+s.key]=[{key:"wrd",type:"string",props:["pk()","ns()"]},{key:"rows",type:"any[]"}],t["_"+e+"_search_fuzzy_"+s.key]=[{key:"wrd",type:"string",props:["pk()","ns()"]},{key:"rows",type:"any[]"}],t["_"+e+"_search_tokens_"+s.key]=[{key:"id",type:i,props:["pk()","ns()"]},{key:"hash",type:"string"},{key:"tokens",type:"any[]"}])})}}),(n||r)&&!i)throw new Error("nSQL: Tables with secondary indexes or search() must have a primary key!")}),t},t.prototype.rn=function(t,e){var n=this;this.tableInfo[t]={gn:"",Ln:"",Rn:[],Cn:[],Bt:[],Dn:!1,xn:[],Jn:t,Z:{},an:[],Mn:{}},this.Yt[t]={},this.Gt[t]={},this.adapters.forEach(function(n){n.adapter.makeTable(t,e)});for(var r=this.models[t].length,s=function(){var e=a.models[t][r];if(a.tableInfo[t].Rn.unshift(e.key),void 0!==e.default&&(a.tableInfo[t].Cn[e.key]=e.default,a.tableInfo[t].Dn=!0),e.props&&e.props.length){var s=!1;e.props.forEach(function(r){if(-1!==r.indexOf("from=>")){n.Pn=!0;var i=e.type;"from=>GHOST"!==r&&"from=>LIVE"!==r&&(i=r.replace("from=>","").split(".").shift()),n.tableInfo[t].Z[i]||(n.tableInfo[t].Z[i]={pkColumn:"",mode:"",columns:[]}),"from=>GHOST"===r||"from=>LIVE"===r?(s=!0,n.tableInfo[t].Z[i].pkColumn=e.key,n.tableInfo[t].Z[i].mode=r.replace("from=>","")):n.tableInfo[t].Z[i].columns.push({thisColumn:e.key,otherColumn:r.replace("from=>","").split(".").pop()})}0===r.indexOf("search(")&&(n.tableInfo[t].Mn[e.key]=r.replace(/search\((.*)\)/gim,"$1").split(",").map(function(t){return t.trim()}))}),o.intersect(["pk","pk()"],e.props)&&(a.tableInfo[t].gn=e.key,a.tableInfo[t].Ln=e.type),(o.intersect(["trie","idx","idx()","trie()"],e.props)||s)&&(a.tableInfo[t].Bt.push(e.key),a.Bt["_"+t+"_idx_"+e.key]={idx:[],rows:[],sortIdx:-1!==["number","int","float"].indexOf(e.type)}),o.intersect(["trie","trie()"],e.props)&&(a.tableInfo[t].xn.push(e.key),a.Gt[t][e.key]=new i.Trie([]))}},a=this;r--;)s();return t},t.prototype.adapterRead=function(t,e,n,r){this.adapters[0].adapter.read(t,e,function(t){n(t)})},t.prototype.adapterWrite=function(t,e,n,r,i){var s;o.fastALL(this.adapters,function(r,i,o){r.waitForWrites?r.adapter.write(t,e,n,function(t){s=t,o()}):(o(),r.adapter.write(t,e,n,function(t){}))}).then(function(){r(s)}).catch(function(t){i&&i(t)})},t.prototype.adapterDelete=function(t,e,n,r){o.fastALL(this.adapters,function(n,r,i){n.waitForWrites?n.adapter.delete(t,e,function(){i()}):(i(),n.adapter.delete(t,e,function(){}))}).then(function(){n()}).catch(function(t){r&&r(t)})},t.prototype.adapterDrop=function(t,e,n){o.fastALL(this.adapters,function(e,n,r){e.waitForWrites?e.adapter.drop(t,function(){r()}):(r(),e.adapter.drop(t,function(){}))}).then(function(){e()}).catch(function(t){n&&n(t)})},t}();e.Hn=l},function(t,e,n){"use strict";t.exports=function(t,e){var n=e.length,r=t.length;if(r>n)return!1;if(r===n)return t===e;t:for(var i=0,o=0;i<r;i++){for(var s=t.charCodeAt(i);o<n;)if(e.charCodeAt(o++)===s)continue t;return!1}return!0}},function(t,e,n){var r=this&&this.C||Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t};Object.defineProperty(e,"__esModule",{value:!0});var i=n(8),o=n(0),s=n(24),a=n(9),u={select:function(t,e){t.Fn(e)},upsert:function(t,e){t.Qn.Xt?t.$n(e):t.Qn.queue.add(t.dt.table,function(n){t.$n(function(){n(),e(t.dt)})})},delete:function(t,e){t.Qn.Xt?t.Tn(e):t.Qn.queue.add(t.dt.table,function(n){t.Tn(function(){n(),e(t.dt)})})},drop:function(t,e){t.Qn.Xt?t.mn(e):t.Qn.queue.add(t.dt.table,function(n){t.mn(function(){n(),e(t.dt)})})},"show tables":function(t,e){t.dt.result=Object.keys(t.Qn.tableInfo),e(t.dt)},describe:function(t,e){"string"==typeof t.dt.table?(t.dt.result=t.Qn.models[t.dt.table]?o.u(t.Qn.models[t.dt.table]):[{error:"Table does not exist"}],e(t.dt)):e(t.dt)}},c=function(){function t(t){this.Qn=t}return t.prototype.doQuery=function(t,e){this.dt=t,this.Wn=Array.isArray(t.table),u[t.action](this,e)},t.prototype.qn=function(t){this.Wn?new l(this.dt,this.Qn.Ut).getRows(t):new h(this,this.dt,this.Qn,function(e){t(e.filter(function(t){return t}))})},t.prototype.Fn=function(t){var e=this;this.zn=JSON.stringify(r({},this.dt,{queryID:null}));var n=!this.dt.join&&!this.dt.orm&&this.Qn.Xt&&!Array.isArray(this.dt.table);this.qn(function(r){["having","orderBy","offset","limit","actionArgs","groupBy","orm","join"].filter(function(t){return e.dt[t]}).length?new f(e.dt,e.Qn).Bn(r,function(i){n&&(e.Qn.Yt[e.dt.table][e.zn]=r),e.dt.result=i,t(e.dt)}):(n&&(e.Qn.Yt[e.dt.table][e.zn]=r),e.dt.result=r,t(e.dt))})},t.prototype.Kn=function(t,e,n,r,i){var s=this;this.Qn.tableInfo[t.wn].gn,this.Qn.On(t.wn,e,function(e){o.fastALL(e,function(e,i,a){var u=Object.isFrozen(e)?o.u(e):e;if("array"===t.yn){u[t.pn]=u[t.pn]||[];var c=u[t.pn].indexOf(r);n?-1===c?u[t.pn].push(r):a():-1!==c?u[t.pn].splice(c,1):a(),u[t.pn].sort()}else u[t.pn]=n?r:null;s.Qn.Ut.query("upsert",u).comment("_orm_skip").manualExec({table:t.wn}).then(a)}).then(i)})},t.prototype.Un=function(t,e,n,r){var i=this;if(this.Qn.vn){var s=this.Qn.un[this.dt.table];if(-1===this.dt.comments.indexOf("_orm_skip"))if(s&&s.length){for(var a=Math.max(e.length,n.length),u=[];a--;)u.push(" ");o.fastCHAIN(u,function(r,a,u){o.fastALL(s,function(r,s,u){var c,f;switch(t){case"del":var h=e[a][i.Qn.tableInfo[i.dt.table].gn],l="array"===r.ln?e[a][r._n]||[]:[e[a][r._n]].filter(function(t){return t});i.Kn(r,l,!1,h,u);break;case"add":var p=n[a][i.Qn.tableInfo[i.dt.table].gn];if(e[a])if(c=e[a][r._n],f=n[a][r._n],Array.isArray(c)&&Array.isArray(f)?c.length===f.length&&c.filter(function(t,e){return t!==f[e]}).length>0:c===f)u();else if("array"===r.ln){var d=(n[a][r._n]||[]).filter(function(t){return-1===(e[a][r._n]||[]).indexOf(t)}),y=(e[a][r._n]||[]).filter(function(t){return-1===(n[a][r._n]||[]).indexOf(t)});o.fastALL([d,y],function(t,e,n){i.Kn(r,t,0===e,p,n)}).then(u)}else{var b=function(){null!==n[a][r._n]&&void 0!==n[a][r._n]?i.Kn(r,[n[a][r._n]],!0,p,u):u()};null!==e[a][r._n]&&void 0!==e[a][r._n]?i.Kn(r,[e[a][r._n]],!1,p,b):b()}else{var v="array"===r.ln?n[a][r._n]||[]:[n[a][r._n]].filter(function(t){return t});v&&v.length?i.Kn(r,v,!0,p,u):u()}}}).then(u)}).then(r)}else r();else r()}else r()},t.prototype.Vn=function(t,e){var n=this.Qn.tableInfo[this.dt.table].Mn[t];if(!n)return[];var r=this.Qn.Ut.getConfig().tokenizer;if(r){var i=r(this.dt.table,t,n,e);if(!1!==i)return i}return o.tokenizer(this.dt.table,t,n,e)},t.prototype.Gn=function(t,e,n){var r=this,i=this.dt.table,s=Object.keys(this.Qn.tableInfo[i].Mn);if(0!==s.length){var a="_"+i+"_search_tokens_";o.fastALL(s,function(n,s,u){var c={};r.Vn(n,e[n]).forEach(function(t){c[t.w]=t.o}),r.Qn.adapterRead(a+n,t,function(e){e?o.fastALL(["_search_","_search_fuzzy_"],function(s,a,u){var f={};e.tokens.forEach(function(t){f[t.w]||(0===a&&(f[t.w]=!0),1===a&&(f[c[t.w]]=!0))}),o.fastALL(Object.keys(f),function(e,a,u){e?r.Qn.adapterRead("_"+i+s+n,e,function(a){a?(Object.isFrozen(a)&&(a=o.u(a)),a.rows=a.rows.filter(function(e){return e.id!==t}),r.Qn.adapterWrite("_"+i+s+n,e,a,u)):u()},!0):u()}).then(u)}).then(function(){r.Qn.adapters[0].adapter.delete(a+n,t,u)}):u()},!0)}).then(n)}else n()},t.prototype.Xn=function(t,e,n){var r=this,i=this.dt.table,s=Object.keys(this.Qn.tableInfo[i].Mn);if(0!==s.length&&o.intersect(Object.keys(e),s)){var a="_"+i+"_search_tokens_";o.fastALL(s,function(n,s,u){-1===[void 0,null,""].indexOf(e[n])?r.Qn.adapterRead(a+n,t,function(s){var c=s||{id:t,hash:"1505",tokens:[]},f=o.hash(e[n]);if(f!==c.hash){var h={},l=r.Vn(n,e[n]),p=c.tokens.map(function(t){return t.i+"-"+t.w}).filter(function(t){return t.split("-")[1]}),d=l.map(function(t){return t.i+"-"+t.w}).filter(function(t){return t.split("-")[1]}),y=d.filter(function(t){return-1===p.indexOf(t)}),b=p.filter(function(t){return-1===d.indexOf(t)});l.forEach(function(t){h[t.w]=t.o}),o.fastCHAIN([b,y],function(e,s,a){var u={};e.forEach(function(t){var e=t.split(/-(.+)/),n={w:e[1],i:parseInt(e[0])};u[n.w]||(u[n.w]=[]),u[n.w].push(n)}),o.fastALL(Object.keys(u),function(e,a,c){o.fastALL(["_search_","_search_fuzzy_"],function(a,c,f){var p=0===c?e:h[e];p?r.Qn.adapterRead("_"+i+a+n,p,function(p){var d=p||{wrd:e,rows:[]};switch(Object.isFrozen(d)&&(d=o.u(d)),s){case 0:for(var y=d.rows.length;y--;)d.rows[y].id===t&&d.rows.splice(y,1);break;case 1:d.rows.push({id:t,i:u[e].map(function(t){return t.i}),l:l.length})}r.Qn.adapterWrite("_"+i+a+n,0===c?e:h[e],d,f)},!0):f()}).then(c)}).then(a)}).then(function(){r.Qn.adapterWrite(a+n,t,{id:t,hash:f,tokens:l.map(function(t){return{w:t.w,i:t.i}})},u)})}else u()},!0):u()}).then(n)}else n()},t.prototype.Yn=function(t,e,n){var r=this;this.Qn.Pn?null!==t&&void 0!==t?o.fastALL(Object.keys(this.Qn.tableInfo[this.dt.table].Z),function(n,i,o){var s=r.Qn.tableInfo[r.dt.table].Z[n].pkColumn;if(void 0!==t[s]){if(t[s]!==e[s])return null===t[s]?(r.Qn.tableInfo[r.dt.table].Z[n].columns.forEach(function(e){t[e.thisColumn]=null}),void o()):void r.Qn.adapterRead(n,t[s],function(e){if(!e.length&&"LIVE"===r.Qn.tableInfo[r.dt.table].Z[n].mode)return r.Qn.tableInfo[r.dt.table].Z[n].columns.forEach(function(e){t[e.thisColumn]=null}),void o();r.Qn.tableInfo[r.dt.table].Z[n].columns.forEach(function(n){t[n.thisColumn]=e[0][n.otherColumn]}),o()},!0);o()}else o()}).then(function(){n(t)}):n(t||{}):n(t)},t.prototype.Zn=function(t,e,n){var r=this,i=this.Qn.tableInfo[this.dt.table].gn;o.fastALL(t,function(t,n,s){o.fastALL(r.Qn.tableInfo[r.dt.table].an,function(n,s,a){e&&"GHOST"===r.Qn.tableInfo[n.table].Z[r.dt.table].mode?a():r.Qn.jn(n.table,"=",n.column,t[i],function(i){if(i.length){var s=r.Qn.tableInfo[n.table].Z[r.dt.table].columns,u=r.Qn.tableInfo[n.table].Z[r.dt.table].pkColumn;o.fastALL(i,function(i,o,a){var c=s.length,f=!1;if(e){if("LIVE"===r.Qn.tableInfo[n.table].Z[r.dt.table].mode)for(f=!0,i[u]=null;c--;)i[s[c].otherColumn]=null}else for(;c--;)i[s[c].otherColumn]!==t[s[c].thisColumn]&&(i[s[c].otherColumn]=t[s[c].thisColumn],f=!0);if(f){var h=r.Qn.tableInfo[n.table].gn;r.Qn.adapterWrite(n.table,i[h],i,a)}else a()}).then(a)}else a()})}).then(s)}).then(n)},t.prototype.ti=function(t,e,n){var r=this;this.Qn.Pn&&this.Qn.tableInfo[this.dt.table].an.length?this.Zn(t,e,function(){n(r.dt)}):n(this.dt)},t.prototype.$n=function(t){var e=this,n=this.Qn.tableInfo[this.dt.table].gn;if(this.Wn)this.qn(function(n){e.dt.result=e.dt.table.map(function(t){return-1===n.indexOf(t)?t:r({},e.dt.actionArgs,t)}),t(e.dt)});else if(this.dt.where)this.qn(function(r){if(r.length){e.Qn.Yt[e.dt.table]={};var i=[];o.fastCHAIN(e.dt.actionArgs,function(t,s,a){o.fastCHAIN(r,function(r,i,o){e.Xn(r[n],r,function(){e.Yn(t||{},r,function(t){e.Qn.tableInfo[e.dt.table].Dn&&Object.keys(e.Qn.tableInfo[e.dt.table].Cn).forEach(function(n){void 0===r[n]&&void 0===t[n]&&(t[n]=e.Qn.tableInfo[e.dt.table].Cn[n])}),e.Qn.In(e.dt.table,r[n],r,t,o)})})}).then(function(t){i=t,a()})}).then(function(){var o=i.map(function(t){return t[n]});e.dt.result=[{msg:i.length+" row(s) modfied.",affectedRowPKS:o,affectedRows:i}],e.Un("add",r,i,function(){e.ti(i,!1,t)})})}else e.dt.result=[{msg:"0 row(s) modfied.",affectedRowPKS:[],affectedRows:[]}],t(e.dt)});else{var i=this.dt.actionArgs||[];this.Qn.Yt[this.dt.table]={};var s=[],a=[];o.fastCHAIN(i,function(t,r,i){var o=function(r){e.Yn(t,r,function(o){e.Qn.tableInfo[e.dt.table].Dn&&Object.keys(e.Qn.tableInfo[e.dt.table].Cn).forEach(function(t){void 0===(r||{})[t]&&void 0===o[t]&&(o[t]=e.Qn.tableInfo[e.dt.table].Cn[t])}),e.Qn.In(e.dt.table,t[n],r,o,function(t){e.Xn(t[n],t,function(){s.push(r||{}),a.push(t),i()})})})};void 0!==t[n]&&-1===e.dt.comments.indexOf("_rebuild_search_index_")?e.Qn.On(e.dt.table,[t[n]],function(t){t.length?o(t[0]):o(null)}):o(null)}).then(function(){e.dt.result=[{msg:a.length+" row(s) inserted.",affectedRowPKS:a.map(function(t){return t[n]}),affectedRows:a}],e.Qn.vn?e.Un("add",s,a,function(){e.ti(a,!1,t)}):e.ti(a,!1,t)})}},t.prototype.Tn=function(t){var e=this;this.Wn?this.dt.where?this.qn(function(n){e.dt.result=e.dt.table.filter(function(t){return-1===n.indexOf(t)}),t(e.dt)}):(this.dt.result=[],t(this.dt)):this.dt.where?this.qn(function(n){(n=n.filter(function(t){return t})).length?o.fastALL(n,function(t,n,r){e.Gn(t[e.Qn.tableInfo[e.dt.table].gn],t,function(){e.Qn.Tn(e.dt.table,t[e.Qn.tableInfo[e.dt.table].gn],r)})}).then(function(r){e.Qn.Yt[e.dt.table]={};var i=n.map(function(t){return t[e.Qn.tableInfo[e.dt.table].gn]});e.dt.result=[{msg:n.length+" row(s) deleted.",affectedRowPKS:i,affectedRows:n}],e.Un("del",n,[],function(){e.ti(n,!0,t)})}):(e.dt.result=[{msg:"0 row(s) deleted.",affectedRowPKS:[],affectedRows:[]}],t(e.dt))}):this.mn(t)},t.prototype.mn=function(t){var e=this;if(this.Wn)return this.dt.result=[],void t(this.dt);this.Qn.kn(this.dt.table,void 0,void 0,!1,function(n){e.Qn.Yt[e.dt.table]={},e.dt.table,e.Qn.mn(e.dt.table,function(){e.dt.result=[{msg:"'"+e.dt.table+"' table dropped.",affectedRowPKS:n.map(function(t){return t[e.Qn.tableInfo[e.dt.table].gn]}),affectedRows:n}],e.Un("del",n,[],function(){e.ti(n,!0,t)})})})},t}();e.ni=c;var f=function(){function t(t,e){this.q=t,this.s=e,this.ii=[]}return t.prototype.ri=function(t,e){var n=this;if(this.q.join){var r=Array.isArray(this.q.join)?this.q.join:[this.q.join],i=this.q.table+"."+this.s.tableInfo[this.q.table].gn;o.fastCHAIN(r,function(t,e,r){var i={};"cross"!==t.type&&t.where&&(i={ei:t.where[0],oi:t.where[1],ui:t.where[2]});var o=n.q.table,s=t.table;n.si(t.type,o,s,i,function(t){r(t)})}).then(function(t){for(var r=1;r<t.length;)t[r].forEach(function(e){var n=!1;-1===[void 0,null].indexOf(e[i])&&t[0].forEach(function(r,o){r[i]&&e[i]===r[i]&&(n=!0,Object.keys(e).forEach(function(n){void 0===t[0][o][n]&&(t[0][o][n]=e[n])}))}),n||t[0].push(e)}),r++;n.q.where?e(t[0].filter(function(t,e){return Array.isArray(n.q.where)?p(t,n.q.where||[],e,!0):n.q.where(t,e)})):n.q.range?e(t[0].filter(function(t,e){return n.q.range&&n.q.range[0]>=e&&n.q.range[0]+n.q.range[1]-1<=e})):e(t[0])})}else e(t)},t.prototype.ci=function(t,e){return t.reduce(function(t,n){return-1!==n.indexOf(".length")?t+"."+String((e[n.replace(".length","")]||[]).length):t+"."+String(e[n])},"").slice(1)},t.prototype.fi=function(t){var e=this,n=this.q.groupBy||{},r=t.sort(function(t,r){return e.hi(t,r,n,!0)});return r.forEach(function(t,r){var i=Object.keys(n).map(function(e){return String(t[e])||""}).join(".");e.li||(e.li={}),e.li[i]||(e.li[i]=[]),e.li[i].push(r)}),r},t.prototype.vi=function(t){var e=this;return t.filter(function(t,n){return Array.isArray(e.q.having)?p(t,e.q.having||[],n,!0):e.q.having(t,n)})},t.prototype.di=function(t){var e=this;return t.sort(function(t,n){return e.hi(t,n,e.q.orderBy||{},!1)})},t.prototype.bi=function(t){var e=this;return t.filter(function(t,n){return!e.q.offset||n>=e.q.offset})},t.prototype._i=function(t){var e=this;return t.filter(function(t,n){return!e.q.limit||n<e.q.limit})},t.prototype.wi=function(t,e){var n=this,r=this.q.orm?this.q.orm.map(function(t){return"string"==typeof t?{key:t,limit:5}:t}):[];o.fastALL(t,function(t,e,s){t=Object.isFrozen(t)?o.u(t):t,o.fastALL(r,function(e,r,o){if(void 0!==t[e.key]){var s=n.s.cn[n.q.table][e.key];s?n.s.Ut.query("select").where([n.s.tableInfo[s.hn].gn,"array"===s.ln?"IN":"=",t[e.key]]).manualExec({table:s.hn}).then(function(n){var r=i.nSQL().query("select",e.select);e.where&&r.where(e.where),void 0!==e.limit&&r.limit(e.limit),void 0!==e.offset&&r.offset(e.offset),e.orderBy&&r.orderBy(e.orderBy),e.groupBy&&r.groupBy(e.groupBy),r.manualExec({table:n}).then(function(r){n.filter(function(t){return t}).length?t[e.key]="array"===s.ln?r:r[0]:t[e.key]="array"===s.ln?[]:void 0,o()})}):o()}else o()}).then(function(){s(t)})}).then(e)},t.prototype.si=function(t,e,n,r,i){var o="left",s="right",a="outer",u=this,c=u.s.tableInfo[t===s?n:e],f=u.s.tableInfo[t===s?e:n],h=function(t,e){return[c,f].reduce(function(n,r,i){return r.Rn.forEach(function(o){n[r.Jn+"."+o]=((0===i?t:e)||{})[o]}),n},{})},l=[],d=r&&r.ui&&r.ui.split(".").pop()||"",y={},b=[];u.s.On(c.Jn,function(e,n,i){var v=!1;u.s.On(f.Jn,function(n,i,o){var u;r&&"cross"!==t?p(((u={})[c.Jn]=e,u[f.Jn]=n,u),[r.ei,r.oi,t===s?e[d]:n[d]],0,!1)?(t===a&&(y[i]=!0),l.push(h(e,n)),v=!0):t===a&&(b[i]=n):(l.push(h(e,n)),v=!0),o(!1)},function(){!v&&[o,s,a].indexOf(t)>-1&&l.push(h(e,null)),i(!1)})},function(){if(t===a){for(var e=b.filter(function(t,e){return!y[e]}),n=0;n<e.length;)l.push(h(null,e[n])),n++;i(l)}else i(l)})},t.prototype.hi=function(t,e,n,r){return Object.keys(n).reduce(function(i,s){var a=r?o.objQuery(s,t):t[s],u=r?o.objQuery(s,e):e[s];return i||(a===u?0:(a>u?1:-1)*("desc"===n[s]?-1:1))},0)},t.prototype.pi=function(t,e){var n=this,r=this.q.actionArgs,s={},a={};if(r&&r.length){var u=!1,c={};r.forEach(function(t){if(-1!==t.indexOf("(")){var e=(t.match(/^.*\(/g)||[""])[0].replace(/\(|\)/g,"").toUpperCase(),n=i.NanoSQLInstance.functions[e],r=1===t.split(" AS ").length?e:(t.split(" AS ").pop()||"").trim();if(!n)throw new Error("nSQL: '"+e+"' is not a valid function!");"A"===n.type&&(u=!0),c[t]={fn:n,key:r}}}),o.fastALL(r,function(e,r,i){if(e.indexOf("(")>-1){var f=(e.match(/\(.*\)/g)||[""])[0].replace(/\(|\)/g,"").split(",").map(function(t){return t.trim()});n.li&&u?o.fastALL(Object.keys(n.li),function(r,i,o){var s;a[r]||(a[r]={}),(s=c[e].fn).call.apply(s,[t.filter(function(t,e){return n.li[r].indexOf(e)>-1}),function(t){a[r][c[e].key]=t,o()},void 0!==n.q.join].concat(f))}).then(i):(h=c[e].fn).call.apply(h,[t,function(t){s[c[e].key]=t,i()},void 0!==n.q.join].concat(f))}else i();var h}).then(function(){var i=function(t,e,i){var s={};return r.forEach(function(r){var a=r.indexOf("(")>-1,u=a?c[r].fn.type:"";if(r.indexOf(" AS ")>-1){var f=r.split(" AS "),h=a?c[r].key:f[0].trim();s[f[1]]=a?"A"===u?i[h]:i[h][e]:o.objQuery(h,t,void 0!==n.q.join)}else h=a?c[r].key:r,s[r]=a?"A"===u?i[h]:i[h][e]:o.objQuery(h,t,void 0!==n.q.join)}),s};if(!t.length&&u){var f=[{}];return Object.keys(c).forEach(function(t){void 0!==s[c[t].key]&&(f[0][t]=s[c[t].key])}),void e(f)}if(n.li&&u){var h=[];Object.keys(n.li).forEach(function(e){var r=t.filter(function(t,r){return n.li[e].indexOf(r)>-1}).filter(function(t,e){return e<1});r&&r.length&&h.push(i(r[0],0,a[e]))}),e(h)}else e(u?t.filter(function(t,e){return e<1}).map(function(t,e){return i(t,e,s)}):t.map(function(t,e){return i(t,e,s)}))})}else e(t)},t.prototype.Bn=function(t,e){var n=this,r=function(){n.q.having&&(t=n.vi(t)),n.q.orderBy&&(t=n.di(t)),n.q.offset&&(t=n.bi(t)),n.q.limit&&(t=n._i(t)),e(t)},i=function(){n.q.actionArgs&&n.q.actionArgs.length?n.pi(t,function(e){t=e,r()}):r()},o=function(){n.q.groupBy&&(t=n.fi(t)),n.q.orm?n.wi(t,function(e){t=e,i()}):i()};this.q.join?this.ri(t,function(e){t=e,o()}):o()},t}();e.yi=f;var h=function(){function t(t,e,n,r){var i=this;if(this.qu=t,this.q=e,this.s=n,this.q.join&&this.q.orm)throw new Error("nSQL: Cannot do a JOIN and ORM command at the same time!");if([this.q.where,this.q.range,this.q.trie].filter(function(t){return t}).length>1)throw new Error("nSQL: Can only have ONE of Trie, Range or Where!");if(this.q.join)r([]);else if(this.q.trie&&this.q.trie.column&&this.q.trie.search)this.mi(r);else if(this.q.range&&this.q.range.length)this.gi(r);else if(this.q.where&&this.q.where.length&&Array.isArray(this.q.where))if("string"==typeof this.q.where[0]?0===this.Oi(this.q.where):0===(this.q.where||[]).reduce(function(t,e,n){return n%2==1?t:t+i.Oi(e)},0))this.Si(this.q.where,r);else{var o=this.ji(this.q.where);if(o>0){var s=this.q.where.slice(0,o),a=this.q.where.slice(o+1);this.Si(s,function(t){r(t.filter(function(t,e){return p(t,a,e,!1)}))})}else this.ki(r)}else this.ki(r)}return t.prototype.Si=function(t,e){var n=this;if(t&&"string"==typeof t[0])this.Ei(t,e);else if(t){var r=[],i="",s=this.s.tableInfo[this.q.table].gn;o.fastCHAIN(t,function(t,e,o){if(e%2==1)return i=t,void o();n.Ei(t,function(t){if("AND"===i){for(var e={},n=t.length;n--;)e[t[n][s]]=!0;r=r.filter(function(t){return e[t[s]]})}else r=r.concat(t);o()})}).then(function(){var t={};e(r.filter(function(e){return!t[e[s]]&&(t[e[s]]=!0,!0)}))})}},t.prototype.Ei=function(t,e){var n=this;if(0!==t[0].indexOf("search("))if(0!==t[0].indexOf("crow("))if("BETWEEN"!==t[1]){var u=[],c="";switch(t[1]){case"IN":if(u=t[2],!Array.isArray(u))throw new Error("nSQL: IN query must use array!");c="=";break;case"=":case">":case">=":case"<":case"<=":u=[t[2]],c=t[1]}t[0]===this.s.tableInfo[this.q.table].gn?"="===c?this.s.On(this.q.table,u,e):this.s.adapters[0].adapter.getIndex(this.q.table,!1,function(t){var r=u[0],i=t.filter(function(t){switch(c){case">":return t>r;case">=":return t>=r;case"<":return t<r;case"<=":return t<=r}return!1});i.length?n.s.On(n.q.table,i,e):e([])}):o.fastALL(u,function(e,r,i){n.s.jn(n.q.table,c,t[0],e,i)}).then(function(t){e([].concat.apply([],t))})}else{var f=t[0]===this.s.tableInfo[this.q.table].gn?"":t[0];if(!Array.isArray(t[2]))throw new Error("nSQL: BETWEEN query must use an array!");if(f){var h="_"+this.q.table+"_idx_"+f;if(this.s.Xt){var l=this.s.Bt[h].idx.filter(function(e){return t[2][0]<=e&&t[2][1]>=e}).map(function(t){return n.s.Bt[h].rows[t]}).reverse().reduce(function(t,e){return t.concat(e.rows)},[]);this.s.On(this.q.table,l,e)}else this.s.kn(h,t[2][0],t[2][1],!0,function(t){for(var r=[],i=t.length;i--;)r=r.concat(t[i].rows);n.s.On(n.q.table,r,e)})}else this.s.kn(this.q.table,t[2][0],t[2][1],!0,function(t){e(t)})}else{var p=t[0].replace(/crow\((.*)\)/gim,"$1").split(",").map(function(t,e){return e<2?parseFloat(t.trim()):t.trim()}),d="_"+this.q.table+"_idx_"+(p.length>2?p[2]:"lat"),y="_"+this.q.table+"_idx_"+(p.length>2?p[3]:"lon"),b=parseFloat(t[2]||"0"),v=[-1,1].map(function(t){return p[0]+b*t/i.NanoSQLInstance.earthRadius*(180*Math.PI)}),g=[-1,1].map(function(t){return p[1]+b*t/i.NanoSQLInstance.earthRadius*(180*Math.PI)/Math.cos(p[0]*Math.PI/180)});o.fastALL([d,y],function(t,e,r){var i=0===e?v:g;n.s.kn(t,i[0],i[1],!0,r)}).then(function(t){if(t[0].length&&t[1].length){var s={},a=[];[0,1].forEach(function(e){t[e].forEach(function(t){t.rows.forEach(function(n){switch(e){case 0:s[n]=t.id;break;case 1:s[n]&&o.crowDistance(p[0],p[1],s[n],t.id,i.NanoSQLInstance.earthRadius)<b&&a.push(n)}})})});var u=n.qu.Qn.tableInfo[n.q.table].gn;n.s.On(n.q.table,a,function(t){e(t.map(function(t){return r({},t,{Ni:s[t[u]]})}))})}else e([])})}else{var m=0;-1!==t[1].indexOf(">")?m=parseFloat(t[1].replace(">",""))+1e-4:-1!==t[1].indexOf("<")&&(m=-1*parseFloat(t[1].replace("<",""))+1e-4);var w=t[0].replace(/search\((.*)\)/gim,"$1").split(",").map(function(t){return t.trim()}),x={},O={};o.fastALL(w,function(e,r,i){var u=n.qu.Vn(e,t[2]),c=n.s.tableInfo[n.q.table].Mn[e],f={},h=[],l={},p={};u.forEach(function(t){l[t.w]=t.o,p[t.o]=t.w}),o.fastALL(["_search_","_search_fuzzy_"],function(t,r,i){var a="_"+n.q.table+t+e;switch(r){case 0:o.fastALL(u,function(t,e,r){n.s.adapterRead(a,t.w,function(e){e?(e.rows.forEach(function(e){f[e.id]||(f[e.id]={}),h.push(e.i[0]),f[e.id][t.w]=e}),r()):r()})}).then(i);break;case 1:if(0===m)return void i();n.s.adapters[0].adapter.getIndex(a,!1,function(t){var e=[];t.forEach(function(t){u.forEach(function(n){s(n.o,t)&&(O[n.o]=t,l[t]=n.o,e.push(t))})}),e=e.filter(function(t,e,n){return n.indexOf(t)===e}),o.fastALL(e,function(t,e,r){n.s.adapterRead(a,t,function(e){e?(e.rows.forEach(function(e){var n=!1;if(f[e.id]?-1!==h.indexOf(e.i[0])&&(n=!0):f[e.id]={},!n){var r=p[t]||t;f[e.id][r]=e}}),r()):r()})}).then(i)})}}).then(function(){Object.keys(f).forEach(function(t){if(0!==m||Object.keys(f[t]).length===u.length){x[t]||(x[t]={weight:0,locations:{}});var n=0,r=Object.keys(f[t]).map(function(e){return n=f[t][e].l,l[e]&&(x[t].weight+=5),{word:l[e]||e,loc:f[t][e].i}}),i=r.reduce(function(t,e){return t+e.loc.length},0);if(x[t].weight+=i/n+parseInt(c[0]),x[t].locations[e]=r,0!==m)u.forEach(function(e){var n=f[t][e.w];n&&n.i.forEach(function(n){Object.keys(f[t]).forEach(function(r){r!==e.w&&f[t][r].i.forEach(function(e){var r=Math.abs(e-n);r&&(x[t].weight+=10/(10*r))})})}),O[e.o]&&r.forEach(function(n){if(O[e.o]===n.word){var r=a(e.o,n.word);x[t].weight+=r<=1?10:10/(5*r)}})});else if(u.length>1){var o=[];Object.keys(f[t]).forEach(function(e){e===u[0].w&&(o=f[t][e].i)});var s=!0;o.forEach(function(e,n){var r=u[n+1];r&&Object.keys(f[t]).forEach(function(n){if(n===r.w){var i=r.i+e;-1===f[t][n].i.indexOf(i)&&(s=!1)}})}),s||delete x[t]}}else delete f[t]}),i()})}).then(function(t){for(var i=0,s=Object.keys(x),u=s.length;u--;)i=Math.max(i,x[s[u]].weight);for(u=s.length;u--;)x[s[u]].weight=x[s[u]].weight/i;o.fastALL(s.filter(function(t){return 0===m||(m>0?m<x[t].weight:!(m<0)||-1*m>x[t].weight)}),function(t,e,r){n.s.adapterRead(n.q.table,t,r)}).then(function(t){var i=n.s.tableInfo[n.q.table].gn;(t=t.filter(function(t){return t})).forEach(function(t){var e=t[i];Object.keys(x[e].locations).forEach(function(r){var i=n.qu.Vn(r,t[r]).map(function(t){return t.o});x[e].locations[r].forEach(function(t){t.loc.forEach(function(n){var r=a(i[n],t.word);x[e].weight+=r<=1?10:10/(10*r)})})})});for(var o=0,s=Object.keys(x),u=s.length;u--;)o=Math.max(o,x[s[u]].weight);for(u=s.length;u--;)x[s[u]].weight=x[s[u]].weight/o;e(t.filter(function(t){return 0===m||(m>0?m<x[t[i]].weight:!(m<0)||-1*m>x[t[i]].weight)}).map(function(t){return r({},t,{Ai:x[t[i]].weight,Ii:x[t[i]].locations})}))})})}},t.prototype.gi=function(t){var e=this;if(this.q.range){var n=this.q.range;n[0]>0?this.s.kn(this.q.table,n[1],n[1]+n[0]-1,!1,t):this.s.adapters[0].adapter.getIndex(this.q.table,!0,function(r){for(var i=r+n[0]-n[1],o=i,s=Math.abs(n[0])-1;s--;)o++;e.s.kn(e.q.table,i,o,!1,t)})}else t([])},t.prototype.mi=function(t){this.q.trie?this.s.En(this.q.table,this.q.trie.column,this.q.trie.search,t):t([])},t.prototype.ki=function(t){var e=this,n=void 0!==this.q.where,r=n&&Array.isArray(this.q.where),i=this.s.tableInfo[this.q.table].gn,s=[],a=function(){e.s.On(e.q.table,function(t,o,a){a(!n||(r?p(t,e.q.where,o,!1,s,i):e.q.where(t,o)))},t)},u=this.q.where||[];r&&"string"!=typeof u[0]?o.fastCHAIN(u,function(t,n,r){-1!==t[0].indexOf("search(")?e.qu.Qn.Ut.query("select").where(t).manualExec({table:e.q.table}).then(function(t){s[n]=t.map(function(t){return t[i]}),r()}):r()}).then(function(){a()}):a()},t.prototype.ji=function(t){var e=this;if("string"==typeof t[0])return 0;if(0===this.Oi(t[0])){var n=0;return t.forEach(function(r,i){i%2==0&&0===e.Oi(r)&&t[i+1]&&(n=i+1)}),"AND"!==t[n]?0:n}return 0},t.prototype.Oi=function(t){var e=this.s.tableInfo[this.q.table],n=t[0]||"",r=t[1]||"";if(Array.isArray(n))return 0;if(1!==n.indexOf("crow(")&&"<"===r){var i=n.replace(/crow\((.*)\)/gim,"$1").split(",").map(function(t){return t.trim()}),o=i[2]||"lat",s=i[3]||"lon";return-1===e.Bt.indexOf(o)||-1===e.Bt.indexOf(s)?1:0}return-1!==n.indexOf("search(")&&-3!==["=",">","<"].reduce(function(e,n){return e+t[1].indexOf(n)},0)?n.replace(/search\((.*)\)/gim,"$1").split(",").map(function(t){return t.trim()}).filter(function(t){return-1!==Object.keys(e.Mn).indexOf(t)}).length?0:1:(n===e.gn||-1!==e.Bt.indexOf(n))&&["=","IN","BETWEEN",">",">=","<","<="].indexOf(t[1])>-1?0:1},t}();e.Ti=h;var l=function(){function t(t,e){this.q=t,this.p=e}return t.prototype.getRows=function(t){var e=this;if(this.q.join||this.q.orm||this.q.trie)throw new Error("nSQL: Cannot do a JOIN, ORM or TRIE command with instance table!");if(this.q.range&&this.q.range.length){var n,r,i=this.q.range;n=i[0]<0?this.q.table.length+i[0]-i[1]:i[1];var o=Math.abs(i[0])-1;for(r=n;o--;)r++;t(this.q.table.filter(function(t,e){return e>=n&&e<=r}))}else t(this.q.table.filter(function(t,n){return!e.q.where||(Array.isArray(e.q.where)?p(t,e.q.where||[],n,!1):e.q.where(t,n))}))},t}();e.InstanceSelection=l;var p=function(t,e,n,r,i,o){if("string"!=typeof e[0]){var s,a,u=-1!==e.indexOf("OR");return e.reduce(function(e,c,f){if(void 0!==s)return s;if(f%2==1)return a=c,e;var h;return h=0===c[0].indexOf("search(")&&i?-1!==i[f].indexOf(t[o]):Array.isArray(c[0])?p(t,c,n,r||!1,i,o):b(c,t,r||!1),u||!1!==h?0===f?h:"AND"===a?e&&h:e||h:s=!1},!1)}return b(e,t,r||!1)},d={},y={},b=function(t,e,n){y[t[0]]||(y[t[0]]=-1!==t[0].indexOf("(")?t[0].replace(/(.*)\((.*)\)/gim,"$1,$2").split(",").map(function(t){return isNaN(t)?t.trim():parseFloat(t.trim())}):[]);var r=function(t,e){if(!d[e]){var n="";d[e]=new RegExp(e.split("").map(function(t){return"\\"===n?(n=t,t):(n=t,"%"===t?".*":"_"===t?".":t)}).join(""),"gmi")}return"string"!=typeof t?"number"==typeof t?null!==String(t).match(d[e]):null!==JSON.stringify(t).match(d[e]):null!==t.match(d[e])},s=t[2],a=t[1],u=function(){if(y[t[0]].length){var r=i.NanoSQLInstance.whereFunctions[y[t[0]][0]];return r?r.apply(null,[e,n].concat(y[t[0]].slice(1))):void 0}return o.objQuery(t[0],e,n)}();if("NULL"===s||"NOT NULL"===s){var c=-1!==[void 0,null,""].indexOf(u),f="="===a||"LIKE"===a;switch(s){case"NULL":return f?c:!c;case"NOT NULL":return f?!c:c}}if(-1!==["IN","BETWEEN","HAVE","NOT HAVE","INTERSECT","INTERSECT ALL","NOT INTERSECT"].indexOf(a)&&!Array.isArray(s))throw new Error("nSQL: "+a+" requires an array value!");switch(a){case"=":return u===s;case"!=":return u!==s;case">":return u>s;case"<":return u<s;case"<=":return u<=s;case">=":return u>=s;case"IN":return-1!==(s||[]).indexOf(u);case"NOT IN":return-1===(s||[]).indexOf(u);case"REGEXP":case"REGEX":return null!==(u||"").match(s);case"LIKE":return r(u||"",s);case"NOT LIKE":return!r(u||"",s);case"BETWEEN":return s[0]<=u&&s[1]>=u;case"HAVE":return-1!==(u||[]).indexOf(s);case"NOT HAVE":return-1===(u||[]).indexOf(s);case"INTERSECT":return(u||[]).filter(function(t){return(s||[]).indexOf(t)>-1}).length>0;case"INTERSECT ALL":return(u||[]).filter(function(t){return(s||[]).indexOf(t)>-1}).length===s.length;case"NOT INTERSECT":return 0===(u||[]).filter(function(t){return(s||[]).indexOf(t)>-1}).length;default:return!1}}},function(t,e,n){var r=this&&this.C||Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t};Object.defineProperty(e,"__esModule",{value:!0});var i=n(8),o=n(25),s=n(0),a=n(23),u=n(1),c=function(){function t(){this.Mi=[],this.xi=0}return t.prototype.willConnect=function(t,e){this.parent=t.parent,this.Qn=new a.Hn(t.parent,r({},t.config)),this.Qn.init(t.models,function(n){t.models=r({},t.models,n),e(t)})},t.prototype.getId=function(){return this.Qn.H},t.prototype.doExec=function(t,e){t.state="complete",new o.ni(this.Qn).doQuery(t,e)},t.prototype.dumpTables=function(t){var e=this;return new s.e(function(n,r){var i={},o=t&&t.length?t:Object.keys(e.Qn.tableInfo);s.fastALL(o,function(t,n,r){i[t]=[],e.Qn.adapters[0].adapter.rangeRead(t,function(e,n,r){i[t].push(e),r()},r)}).then(function(){n(i)})})},t.prototype.importTables=function(t,e){var n=this;return new s.e(function(r,i){var o=0,a=0;Object.keys(t).forEach(function(e){o+=(t[e]||[]).length||0}),s.fastALL(Object.keys(t),function(r,i,s){var c=n.Qn.tableInfo[r].gn,f=(t[r]||[]).length||0,h=0,l=function(){if(h<f){var i=t[r][h];h++,a++,i[c]?n.Qn.adapterWrite(r,i[c],i,function(){e(Math.round((a+1)/o*1e4)/100),h%500==0?u.setFast(l):l()}):(e(Math.round((a+1)/o*1e4)/100),h%500==0?u.setFast(l):l())}else s()};l()}).then(function(){r()})})},t.prototype.willDisconnect=function(t){s.fastALL(this.Qn.adapters||[],function(t,e,n){t.disconnect?t.disconnect(n):n()}).then(t)},t.prototype.extend=function(t,e,n){var r=this;switch(e[0]){case"clone":var o=new i.NanoSQLInstance;Object.keys(this.parent.dataModels).forEach(function(t){o.table(t).model(r.parent.dataModels[t],[],!0)}),o.config({id:this.Qn.H,mode:e[1]}).connect().then(function(){s.fastCHAIN(Object.keys(r.parent.dataModels),function(t,e,n){console.log("Importing "+t+"..."),r.parent.rawDump([t]).then(function(t){return o.rawImport(t)}).then(n)}).then(function(){t(e,[])})});break;case"flush":var a;a=e[1]?[e[1]]:this.parent.tableNames,s.fastCHAIN(a,function(t,e,n){r.Qn.mn(t,n)}).then(function(){t(e,a)});break;case"get_adapter":e[1]?t(e,[this.Qn.adapters[e[1]].adapter]):t(e,[this.Qn.adapters[0].adapter]);break;case"idx.length":case"idx":var u=e[1];Object.keys(this.Qn.tableInfo).indexOf(u)>-1?this.Qn.adapters[0].adapter.getIndex(u,"idx"!==e[0],function(n){t(e,n)}):t(e,[]);break;case"rebuild_search":var c=e[1]?[e[1]]:Object.keys(r.Qn.tableInfo),f=e[2];s.fastALL(c,function(t,e,n){var i=0,o=0;s.fastALL(c,function(t,e,n){r.Qn.adapters[0].adapter.getIndex(t,!0,function(t){i+=t,n()})}).then(function(){var e=Object.keys(r.Qn.tableInfo[t].Mn).map(function(e){return"_"+t+"_search_tokens_"+e});e=(e=e.concat(Object.keys(r.Qn.tableInfo[t].Mn).map(function(e){return"_"+t+"_search_"+e}))).concat(Object.keys(r.Qn.tableInfo[t].Mn).map(function(e){return"_"+t+"_search_fuzzy_"+e})),s.fastALL(e,function(t,e,n){r.Qn.adapterDrop(t,n)}).then(function(){r.Qn.adapters[0].adapter.rangeRead(t,function(e,n,s){r.parent.query("upsert",e).comment("_rebuild_search_index_").manualExec({table:t}).then(function(){f&&f(Math.round((o+1)/i*1e4)/100),o++,s()})},n)})})}).then(function(){t(e,[])});break;case"rebuild_idx":e[1]?this.Qn.rebuildIndexes(e[1],function(n){t(e,[n])}):s.fastALL(Object.keys(this.Qn.tableInfo),function(t,e,n){r.Qn.rebuildIndexes(t,n)}).then(function(n){t(e,n)});break;default:t(e,n)}},t}();e.NanoSQLDefaultBackend=c},function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){this.eventListeners={}}return t.prototype.on=function(t,e){this.eventListeners[t]||(this.eventListeners[t]=[]),this.eventListeners[t].push(e)},t.prototype.off=function(t,e){var n=this;this.eventListeners[t]&&this.eventListeners[t].length&&this.eventListeners[t].forEach(function(r,i){r===e&&n.eventListeners[t].splice(i,1)})},t.prototype.trigger=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.eventListeners[t]&&this.eventListeners[t].forEach(function(t){return t.apply(void 0,e)})},t}();e.ReallySmallEvents=n,e.RSE=new n},function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e,n,r,i){this.thisQ={state:"pending",table:n,action:t,actionArgs:e,queryID:i,transaction:!0,result:[],comments:[]},this.Li=r}return t.prototype.where=function(t){return this.thisQ.where=t,this},t.prototype.exec=function(){this.Li.push(this.thisQ)},t}();e.lt=n},function(t,e,n){var r=this&&this.C||Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t};Object.defineProperty(e,"__esModule",{value:!0});var i=n(0),o={affectedRowPKS:[],affectedRows:[]},s=function(t,e){1!==t.F.plugins.length||t.F.hasAnyEvents?i.fastCHAIN(t.F.plugins,function(e,n,r){e.doExec?e.doExec(t.dt,function(e){t.dt=e||t.dt,r()}):r()}).then(function(){if(t.F.hasPK[t.dt.table]?e(t.dt.result):e(t.dt.result.map(function(t){return r({},t,{Ri:void 0})})),t.F.hasAnyEvents||t.F.pluginHasDidExec){var n=function(){switch(t.dt.action){case"select":return[t.dt.action];case"delete":case"upsert":case"drop":return[t.dt.action,"change"];default:return[]}}(),s=t.dt.result&&t.dt.result.length,a={table:t.dt.table,query:t.dt,time:Date.now(),result:t.dt.result,notes:[],types:n,actionOrView:t.Ci,transactionID:t.dt.transaction?t.dt.queryID:void 0,affectedRowPKS:s?(t.dt.result[0]||o).affectedRowPKS:[],affectedRows:s?(t.dt.result[0]||o).affectedRows:[]};i.fastCHAIN(t.F.plugins,function(t,e,n){t.didExec?t.didExec(a,function(t){a=t,n()}):n()}).then(function(){t.F.triggerEvent(a)})}}):t.F.plugins[0].doExec(t.dt,function(n){t.dt=n,t.F.hasPK[t.dt.table]?e(t.dt.result):e(t.dt.result.map(function(t){return r({},t,{Ri:void 0})}))})},a={},u=function(){function t(t,e,n,r,i){this.F=t,this.Ci=i||"",this.dt={table:e,comments:[],state:"pending",queryID:Date.now()+"."+this.F.fastRand().toString(16),action:n,actionArgs:r,result:[]}}return t.prototype.where=function(t){return this.dt.where=t,this},t.prototype.range=function(t,e){return this.dt.range=[t,e],this},t.prototype.on=function(t){return this.dt.on=t,this},t.prototype.debounce=function(t){return this.dt.debounce=t||250,this},t.prototype.orm=function(t){return this.dt.orm=t,this},t.prototype.orderBy=function(t){return this.dt.orderBy=t,this},t.prototype.groupBy=function(t){return this.dt.groupBy=t,this},t.prototype.having=function(t){return t.length&&Array.isArray(t)||(this.Di="Having condition requires an array!"),this.dt.having=t,this},t.prototype.join=function(t){var e=this;if(Array.isArray(this.dt.table))throw new Error("Can't JOIN with instance table!");var n="Join commands requires table and type arguments!";return Array.isArray(t)?t.forEach(function(t){t.table&&t.type||(e.Di=n)}):t.table&&t.type||(this.Di=n),this.dt.join=t,this},t.prototype.limit=function(t){return this.dt.limit=t,this},t.prototype.trieSearch=function(t,e){return this.dt.trie={column:t,search:e},this},t.prototype.comment=function(t){return this.dt.comments.push(t),this},t.prototype.extend=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.dt.extend=t,this},t.prototype.offset=function(t){return this.dt.offset=t,this},t.prototype.emit=function(){return this.dt},t.prototype.toCSV=function(t){var e=this,n=this;return new i.e(function(r,i){n.exec().then(function(i){var o="string"==typeof e.dt.table?e.F.dataModels[e.dt.table].map(function(t){return t.key}):void 0;r(n.F.JSONtoCSV(i,t||!1,o))})})},t.prototype.manualExec=function(t){return this.dt=r({},this.dt,t),this.exec()},t.prototype.denormalizationQuery=function(t){var e=this;return new i.e(function(n,r){switch(t){case"tocolumn":var o={};e.dt.actionArgs&&e.dt.actionArgs.length?Object.keys(e.F.toColRules[e.dt.table]).filter(function(t){return-1!==e.dt.actionArgs.indexOf(t)}).forEach(function(t){o[t]=e.F.toColRules[e.dt.table][t]}):o=e.F.toColRules[e.dt.table],e.dt.action="select",e.dt.actionArgs=void 0;var a=Object.keys(o);s(e,function(t){i.fastCHAIN(t,function(t,n,r){Object.isFrozen(t)&&(t=i.u(t)),i.fastALL(a,function(n,r,i){var s=e.F.toColFns[e.dt.table][o[n][0]];s?s.apply(null,[t[n],function(e){t[n]=e,i()}].concat(o[n].filter(function(t,e){return e>0}).map(function(e){return t[e]}))):i()}).then(function(){e.F.query("upsert",t).manualExec({table:e.dt.table}).then(r).catch(r)})}).then(function(){n({msg:t.length+" rows modified"})})});break;case"torow":var u=(e.dt.actionArgs||"").replace("()","");if(!e.F.toRowFns[e.dt.table]||!e.F.toRowFns[e.dt.table][u])return void r("No function "+e.dt.actionArgs+" found to perform updates!");var c=e.F.toRowFns[e.dt.table][u],f=e.F.tablePKs[e.dt.table];if(e.dt.on&&e.dt.on.length)return void i.fastALL(e.dt.on,function(t,n,r){c(t,{},function(n){n[f]=t,e.F.query("upsert",n).manualExec({table:e.dt.table}).then(r).catch(r)})}).then(function(){n([{msg:(e.dt.on||[]).length+" rows modified or added."}])});e.dt.action="select",e.dt.actionArgs=void 0,s(e,function(t){i.fastALL(t,function(t,n,r){Object.isFrozen(t)&&(t=i.u(t)),c(t[f],t,function(n){n[f]=t[f],e.F.query("upsert",n).manualExec({table:e.dt.table}).then(r).catch(r)})}).then(function(){n({msg:t.length+" rows modified"})})})}})},t.prototype.exec=function(){var t=this;if(Array.isArray(this.dt.table))return new i.e(function(e,n){t.F.iB.doExec&&t.F.iB.doExec(t.dt,function(t){e(t.result)})});if("*"!==this.dt.table){var e=this,n=(this.dt.action||"").toLowerCase().trim();if(["tocolumn","torow"].indexOf(n)>-1){if(this.dt.debounce){var r=i.hash(JSON.stringify([this.dt.table,n,this.dt.actionArgs,this.dt.on,this.dt.where].filter(function(t){return t})));return new i.e(function(e,i){a[r]&&clearTimeout(a[r]),a[r]=setTimeout(function(){t.denormalizationQuery(n).then(e)},t.dt.debounce)})}return this.denormalizationQuery(n)}if(!(["select","upsert","delete","drop","show tables","describe"].indexOf(n)>-1))throw Error("nSQL: No valid database action!");var o=this.dt.actionArgs||("select"===n?[]:{}),u=[];return"upsert"===n?(u=Array.isArray(o)?o:[o]).forEach(function(e,n){t.F.rowFilters[t.dt.table]&&(u[n]=t.F.rowFilters[t.dt.table](u[n]));for(var r={},o=t.F.dataModels[t.dt.table],s=0;s<o.length;)void 0!==u[n][o[s].key]&&(r[o[s].key]=i.cast(o[s].type,u[n][o[s].key])),s++;if(t.F.skipPurge[t.dt.table]){var a=o.map(function(t){return t.key});Object.keys(u[n]).filter(function(t){return-1===a.indexOf(t)}).forEach(function(t){r[t]=u[n][t]})}u[n]=r}):u=this.dt.actionArgs,this.dt.action=n,this.dt.actionArgs=this.dt.actionArgs?u:void 0,new i.e(function(n,r){var i=function(){e.F.plugins.length||(e.Di="nSQL: No plugins, nothing to do!"),e.Di?r(e.Di):t.F.queryMod?t.F.queryMod(t.dt,function(e){t.dt=e,s(t,n)}):s(t,n)};t.F.isConnected||0===t.dt.table.indexOf("_")?i():t.F.onConnected(i)})}},t}();e.ht=u},function(t,e,n){t.exports=n(8)}])});
!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){e.exports=n(1)},function(e,t,n){"use strict";function r(e){return a.table(e)}var i=n(2),o=n(3),s=n(4),c=function(){function e(){var e=this;e.e=new i.TSMap,e.t=new i.TSMap,e.n=new i.TSMap,e.r=[],e.i=[],e.o=["change","delete","upsert","drop","select","error"],e.s=new i.TSMap,e.s.set("*",new i.TSMap),e.o.forEach(function(t){e.s.get("*").set(t,[])}),e.a=new i.TSMap,e.u=[]}return e.prototype.table=function(e){return e&&(this.l=e),this},e.prototype.connect=function(e){var t=this;return t.f=e||new s.SomeSQLMemDB,new o.TSPromise(function(e,n){t.f.connect(t.n,t.e,t.t,t.a,t.i,e,n)},t)},e.prototype.on=function(e,t){var n=this,r=n.l;return n.s.get(r)||n.o.forEach(function(e){n.s.get(r).set(e,[])}),e.split(" ").forEach(function(e){n.o.indexOf(e)!==-1&&n.s.get(r).get(e).push(t)}),n},e.prototype.off=function(e){return this.s.forEach(function(t){t.forEach(function(t){t.filter(function(t){return t!==e})})}),this},e.prototype.alwaysApplyFilter=function(e){return this.u.indexOf(e)===-1&&this.u.push(e),this},e.prototype.model=function(e){var t=this,n=t.l;return t.s.set(n,new i.TSMap),t.s.get(n).set("*",[]),t.o.forEach(function(e){t.s.get(n).set(e,[])}),t.n.set(n,e),t.t.set(n,[]),t.e.set(n,[]),t},e.prototype.views=function(e){return this.t.set(this.l,e),this},e.prototype.getView=function(e,t){void 0===t&&(t={});var n,r=this,i=r.l;if(r.t.get(i).forEach(function(t){t.name===e&&(n=t)}),!n)throw Error("View does not exist");return r._=e,n.call.apply(r,[r.h(n.args,t),r])},e.prototype.h=function(e,t){var n=this,r=(n.l,{});return e&&e.forEach(function(e){var i=e.split(":");i.length>1?r[i[0]]=n.d(i[1],t[i[0]]||null):r[i[0]]=t[i[0]]||null}),r},e.prototype.d=function(e,t){switch(["string","int","float","array","map","bool"].indexOf(e)){case 0:return String(t);case 1:return parseInt(t);case 2:return parseFloat(t);case 3:case 4:return JSON.parse(JSON.stringify(t));case 5:return t===!0;default:return""}},e.prototype.actions=function(e){return this.e.set(this.l,e),this},e.prototype.doAction=function(e,t){void 0===t&&(t={});var n,r=this,i=r.l;if(r.e.get(i).forEach(function(t){t.name===e&&(n=t)}),!n)throw Error("Action does not exist");return r._=e,n.call.apply(r,[r.h(n.args,t),r])},e.prototype.addFilter=function(e,t){return this.a.set(e,t),this},e.prototype.query=function(e,t){this.r=[];var n=e.toLowerCase();return["select","upsert","delete","drop"].indexOf(n)!==-1?this.r.push({type:n,args:t}):console.error("Invalid query '"+e+"'!"),this},e.prototype.where=function(e){return this.y("where",e)},e.prototype.orderBy=function(e){return this.y("orderby",e)},e.prototype.limit=function(e){return this.y("limit",e)},e.prototype.offset=function(e){return this.y("offset",e)},e.prototype.filter=function(e,t){return this.y("filter-"+e,t)},e.prototype.y=function(e,t){return this.r.push({type:e,args:t}),this},e.prototype.exec=function(){var e=this,t=e.l;e.v=e.r.map(function(e){switch(e.type){case"select":return[e.type];case"delete":case"upsert":case"drop":return[e.type,"change"];default:return[]}}).reduce(function(e,t){return e.concat(t)});var n=function(n){e.v.forEach(function(r){e.s.get(t).get(r).concat(e.s.get(t).get("*")).forEach(function(t){n.name=r,n.actionOrView=e._,t.apply(e,[n,e])})}),e._=void 0};return new o.TSPromise(function(r,i){var o=function(r,i,o){e.u.length&&o!==!0&&(r=e.u.reduce(function(t,n,i){return e.a.get(e.u[i]).apply(e,[r])},r)),n({table:t,query:e.r,time:(new Date).getTime(),result:r}),i(r,e)};e.f.exec(t,e.r,e._,function(e){o(e,r,!1)},function(t){e.v=["error"],o(t,i,!0)})},e)},e.prototype.extend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=this;return n.f?n.f.extend?n.f.extend.apply(n,e):void 0:(n.i.push(e),this)},e.prototype.loadJS=function(e){var t=this;return o.TSPromise.all(e.map(function(e){return t.table(t.l).query("upsert",e).exec()}))},e.prototype.loadCSV=function(e){var t=this,n=[];return new o.TSPromise(function(r,i){o.TSPromise.all(e.split("\n").map(function(e,r){return new o.TSPromise(function(i,o){if(0===r)n=e.split(","),i();else{var s={},c=e.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g).map(function(e){return e.replace(/^"(.+(?="$))"$/,"$1")});n.forEach(function(e,t){0!==c[t].indexOf("{")&&0!==c[t].indexOf("[")||(c[t]=JSON.parse(c[t].replace(/'/g,""))),s[e]=c[t]}),t.table(t.l).query("upsert",c).exec().then(function(){i()})}},t)})).then(function(){r()})},t)},e.prototype.toCSV=function(e){var t=this;return new o.TSPromise(function(n,r){t.exec().then(function(r){var i=t.r.filter(function(e){return"select"===e.type}).map(function(e){return e.args?e.args.map(function(e){return t.n.get(t.l).filter(function(t){return t.key===e})[0]}):t.n.get(t.l)})[0];e&&r.unshift(i.map(function(e){return e.key})),n(r.map(function(t,n){return e&&0===n?t:i.filter(function(e){return!!t[e.key]}).map(function(e){switch(e.type){case"map":return'"'+JSON.stringify(t[e.key]).replace(/"/g,"'")+'"';case"array":return'"'+JSON.stringify(t[e.key]).replace(/"/g,"'")+'"';default:return JSON.stringify(t[e.key])}}).join(",")}).join("\n"))})},t)},e.uuid=function(e){return e?e:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"===e?t:3&t|8;return n.toString(16)})}()},e.hash=function(e){for(var t=5381,n=0;n<e.length;n++){var r=e.charCodeAt(n);t=(t<<5)+t+r}return String(t)},e}();t.SomeSQLInstance=c;var a=new c;t.SomeSQL=r},function(e,t){"use strict";var n=function(){function e(e){var t=this;t.g=[],t.x=[],t.b=[],t.length=0,e&&e.forEach(function(e,n){t.set(e[0],e[1])})}return e.prototype.fromJSON=function(e){for(var t in e)e.hasOwnProperty(t)&&this.set(t,e[t])},e.prototype.toJSON=function(){var e={},t=this;return t.keys().forEach(function(n){e[String(n)]=t.get(n)}),e},e.prototype.entries=function(){return[].slice.call(this.g)},e.prototype.keys=function(){return[].slice.call(this.x)},e.prototype.values=function(){return[].slice.call(this.b)},e.prototype.has=function(e){return this.x.indexOf(e)>-1},e.prototype.get=function(e){var t=this.x.indexOf(e);return t>-1?this.b[t]:void 0},e.prototype.set=function(e,t){var n=this,r=this.x.indexOf(e);r>-1?(n.g[r][1]=t,n.b[r]=t):(n.g.push([e,t]),n.x.push(e),n.b.push(t)),n.length=n.size()},e.prototype.size=function(){return this.g.length},e.prototype.clear=function(){var e=this;e.x.length=e.b.length=e.g.length=0,e.length=e.size()},e.prototype.delete=function(e){var t=this,n=t.x.indexOf(e);return n>-1&&(t.x.splice(n,1),t.b.splice(n,1),t.g.splice(n,1),t.length=t.size(),!0)},e.prototype.forEach=function(e){var t=this;t.x.forEach(function(n){e(t.get(n),n)})},e.prototype.map=function(e){var t=this;return this.x.map(function(n){return e(t.get(n),n)})},e.prototype.filter=function(e){var t=this;return t.x.forEach(function(n){0==e(t.get(n),n)&&t.delete(n)}),this},e.prototype.clone=function(){return new e(JSON.parse(JSON.stringify(this.g)))},e}();t.TSMap=n},function(e,t){"use strict";var n=function(){function e(e,t){this.s=[],this.w=!1,this.S=!1,this.T=!1,this.k=t||this,e(this.O.bind(this),this.M.bind(this))}return e.resolve=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return new e(function(e){e.apply(this,t)})},e.reject=function(t){return new e(function(e,n){n(t)})},e.race=function(t){var n=!1;return new e(function(e,r){t.forEach(function(t){t.then(function(t){n||(e(t),n=!0)}).catch(function(e){r(e),n=!0})})})},e.chain=function(t){var n,r=0,i=[],o=function(e){r===t.length?n(i):e.then(function(e){i.push(e),r++,o(t[r])})};return new e(function(e){n=e,o(t[r])})},e.all=function(t){return new e(function(e,n){var r=t.length,i=[],o=!1;t.forEach(function(t,s){t.then(function(t){o||(r--,i[s]=t,0===r&&e(i))}).catch(function(e){n(e),o=!0})})})},e.prototype.done=function(e,t){this.T?setTimeout(this.F.bind(this,e,t),0):this.s.push({onSuccess:e,onFail:t})},e.prototype.then=function(t,n){var r=this;return new e(function(e,i){r.done(function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];if("function"==typeof t)try{n=t.apply(r.k,n)}catch(e){return void i(e)}e.apply(r.k,n)},function(t){if("function"==typeof n){try{t=n.apply(r.k,[t])}catch(e){return void i(e)}e(t)}else i(t)})},r.k)},e.prototype.catch=function(e){return this.then(null,e)},e.prototype.F=function(e,t){this.w?t.apply(this,this.b):e.apply(this,this.b)},e.prototype.O=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this.S||(this.S=!0,t[0]instanceof e?t[0].done(this.K.bind(this),function(e){this.w=!0,this.K(e)}.bind(this)):this.K.apply(this,t))},e.prototype.M=function(e){this.S||(this.S=!0,this.w=!0,this.K(e))},e.prototype.K=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.T=!0,this.b=e,setTimeout(this.s.forEach.bind(this.s,function(e){this.F(e.onSuccess,e.onFail)},this),0)},e}();t.TSPromise=n},function(e,t,n){"use strict";var r=n(1),i=n(3),o=n(2),s=function(){function e(){var e=this;e.a=new o.TSMap,e.N=new o.TSMap,e.J=new o.TSMap,e.C=new o.TSMap,e.q=new o.TSMap,e.I=[],e.A()}return e.prototype.connect=function(e,t,n,r,i,o){var s=this;e.forEach(function(e,t){s.Q(t,e)}),r.forEach(function(e,t){s.a.set(t,e)}),o()},e.prototype.Q=function(e,t){this.C.set(e,new o.TSMap),this.J.set(e,new o.TSMap),this.N.set(e,new c(t))},e.prototype.exec=function(e,t,n,o,s){var c=this;return null!=c.j?void c.I.push([e,t,n,o,s]):(c.l=e,c.P=[],c.j=null,c.V=r.SomeSQLInstance.hash(JSON.stringify(t)),c.q.set(c.V,t),void i.TSPromise.all(t.map(function(e){return new i.TSPromise(function(t,n){c.r(e,t)})})).then(function(){c.L(function(e){o(e),c.j=null,c.I.length&&c.exec.apply(c,c.I.pop())})}))},e.prototype.r=function(e,t){["upsert","select","delete","drop"].indexOf(e.type)!==-1?this.j=e:this.P.push(e),t()},e.prototype.A=function(){var e=this,t=e.a;t.set("sum",function(t){return[{sum:t.map(function(t){return t[e.j.args[0]]}).reduce(function(e,t){return e+t},0)}]}),t.set("first",function(e){return[e[0]]}),t.set("last",function(e){return[e.pop()]}),t.set("min",function(t){return[{min:t.map(function(t){return t[e.j.args[0]]}).sort(function(e,t){return e<t?-1:1})[0]}]}),t.set("max",function(t){return[{max:t.map(function(t){return t[e.j.args[0]]}).sort(function(e,t){return e>t?-1:1})[0]}]}),t.set("average",function(t){return[{average:e.W("sum",t)[0].sum/t.length}]}),t.set("count",function(e){return[{length:e.length}]})},e.prototype.W=function(e,t,n){return this.a.get(e).apply(this,[t,n])},e.prototype.D=function(e){var t=this,n=t.P.filter(function(e){return 0===e.type.indexOf("filter-")});return n.length?n.reduce(function(e,r,i){return t.W(n[i].type.replace("filter-",""),e,n[i].args)},e):e},e.prototype.z=function(e){var t=this;t.C.set(t.l,new o.TSMap),t.J.set(t.l,new o.TSMap)},e.prototype.L=function(e){var t,n=this,r=n.P.filter(function(e){return"where"===e.type}),i=r.length?r[0].args:void 0,s=n.j.args,c=n.N.get(n.l),a=0;switch(n.j.type){case"upsert":if(i){t=n.R(c,i);var u=[];t.$(function(e,t){for(var n in s)c.B(t)[n]=s[n];u.push(t),a++}),n.z(u)}else c.G(s),a++,n.C.set(n.l,new o.TSMap),n.J.set(n.l,new o.TSMap);e([{result:a+" row(s) upserted"}]);break;case"select":if(n.C.get(n.l).has(n.V))return void e(n.C.get(n.l).get(n.V));t=i?n.R(c,i):c.X();var l=["ordr","ofs","lmt","clms"],f=function(e){return n.P.filter(function(t){return t.type===e}).pop()},p=l.reduce(function(e,t,n){switch(l[n]){case"ordr":if(f("orderby")){var r=new o.TSMap;return r.fromJSON(f("orderby").args),e.sort(function(e,t){return r.keys().reduce(function(n,i,o){var s=r.keys()[o];return e[s]===t[s]?0+n:(e[s]>t[s]?1:-1)*("asc"===r.get(s)?1:-1)+n},0)})}case"ofs":if(f("offset")){var i=f("offset").args;return e.filter(function(e,t){return t>=i})}case"lmt":if(f("limit")){var a=f("limit").args;return e.filter(function(e,t){return t<a})}case"clms":if(s){var u=c.H.map(function(e){return e.key}).filter(function(e){return s.indexOf(e)===-1});return e.map(function(e){return u.forEach(function(t){return delete e[t]}),e})}default:return e}},t.U),_=n.D(p);n.C.get(n.l).set(n.V,_),n.J.get(n.l).set(n.V,p.map(function(e){return e[t.Y]})),e(_);break;case"delete":if(i){var h=[],d=n.R(c,i);d.$(function(e,t){c.Z(t),h.push(t)}),n.z(h),e([{result:d.length+" row(s) deleted"}])}else n.Q(n.l,n.N.get(n.l).H),e([{result:"Table Dropped"}]);break;case"drop":n.Q(n.l,n.N.get(n.l).H),e([{result:"Table Dropped"}])}},e.prototype.R=function(e,t){var n=this;if(t&&t.length){if("string"==typeof t[0])return n.ee(e.X(),t);var r=0,i=null;return t.map(function(t){return n.ee(e.X(),t)}).reduce(function(e,n,o){if(0===o)return n;if(0===r)return i=t[o],r=1,e;if(1===r)switch(r=0,i){case"and":return e.te("inner",n);case"or":return e.te("outer",n);default:return e}})}return e.X()},e.prototype.ee=function(e,t){var n=this,r=(t[0],t[1]),i=t[2];return e.ne=e.ne.filter(function(o){return 0===n.re(i,r,e.B(o)[t[0]])}),e},e.prototype.re=function(e,t,n){switch(t){case"=":return n===e?0:1;case">":return n>e?0:1;case"<":return n<e?0:1;case"<=":return n<=e?0:1;case">=":return n>=e?0:1;case"IN":return e.indexOf(n)===-1?1:0;case"NOT IN":return e.indexOf(n)===-1?0:1;case"REGEX":case"LIKE":return n.search(e)===-1?1:0;default:return 0}},e}();t.SomeSQLMemDB=s;var c=function(){function e(e,t,n){var r=this;r.H=e,r.ne=t||[],r.U=n||[],r.ie=1,r.length=0,r.Y=r.H.reduce(function(e,t){return t.props&&t.props.indexOf("pk")!==-1?(r.oe=t.type,t.key):e},"")}return e.se=function(e){return JSON.parse(JSON.stringify(e))},e.prototype.B=function(e){return this.U[this.ne.indexOf(e)]},e.prototype.ce=function(e,t){this.U[this.ne.indexOf(e)]=t},e.prototype.G=function(e){var t=this;if(e=JSON.parse(JSON.stringify(e)),t.H.forEach(function(t){e[t.key]=e[t.key]||t.default}),e[t.Y])t.ce(e[t.Y],e);else{switch(t.oe){case"int":e[t.Y]=t.ie,t.ie++;break;case"uuid":e[t.Y]=r.SomeSQLInstance.uuid()}t.ne.push(e[t.Y]),t.U.push(e),t.length=t.ne.length}},e.prototype.ae=function(e){var t=this;return t.ne.forEach(function(n){e(t.B(n),n)===!1&&t.Z(n)}),t},e.prototype.$=function(e){var t=this;return t.ne.forEach(function(n){e.apply(t,[t.B(n),n])}),t},e.prototype.ue=function(e){var t=this,n=[],r=-1;return t.ne.sort(function(r,i){var o=e.apply(t,[t.B(r),t.B(i)]);return n.push(o),o}),t.U.sort(function(e,t){return r++,n[r]}),t},e.prototype.te=function(e,t,n,r){var i=this,o=[];o=n?n:[i.Y,t.Y];var s=[this,t];return"inner"===e&&s.sort(function(e,t){return e.length>t.length?-1:1}),s[0].$(function(t,n){var r;if(s[1].$(function(e,n){void 0===r&&t[o[0]]===e[o[1]]&&(r=e)}),void 0===r)switch(e){case"inner":s[0].Z(n);break;case"outer":s[1].G(r)}}),"outer"===e&&s[0].ue(function(e,t){return e[s[0].Y]>t[s[0].Y]?1:-1}),s[0]},e.prototype.Z=function(e){var t=this,n=t.ne.indexOf(e);t.ne.splice(n,1),t.U.splice(n,1),t.length=t.ne.length},e.prototype.X=function(){var t=new e(this.H,e.se(this.ne),e.se(this.U));return t.ie=this.ie,t.length=this.length,t},e}()}])});
!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.e?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=3)}([function(e,t,n){function r(e){return c.table(e)}var o=this&&this.t||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},i=n(1),s=n(2),a=function(){function e(){var e=this;e.r={},e.a={},e._={},e.u=[],e.f=[],e.h=["change","delete","upsert","drop","select","error"],e.b={},e.b["*"]={};for(var t=e.h.length;t--;)e.b["*"][e.h[t]]=[];e.y={},e.g=[]}return e.prototype.table=function(e){return e&&(this.v=e,this.activeTable=e),this},e.prototype.connect=function(e){var t=this,n=this;return n.backend=e||new s.w,new i.x(function(e,r){n.backend.k({_:n._,r:n.r,a:n.a,y:n.y,I:n.f,T:t,S:function(t){e(t,n)},j:function(e){r&&r(e,n)}})})},e.prototype.on=function(e,t){var n=this,r=n.v,o=0;if(!n.b[r])for(n.b[r]={},n.b[r]["*"]=[];o--;)n.b[r][n.h[o]]=[];var i=e.split(" ");for(o=i.length;o--;)n.h.indexOf(i[o])!==-1&&n.b[r][i[o]].push(t);return n},e.prototype.off=function(e){var t=this;for(var n in t.b)for(var r in t.b[n])t.b[n][r]=t.b[n][r].filter(function(t){return t!==e});return t},e.prototype.alwaysApplyFilter=function(e){return this.g.indexOf(e)===-1&&this.g.push(e),this},e.prototype.model=function(e){var t=this,n=t.v,r=t.h.length;if(!t.b[n])for(t.b[n]={},t.b[n]["*"]=[];r--;)t.b[n][t.h[r]]=[];return t._[n]=e,t.a[n]=[],t.r[n]=[],t},e.prototype.views=function(e){return this.a[this.v]=e,this},e.prototype.getView=function(e,t){void 0===t&&(t={});for(var n,r=this,o=r.v,i=r.a[o].length;i--;)r.a[o][i].name===e&&(n=r.a[o][i]);if(!n)throw Error;return r.O=e,n.call.apply(r,[r.R(n.args?n.args:[],t),r])},e.prototype.R=function(e,t){var n=this,r=(n.v,{}),o=e.length?e.length:-1;if(o>0)for(;o--;){var i=e[o].split(":");i.length>1?r[i[0]]=n.P(i[1],t[i[0]]||null):r[i[0]]=t[i[0]]||null}return r},e.prototype.P=function(e,t){return{string:String(t),int:parseInt(t),float:parseFloat(t),array:o({},t),map:o({},t),bool:t===!0}[e]||t},e.prototype.actions=function(e){return this.r[this.v]=e,this},e.prototype.doAction=function(e,t){void 0===t&&(t={});for(var n,r=this,o=r.v,i=r.r[o].length;i--;)r.r[o][i].name===e&&(n=r.r[o][i]);if(!n)throw Error;return r.O=e,n.call.apply(r,[r.R(n.args?n.args:[],t),r])},e.prototype.addFilter=function(e,t){return this.y[e]=t,this},e.prototype.query=function(e,t){var n=this;this.u=[];var r=e.toLowerCase();if(["select","upsert","delete","drop"].indexOf(r)===-1)throw Error;var o=t||{};return"upsert"===e&&(o=JSON.parse(JSON.stringify(t)),this._[this.v].forEach(function(e){e.default&&!o[e.key]?o[e.key]=e.default:o[e.key]=n.P(e.type,o[e.key])}),this.D[this.v]&&(o=this.D[this.v](o))),this.u.push({type:r,args:o}),this},e.prototype.where=function(e){return this.q("where",e)},e.prototype.orderBy=function(e){return this.q("orderby",e)},e.prototype.join=function(e){return this.q("join",e)},e.prototype.limit=function(e){return this.q("limit",e)},e.prototype.offset=function(e){return this.q("offset",e)},e.prototype.filter=function(e,t){return this.q("filter-"+e,t)},e.prototype.q=function(e,t){return this.u.push({type:e,args:t}),this},e.prototype.triggerEvent=function(e,t){var n=this;setTimeout(function(){for(var r,o,i=t.length,s=0;i--;)for(r=t[i],o=n.b[n.v][r].concat(n.b[n.v]["*"]),s=o.length;s--;)e.name=r,e.actionOrView=n.O||"",o[s](e,n);n.O=void 0},0)},e.prototype.exec=function(){var e=this,t=e.v;return e.C=e.u.map(function(e){switch(e.type){case"select":return[e.type];case"delete":case"upsert":case"drop":return[e.type,"change"];default:return[]}}).reduce(function(e,t){return e.concat(t)}),new i.x(function(n,r){var o=function(n,r,o){e.g.length&&o!==!0&&(n=e.g.reduce(function(t,r,o){return e.y[e.g[o]].apply(e,[n])},n)),e.triggerEvent({name:"error",actionOrView:"",table:t,query:e.u,time:(new Date).getTime(),result:n},e.C),r(n,e)};e.backend.F({Q:t,u:e.u,A:e.O||"",S:function(e){o(e,n,!1)},j:function(t){e.C=["error"],r&&o(t,r,!0)}})})},e.prototype.config=function(e){var t=this;return t.backend||t.f.push(e),t},e.prototype.extend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=this;if(n.backend)return n.backend.B?(e.unshift(n),n.backend.B.apply(n.backend,e)):void 0},e.prototype.loadJS=function(e){var t=this;return new i.x(function(n,r){i.x.chain(e.map(function(e){return t.table(t.v).query("upsert",e).exec()})).then(function(e){n(e,t)})})},e.prototype.rowFilter=function(e){return this.D[this.v]=e,this},e.prototype.loadCSV=function(e){var t=this,n=[];return new i.x(function(r,o){i.x.all(e.split("\n").map(function(e,r){return new i.x(function(o,i){if(0===r)n=e.split(","),o();else{var s={},a=e.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)||[];a=a.map(function(e){return e.replace(/^"(.+(?="$))"$/,"$1")});for(var c=n.length;c--;)0!==a[c].indexOf("{")&&0!==a[c].indexOf("[")||(a[c]=JSON.parse(a[c].replace(/'/g,""))),s[n[c]]=a[c];t.table(t.v).query("upsert",s).exec().then(function(){o()})}})})).then(function(){r([],t)})})},e.uuid=function(){var e,t,n,r=function(){return window&&window.crypto.getRandomValues?(n=new Uint16Array(1),window.crypto.getRandomValues(n),n[0]):Math.round(Math.random()*Math.pow(2,16))},o="";return[o,o,o,o,o,o,o,o,o].reduce(function(n,i,s){for(e=r(),t=4===s?s:5===s?(e%16&3|8).toString(16):o,e=e.toString(16);e.length<4;)e="0"+e;return n+([3,4,5,6].indexOf(s)>=0?"-":o)+(t+e).slice(0,4)},o)},e.L=function(e){return Math.abs(e.split("").reduce(function(t,n,r){return(t<<5)+t+e.charCodeAt(r)},0))},e.prototype.toCSV=function(e){var t=this;return new i.x(function(n,r){t.exec().then(function(r){var o=t.u.filter(function(e){return"select"===e.type}).map(function(e){return e.args?e.args.map(function(e){return t._[t.v].filter(function(t){return t.key===e})[0]}):t._[t.v]})[0];e&&r.unshift(o.map(function(e){return e.key})),n(r.map(function(t,n){return e&&0===n?t:o.filter(function(e){return!!t[e.key]}).map(function(e){switch(e.type){case"map":case"array":return'"'+JSON.stringify(t[e.key]).replace(/"/g,"'")+'"';default:return JSON.stringify(t[e.key])}}).join(",")}).join("\n"),t)})})},e}();t.SomeSQLInstance=a;var c=new a;t.SomeSQL=r},function(e,t,n){"use strict";var r="function",o=function(){function e(e){var t=this;e&&e(function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];t.resolve.apply(t,e)},function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];t.reject.apply(t,e)})}return e.prototype.resolve=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.V(1,e)},e.prototype.reject=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.V(-1,e)},e.prototype.V=function(t,n){var o=this;if(!o.N&&n[0]!==o){if(1===t&&n[0]&&(typeof n[0]===r||"object"==typeof n[0])&&typeof n[0].then===r)return void n[0].then.call(n[0],function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];o.resolve.apply(o,e)},function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];o.reject.apply(o,e)});o.N=t,o.J=n,o.H&&o.H.forEach(function(n){1===t&&e.M(n,o.J),t===-1&&e.$(n,o.J)})}},e.prototype.then=function(t,n){var r=new e,o=this,i={promise:r,successFunc:t,failFunc:n};return o.N?1===o.N?e.M(i,o.J):e.$(i,o.J):o.H?o.H.push(i):o.H=[i],r},e.prototype.catch=function(e){return this.then(function(){},e)},e.all=function(t){var n=[];return new e(function(e,r){t&&t.length?t.forEach(function(r){r.then(function(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];n.push(r),n.length===t.length&&e(n)})}):e([])})},e.chain=function(t){var n=0,r=[];return new e(function(e){var o=function(i){n===t.length?e(r):i.then(function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];r.push(e),n++,o(t[n])})};o(t[n])})},e.race=function(t){return new e(function(e,n){t&&t.length?t.forEach(function(t){t.then(function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];e.apply(t,n)})}):e()})},e.M=function(t,n){e.V(1,t.successFunc,t,n)},e.$=function(t,n){t.failFunc&&e.V(-1,t.failFunc,t,n)},e.V=function(e,t,n,o){if(typeof t===r)try{n.promise.resolve(t.apply(n.promise,o))}catch(e){n.promise.reject(e)}else 1===e&&n.promise.resolve.apply(n.promise,o),e===-1&&n.promise.reject.apply(n.promise,o)},e}();t.x=o},function(e,t,n){var r=this&&this.t||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},o=n(0),i=n(1),s={sum:function(e){return[{sum:e.map(function(e){for(var t in e)return e[t]}).reduce(function(e,t){return e+t},0)}]},min:function(e){return[{min:e.map(function(e){for(var t in e)return e[t]}).sort(function(e,t){return e<t?-1:1})[0]}]},max:function(e){return[{max:e.map(function(e){for(var t in e)return e[t]}).sort(function(e,t){return e>t?-1:1})[0]}]},average:function(e){return[{average:s.sum(e)[0].sum/e.length}]},count:function(e){return[{count:e.length}]}},a=function(){function e(){var e=this;e._={},e.z={},e.G=[],e.K=[[]],e.U=0,e.X={},e.W=[0,0],e.Y={},e.Z=[],e.ee={},e.te=[]}return e.prototype.ne=function(e){return this.Z[e][this.re(e)]},e.prototype.re=function(e){return this.X[e]},e.prototype.k=function(e){var t,n=this,r=0,i=[],a=!1;n.T=e.T,n.oe=!!e.I.length&&(e.I[0].persistent||!1);for(var c in e._){var _=o.SomeSQLInstance.L(c);for(i.push(c),n._[_]=e._[c],n.ee[_]={},n.z[_]={ie:"",se:c,ae:1,ce:[],_e:{}},r=n._[_].length;r--;)t=n._[_][r],t.props&&t.props.indexOf("pk")!==-1&&(n.z[_].ie=t.key)}if(n.ue=o.SomeSQLInstance.L(JSON.stringify(e._)),e.y)for(var u in e.y)s[u]=e.y[u];var l=0;if(n.oe&&window&&window.indexedDB){var f=window.indexedDB.open(String(n.ue),1);f.onupgradeneeded=function(t){a=!0;var r=t.target.result,s=function(){if(l<i.length){var t=o.SomeSQLInstance.L(i[l]),a=n.z[t].ie?{keyPath:n.z[t].ie}:{};r.createObjectStore(i[l],a),l++,s()}else e.S()};s()},f.onsuccess=function(t){if(n.le=t.target.result,!a){n.isImporting=!0;var r=function(){if(l<i.length){var t=(o.SomeSQLInstance.L(i[l]),n.le.transaction(i[l],"readonly")),s=t.objectStore(i[l]),a=s.openCursor(),c=[];t.oncomplete=function(){n.T.table(i[l]).loadJS(c).then(function(){l++,r()})},a.onsuccess=function(e){var t=e.target.result;t&&(c.push(t.value),t.continue())}}else n.isImporting=!1,e.S()};r()}}}else e.S()},e.prototype.F=function(e){var t=this;t.G.length?t.G.push(e):(t.v=o.SomeSQLInstance.L(e.Q),new c(t).fe(e).then(function(e){t.G.length&&t.F(t.G.pop())}))},e.prototype.de=function(e){for(var t=this,n=[t.v],r=t.te.length;r--;)t.te[r].indexOf(t.v)!==-1&&n.concat(t.te[r]);t.pe(n.sort()).forEach(function(n){t.ee[n]={},e&&t.T.triggerEvent({name:"change",actionOrView:"",table:t.z[n].se,query:[],time:(new Date).getTime(),result:[]},["change"])})},e.prototype.pe=function(e){return e.filter(function(e,t,n){return!t||e!==n[t-1]})},e.prototype.B=function(e,t){var n,r,o,s,a,c=this,_=c.le.transaction(c.z[c.v].se,"readwrite").objectStore(c.z[c.v].se),u=function(e){for(n=c.K[c.U].length;n--;)o=c.K[c.U][n],s=c.ne(o)||{},a=s[c.z[c.v].ie],c.X[o]+=e,s=c.ne(o),c.le&&(s?_.put(s):_.delete(a)),c.X[o]<0&&(c.X[o]=0)};return new i.x(function(e,n){if(!c.K.length&&["<",">"].indexOf(t)!==-1)return void e(!1);switch(t){case"<":c.U===c.K.length-1?e(!1):(u(1),c.U++,c.de(!0),e(!0));break;case">":c.U<1?e(!1):(c.U--,u(-1),c.de(!0),e(!0));break;case"?":r=[c.K.length-1,c.U],c.W.join("+")!==r.join("+")&&(c.W=r),e(c.W);break;case"flush_db":c.le&&window.indexedDB.deleteDatabase(String(c.ue))}})},e}();t.w=a;var c=function(){function e(e){this.he=e}return e.prototype.fe=function(e){var t=this;return new i.x(function(n,r){t.be=[],t.ye=void 0,t.he.v=o.SomeSQLInstance.L(e.Q),t.ge=o.SomeSQLInstance.L(JSON.stringify(e.u)),i.x.all(e.u.map(function(e){return new i.x(function(n,r){["upsert","select","delete","drop"].indexOf(e.type)!==-1?t.ye=e:t.be.push(e),n()})})).then(function(){t.ve(function(r){e.S(r),n(t)})})})},e.prototype.me=function(){var e=this,t=e.he.Z.length;return e.he.Z.push([null]),e.he.z[e.he.v].ce.push(t),e.he.X[t]=0,t},e.prototype.ve=function(e){var t=this;if(t.ye){var n,s,a,c,_,u,l,f,d,p,h,b,y,g,v,m=t.he.z[t.he.v].ie,w=t.ye.args||[],x=0,k=[],I=[],T=t.he.z[t.he.v].ce.slice(),S=[],j=t.be.filter(function(e){return"where"===e.type}),O=function(e){return t.be.filter(function(t){return t.type===e}).pop()},R=function(n,r){n>0?(t.he.U>0&&(t.he.K=t.he.K.filter(function(e,n){if(n<t.he.U){for(a=e.length;a--;)t.he.X[e[a]]=0,t.he.Z[e[a]].shift();return!1}return!0}),t.he.U=0),t.he.isImporting?(t.he.K[0]||(t.he.K[0]=[]),t.he.K[0]=t.he.K[0].concat(I)):t.he.K.unshift(I),t.he.de(!1),e([{msg:n+" row(s) "+r}])):e([{msg:"0 rows "+r}])},P=function(e,n){I.push(e);var o=r({},t.he.ne(e)||{});for(var i in w)o[i]=n(i,o[i]);if(t.he.Z[e].unshift(Object.freeze(o)),t.he.le){var s=t.he.z[t.he.v].se;t.he.le.transaction(s,"readwrite").objectStore(s).put(o)}};switch("drop"!==t.ye.type&&(k=j.length&&!O("join")?t.we(T,j[0].args):T),t.ye.type){case"upsert":if(n="updated",s=k.length,j.length&&w[m])throw new Error("Can't use a where statement if you have a non null primary key value!");if(j.length)for(x=s,n="modified";s--;)P(k[s],function(e,t){return e!==m?w[e]:t});else{if(c=0,w[m])t.he.z[t.he.v]._e[w[m]]?c=t.he.z[t.he.v]._e[w[m]]:(c=t.me(),n="inserted",t.he.z[t.he.v].ae=Math.max(w[m]+1,t.he.z[t.he.v].ae),t.he.z[t.he.v]._e[w[m]]=c);else for(n="inserted",_=t.he._[t.he.v].length;_--;)if(u=t.he._[t.he.v][_],u.props&&u.props.indexOf("pk")!==-1){switch(u.type){case"int":w[m]=t.he.z[t.he.v].ae++;break;case"uuid":w[m]=o.SomeSQLInstance.uuid()}c=t.me(),t.he.z[t.he.v]._e[w[m]]=c}P(c,function(e,t){return w[e]||t}),x=1}R(x,n);break;case"select":if(t.he.ee[t.he.v][t.ge]){e(t.he.ee[t.he.v][t.ge]);break}l=["join","orderby","offset","limit"];var D=function(e,n){return new i.x(function(r,i){if(f=O(l[n]),!f)return r(e),!1;switch(n){case 0:t.he.T.table(f.args.table).query("select").exec().then(function(n,i){if(f){d=f.args.where.map(function(e,t){return e.split(".").map(function(e,n){return 1!==t&&0===n?o.SomeSQLInstance.L(e):e})});var s=t.he.z[d[2][0]];n=n.map(function(e){return s._e[e[s.ie]]}).filter(function(e){return e}),e=t.xe(f.args.type,e,n,d),j.length&&(e=t.we(e,j[0].args)),r(e)}});break;case 1:r(e.sort(function(e,n){if(f){p=[];for(var r in f.args)p.push(r);return p.reduce(function(r,o,i){if(f)return h=p[i],b=t.he.ne(e)||{},y=t.he.ne(n)||{},(b[h]>y[h]?1:-1)*("asc"===f.args[h]?1:-1)+r},0)}}));break;case 2:r(e.filter(function(e,t){return!f||t>=f.args}));break;case 3:r(e.filter(function(e,t){return!f||t<f.args}))}})};s=l.length;var q=function(n){s>-1?(s--,D(n,s).then(function(e){q(e)})):(n.forEach(function(e){if(w.length)if(a=w.length,g=t.he.ne(e))for(v={};a--&&v&&g;)v[w[a]]=g[w[a]];else v=null;else v=t.he.ne(e);v&&S.push(v)}),S=t.ke(S),t.he.ee[t.he.v][t.ge]=S,e(t.he.ee[t.he.v][t.ge]))};q(k);break;case"drop":case"delete":var C=[];C=k.length&&"delete"===t.ye.type?k:T,n="deleted",s=C.length;for(var E=t.he.z[t.he.v].se;s--;)if(w.length)P(C[s],function(e,t){return w.indexOf(e)!==-1?null:t}),n="modified";else{var F=(t.he.ne(C[s])||{})[t.he.z[t.he.v].ie];t.he.le&&F&&t.he.le.transaction(E,"readwrite").objectStore(E).delete(F),t.he.Z[C[s]].unshift(null),I.push(C[s])}R(C.length,n)}}},e.prototype.Ie=function(e,t){var n,r=this;return e.filter(function(e){return n=r.he.ne(e),!!n&&0===r.Te(t[2],t[1],n[t[0]])})},e.prototype.we=function(e,t){var n,r=this,o=["and","or"],i=function(e,t){return r.he.pe(e[0].concat(e[1]).sort().filter(function(e,n,r){return"and"!==t||n!==r.lastIndexOf(e)}))};return"string"==typeof t[0]?r.Ie(e,t):t.map(function(t){return o.indexOf(t)!==-1?t:r.Ie(e,t)}).reduce(function(e,t,r){return o.indexOf(t)===-1?0===r?t:i([e,t],n):(n=t,e)})},e.prototype.xe=function(e,t,n,r){var o,i,s,a,c,_,u=this,l=[],f=[],d=[r[0][0],r[2][0]],p=[u.he.z[r[0][0]].se,u.he.z[r[2][0]].se],h=[u.he._[r[0][0]],u.he._[r[2][0]]],b={},y=[],g=[],v=t.length;for(v=u.he.te.length,a=0;v--&&!a;)u.he.te[v].indexOf(d[0])!==-1&&u.he.te[v].indexOf(d[1])!==-1&&(a=1);a||u.he.te.push(d);var m=function(e,t){return o=e.join("+"),i=!1,_=e.map(function(e){return u.he.re(e)}),u.he.Y[o]||(i=!0,u.he.Y[o]={Se:0,je:_}),(i||_.join("+")!==u.he.Y[o].je.join("+"))&&(b={},h.forEach(function(n,r){s=e[r]===-1||t[r]===!1,n.forEach(function(e){b[p[r]+"."+e.key]=s?null:t[r][e.key]})}),i&&(u.he.Y[o].Se=u.me()),u.he.Z[u.he.Y[o].Se].unshift(b)),u.he.Y[o].Se};for(v=t.length;v--;){for(a=n.length,l[0]=u.he.ne(t[v])||{},y=[];a--;)l[1]=u.he.ne(n[a])||{},u.Te(l[0][r[0][1]],r[1][0],l[1][r[2][1]])&&"cross"!==e||(y.push([n[a],l[1]]),g.push(n[a]));if(c=y.length)for(;c--;)f.push(m([t[v],y[c][0]],[l[0],y[c][1]]));else"left"===e&&f.push(m([t[v],-1],[l[0],!1]))}if("right"===e)for(v=n.length;v--;)g.indexOf(n[v])===-1&&f.push(m([-1,n[v]],[!1,u.he.ne(n[v])||{}]));return f.reverse()},e.prototype.Te=function(e,t,n){switch(t){case"=":return n===e?0:1;case">":return n>e?0:1;case"<":return n<e?0:1;case"<=":return n<=e?0:1;case">=":return n>=e?0:1;case"IN":return e.indexOf(n)===-1?1:0;case"NOT IN":return e.indexOf(n)===-1?0:1;case"REGEX":case"LIKE":return n.search(e)===-1?1:0;default:return 0}},e.prototype.ke=function(e){var t=this,n=t.be.filter(function(e){return 0===e.type.indexOf("filter-")});return n.length?n.reduce(function(e,r,o){return s[n[o].type.replace("filter-","")].apply(t,[e,n[o].args])},e):e},e}()},function(e,t,n){e.exports=n(0)}])});